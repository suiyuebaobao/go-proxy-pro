import{_ as Ae,r,a as J,L as Te,o as De,b as h,d as w,e as u,f as l,w as s,h as c,i as p,O as Se,M as ne,n as o,k as ie,x as M,l as $,E as m,P as Fe}from"./index-DH-ATN2M.js";const Be={class:"error-config-page"},qe={class:"tab-header"},Oe={class:"muted-text"},Pe={class:"tab-header"},je={class:"rule-guide"},Ne={class:"guide-content"},He={class:"guide-item"},Ie={class:"guide-item"},Le={class:"guide-item"},Ge={class:"match-condition"},Je={key:0,class:"condition-item"},Ke={key:1,class:"condition-sep"},Qe={key:2,class:"condition-item"},We={class:"keyword-code"},Xe={key:3,class:"muted-text"},Ye={class:"priority-num"},Ze={class:"pagination-container"},el={__name:"ErrorMessages",setup(ll){const A=r("messages"),T=r(!1),D=r(!1),S=r(!1),F=r(!1),B=r(!1),q=r(!1),k=r(!1),C=r(!1),O=r([]),K=r(),n=J({id:null,code:400,error_type:"",custom_message:"",description:"",enabled:!0}),de={code:[{required:!0,message:"请选择状态码",trigger:"change"}],error_type:[{required:!0,message:"请输入错误类型",trigger:"blur"}],custom_message:[{required:!0,message:"请输入自定义消息",trigger:"blur"}]};async function V(){T.value=!0;try{const t=await p.getErrorMessages();O.value=t.data||t||[]}catch{}finally{T.value=!1}}function re(){C.value=!1,Object.assign(n,{id:null,code:400,error_type:"",custom_message:"",description:"",enabled:!0}),k.value=!0}function ue(t){C.value=!0,Object.assign(n,{id:t.id,code:t.code,error_type:t.error_type,custom_message:t.custom_message,description:t.description||"",enabled:t.enabled}),k.value=!0}async function pe(){if(await K.value.validate().catch(()=>!1)){F.value=!0;try{C.value?(await p.updateErrorMessage(n.id,{custom_message:n.custom_message,enabled:n.enabled,description:n.description}),m.success("更新成功")):(await p.createErrorMessage({code:n.code,error_type:n.error_type,custom_message:n.custom_message,enabled:n.enabled,description:n.description}),m.success("创建成功")),k.value=!1,V()}catch{}finally{F.value=!1}}}async function ce(t){try{await p.toggleErrorMessage(t.id),m.success("状态已更新")}catch{t.enabled=!t.enabled}}async function me(t){try{await p.deleteErrorMessage(t),m.success("删除成功"),V()}catch{}}async function fe(){D.value=!0;try{await p.initErrorMessages(),m.success("默认配置已初始化"),V()}catch{}finally{D.value=!1}}async function ge(){S.value=!0;try{await p.refreshErrorMessages(),m.success("缓存已刷新")}catch{}finally{S.value=!1}}async function _e(){var t;B.value=!0;try{const e=await p.enableAllErrorMessages();m.success(`已启用所有配置（影响 ${((t=e.data)==null?void 0:t.affected)||0} 条）`),V()}catch{}finally{B.value=!1}}async function ve(){var t;q.value=!0;try{const e=await p.disableAllErrorMessages();m.success(`已禁用所有配置（影响 ${((t=e.data)==null?void 0:t.affected)||0} 条）`),V()}catch{}finally{q.value=!1}}const P=r(!1),j=r(!1),N=r(!1),H=r(!1),I=r(!1),L=r(!1),R=r(!1),U=r(!1),G=r([]),Q=r(),y=J({page:1,pageSize:50,total:0}),i=J({id:null,http_status_code:0,keyword:"",target_status:"valid",priority:50,description:"",enabled:!0}),ye={target_status:[{required:!0,message:"请选择目标状态",trigger:"change"}]};async function b(){var t,e;P.value=!0;try{const d=await p.getErrorRules({page:y.page,page_size:y.pageSize});G.value=((t=d.data)==null?void 0:t.items)||[],y.total=((e=d.data)==null?void 0:e.total)||0}catch{}finally{P.value=!1}}function be(){U.value=!1,Object.assign(i,{id:null,http_status_code:0,keyword:"",target_status:"valid",priority:50,description:"",enabled:!0}),R.value=!0}function Ve(t){U.value=!0,Object.assign(i,{id:t.id,http_status_code:t.http_status_code,keyword:t.keyword,target_status:t.target_status,priority:t.priority,description:t.description||"",enabled:t.enabled}),R.value=!0}async function we(){if(await Q.value.validate().catch(()=>!1)){H.value=!0;try{const e={http_status_code:i.http_status_code||0,keyword:i.keyword||"",target_status:i.target_status,priority:i.priority,description:i.description,enabled:i.enabled};U.value?(await p.updateErrorRule(i.id,e),m.success("更新成功")):(await p.createErrorRule(e),m.success("创建成功")),R.value=!1,b()}catch{}finally{H.value=!1}}}async function ke(t){try{await p.updateErrorRule(t.id,{enabled:t.enabled}),m.success("状态已更新")}catch{t.enabled=!t.enabled}}async function Ce(t){try{await p.deleteErrorRule(t),m.success("删除成功"),b()}catch{}}async function Re(){try{await Fe.confirm("此操作将删除所有现有规则并恢复为默认规则，是否继续？","确认重置",{type:"warning"}),j.value=!0,await p.resetErrorRules(),m.success("已重置为默认规则"),b()}catch{}finally{j.value=!1}}async function Ee(){var t;N.value=!0;try{const e=await p.refreshErrorRulesCache();m.success(`缓存已刷新，共 ${((t=e.data)==null?void 0:t.rule_count)||0} 条规则`)}catch{}finally{N.value=!1}}async function Me(){var t;I.value=!0;try{const e=await p.enableAllErrorRules();m.success(`已启用所有规则（影响 ${((t=e.data)==null?void 0:t.affected)||0} 条）`),b()}catch{}finally{I.value=!1}}async function ze(){var t;L.value=!0;try{const e=await p.disableAllErrorRules();m.success(`已禁用所有规则（影响 ${((t=e.data)==null?void 0:t.affected)||0} 条）`),b()}catch{}finally{L.value=!1}}function W(t){return t>=500?"danger":t===429?"warning":t>=400?"info":""}function he(t){switch(t){case"valid":return"success";case"invalid":return"danger";case"rate_limited":return"warning";case"overloaded":return"info";default:return""}}function Ue(t){switch(t){case"valid":return"忽略";case"invalid":return"禁用账户";case"rate_limited":return"临时限流";case"overloaded":return"过载";default:return t}}return Te(A,t=>{t==="messages"&&O.value.length===0&&V(),t==="rules"&&G.value.length===0&&b()}),De(()=>{V()}),(t,e)=>{const d=c("el-button"),X=c("el-divider"),E=c("el-tag"),f=c("el-table-column"),x=c("el-switch"),Y=c("el-popconfirm"),Z=c("el-table"),ee=c("el-tab-pane"),xe=c("el-pagination"),$e=c("el-tabs"),g=c("el-option"),le=c("el-select"),_=c("el-form-item"),z=c("el-input"),te=c("el-form"),ae=c("el-dialog"),se=c("el-input-number"),oe=Se("loading");return w(),h("div",Be,[e[45]||(e[45]=u("div",{class:"page-header"},[u("h2",null,"错误配置")],-1)),l($e,{modelValue:A.value,"onUpdate:modelValue":e[2]||(e[2]=a=>A.value=a),type:"border-card"},{default:s(()=>[l(ee,{label:"错误消息",name:"messages"},{default:s(()=>[u("div",qe,[l(d,{type:"success",onClick:_e,loading:B.value,size:"small"},{default:s(()=>[...e[18]||(e[18]=[o("全部启用",-1)])]),_:1},8,["loading"]),l(d,{type:"warning",onClick:ve,loading:q.value,size:"small"},{default:s(()=>[...e[19]||(e[19]=[o("全部禁用",-1)])]),_:1},8,["loading"]),l(X,{direction:"vertical"}),l(d,{type:"primary",onClick:re,size:"small"},{default:s(()=>[...e[20]||(e[20]=[o("新增配置",-1)])]),_:1}),l(d,{onClick:fe,loading:D.value,size:"small"},{default:s(()=>[...e[21]||(e[21]=[o("初始化默认",-1)])]),_:1},8,["loading"]),l(d,{onClick:ge,loading:S.value,size:"small"},{default:s(()=>[...e[22]||(e[22]=[o("刷新缓存",-1)])]),_:1},8,["loading"])]),ne((w(),ie(Z,{data:O.value,stripe:"",style:{"margin-top":"15px"}},{default:s(()=>[l(f,{prop:"code",label:"状态码",width:"100"},{default:s(({row:a})=>[l(E,{type:W(a.code)},{default:s(()=>[o(M(a.code),1)]),_:2},1032,["type"])]),_:1}),l(f,{prop:"error_type",label:"错误类型",width:"200"}),l(f,{prop:"original_message",label:"原始信息","min-width":"150","show-overflow-tooltip":""},{default:s(({row:a})=>[u("span",Oe,M(a.original_message||"-"),1)]),_:1}),l(f,{prop:"custom_message",label:"自定义消息","min-width":"200","show-overflow-tooltip":""}),l(f,{prop:"description",label:"说明","min-width":"150","show-overflow-tooltip":""}),l(f,{prop:"enabled",label:"状态",width:"80"},{default:s(({row:a})=>[l(x,{modelValue:a.enabled,"onUpdate:modelValue":v=>a.enabled=v,onChange:v=>ce(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(f,{label:"操作",width:"150",fixed:"right"},{default:s(({row:a})=>[l(d,{type:"primary",link:"",onClick:v=>ue(a)},{default:s(()=>[...e[23]||(e[23]=[o("编辑",-1)])]),_:1},8,["onClick"]),l(Y,{title:"确定删除该配置?",onConfirm:v=>me(a.id)},{reference:s(()=>[l(d,{type:"danger",link:""},{default:s(()=>[...e[24]||(e[24]=[o("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[oe,T.value]])]),_:1}),l(ee,{label:"错误规则",name:"rules"},{default:s(()=>[u("div",Pe,[l(d,{type:"success",onClick:Me,loading:I.value,size:"small"},{default:s(()=>[...e[25]||(e[25]=[o("全部启用",-1)])]),_:1},8,["loading"]),l(d,{type:"warning",onClick:ze,loading:L.value,size:"small"},{default:s(()=>[...e[26]||(e[26]=[o("全部禁用",-1)])]),_:1},8,["loading"]),l(X,{direction:"vertical"}),l(d,{type:"primary",onClick:be,size:"small"},{default:s(()=>[...e[27]||(e[27]=[o("新增规则",-1)])]),_:1}),l(d,{onClick:Re,loading:j.value,size:"small"},{default:s(()=>[...e[28]||(e[28]=[o("重置为默认",-1)])]),_:1},8,["loading"]),l(d,{onClick:Ee,loading:N.value,size:"small"},{default:s(()=>[...e[29]||(e[29]=[o("刷新缓存",-1)])]),_:1},8,["loading"])]),u("div",je,[e[36]||(e[36]=u("div",{class:"guide-title"},"规则说明",-1)),u("div",Ne,[u("div",He,[l(E,{type:"danger",size:"small"},{default:s(()=>[...e[30]||(e[30]=[o("禁用账户",-1)])]),_:1}),e[31]||(e[31]=u("span",null,"账户被封号、认证失效时，自动禁用该账户",-1))]),u("div",Ie,[l(E,{type:"warning",size:"small"},{default:s(()=>[...e[32]||(e[32]=[o("临时限流",-1)])]),_:1}),e[33]||(e[33]=u("span",null,"遇到限流或临时错误，切换其他账户重试（1小时后恢复）",-1))]),u("div",Le,[l(E,{type:"info",size:"small"},{default:s(()=>[...e[34]||(e[34]=[o("过载",-1)])]),_:1}),e[35]||(e[35]=u("span",null,"服务过载，临时切换账户",-1))])])]),ne((w(),ie(Z,{data:G.value,stripe:""},{default:s(()=>[l(f,{prop:"target_status",label:"处理方式",width:"130"},{default:s(({row:a})=>[l(E,{type:he(a.target_status),effect:"dark"},{default:s(()=>[o(M(Ue(a.target_status)),1)]),_:2},1032,["type"])]),_:1}),l(f,{label:"匹配条件","min-width":"280"},{default:s(({row:a})=>[u("div",Ge,[a.http_status_code>0?(w(),h("span",Je,[l(E,{size:"small",type:W(a.http_status_code)},{default:s(()=>[o("HTTP "+M(a.http_status_code),1)]),_:2},1032,["type"])])):$("",!0),a.http_status_code>0&&a.keyword?(w(),h("span",Ke,"+")):$("",!0),a.keyword?(w(),h("span",Qe,[u("code",We,M(a.keyword),1)])):$("",!0),!a.http_status_code&&!a.keyword?(w(),h("span",Xe,"匹配所有错误")):$("",!0)])]),_:1}),l(f,{prop:"description",label:"说明","min-width":"180","show-overflow-tooltip":""}),l(f,{prop:"priority",label:"优先级",width:"80",sortable:""},{default:s(({row:a})=>[u("span",Ye,M(a.priority),1)]),_:1}),l(f,{prop:"enabled",label:"启用",width:"70"},{default:s(({row:a})=>[l(x,{modelValue:a.enabled,"onUpdate:modelValue":v=>a.enabled=v,onChange:v=>ke(a),size:"small"},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(f,{label:"操作",width:"120",fixed:"right"},{default:s(({row:a})=>[l(d,{type:"primary",link:"",size:"small",onClick:v=>Ve(a)},{default:s(()=>[...e[37]||(e[37]=[o("编辑",-1)])]),_:1},8,["onClick"]),l(Y,{title:"确定删除?",onConfirm:v=>Ce(a.id)},{reference:s(()=>[l(d,{type:"danger",link:"",size:"small"},{default:s(()=>[...e[38]||(e[38]=[o("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[oe,P.value]]),u("div",Ze,[l(xe,{"current-page":y.page,"onUpdate:currentPage":e[0]||(e[0]=a=>y.page=a),"page-size":y.pageSize,"onUpdate:pageSize":e[1]||(e[1]=a=>y.pageSize=a),total:y.total,"page-sizes":[20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:b,onCurrentChange:b},null,8,["current-page","page-size","total"])])]),_:1})]),_:1},8,["modelValue"]),l(ae,{modelValue:k.value,"onUpdate:modelValue":e[9]||(e[9]=a=>k.value=a),title:C.value?"编辑错误消息":"新增错误消息",width:"500px"},{footer:s(()=>[l(d,{onClick:e[8]||(e[8]=a=>k.value=!1)},{default:s(()=>[...e[39]||(e[39]=[o("取消",-1)])]),_:1}),l(d,{type:"primary",onClick:pe,loading:F.value},{default:s(()=>[...e[40]||(e[40]=[o("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[l(te,{ref_key:"messageFormRef",ref:K,model:n,rules:de,"label-width":"100px"},{default:s(()=>[l(_,{label:"状态码",prop:"code"},{default:s(()=>[l(le,{modelValue:n.code,"onUpdate:modelValue":e[3]||(e[3]=a=>n.code=a),disabled:C.value,style:{width:"100%"}},{default:s(()=>[l(g,{value:400,label:"400 - Bad Request"}),l(g,{value:401,label:"401 - Unauthorized"}),l(g,{value:403,label:"403 - Forbidden"}),l(g,{value:429,label:"429 - Too Many Requests"}),l(g,{value:500,label:"500 - Internal Server Error"}),l(g,{value:502,label:"502 - Bad Gateway"}),l(g,{value:503,label:"503 - Service Unavailable"})]),_:1},8,["modelValue","disabled"])]),_:1}),l(_,{label:"错误类型",prop:"error_type"},{default:s(()=>[l(z,{modelValue:n.error_type,"onUpdate:modelValue":e[4]||(e[4]=a=>n.error_type=a),disabled:C.value,placeholder:"如: auth_failed"},null,8,["modelValue","disabled"])]),_:1}),l(_,{label:"自定义消息",prop:"custom_message"},{default:s(()=>[l(z,{modelValue:n.custom_message,"onUpdate:modelValue":e[5]||(e[5]=a=>n.custom_message=a),type:"textarea",rows:3,placeholder:"返回给用户的错误消息"},null,8,["modelValue"])]),_:1}),l(_,{label:"说明",prop:"description"},{default:s(()=>[l(z,{modelValue:n.description,"onUpdate:modelValue":e[6]||(e[6]=a=>n.description=a),placeholder:"管理员备注（可选）"},null,8,["modelValue"])]),_:1}),l(_,{label:"启用"},{default:s(()=>[l(x,{modelValue:n.enabled,"onUpdate:modelValue":e[7]||(e[7]=a=>n.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(ae,{modelValue:R.value,"onUpdate:modelValue":e[17]||(e[17]=a=>R.value=a),title:U.value?"编辑规则":"新增规则",width:"550px"},{footer:s(()=>[l(d,{onClick:e[16]||(e[16]=a=>R.value=!1)},{default:s(()=>[...e[43]||(e[43]=[o("取消",-1)])]),_:1}),l(d,{type:"primary",onClick:we,loading:H.value},{default:s(()=>[...e[44]||(e[44]=[o("确定",-1)])]),_:1},8,["loading"])]),default:s(()=>[l(te,{ref_key:"ruleFormRef",ref:Q,model:i,rules:ye,"label-width":"110px"},{default:s(()=>[l(_,{label:"HTTP状态码",prop:"http_status_code"},{default:s(()=>[l(se,{modelValue:i.http_status_code,"onUpdate:modelValue":e[10]||(e[10]=a=>i.http_status_code=a),min:0,max:599,controls:!1,placeholder:"0",style:{width:"120px"}},null,8,["modelValue"]),e[41]||(e[41]=u("span",{class:"form-tip"},"0 表示匹配任意状态码",-1))]),_:1}),l(_,{label:"错误关键词",prop:"keyword"},{default:s(()=>[l(z,{modelValue:i.keyword,"onUpdate:modelValue":e[11]||(e[11]=a=>i.keyword=a),placeholder:"匹配错误消息中的关键词（不区分大小写，留空表示任意）"},null,8,["modelValue"])]),_:1}),l(_,{label:"目标状态",prop:"target_status"},{default:s(()=>[l(le,{modelValue:i.target_status,"onUpdate:modelValue":e[12]||(e[12]=a=>i.target_status=a),placeholder:"匹配后将账户标记为",style:{width:"100%"}},{default:s(()=>[l(g,{value:"valid",label:"valid - 不修改（仅记录错误）"}),l(g,{value:"invalid",label:"invalid - 无效（禁用账户）"}),l(g,{value:"rate_limited",label:"rate_limited - 限流（1小时后恢复）"}),l(g,{value:"overloaded",label:"overloaded - 过载（临时不可用）"})]),_:1},8,["modelValue"])]),_:1}),l(_,{label:"优先级",prop:"priority"},{default:s(()=>[l(se,{modelValue:i.priority,"onUpdate:modelValue":e[13]||(e[13]=a=>i.priority=a),min:0,max:1e3},null,8,["modelValue"]),e[42]||(e[42]=u("span",{class:"form-tip"},"数值越大优先级越高",-1))]),_:1}),l(_,{label:"描述",prop:"description"},{default:s(()=>[l(z,{modelValue:i.description,"onUpdate:modelValue":e[14]||(e[14]=a=>i.description=a),placeholder:"规则说明（可选）"},null,8,["modelValue"])]),_:1}),l(_,{label:"启用"},{default:s(()=>[l(x,{modelValue:i.enabled,"onUpdate:modelValue":e[15]||(e[15]=a=>i.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},al=Ae(el,[["__scopeId","data-v-19ab27d6"]]);export{al as default};

import{_ as de,r as p,c as re,a as O,o as ie,b as q,d as r,e as u,f as a,w as l,h as n,i as L,O as ce,n as i,z as _e,C as pe,x as d,M as $,k as v,l as h,F as j,t as G,v as H}from"./index-DH-ATN2M.js";const ve={class:"logs-page"},fe={class:"page-header"},me={class:"stat-item"},ge={class:"stat-value"},he={class:"stat-item"},be={class:"stat-value"},we={class:"stat-item cost"},ye={class:"stat-value"},ke={class:"stat-item"},xe={class:"stat-value"},De={key:2,class:"pagination-wrap"},Ve={__name:"RequestLogs",setup(ze){const A=p("daily"),c=p(null),I=p([]),m=p(null),b=p(""),J=[{text:"今天",value:()=>{const o=new Date;return[o,o]}},{text:"最近7天",value:()=>{const o=new Date,e=new Date;return e.setDate(e.getDate()-7),[e,o]}},{text:"最近30天",value:()=>{const o=new Date,e=new Date;return e.setDate(e.getDate()-30),[e,o]}},{text:"本月",value:()=>{const o=new Date;return[new Date(o.getFullYear(),o.getMonth(),1),o]}}],Q=re(()=>w.value.map(o=>o.model).filter(Boolean)),g=O({total_requests:0,total_tokens:0,total_cost:0}),M=p([]),x=p(!1),w=p([]),D=p(!1),y=p([]),V=p(!1),_=O({page:1,pageSize:20,total:0});function f(o){return o?o>=1e6?(o/1e6).toFixed(1)+"M":o>=1e3?(o/1e3).toFixed(1)+"K":o:"0"}function W(o){return o?new Date(o).toLocaleString("zh-CN"):""}async function X(){var o;try{const e=await L.getUsers({page:1,page_size:1e3});I.value=((o=e.data)==null?void 0:o.items)||[]}catch(e){console.error("Failed to fetch users:",e)}}async function P(){x.value=!0,D.value=!0;try{const e=(await L.getAllUsageSummary({})).data||{};g.total_requests=e.total_requests||0,g.total_tokens=e.total_tokens||0,g.total_cost=e.total_cost||0,M.value=e.daily||[],w.value=e.models||[]}catch(o){console.error("Failed to fetch summary:",o)}finally{x.value=!1,D.value=!1}}function Z(){_.page=1,y.value=[]}async function z(){if(c.value){V.value=!0;try{const o={page:_.page,page_size:_.pageSize};m.value&&m.value.length===2&&(o.start_date=m.value[0],o.end_date=m.value[1]),b.value&&(o.model=b.value);const F=(await L.getUserUsageRecords(c.value,o)).data||{};y.value=F.items||[],_.total=F.total||y.value.length}catch(o){console.error("Failed to fetch records:",o)}finally{V.value=!1}}}function ee(){m.value=null,b.value="",_.page=1,c.value&&z()}function te(){P(),c.value&&z()}return ie(()=>{X(),P()}),(o,e)=>{const F=n("el-icon"),T=n("el-button"),U=n("el-card"),C=n("el-col"),ae=n("el-row"),s=n("el-table-column"),R=n("el-table"),B=n("el-empty"),N=n("el-tab-pane"),E=n("el-option"),K=n("el-select"),S=n("el-form-item"),le=n("el-date-picker"),oe=n("el-form"),se=n("el-alert"),ne=n("el-pagination"),ue=n("el-tabs"),Y=ce("loading");return r(),q("div",ve,[u("div",fe,[e[7]||(e[7]=u("h2",null,"请求日志",-1)),a(T,{onClick:te},{default:l(()=>[a(F,null,{default:l(()=>[a(_e(pe))]),_:1}),e[6]||(e[6]=i(" 刷新 ",-1))]),_:1})]),a(ae,{gutter:20,class:"summary-cards"},{default:l(()=>[a(C,{span:6},{default:l(()=>[a(U,{shadow:"hover"},{default:l(()=>[u("div",me,[u("div",ge,d(g.total_requests||0),1),e[8]||(e[8]=u("div",{class:"stat-label"},"总请求数",-1))])]),_:1})]),_:1}),a(C,{span:6},{default:l(()=>[a(U,{shadow:"hover"},{default:l(()=>[u("div",he,[u("div",be,d(f(g.total_tokens)),1),e[9]||(e[9]=u("div",{class:"stat-label"},"总Token",-1))])]),_:1})]),_:1}),a(C,{span:6},{default:l(()=>[a(U,{shadow:"hover"},{default:l(()=>[u("div",we,[u("div",ye,"$"+d((g.total_cost||0).toFixed(4)),1),e[10]||(e[10]=u("div",{class:"stat-label"},"总费用",-1))])]),_:1})]),_:1}),a(C,{span:6},{default:l(()=>[a(U,{shadow:"hover"},{default:l(()=>[u("div",ke,[u("div",xe,d(w.value.length),1),e[11]||(e[11]=u("div",{class:"stat-label"},"模型数",-1))])]),_:1})]),_:1})]),_:1}),a(ue,{modelValue:A.value,"onUpdate:modelValue":e[5]||(e[5]=t=>A.value=t)},{default:l(()=>[a(N,{label:"每日汇总",name:"daily"},{default:l(()=>[$((r(),v(R,{data:M.value,stripe:""},{default:l(()=>[a(s,{prop:"date",label:"日期",width:"120"}),a(s,{prop:"request_count",label:"请求数",width:"100"}),a(s,{prop:"total_tokens",label:"Token",width:"120"},{default:l(({row:t})=>[i(d(f(t.total_tokens)),1)]),_:1}),a(s,{label:"费用",width:"120"},{default:l(({row:t})=>{var k;return[i(" $"+d(((k=t.total_cost)==null?void 0:k.toFixed(4))||"0"),1)]}),_:1})]),_:1},8,["data"])),[[Y,x.value]]),M.value.length===0&&!x.value?(r(),v(B,{key:0,description:"暂无数据"})):h("",!0)]),_:1}),a(N,{label:"模型统计",name:"models"},{default:l(()=>[$((r(),v(R,{data:w.value,stripe:""},{default:l(()=>[a(s,{prop:"model",label:"模型","min-width":"200"}),a(s,{prop:"request_count",label:"请求数",width:"100"}),a(s,{prop:"total_tokens",label:"Token",width:"120"},{default:l(({row:t})=>[i(d(f(t.total_tokens)),1)]),_:1}),a(s,{label:"费用",width:"120"},{default:l(({row:t})=>{var k;return[i(" $"+d(((k=t.total_cost)==null?void 0:k.toFixed(4))||"0"),1)]}),_:1})]),_:1},8,["data"])),[[Y,D.value]]),w.value.length===0&&!D.value?(r(),v(B,{key:0,description:"暂无数据"})):h("",!0)]),_:1}),a(N,{label:"用户详细记录",name:"records"},{default:l(()=>[a(oe,{inline:!0,style:{"margin-bottom":"16px"}},{default:l(()=>[a(S,{label:"选择用户"},{default:l(()=>[a(K,{modelValue:c.value,"onUpdate:modelValue":e[0]||(e[0]=t=>c.value=t),clearable:"",placeholder:"选择用户",onChange:Z,filterable:"",style:{width:"160px"}},{default:l(()=>[(r(!0),q(j,null,G(I.value,t=>(r(),v(E,{key:t.id,label:t.username,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(S,{label:"时间范围"},{default:l(()=>[a(le,{modelValue:m.value,"onUpdate:modelValue":e[1]||(e[1]=t=>m.value=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"240px"},shortcuts:J},null,8,["modelValue"])]),_:1}),a(S,{label:"模型"},{default:l(()=>[a(K,{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=t=>b.value=t),clearable:"",placeholder:"全部模型",filterable:"",style:{width:"200px"}},{default:l(()=>[(r(!0),q(j,null,G(Q.value,t=>(r(),v(E,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(S,null,{default:l(()=>[a(T,{type:"primary",onClick:z,disabled:!c.value},{default:l(()=>[...e[12]||(e[12]=[i("查询",-1)])]),_:1},8,["disabled"]),a(T,{onClick:ee},{default:l(()=>[...e[13]||(e[13]=[i("重置",-1)])]),_:1})]),_:1})]),_:1}),c.value?h("",!0):(r(),v(se,{key:0,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:l(()=>[...e[14]||(e[14]=[i(" 请选择用户查看详细记录 ",-1)])]),_:1})),c.value?$((r(),v(R,{key:1,data:y.value,stripe:""},{default:l(()=>[a(s,{prop:"model",label:"模型","min-width":"180","show-overflow-tooltip":""}),a(s,{prop:"request_ip",label:"请求IP",width:"120","show-overflow-tooltip":""}),a(s,{label:"输入",width:"80"},{default:l(({row:t})=>[i(d(f(t.input_tokens)),1)]),_:1}),a(s,{label:"输出",width:"80"},{default:l(({row:t})=>[i(d(f(t.output_tokens)),1)]),_:1}),a(s,{label:"缓存创建",width:"90"},{default:l(({row:t})=>[u("span",{class:H({"cache-highlight":t.cache_creation_input_tokens>0})},d(f(t.cache_creation_input_tokens)),3)]),_:1}),a(s,{label:"缓存读取",width:"90"},{default:l(({row:t})=>[u("span",{class:H({"cache-read-highlight":t.cache_read_input_tokens>0})},d(f(t.cache_read_input_tokens)),3)]),_:1}),a(s,{label:"总Token",width:"90"},{default:l(({row:t})=>[i(d(f(t.total_tokens)),1)]),_:1}),a(s,{label:"费用",width:"90"},{default:l(({row:t})=>[i(" $"+d((t.total_cost||0).toFixed(4)),1)]),_:1}),a(s,{label:"时间",width:"160"},{default:l(({row:t})=>[i(d(W(t.timestamp||t.request_time)),1)]),_:1})]),_:1},8,["data"])),[[Y,V.value]]):h("",!0),c.value&&_.total>0?(r(),q("div",De,[a(ne,{"current-page":_.page,"onUpdate:currentPage":e[3]||(e[3]=t=>_.page=t),"page-size":_.pageSize,"onUpdate:pageSize":e[4]||(e[4]=t=>_.pageSize=t),total:_.total,"page-sizes":[20,50,100],layout:"total, sizes, prev, pager, next",onChange:z},null,8,["current-page","page-size","total"])])):h("",!0),c.value&&y.value.length===0&&!V.value?(r(),v(B,{key:3,description:"暂无记录"})):h("",!0)]),_:1})]),_:1},8,["modelValue"])])}}},Ue=de(Ve,[["__scopeId","data-v-50b6c72a"]]);export{Ue as default};

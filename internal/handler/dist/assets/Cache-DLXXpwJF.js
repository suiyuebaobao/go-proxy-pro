import{_ as $e,r as y,a as Ne,c as H,o as Pe,p as Fe,b as T,d as h,e as d,f as a,w as n,h as _,i as g,O as Me,n as c,z as J,C as re,M as Q,k as x,l as X,x as i,R as Ee,v as ue,E as b}from"./index-RaNI7jtP.js";const Be={class:"cache-page"},De={class:"page-header"},Ke={class:"card-header"},Ie={class:"header-actions"},Re={class:"session-id"},je={key:0},Oe={key:1,class:"no-data"},We={class:"api-key-prefix"},qe={key:1,class:"no-data"},Ge={key:0,class:"pagination-wrap"},He={class:"card-header"},Je={class:"card-header"},Qe={class:"card-header"},Xe={__name:"Cache",setup(Ye){const z=y(!1),p=Ne({session_ttl:60,session_renewal_ttl:14,unavailable_ttl:5,concurrency_ttl:5}),U=y("sessions"),L=y(!1),w=y([]),V=y(0),I=y(1),S=y(20),$=y(""),A=y({}),R=y({}),N=y({}),Y=y({}),P=y(!1),F=y([]),Z=H(()=>{const t=new Map;return w.value.forEach(e=>{t.has(e.account_id)||t.set(e.account_id,{account_id:e.account_id,concurrency:0,max_concurrency:5}),t.get(e.account_id).concurrency++}),Array.from(t.values())}),ee=H(()=>{const t=new Map;return w.value.forEach(e=>{e.user_id&&!t.has(e.user_id)&&t.set(e.user_id,{user_id:e.user_id,concurrency:0,max_concurrency:10}),e.user_id&&t.get(e.user_id).concurrency++}),Array.from(t.values())}),ce=H(()=>{if(!$.value)return w.value;const t=$.value.toLowerCase();return w.value.filter(e=>{var f;return((f=e.session_id)==null?void 0:f.toLowerCase().includes(t))||E(e.account_id).toLowerCase().includes(t)||j(e.user_id).toLowerCase().includes(t)||le(e.api_key_id).toLowerCase().includes(t)})});let M=null;function te(t){return t?new Date(t).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-"}function ae(t,e){return t>=e?"danger":t>=e*.8?"warning":"success"}function de(t){if(!t)return"-";if(t.startsWith("apikey:")){const e=t.split(":");return e.length>=3?e.slice(2).join(":"):`Key#${e[1]}`}return t}function ne(t){return!t||t<=0?"已过期":t<60?`${t}秒`:t<3600?`${Math.floor(t/60)}分${t%60}秒`:`${Math.floor(t/3600)}时${Math.floor(t%3600/60)}分`}function fe(t){return!t||t<=0?"danger":t<300?"warning":"success"}function E(t){return t?A.value[t]||`#${t}`:"-"}function j(t){return t?R.value[t]||`#${t}`:"-"}function le(t){return t?N.value[t]||"sk-...":"-"}function _e(t){return t&&(Y.value[t]||N.value[t])||""}function me(){}async function oe(){z.value=!0;try{const e=(await g.getCacheConfig()).data||{};p.session_ttl=e.session_ttl||60,p.session_renewal_ttl=e.session_renewal_ttl||14,p.unavailable_ttl=e.unavailable_ttl||5,p.concurrency_ttl=e.concurrency_ttl||5}catch(t){console.error("Failed to fetch config:",t)}finally{z.value=!1}}async function pe(){z.value=!0;try{await g.updateCacheConfig(p),b.success("配置已保存")}catch(t){console.error("Failed to save config:",t)}finally{z.value=!1}}async function C(){var t,e;L.value=!0;try{const f=(I.value-1)*S.value,s=await g.getCacheSessions({offset:f,limit:S.value});w.value=((t=s.data)==null?void 0:t.sessions)||[],V.value=((e=s.data)==null?void 0:e.total)||0;const m=[...new Set(w.value.map(o=>o.account_id).filter(Boolean))],r=[...new Set(w.value.map(o=>o.user_id).filter(Boolean))],v=[...new Set(w.value.map(o=>o.api_key_id).filter(Boolean))];await ve(m),await ye(r),await ge(v)}catch(f){console.error("Failed to load sessions:",f)}finally{L.value=!1}}async function ve(t){var e,f,s;if(t.length)try{const m=t.filter(o=>o&&!A.value[o]);if(!m.length)return;const r=await g.getAccounts({page:1,page_size:1e3});(((e=r.data)==null?void 0:e.items)||((f=r.data)==null?void 0:f.list)||[]).forEach(o=>{o!=null&&o.id&&(A.value[o.id]=o.name||`账号${o.id}`)});for(const o of m)if(!A.value[o])try{const k=await g.getAccount(o);(s=k.data)!=null&&s.id&&(A.value[k.data.id]=k.data.name||`账号${k.data.id}`)}catch{}}catch(m){console.error("Failed to load account names:",m)}}async function ye(t){var e,f;if(t.length)try{if(!t.filter(v=>v&&!R.value[v]).length)return;const m=await g.getAllUsers();(((e=m.data)==null?void 0:e.items)||((f=m.data)==null?void 0:f.list)||[]).forEach(v=>{v!=null&&v.id&&(R.value[v.id]=v.username||`用户${v.id}`)})}catch(s){console.error("Failed to load user names:",s)}}async function ge(t){var f;if(!t.length)return;const e=t.filter(s=>s&&!N.value[s]);if(e.length)try{(((f=(await g.adminLookupAPIKeys(e)).data)==null?void 0:f.items)||[]).forEach(r=>{r!=null&&r.id&&(r.key_prefix&&(N.value[r.id]=r.key_prefix),r.key_full&&(Y.value[r.id]=r.key_full))})}catch(s){console.error("Failed to load API key labels:",s)}}async function he(t){try{await g.removeCacheSession(t),b.success("会话已移除"),C()}catch{b.error("移除失败")}}async function be(){try{await g.clearCache("sessions"),b.success("所有会话已清除"),w.value=[],V.value=0}catch{b.error("清除失败")}}async function B(){var t;P.value=!0;try{const e=await g.getUnavailableAccounts();F.value=((t=e.data)==null?void 0:t.accounts)||[]}catch(e){console.error("Failed to load unavailable accounts:",e)}finally{P.value=!1}}async function we(t){try{await g.clearAccountUnavailable(t),b.success("已恢复账号"),B()}catch{b.error("操作失败")}}async function Ce(t){try{await g.resetAccountConcurrency(t),b.success("已重置"),C()}catch{b.error("重置失败")}}async function ke(t){try{await g.resetUserConcurrency(t),b.success("已重置"),C()}catch{b.error("重置失败")}}function xe(t){t==="sessions"?C():t==="unavailable"?B():t==="concurrency"&&C()}function ze(){oe(),C(),U.value==="unavailable"&&B()}function Ve(){M=setInterval(()=>{U.value==="sessions"&&C()},3e4)}function Ae(){M&&(clearInterval(M),M=null)}return Pe(()=>{oe(),C(),Ve()}),Fe(()=>{Ae()}),(t,e)=>{const f=_("el-icon"),s=_("el-button"),m=_("el-input-number"),r=_("el-form-item"),v=_("el-form"),o=_("el-card"),k=_("el-input"),O=_("el-popconfirm"),u=_("el-table-column"),D=_("el-tag"),Te=_("el-tooltip"),K=_("el-table"),Ue=_("el-pagination"),se=_("el-empty"),W=_("el-tab-pane"),ie=_("el-col"),Le=_("el-row"),Se=_("el-tabs"),q=Me("loading");return h(),T("div",Be,[d("div",De,[e[9]||(e[9]=d("h2",null,"缓存管理",-1)),a(s,{onClick:ze},{default:n(()=>[a(f,null,{default:n(()=>[a(J(re))]),_:1}),e[8]||(e[8]=c(" 刷新 ",-1))]),_:1})]),a(o,{class:"config-card"},{header:n(()=>[...e[10]||(e[10]=[d("span",null,"缓存配置",-1)])]),default:n(()=>[Q((h(),x(v,{inline:!0,model:p},{default:n(()=>[a(r,{label:"粘性会话TTL"},{default:n(()=>[a(m,{modelValue:p.session_ttl,"onUpdate:modelValue":e[0]||(e[0]=l=>p.session_ttl=l),min:1,max:1440},null,8,["modelValue"]),e[11]||(e[11]=d("span",{class:"unit"},"分钟",-1))]),_:1}),a(r,{label:"会话续期阈值"},{default:n(()=>[a(m,{modelValue:p.session_renewal_ttl,"onUpdate:modelValue":e[1]||(e[1]=l=>p.session_renewal_ttl=l),min:1,max:60},null,8,["modelValue"]),e[12]||(e[12]=d("span",{class:"unit"},"分钟",-1))]),_:1}),a(r,{label:"不可用标记TTL"},{default:n(()=>[a(m,{modelValue:p.unavailable_ttl,"onUpdate:modelValue":e[2]||(e[2]=l=>p.unavailable_ttl=l),min:1,max:60},null,8,["modelValue"]),e[13]||(e[13]=d("span",{class:"unit"},"分钟",-1))]),_:1}),a(r,{label:"并发计数TTL"},{default:n(()=>[a(m,{modelValue:p.concurrency_ttl,"onUpdate:modelValue":e[3]||(e[3]=l=>p.concurrency_ttl=l),min:1,max:60},null,8,["modelValue"]),e[14]||(e[14]=d("span",{class:"unit"},"分钟",-1))]),_:1}),a(r,null,{default:n(()=>[a(s,{type:"primary",onClick:pe},{default:n(()=>[...e[15]||(e[15]=[c("保存配置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])),[[q,z.value]])]),_:1}),a(Se,{modelValue:U.value,"onUpdate:modelValue":e[7]||(e[7]=l=>U.value=l),onTabChange:xe},{default:n(()=>[a(W,{label:"会话列表",name:"sessions"},{default:n(()=>[a(o,null,{header:n(()=>[d("div",Ke,[d("span",null,"活跃会话 ("+i(V.value)+")",1),d("div",Ie,[a(k,{modelValue:$.value,"onUpdate:modelValue":e[4]||(e[4]=l=>$.value=l),placeholder:"搜索会话/账号/用户",clearable:"",style:{width:"200px"},onInput:me},{prefix:n(()=>[a(f,null,{default:n(()=>[a(J(Ee))]),_:1})]),_:1},8,["modelValue"]),a(O,{title:"清除所有会话缓存?",onConfirm:be},{reference:n(()=>[a(s,{type:"danger",size:"small"},{default:n(()=>[...e[16]||(e[16]=[c("清除全部",-1)])]),_:1})]),_:1})])])]),default:n(()=>[Q((h(),x(K,{data:ce.value,size:"small",stripe:""},{default:n(()=>[a(u,{label:"会话ID","min-width":"200","show-overflow-tooltip":""},{default:n(({row:l})=>[d("span",Re,i(de(l.session_id)),1)]),_:1}),a(u,{label:"账号",width:"150"},{default:n(({row:l})=>[a(D,{size:"small",type:"warning"},{default:n(()=>[c(i(E(l.account_id)),1)]),_:2},1024)]),_:1}),a(u,{label:"用户",width:"120"},{default:n(({row:l})=>[l.user_id?(h(),T("span",je,i(j(l.user_id)),1)):(h(),T("span",Oe,"-"))]),_:1}),a(u,{label:"API Key",width:"100"},{default:n(({row:l})=>[l.api_key_id?(h(),x(Te,{key:0,content:_e(l.api_key_id),placement:"top","show-after":200},{default:n(()=>[d("code",We,i(le(l.api_key_id)),1)]),_:2},1032,["content"])):(h(),T("span",qe,"-"))]),_:1}),a(u,{label:"平台",width:"100"},{default:n(({row:l})=>[a(D,{size:"small",type:"info"},{default:n(()=>[c(i(l.platform||"-"),1)]),_:2},1024)]),_:1}),a(u,{label:"模型",width:"150","show-overflow-tooltip":""},{default:n(({row:l})=>[c(i(l.model||"-"),1)]),_:1}),a(u,{label:"绑定时间",width:"140"},{default:n(({row:l})=>[c(i(te(l.bound_at)),1)]),_:1}),a(u,{label:"最后使用",width:"140"},{default:n(({row:l})=>[c(i(te(l.last_used_at)),1)]),_:1}),a(u,{label:"剩余时间",width:"100",align:"center"},{default:n(({row:l})=>[a(D,{type:fe(l.remaining_ttl),size:"small"},{default:n(()=>[c(i(ne(l.remaining_ttl)),1)]),_:2},1032,["type"])]),_:1}),a(u,{label:"客户端IP",width:"130","show-overflow-tooltip":""},{default:n(({row:l})=>[c(i(l.client_ip||"-"),1)]),_:1}),a(u,{label:"操作",width:"80",align:"center",fixed:"right"},{default:n(({row:l})=>[a(O,{title:"移除此会话?",onConfirm:G=>he(l.session_id)},{reference:n(()=>[a(s,{link:"",type:"danger",size:"small"},{default:n(()=>[...e[17]||(e[17]=[c("移除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[q,L.value]]),V.value>0?(h(),T("div",Ge,[a(Ue,{"current-page":I.value,"onUpdate:currentPage":e[5]||(e[5]=l=>I.value=l),"page-size":S.value,"onUpdate:pageSize":e[6]||(e[6]=l=>S.value=l),total:V.value,"page-sizes":[20,50,100],layout:"total, sizes, prev, pager, next",onChange:C},null,8,["current-page","page-size","total"])])):X("",!0),!L.value&&w.value.length===0?(h(),x(se,{key:1,description:"暂无活跃会话"})):X("",!0)]),_:1})]),_:1}),a(W,{label:"不可用账号",name:"unavailable"},{default:n(()=>[a(o,null,{header:n(()=>[d("div",He,[d("span",null,"临时不可用账号 ("+i(F.value.length)+")",1),a(s,{type:"primary",size:"small",onClick:B},{default:n(()=>[a(f,null,{default:n(()=>[a(J(re))]),_:1}),e[18]||(e[18]=c(" 刷新 ",-1))]),_:1})])]),default:n(()=>[Q((h(),x(K,{data:F.value,size:"small"},{default:n(()=>[a(u,{label:"账号","min-width":"150"},{default:n(({row:l})=>[c(i(E(l.account_id)),1)]),_:1}),a(u,{prop:"reason",label:"原因","min-width":"200","show-overflow-tooltip":""}),a(u,{label:"剩余时间",width:"120",align:"center"},{default:n(({row:l})=>[a(D,{type:"danger",size:"small"},{default:n(()=>[c(i(ne(l.remaining_ttl)),1)]),_:2},1024)]),_:1}),a(u,{label:"操作",width:"100",align:"center"},{default:n(({row:l})=>[a(O,{title:"清除不可用标记?",onConfirm:G=>we(l.account_id)},{reference:n(()=>[a(s,{link:"",type:"primary",size:"small"},{default:n(()=>[...e[19]||(e[19]=[c("恢复",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[q,P.value]]),!P.value&&F.value.length===0?(h(),x(se,{key:0,description:"暂无不可用账号"})):X("",!0)]),_:1})]),_:1}),a(W,{label:"并发统计",name:"concurrency"},{default:n(()=>[a(Le,{gutter:20},{default:n(()=>[a(ie,{span:12},{default:n(()=>[a(o,null,{header:n(()=>[d("div",Je,[d("span",null,"账号并发 ("+i(Z.value.length)+")",1)])]),default:n(()=>[a(K,{data:Z.value,size:"small","max-height":"400"},{default:n(()=>[a(u,{label:"账号","min-width":"120"},{default:n(({row:l})=>[c(i(E(l.account_id)),1)]),_:1}),a(u,{label:"并发",width:"120",align:"center"},{default:n(({row:l})=>[d("span",{class:ue(ae(l.concurrency,l.max_concurrency))},i(l.concurrency),3),c(" / "+i(l.max_concurrency),1)]),_:1}),a(u,{label:"操作",width:"80",align:"center"},{default:n(({row:l})=>[a(s,{link:"",type:"danger",size:"small",onClick:G=>Ce(l.account_id)},{default:n(()=>[...e[20]||(e[20]=[c(" 重置 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1}),a(ie,{span:12},{default:n(()=>[a(o,null,{header:n(()=>[d("div",Qe,[d("span",null,"用户并发 ("+i(ee.value.length)+")",1)])]),default:n(()=>[a(K,{data:ee.value,size:"small","max-height":"400"},{default:n(()=>[a(u,{label:"用户","min-width":"120"},{default:n(({row:l})=>[c(i(j(l.user_id)),1)]),_:1}),a(u,{label:"并发",width:"120",align:"center"},{default:n(({row:l})=>[d("span",{class:ue(ae(l.concurrency,l.max_concurrency))},i(l.concurrency),3),c(" / "+i(l.max_concurrency),1)]),_:1}),a(u,{label:"操作",width:"80",align:"center"},{default:n(({row:l})=>[a(s,{link:"",type:"danger",size:"small",onClick:G=>ke(l.user_id)},{default:n(()=>[...e[21]||(e[21]=[c(" 重置 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},et=$e(Xe,[["__scopeId","data-v-70c3e5a1"]]);export{et as default};

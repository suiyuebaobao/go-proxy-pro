import{_ as le,r as x,a as te,c as g,N as ae,o as oe,b as q,d as V,e as o,f as l,w as a,h as _,i as A,O as ne,L as O,k as c,n as s,t as p,l as de,E as J}from"./index-C4cVtHYC.js";const ie={class:"settings-page"},re={class:"card-header"},se={class:"header-actions"},ue={key:1},_e={class:"error-text"},me={style:{"margin-top":"20px","text-align":"center"}},pe={class:"action-bar"},fe={__name:"Settings",setup(be){const k=x(!1),N=x(!1),D=x(!1),H=x(!1),m=x(null),t=te({record_retention_days:30,record_max_count:1e3,global_price_rate:1,captcha_enabled:"true",captcha_rate_limit:10,login_rate_limit_enable:"true",login_rate_limit_count:3,login_rate_limit_window:5,account_health_check_enabled:"false",account_health_check_interval:5,account_error_threshold:5,oauth_auto_reauthorize_enabled:"true",oauth_reauthorize_cooldown:30,health_check_auto_recovery:"true",health_check_auto_token_refresh:"true",rate_limited_probe_enabled:"true",rate_limited_probe_init_interval:10,rate_limited_probe_max_interval:30,rate_limited_probe_backoff:1.5,suspended_probe_interval:5,suspended_confirm_threshold:3,banned_probe_enabled:"false",banned_probe_interval:1,token_refresh_cooldown:30,token_refresh_max_retries:3}),L=x([]),G=g({get:()=>t.captcha_enabled==="true",set:d=>{t.captcha_enabled=d?"true":"false"}}),C=g({get:()=>t.login_rate_limit_enable==="true",set:d=>{t.login_rate_limit_enable=d?"true":"false"}}),r=g({get:()=>t.account_health_check_enabled==="true",set:d=>{t.account_health_check_enabled=d?"true":"false"}}),R=g({get:()=>t.oauth_auto_reauthorize_enabled==="true",set:d=>{t.oauth_auto_reauthorize_enabled=d?"true":"false"}}),K=g({get:()=>t.health_check_auto_recovery==="true",set:d=>{t.health_check_auto_recovery=d?"true":"false"}}),j=g({get:()=>t.health_check_auto_token_refresh==="true",set:d=>{t.health_check_auto_token_refresh=d?"true":"false"}}),w=g({get:()=>t.rate_limited_probe_enabled==="true",set:d=>{t.rate_limited_probe_enabled=d?"true":"false"}}),B=g({get:()=>t.banned_probe_enabled==="true",set:d=>{t.banned_probe_enabled=d?"true":"false"}});function Q(d){return d?new Date(d).toLocaleString("zh-CN"):""}async function I(){k.value=!0;try{const d=await A.getSystemConfigs();L.value=d.items||[];for(const e of L.value)e.key in t&&(e.type==="int"?t[e.key]=parseInt(e.value)||0:e.type==="float"?t[e.key]=parseFloat(e.value)||0:t[e.key]=e.value)}catch{}finally{k.value=!1}}async function W(){N.value=!0;try{const d={record_retention_days:String(t.record_retention_days),record_max_count:String(t.record_max_count),global_price_rate:String(t.global_price_rate),captcha_enabled:t.captcha_enabled,captcha_rate_limit:String(t.captcha_rate_limit),login_rate_limit_enable:t.login_rate_limit_enable,login_rate_limit_count:String(t.login_rate_limit_count),login_rate_limit_window:String(t.login_rate_limit_window),account_health_check_enabled:t.account_health_check_enabled,account_health_check_interval:String(t.account_health_check_interval),account_error_threshold:String(t.account_error_threshold),oauth_auto_reauthorize_enabled:t.oauth_auto_reauthorize_enabled,oauth_reauthorize_cooldown:String(t.oauth_reauthorize_cooldown),health_check_auto_recovery:t.health_check_auto_recovery,health_check_auto_token_refresh:t.health_check_auto_token_refresh,rate_limited_probe_enabled:t.rate_limited_probe_enabled,rate_limited_probe_init_interval:String(t.rate_limited_probe_init_interval),rate_limited_probe_max_interval:String(t.rate_limited_probe_max_interval),rate_limited_probe_backoff:String(t.rate_limited_probe_backoff),suspended_probe_interval:String(t.suspended_probe_interval),suspended_confirm_threshold:String(t.suspended_confirm_threshold),banned_probe_enabled:t.banned_probe_enabled,banned_probe_interval:String(t.banned_probe_interval),token_refresh_cooldown:String(t.token_refresh_cooldown),token_refresh_max_retries:String(t.token_refresh_max_retries)};await A.updateSystemConfigs(d),J.success("配置保存成功"),await I()}catch{}finally{N.value=!1}}async function X(){D.value=!0,await P()}async function P(){try{const d=await A.getHealthCheckStatus();m.value=d}catch{}}let y=null;async function Y(){H.value=!0;try{await A.triggerHealthCheck(),J.success("健康检测已触发"),y&&clearTimeout(y),y=setTimeout(P,2e3)}catch{}finally{H.value=!1}}return ae(()=>{y&&(clearTimeout(y),y=null)}),oe(()=>{I()}),(d,e)=>{const f=_("el-switch"),i=_("el-form-item"),u=_("el-input-number"),b=_("el-divider"),z=_("el-form"),h=_("el-card"),S=_("el-col"),M=_("el-row"),T=_("el-tag"),U=_("el-button"),F=_("el-table-column"),Z=_("el-table"),v=_("el-descriptions-item"),$=_("el-descriptions"),ee=_("el-dialog"),E=ne("loading");return V(),q("div",ie,[e[82]||(e[82]=o("div",{class:"page-header"},[o("h2",null,"系统设置")],-1)),l(M,{gutter:20},{default:a(()=>[l(S,{span:12},{default:a(()=>[l(h,{class:"config-card"},{header:a(()=>[...e[26]||(e[26]=[o("div",{class:"card-header"},[o("span",null,"安全配置")],-1)])]),default:a(()=>[O((V(),c(z,{"label-width":"160px"},{default:a(()=>[l(i,{label:"启用登录验证码"},{default:a(()=>[l(f,{modelValue:G.value,"onUpdate:modelValue":e[0]||(e[0]=n=>G.value=n)},null,8,["modelValue"]),e[27]||(e[27]=o("div",{class:"form-tip"},"开启后登录和注册需要输入图片验证码",-1))]),_:1}),l(i,{label:"验证码频率限制"},{default:a(()=>[l(u,{modelValue:t.captcha_rate_limit,"onUpdate:modelValue":e[1]||(e[1]=n=>t.captcha_rate_limit=n),min:1,max:100},null,8,["modelValue"]),e[28]||(e[28]=o("span",{class:"unit"},"次/分钟",-1)),e[29]||(e[29]=o("div",{class:"form-tip"},"每个 IP 每分钟最多获取验证码的次数",-1))]),_:1}),l(b),l(i,{label:"启用登录频率限制"},{default:a(()=>[l(f,{modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=n=>C.value=n)},null,8,["modelValue"]),e[30]||(e[30]=o("div",{class:"form-tip"},"防止暴力破解，限制登录尝试次数",-1))]),_:1}),l(i,{label:"登录限制次数"},{default:a(()=>[l(u,{modelValue:t.login_rate_limit_count,"onUpdate:modelValue":e[3]||(e[3]=n=>t.login_rate_limit_count=n),min:1,max:100,disabled:!C.value},null,8,["modelValue","disabled"]),e[31]||(e[31]=o("span",{class:"unit"},"次",-1)),e[32]||(e[32]=o("div",{class:"form-tip"},"时间窗口内允许的最大登录尝试次数",-1))]),_:1}),l(i,{label:"登录限制窗口"},{default:a(()=>[l(u,{modelValue:t.login_rate_limit_window,"onUpdate:modelValue":e[4]||(e[4]=n=>t.login_rate_limit_window=n),min:1,max:60,disabled:!C.value},null,8,["modelValue","disabled"]),e[33]||(e[33]=o("span",{class:"unit"},"分钟",-1)),e[34]||(e[34]=o("div",{class:"form-tip"},"频率限制的时间窗口",-1))]),_:1})]),_:1})),[[E,k.value]])]),_:1})]),_:1}),l(S,{span:12},{default:a(()=>[l(h,{class:"config-card"},{header:a(()=>[...e[35]||(e[35]=[o("div",{class:"card-header"},[o("span",null,"记录配置")],-1)])]),default:a(()=>[O((V(),c(z,{"label-width":"140px"},{default:a(()=>[l(i,{label:"记录保留天数"},{default:a(()=>[l(u,{modelValue:t.record_retention_days,"onUpdate:modelValue":e[5]||(e[5]=n=>t.record_retention_days=n),min:1,max:365},null,8,["modelValue"]),e[36]||(e[36]=o("span",{class:"unit"},"天",-1)),e[37]||(e[37]=o("div",{class:"form-tip"},"使用记录的保留时间",-1))]),_:1}),l(i,{label:"最大记录数"},{default:a(()=>[l(u,{modelValue:t.record_max_count,"onUpdate:modelValue":e[6]||(e[6]=n=>t.record_max_count=n),min:100,max:1e4,step:100},null,8,["modelValue"]),e[38]||(e[38]=o("span",{class:"unit"},"条/用户",-1)),e[39]||(e[39]=o("div",{class:"form-tip"},"每个用户保留的最大记录数",-1))]),_:1}),l(b),l(i,{label:"全局价格倍率"},{default:a(()=>[l(u,{modelValue:t.global_price_rate,"onUpdate:modelValue":e[7]||(e[7]=n=>t.global_price_rate=n),min:0,max:10,step:.1,precision:2},null,8,["modelValue"]),e[40]||(e[40]=o("div",{class:"form-tip"},[s(" 全局价格倍率（1=原价，0=免费，2=2倍）"),o("br"),s(" 优先级：全局倍率 → 用户倍率（全局为1时使用用户倍率） ")],-1))]),_:1})]),_:1})),[[E,k.value]])]),_:1})]),_:1})]),_:1}),l(M,{gutter:20,style:{"margin-top":"20px"}},{default:a(()=>[l(S,{span:12},{default:a(()=>[l(h,{class:"config-card"},{header:a(()=>[o("div",re,[e[42]||(e[42]=o("span",null,"账号健康检查",-1)),o("div",se,[l(T,{type:r.value?"success":"info",size:"small"},{default:a(()=>[s(p(r.value?"已启用":"已禁用"),1)]),_:1},8,["type"]),l(U,{type:"primary",size:"small",onClick:X,disabled:!r.value,style:{"margin-left":"10px"}},{default:a(()=>[...e[41]||(e[41]=[s(" 查看状态 ",-1)])]),_:1},8,["disabled"])])])]),default:a(()=>[O((V(),c(z,{"label-width":"160px"},{default:a(()=>[l(i,{label:"启用健康检查"},{default:a(()=>[l(f,{modelValue:r.value,"onUpdate:modelValue":e[8]||(e[8]=n=>r.value=n)},null,8,["modelValue"]),e[43]||(e[43]=o("div",{class:"form-tip"},"定期检查 OAuth 账号的有效性（仅检查 Claude Official、OpenAI Responses、Gemini 类型）",-1))]),_:1}),l(i,{label:"检查间隔"},{default:a(()=>[l(u,{modelValue:t.account_health_check_interval,"onUpdate:modelValue":e[9]||(e[9]=n=>t.account_health_check_interval=n),min:1,max:60,disabled:!r.value},null,8,["modelValue","disabled"]),e[44]||(e[44]=o("span",{class:"unit"},"分钟",-1)),e[45]||(e[45]=o("div",{class:"form-tip"},"正常账号的定期检查间隔",-1))]),_:1}),l(i,{label:"连续错误阈值"},{default:a(()=>[l(u,{modelValue:t.account_error_threshold,"onUpdate:modelValue":e[10]||(e[10]=n=>t.account_error_threshold=n),min:1,max:100,disabled:!r.value},null,8,["modelValue","disabled"]),e[46]||(e[46]=o("span",{class:"unit"},"次",-1)),e[47]||(e[47]=o("div",{class:"form-tip"},"连续检查失败达到此次数后标记为疑似封号",-1))]),_:1}),l(b,{"content-position":"left"},{default:a(()=>[...e[48]||(e[48]=[s("恢复策略",-1)])]),_:1}),l(i,{label:"自动恢复"},{default:a(()=>[l(f,{modelValue:K.value,"onUpdate:modelValue":e[11]||(e[11]=n=>K.value=n),disabled:!r.value},null,8,["modelValue","disabled"]),e[49]||(e[49]=o("div",{class:"form-tip"},"检测通过时自动恢复账号为正常状态",-1))]),_:1}),l(i,{label:"自动刷新 Token"},{default:a(()=>[l(f,{modelValue:j.value,"onUpdate:modelValue":e[12]||(e[12]=n=>j.value=n),disabled:!r.value},null,8,["modelValue","disabled"]),e[50]||(e[50]=o("div",{class:"form-tip"},"Token 过期时自动尝试刷新",-1))]),_:1}),l(b,{"content-position":"left"},{default:a(()=>[...e[51]||(e[51]=[s("OAuth 配置",-1)])]),_:1}),l(i,{label:"OAuth 自动重授权"},{default:a(()=>[l(f,{modelValue:R.value,"onUpdate:modelValue":e[13]||(e[13]=n=>R.value=n),disabled:!r.value},null,8,["modelValue","disabled"]),e[52]||(e[52]=o("div",{class:"form-tip"},"OAuth Token 失效时，自动使用 SessionKey 重新获取 Token",-1))]),_:1}),l(i,{label:"重授权冷却时间"},{default:a(()=>[l(u,{modelValue:t.oauth_reauthorize_cooldown,"onUpdate:modelValue":e[14]||(e[14]=n=>t.oauth_reauthorize_cooldown=n),min:5,max:1440,disabled:!r.value||!R.value},null,8,["modelValue","disabled"]),e[53]||(e[53]=o("span",{class:"unit"},"分钟",-1)),e[54]||(e[54]=o("div",{class:"form-tip"},"重新授权失败后的冷却时间（默认 30 分钟）",-1))]),_:1})]),_:1})),[[E,k.value]])]),_:1})]),_:1}),l(S,{span:12},{default:a(()=>[l(h,{class:"config-card"},{header:a(()=>[...e[55]||(e[55]=[o("div",{class:"card-header"},[o("span",null,"分级检测策略")],-1)])]),default:a(()=>[O((V(),c(z,{"label-width":"160px"},{default:a(()=>[l(b,{"content-position":"left"},{default:a(()=>[...e[56]||(e[56]=[s("限流账号探测",-1)])]),_:1}),l(i,{label:"启用主动探测"},{default:a(()=>[l(f,{modelValue:w.value,"onUpdate:modelValue":e[15]||(e[15]=n=>w.value=n),disabled:!r.value},null,8,["modelValue","disabled"]),e[57]||(e[57]=o("div",{class:"form-tip"},"限流账号不等待官方 reset 时间，主动探测恢复",-1))]),_:1}),l(i,{label:"初始探测间隔"},{default:a(()=>[l(u,{modelValue:t.rate_limited_probe_init_interval,"onUpdate:modelValue":e[16]||(e[16]=n=>t.rate_limited_probe_init_interval=n),min:1,max:60,disabled:!r.value||!w.value},null,8,["modelValue","disabled"]),e[58]||(e[58]=o("span",{class:"unit"},"分钟",-1)),e[59]||(e[59]=o("div",{class:"form-tip"},"限流后首次探测的等待时间",-1))]),_:1}),l(i,{label:"最大探测间隔"},{default:a(()=>[l(u,{modelValue:t.rate_limited_probe_max_interval,"onUpdate:modelValue":e[17]||(e[17]=n=>t.rate_limited_probe_max_interval=n),min:10,max:120,disabled:!r.value||!w.value},null,8,["modelValue","disabled"]),e[60]||(e[60]=o("span",{class:"unit"},"分钟",-1)),e[61]||(e[61]=o("div",{class:"form-tip"},"探测间隔递增的上限",-1))]),_:1}),l(i,{label:"间隔递增因子"},{default:a(()=>[l(u,{modelValue:t.rate_limited_probe_backoff,"onUpdate:modelValue":e[18]||(e[18]=n=>t.rate_limited_probe_backoff=n),min:1,max:3,step:.1,precision:1,disabled:!r.value||!w.value},null,8,["modelValue","disabled"]),e[62]||(e[62]=o("div",{class:"form-tip"},"每次失败后间隔乘以此因子（如 1.5 表示每次增加 50%）",-1))]),_:1}),l(b,{"content-position":"left"},{default:a(()=>[...e[63]||(e[63]=[s("疑似封号检测",-1)])]),_:1}),l(i,{label:"探测间隔"},{default:a(()=>[l(u,{modelValue:t.suspended_probe_interval,"onUpdate:modelValue":e[19]||(e[19]=n=>t.suspended_probe_interval=n),min:1,max:60,disabled:!r.value},null,8,["modelValue","disabled"]),e[64]||(e[64]=o("span",{class:"unit"},"分钟",-1)),e[65]||(e[65]=o("div",{class:"form-tip"},"疑似封号账号的探测间隔",-1))]),_:1}),l(i,{label:"确认封号阈值"},{default:a(()=>[l(u,{modelValue:t.suspended_confirm_threshold,"onUpdate:modelValue":e[20]||(e[20]=n=>t.suspended_confirm_threshold=n),min:1,max:10,disabled:!r.value},null,8,["modelValue","disabled"]),e[66]||(e[66]=o("span",{class:"unit"},"次",-1)),e[67]||(e[67]=o("div",{class:"form-tip"},"连续失败此次数后确认为封号状态",-1))]),_:1}),l(b,{"content-position":"left"},{default:a(()=>[...e[68]||(e[68]=[s("封号账号复活检测",-1)])]),_:1}),l(i,{label:"启用复活检测"},{default:a(()=>[l(f,{modelValue:B.value,"onUpdate:modelValue":e[21]||(e[21]=n=>B.value=n),disabled:!r.value},null,8,["modelValue","disabled"]),e[69]||(e[69]=o("div",{class:"form-tip"},"定期检测已封号账号是否恢复",-1))]),_:1}),l(i,{label:"复活探测间隔"},{default:a(()=>[l(u,{modelValue:t.banned_probe_interval,"onUpdate:modelValue":e[22]||(e[22]=n=>t.banned_probe_interval=n),min:1,max:24,disabled:!r.value||!B.value},null,8,["modelValue","disabled"]),e[70]||(e[70]=o("span",{class:"unit"},"小时",-1)),e[71]||(e[71]=o("div",{class:"form-tip"},"封号账号的复活检测间隔",-1))]),_:1}),l(b,{"content-position":"left"},{default:a(()=>[...e[72]||(e[72]=[s("Token 刷新",-1)])]),_:1}),l(i,{label:"刷新冷却时间"},{default:a(()=>[l(u,{modelValue:t.token_refresh_cooldown,"onUpdate:modelValue":e[23]||(e[23]=n=>t.token_refresh_cooldown=n),min:5,max:120,disabled:!r.value},null,8,["modelValue","disabled"]),e[73]||(e[73]=o("span",{class:"unit"},"分钟",-1)),e[74]||(e[74]=o("div",{class:"form-tip"},"Token 刷新失败后的冷却时间",-1))]),_:1}),l(i,{label:"最大重试次数"},{default:a(()=>[l(u,{modelValue:t.token_refresh_max_retries,"onUpdate:modelValue":e[24]||(e[24]=n=>t.token_refresh_max_retries=n),min:1,max:10,disabled:!r.value},null,8,["modelValue","disabled"]),e[75]||(e[75]=o("span",{class:"unit"},"次",-1)),e[76]||(e[76]=o("div",{class:"form-tip"},"Token 刷新的最大重试次数",-1))]),_:1})]),_:1})),[[E,k.value]])]),_:1})]),_:1})]),_:1}),l(M,{gutter:20,style:{"margin-top":"20px"}},{default:a(()=>[l(S,{span:24},{default:a(()=>[l(h,{class:"config-card"},{header:a(()=>[...e[77]||(e[77]=[o("div",{class:"card-header"},[o("span",null,"配置项列表")],-1)])]),default:a(()=>[l(Z,{data:L.value,stripe:"",size:"small","max-height":"300"},{default:a(()=>[l(F,{prop:"key",label:"配置项",width:"260"}),l(F,{prop:"value",label:"当前值",width:"100"}),l(F,{prop:"desc",label:"说明","show-overflow-tooltip":""})]),_:1},8,["data"])]),_:1})]),_:1})]),_:1}),l(ee,{modelValue:D.value,"onUpdate:modelValue":e[25]||(e[25]=n=>D.value=n),title:"健康检测服务状态",width:"600px"},{default:a(()=>[m.value?(V(),c($,{key:0,column:2,border:""},{default:a(()=>[l(v,{label:"服务状态"},{default:a(()=>[l(T,{type:m.value.running?"success":"danger"},{default:a(()=>[s(p(m.value.running?"运行中":"已停止"),1)]),_:1},8,["type"])]),_:1}),l(v,{label:"检测间隔"},{default:a(()=>[s(p(m.value.interval)+" 分钟 ",1)]),_:1}),l(v,{label:"上次检测"},{default:a(()=>[s(p(m.value.last_check?Q(m.value.last_check):"暂无"),1)]),_:1}),l(v,{label:"问题账号数"},{default:a(()=>[l(T,{type:"warning"},{default:a(()=>[s(p(m.value.problem_account_count||0),1)]),_:1})]),_:1}),l(v,{label:"已检测账号数"},{default:a(()=>[s(p(m.value.checked_count||0),1)]),_:1}),l(v,{label:"失败账号数"},{default:a(()=>[m.value.failed_count>0?(V(),c(T,{key:0,type:"danger"},{default:a(()=>[s(p(m.value.failed_count),1)]),_:1})):(V(),q("span",ue,"0"))]),_:1}),l(v,{label:"错误阈值"},{default:a(()=>[s(p(m.value.threshold)+" 次 ",1)]),_:1}),l(v,{label:"最后错误"},{default:a(()=>[o("span",_e,p(m.value.last_error||"无"),1)]),_:1})]),_:1})):de("",!0),o("div",me,[l(U,{type:"primary",onClick:Y,loading:H.value},{default:a(()=>[...e[78]||(e[78]=[s(" 手动触发检测 ",-1)])]),_:1},8,["loading"]),l(U,{onClick:P},{default:a(()=>[...e[79]||(e[79]=[s("刷新状态",-1)])]),_:1})])]),_:1},8,["modelValue"]),o("div",pe,[l(U,{type:"primary",size:"large",onClick:W,loading:N.value},{default:a(()=>[...e[80]||(e[80]=[s(" 保存配置 ",-1)])]),_:1},8,["loading"]),l(U,{size:"large",onClick:I},{default:a(()=>[...e[81]||(e[81]=[s("重置",-1)])]),_:1})])])}}},ge=le(fe,[["__scopeId","data-v-88acf124"]]);export{ge as default};

import{_ as me,r as p,a as pe,c as X,o as he,b as k,d as _,e as i,f as l,w as t,h as c,i as f,M as ge,n as u,q as j,v as ve,J as q,k as b,l as S,t as r,D as Y,F as Z,H as ee,P as le,E as x}from"./index-BdjcZBcD.js";const ye={class:"cache-page"},be={class:"page-header"},we={class:"card-header"},Ce={class:"header-actions"},Ve={key:0,class:"no-data"},ke={class:"session-id"},xe={class:"card-header"},ze={class:"header-actions"},Ue={key:0,class:"no-data"},Te={class:"session-id"},Ae={__name:"Cache",setup($e){const C=p(!1),d=pe({session_ttl:60,session_renewal_ttl:14,unavailable_ttl:5,concurrency_ttl:5}),N=p("accounts"),z=p(!1),h=p([]),U=p(""),T=p(!1),g=p([]),A=p(""),te=X(()=>U.value?h.value.filter(a=>String(a.account_id).includes(U.value)):h.value),ae=X(()=>A.value?g.value.filter(a=>String(a.user_id).includes(A.value)):g.value);function H(a){return a?new Date(a).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-"}function J(a,e){return a>=e?"danger":a>=e*.8?"warning":"success"}function K(a){if(!a)return"-";if(a.startsWith("apikey:")){const e=a.split(":");return e.length>=3?e.slice(2).join(":"):`Key#${e[1]}`}return a}function P(a){return!a||a<=0?"已过期":a<60?`${a}秒`:a<3600?`${Math.floor(a/60)}分钟`:`${Math.floor(a/3600)}小时`}function W(a){return!a||a<=0?"danger":a<300?"warning":"success"}function ne(a,e){if(!e||!e.length)return`#${a}`;const v=e.find(m=>m.id===a);return(v==null?void 0:v.name)||`#${a}`}async function G(){C.value=!0;try{const e=(await f.getCacheConfig()).data||{};d.session_ttl=e.session_ttl||60,d.session_renewal_ttl=e.session_renewal_ttl||14,d.unavailable_ttl=e.unavailable_ttl||5,d.concurrency_ttl=e.concurrency_ttl||5}catch(a){console.error("Failed to fetch config:",a)}finally{C.value=!1}}async function se(){C.value=!0;try{await f.updateCacheConfig(d),x.success("配置已保存")}catch(a){console.error("Failed to save config:",a)}finally{C.value=!1}}async function $(){var a;z.value=!0;try{const e=await f.getCacheAccounts();h.value=((a=e.data)==null?void 0:a.accounts)||[]}catch(e){console.error("Failed to load account cache:",e)}finally{z.value=!1}}async function M(){var a;T.value=!0;try{const e=await f.getCacheUsers();g.value=((a=e.data)==null?void 0:a.users)||[]}catch(e){console.error("Failed to load user cache:",e)}finally{T.value=!1}}async function oe(a){try{await f.clearAccountSessions(a),await f.resetAccountConcurrency(a),x.success("账号缓存已清除"),$()}catch(e){console.error("Failed to clear account cache:",e)}}async function re(){try{await f.clearCache("sessions"),await f.clearCache("concurrency"),x.success("所有账号缓存已清除"),h.value=[]}catch(a){console.error("Failed to clear all account cache:",a)}}async function ie(a){try{await f.clearUserCache(a),await f.resetUserConcurrency(a),x.success("用户缓存已清除"),M()}catch(e){console.error("Failed to clear user cache:",e)}}async function ue(){try{await f.clearCache("sessions"),await f.clearCache("concurrency"),x.success("所有用户缓存已清除"),g.value=[]}catch(a){console.error("Failed to clear all user cache:",a)}}function ce(a){a==="accounts"&&h.value.length===0?$():a==="users"&&g.value.length===0&&M()}function de(){G(),N.value==="accounts"?$():M()}return he(()=>{G(),$()}),(a,e)=>{const v=c("el-icon"),m=c("el-button"),F=c("el-input-number"),V=c("el-form-item"),_e=c("el-form"),B=c("el-card"),I=c("el-input"),D=c("el-popconfirm"),o=c("el-table-column"),w=c("el-tag"),L=c("el-table"),O=c("el-popover"),Q=c("el-empty"),R=c("el-tab-pane"),fe=c("el-tabs"),E=ge("loading");return _(),k("div",ye,[i("div",be,[e[8]||(e[8]=i("h2",null,"缓存管理",-1)),l(m,{onClick:de},{default:t(()=>[l(v,null,{default:t(()=>[l(j(ve))]),_:1}),e[7]||(e[7]=u(" 刷新 ",-1))]),_:1})]),l(B,{class:"config-card"},{header:t(()=>[...e[9]||(e[9]=[i("span",null,"缓存配置",-1)])]),default:t(()=>[q((_(),b(_e,{inline:!0,model:d},{default:t(()=>[l(V,{label:"粘性会话TTL"},{default:t(()=>[l(F,{modelValue:d.session_ttl,"onUpdate:modelValue":e[0]||(e[0]=n=>d.session_ttl=n),min:1,max:1440},null,8,["modelValue"]),e[10]||(e[10]=i("span",{class:"unit"},"分钟",-1))]),_:1}),l(V,{label:"会话续期阈值"},{default:t(()=>[l(F,{modelValue:d.session_renewal_ttl,"onUpdate:modelValue":e[1]||(e[1]=n=>d.session_renewal_ttl=n),min:1,max:60},null,8,["modelValue"]),e[11]||(e[11]=i("span",{class:"unit"},"分钟",-1))]),_:1}),l(V,{label:"不可用标记TTL"},{default:t(()=>[l(F,{modelValue:d.unavailable_ttl,"onUpdate:modelValue":e[2]||(e[2]=n=>d.unavailable_ttl=n),min:1,max:60},null,8,["modelValue"]),e[12]||(e[12]=i("span",{class:"unit"},"分钟",-1))]),_:1}),l(V,{label:"并发计数TTL"},{default:t(()=>[l(F,{modelValue:d.concurrency_ttl,"onUpdate:modelValue":e[3]||(e[3]=n=>d.concurrency_ttl=n),min:1,max:60},null,8,["modelValue"]),e[13]||(e[13]=i("span",{class:"unit"},"分钟",-1))]),_:1}),l(V,null,{default:t(()=>[l(m,{type:"primary",onClick:se},{default:t(()=>[...e[14]||(e[14]=[u("保存配置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])),[[E,C.value]])]),_:1}),l(fe,{modelValue:N.value,"onUpdate:modelValue":e[6]||(e[6]=n=>N.value=n),onTabChange:ce},{default:t(()=>[l(R,{label:"账号缓存",name:"accounts"},{default:t(()=>[l(B,null,{header:t(()=>[i("div",we,[i("span",null,"账号缓存列表 ("+r(h.value.length)+")",1),i("div",Ce,[l(I,{modelValue:U.value,"onUpdate:modelValue":e[4]||(e[4]=n=>U.value=n),placeholder:"搜索账号ID",clearable:"",style:{width:"150px"}},{prefix:t(()=>[l(v,null,{default:t(()=>[l(j(le))]),_:1})]),_:1},8,["modelValue"]),l(D,{title:"清除所有账号缓存?",onConfirm:re},{reference:t(()=>[l(m,{type:"danger",size:"small"},{default:t(()=>[...e[15]||(e[15]=[u("清除全部",-1)])]),_:1})]),_:1})])])]),default:t(()=>[q((_(),b(L,{data:te.value,size:"small"},{default:t(()=>[l(o,{prop:"account_name",label:"账号","min-width":"120"},{default:t(({row:n})=>[i("span",null,r(n.account_name||`账号${n.account_id}`),1)]),_:1}),l(o,{label:"并发",width:"120",align:"center"},{default:t(({row:n})=>[i("span",{class:Y(J(n.concurrency,n.max_concurrency))},r(n.concurrency),3),u(" / "+r(n.max_concurrency),1)]),_:1}),l(o,{label:"会话数",width:"100",align:"center"},{default:t(({row:n})=>[l(w,{size:"small"},{default:t(()=>[u(r(n.session_count),1)]),_:2},1024)]),_:1}),l(o,{label:"使用此账号的用户","min-width":"150"},{default:t(({row:n})=>{var s;return[(_(!0),k(Z,null,ee(n.users,y=>(_(),b(w,{key:y.id,size:"small",class:"user-tag"},{default:t(()=>[u(r(y.name||`用户${y.id}`),1)]),_:2},1024))),128)),(s=n.users)!=null&&s.length?S("",!0):(_(),k("span",Ve,"-"))]}),_:1}),l(o,{label:"会话详情","min-width":"200"},{default:t(({row:n})=>[l(O,{placement:"left",width:600,trigger:"click"},{reference:t(()=>[l(m,{link:"",type:"primary",size:"small"},{default:t(()=>[u("查看会话 ("+r(n.session_count)+")",1)]),_:2},1024)]),default:t(()=>[l(L,{data:n.sessions,size:"small","max-height":"300"},{default:t(()=>[l(o,{label:"会话ID",width:"200","show-overflow-tooltip":""},{default:t(({row:s})=>[i("span",ke,r(K(s.session_id)),1)]),_:1}),l(o,{prop:"user_id",label:"用户ID",width:"70"}),l(o,{label:"剩余时间",width:"90",align:"center"},{default:t(({row:s})=>[l(w,{type:W(s.remaining_ttl),size:"small"},{default:t(()=>[u(r(P(s.remaining_ttl)),1)]),_:2},1032,["type"])]),_:1}),l(o,{prop:"user_agent",label:"UA","min-width":"120","show-overflow-tooltip":""}),l(o,{label:"绑定时间",width:"100"},{default:t(({row:s})=>[u(r(H(s.bound_at)),1)]),_:1})]),_:1},8,["data"])]),_:2},1024)]),_:1}),l(o,{label:"操作",width:"100",align:"center"},{default:t(({row:n})=>[l(D,{title:"清除此账号缓存?",onConfirm:s=>oe(n.account_id)},{reference:t(()=>[l(m,{link:"",type:"danger",size:"small"},{default:t(()=>[...e[16]||(e[16]=[u("清除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[E,z.value]]),!z.value&&h.value.length===0?(_(),b(Q,{key:0,description:"暂无账号缓存"})):S("",!0)]),_:1})]),_:1}),l(R,{label:"用户缓存",name:"users"},{default:t(()=>[l(B,null,{header:t(()=>[i("div",xe,[i("span",null,"用户缓存列表 ("+r(g.value.length)+")",1),i("div",ze,[l(I,{modelValue:A.value,"onUpdate:modelValue":e[5]||(e[5]=n=>A.value=n),placeholder:"搜索用户ID",clearable:"",style:{width:"150px"}},{prefix:t(()=>[l(v,null,{default:t(()=>[l(j(le))]),_:1})]),_:1},8,["modelValue"]),l(D,{title:"清除所有用户缓存?",onConfirm:ue},{reference:t(()=>[l(m,{type:"danger",size:"small"},{default:t(()=>[...e[17]||(e[17]=[u("清除全部",-1)])]),_:1})]),_:1})])])]),default:t(()=>[q((_(),b(L,{data:ae.value,size:"small"},{default:t(()=>[l(o,{label:"用户","min-width":"120"},{default:t(({row:n})=>[i("span",null,r(n.user_name||`用户${n.user_id}`),1)]),_:1}),l(o,{label:"并发",width:"120",align:"center"},{default:t(({row:n})=>[i("span",{class:Y(J(n.concurrency,n.max_concurrency))},r(n.concurrency),3),u(" / "+r(n.max_concurrency),1)]),_:1}),l(o,{label:"会话数",width:"100",align:"center"},{default:t(({row:n})=>[l(w,{size:"small"},{default:t(()=>[u(r(n.session_count),1)]),_:2},1024)]),_:1}),l(o,{label:"使用的账号","min-width":"150"},{default:t(({row:n})=>{var s;return[(_(!0),k(Z,null,ee(n.accounts,y=>(_(),b(w,{key:y.id,size:"small",type:"warning",class:"account-tag"},{default:t(()=>[u(r(y.name||`账号${y.id}`),1)]),_:2},1024))),128)),(s=n.accounts)!=null&&s.length?S("",!0):(_(),k("span",Ue,"-"))]}),_:1}),l(o,{label:"会话详情","min-width":"200"},{default:t(({row:n})=>[l(O,{placement:"left",width:600,trigger:"click"},{reference:t(()=>[l(m,{link:"",type:"primary",size:"small"},{default:t(()=>[u("查看会话 ("+r(n.session_count)+")",1)]),_:2},1024)]),default:t(()=>[l(L,{data:n.sessions,size:"small","max-height":"300"},{default:t(()=>[l(o,{label:"会话ID",width:"200","show-overflow-tooltip":""},{default:t(({row:s})=>[i("span",Te,r(K(s.session_id)),1)]),_:1}),l(o,{label:"账号",width:"100"},{default:t(({row:s})=>[u(r(ne(s.account_id,n.accounts)),1)]),_:2},1024),l(o,{label:"剩余时间",width:"90",align:"center"},{default:t(({row:s})=>[l(w,{type:W(s.remaining_ttl),size:"small"},{default:t(()=>[u(r(P(s.remaining_ttl)),1)]),_:2},1032,["type"])]),_:1}),l(o,{prop:"user_agent",label:"UA","min-width":"120","show-overflow-tooltip":""}),l(o,{label:"绑定时间",width:"100"},{default:t(({row:s})=>[u(r(H(s.bound_at)),1)]),_:1})]),_:2},1032,["data"])]),_:2},1024)]),_:1}),l(o,{label:"操作",width:"100",align:"center"},{default:t(({row:n})=>[l(D,{title:"清除此用户缓存?",onConfirm:s=>ie(n.user_id)},{reference:t(()=>[l(m,{link:"",type:"danger",size:"small"},{default:t(()=>[...e[18]||(e[18]=[u("清除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[E,T.value]]),!T.value&&g.value.length===0?(_(),b(Q,{key:0,description:"暂无用户缓存"})):S("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},De=me(Ae,[["__scopeId","data-v-8ec5b70e"]]);export{De as default};

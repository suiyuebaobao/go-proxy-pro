import{_ as xe,r as f,a as Ue,c as q,o as Te,P as Se,b as w,d as m,e as c,f as t,w as n,h as d,i as p,M as Ae,n as i,q as J,v as le,J as Q,k as x,l as W,t as s,Q as $e,D as se,E as v}from"./index-BNmznGOD.js";const Le={class:"cache-page"},Ne={class:"page-header"},Me={class:"card-header"},Ee={class:"header-actions"},Fe={class:"session-id"},Be={key:0},De={key:1,class:"no-data"},Pe={key:0},Ie={key:1,class:"no-data"},Ke={key:0,class:"pagination-wrap"},Re={class:"card-header"},je={class:"card-header"},qe={class:"card-header"},Je={__name:"Cache",setup(Qe){const C=f(!1),_=Ue({session_ttl:60,session_renewal_ttl:14,unavailable_ttl:5,concurrency_ttl:5}),U=f("sessions"),T=f(!1),g=f([]),k=f(0),D=f(1),S=f(20),A=f(""),G=f({}),H=f({}),$=f(!1),L=f([]),O=q(()=>{const a=new Map;return g.value.forEach(e=>{a.has(e.account_id)||a.set(e.account_id,{account_id:e.account_id,concurrency:0,max_concurrency:5}),a.get(e.account_id).concurrency++}),Array.from(a.values())}),X=q(()=>{const a=new Map;return g.value.forEach(e=>{e.user_id&&!a.has(e.user_id)&&a.set(e.user_id,{user_id:e.user_id,concurrency:0,max_concurrency:10}),e.user_id&&a.get(e.user_id).concurrency++}),Array.from(a.values())}),oe=q(()=>{if(!A.value)return g.value;const a=A.value.toLowerCase();return g.value.filter(e=>{var r;return((r=e.session_id)==null?void 0:r.toLowerCase().includes(a))||M(e.account_id).toLowerCase().includes(a)||P(e.user_id).toLowerCase().includes(a)})});let N=null;function Y(a){return a?new Date(a).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-"}function Z(a,e){return a>=e?"danger":a>=e*.8?"warning":"success"}function ie(a){if(!a)return"-";if(a.startsWith("apikey:")){const e=a.split(":");return e.length>=3?e.slice(2).join(":"):`Key#${e[1]}`}return a}function ee(a){return!a||a<=0?"已过期":a<60?`${a}秒`:a<3600?`${Math.floor(a/60)}分${a%60}秒`:`${Math.floor(a/3600)}时${Math.floor(a%3600/60)}分`}function re(a){return!a||a<=0?"danger":a<300?"warning":"success"}function M(a){return a?G.value[a]||`#${a}`:"-"}function P(a){return a?H.value[a]||`#${a}`:"-"}function ue(){}async function ae(){C.value=!0;try{const e=(await p.getCacheConfig()).data||{};_.session_ttl=e.session_ttl||60,_.session_renewal_ttl=e.session_renewal_ttl||14,_.unavailable_ttl=e.unavailable_ttl||5,_.concurrency_ttl=e.concurrency_ttl||5}catch(a){console.error("Failed to fetch config:",a)}finally{C.value=!1}}async function ce(){C.value=!0;try{await p.updateCacheConfig(_),v.success("配置已保存")}catch(a){console.error("Failed to save config:",a)}finally{C.value=!1}}async function y(){var a,e;T.value=!0;try{const r=(D.value-1)*S.value,u=await p.getCacheSessions({offset:r,limit:S.value});g.value=((a=u.data)==null?void 0:a.sessions)||[],k.value=((e=u.data)==null?void 0:e.total)||0;const b=[...new Set(g.value.map(z=>z.account_id).filter(Boolean))],h=[...new Set(g.value.map(z=>z.user_id).filter(Boolean))];await de(b),await _e(h)}catch(r){console.error("Failed to load sessions:",r)}finally{T.value=!1}}async function de(a){var e;if(a.length)try{const r=await p.getAccounts({page:1,page_size:100});(e=r.data)!=null&&e.list&&r.data.list.forEach(u=>{G.value[u.id]=u.name||`账号${u.id}`})}catch(r){console.error("Failed to load account names:",r)}}async function _e(a){var e;if(a.length)try{const r=await p.getUsers({page:1,page_size:100});(e=r.data)!=null&&e.list&&r.data.list.forEach(u=>{H.value[u.id]=u.username||`用户${u.id}`})}catch(r){console.error("Failed to load user names:",r)}}async function fe(a){try{await p.removeCacheSession(a),v.success("会话已移除"),y()}catch{v.error("移除失败")}}async function me(){try{await p.clearCache("sessions"),v.success("所有会话已清除"),g.value=[],k.value=0}catch{v.error("清除失败")}}async function E(){var a;$.value=!0;try{const e=await p.getUnavailableAccounts();L.value=((a=e.data)==null?void 0:a.accounts)||[]}catch(e){console.error("Failed to load unavailable accounts:",e)}finally{$.value=!1}}async function pe(a){try{await p.clearAccountUnavailable(a),v.success("已恢复账号"),E()}catch{v.error("操作失败")}}async function ve(a){try{await p.resetAccountConcurrency(a),v.success("已重置"),y()}catch{v.error("重置失败")}}async function ge(a){try{await p.resetUserConcurrency(a),v.success("已重置"),y()}catch{v.error("重置失败")}}function ye(a){a==="sessions"?y():a==="unavailable"?E():a==="concurrency"&&y()}function he(){ae(),y(),U.value==="unavailable"&&E()}function be(){N=setInterval(()=>{U.value==="sessions"&&y()},3e4)}function we(){N&&(clearInterval(N),N=null)}return Te(()=>{ae(),y(),be()}),Se(()=>{we()}),(a,e)=>{const r=d("el-icon"),u=d("el-button"),b=d("el-input-number"),h=d("el-form-item"),z=d("el-form"),V=d("el-card"),Ce=d("el-input"),I=d("el-popconfirm"),o=d("el-table-column"),F=d("el-tag"),B=d("el-table"),ke=d("el-pagination"),te=d("el-empty"),K=d("el-tab-pane"),ne=d("el-col"),ze=d("el-row"),Ve=d("el-tabs"),R=Ae("loading");return m(),w("div",Le,[c("div",Ne,[e[9]||(e[9]=c("h2",null,"缓存管理",-1)),t(u,{onClick:he},{default:n(()=>[t(r,null,{default:n(()=>[t(J(le))]),_:1}),e[8]||(e[8]=i(" 刷新 ",-1))]),_:1})]),t(V,{class:"config-card"},{header:n(()=>[...e[10]||(e[10]=[c("span",null,"缓存配置",-1)])]),default:n(()=>[Q((m(),x(z,{inline:!0,model:_},{default:n(()=>[t(h,{label:"粘性会话TTL"},{default:n(()=>[t(b,{modelValue:_.session_ttl,"onUpdate:modelValue":e[0]||(e[0]=l=>_.session_ttl=l),min:1,max:1440},null,8,["modelValue"]),e[11]||(e[11]=c("span",{class:"unit"},"分钟",-1))]),_:1}),t(h,{label:"会话续期阈值"},{default:n(()=>[t(b,{modelValue:_.session_renewal_ttl,"onUpdate:modelValue":e[1]||(e[1]=l=>_.session_renewal_ttl=l),min:1,max:60},null,8,["modelValue"]),e[12]||(e[12]=c("span",{class:"unit"},"分钟",-1))]),_:1}),t(h,{label:"不可用标记TTL"},{default:n(()=>[t(b,{modelValue:_.unavailable_ttl,"onUpdate:modelValue":e[2]||(e[2]=l=>_.unavailable_ttl=l),min:1,max:60},null,8,["modelValue"]),e[13]||(e[13]=c("span",{class:"unit"},"分钟",-1))]),_:1}),t(h,{label:"并发计数TTL"},{default:n(()=>[t(b,{modelValue:_.concurrency_ttl,"onUpdate:modelValue":e[3]||(e[3]=l=>_.concurrency_ttl=l),min:1,max:60},null,8,["modelValue"]),e[14]||(e[14]=c("span",{class:"unit"},"分钟",-1))]),_:1}),t(h,null,{default:n(()=>[t(u,{type:"primary",onClick:ce},{default:n(()=>[...e[15]||(e[15]=[i("保存配置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])),[[R,C.value]])]),_:1}),t(Ve,{modelValue:U.value,"onUpdate:modelValue":e[7]||(e[7]=l=>U.value=l),onTabChange:ye},{default:n(()=>[t(K,{label:"会话列表",name:"sessions"},{default:n(()=>[t(V,null,{header:n(()=>[c("div",Me,[c("span",null,"活跃会话 ("+s(k.value)+")",1),c("div",Ee,[t(Ce,{modelValue:A.value,"onUpdate:modelValue":e[4]||(e[4]=l=>A.value=l),placeholder:"搜索会话/账号/用户",clearable:"",style:{width:"200px"},onInput:ue},{prefix:n(()=>[t(r,null,{default:n(()=>[t(J($e))]),_:1})]),_:1},8,["modelValue"]),t(I,{title:"清除所有会话缓存?",onConfirm:me},{reference:n(()=>[t(u,{type:"danger",size:"small"},{default:n(()=>[...e[16]||(e[16]=[i("清除全部",-1)])]),_:1})]),_:1})])])]),default:n(()=>[Q((m(),x(B,{data:oe.value,size:"small",stripe:""},{default:n(()=>[t(o,{label:"会话ID","min-width":"200","show-overflow-tooltip":""},{default:n(({row:l})=>[c("span",Fe,s(ie(l.session_id)),1)]),_:1}),t(o,{label:"账号",width:"150"},{default:n(({row:l})=>[t(F,{size:"small",type:"warning"},{default:n(()=>[i(s(M(l.account_id)),1)]),_:2},1024)]),_:1}),t(o,{label:"用户",width:"120"},{default:n(({row:l})=>[l.user_id?(m(),w("span",Be,s(P(l.user_id)),1)):(m(),w("span",De,"-"))]),_:1}),t(o,{label:"API Key",width:"100"},{default:n(({row:l})=>[l.api_key_id?(m(),w("span",Pe,"#"+s(l.api_key_id),1)):(m(),w("span",Ie,"-"))]),_:1}),t(o,{label:"平台",width:"100"},{default:n(({row:l})=>[t(F,{size:"small",type:"info"},{default:n(()=>[i(s(l.platform||"-"),1)]),_:2},1024)]),_:1}),t(o,{label:"模型",width:"150","show-overflow-tooltip":""},{default:n(({row:l})=>[i(s(l.model||"-"),1)]),_:1}),t(o,{label:"绑定时间",width:"140"},{default:n(({row:l})=>[i(s(Y(l.bound_at)),1)]),_:1}),t(o,{label:"最后使用",width:"140"},{default:n(({row:l})=>[i(s(Y(l.last_used_at)),1)]),_:1}),t(o,{label:"剩余时间",width:"100",align:"center"},{default:n(({row:l})=>[t(F,{type:re(l.remaining_ttl),size:"small"},{default:n(()=>[i(s(ee(l.remaining_ttl)),1)]),_:2},1032,["type"])]),_:1}),t(o,{label:"客户端IP",width:"130","show-overflow-tooltip":""},{default:n(({row:l})=>[i(s(l.client_ip||"-"),1)]),_:1}),t(o,{label:"操作",width:"80",align:"center",fixed:"right"},{default:n(({row:l})=>[t(I,{title:"移除此会话?",onConfirm:j=>fe(l.session_id)},{reference:n(()=>[t(u,{link:"",type:"danger",size:"small"},{default:n(()=>[...e[17]||(e[17]=[i("移除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[R,T.value]]),k.value>0?(m(),w("div",Ke,[t(ke,{"current-page":D.value,"onUpdate:currentPage":e[5]||(e[5]=l=>D.value=l),"page-size":S.value,"onUpdate:pageSize":e[6]||(e[6]=l=>S.value=l),total:k.value,"page-sizes":[20,50,100],layout:"total, sizes, prev, pager, next",onChange:y},null,8,["current-page","page-size","total"])])):W("",!0),!T.value&&g.value.length===0?(m(),x(te,{key:1,description:"暂无活跃会话"})):W("",!0)]),_:1})]),_:1}),t(K,{label:"不可用账号",name:"unavailable"},{default:n(()=>[t(V,null,{header:n(()=>[c("div",Re,[c("span",null,"临时不可用账号 ("+s(L.value.length)+")",1),t(u,{type:"primary",size:"small",onClick:E},{default:n(()=>[t(r,null,{default:n(()=>[t(J(le))]),_:1}),e[18]||(e[18]=i(" 刷新 ",-1))]),_:1})])]),default:n(()=>[Q((m(),x(B,{data:L.value,size:"small"},{default:n(()=>[t(o,{label:"账号","min-width":"150"},{default:n(({row:l})=>[i(s(M(l.account_id)),1)]),_:1}),t(o,{prop:"reason",label:"原因","min-width":"200","show-overflow-tooltip":""}),t(o,{label:"剩余时间",width:"120",align:"center"},{default:n(({row:l})=>[t(F,{type:"danger",size:"small"},{default:n(()=>[i(s(ee(l.remaining_ttl)),1)]),_:2},1024)]),_:1}),t(o,{label:"操作",width:"100",align:"center"},{default:n(({row:l})=>[t(I,{title:"清除不可用标记?",onConfirm:j=>pe(l.account_id)},{reference:n(()=>[t(u,{link:"",type:"primary",size:"small"},{default:n(()=>[...e[19]||(e[19]=[i("恢复",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[R,$.value]]),!$.value&&L.value.length===0?(m(),x(te,{key:0,description:"暂无不可用账号"})):W("",!0)]),_:1})]),_:1}),t(K,{label:"并发统计",name:"concurrency"},{default:n(()=>[t(ze,{gutter:20},{default:n(()=>[t(ne,{span:12},{default:n(()=>[t(V,null,{header:n(()=>[c("div",je,[c("span",null,"账号并发 ("+s(O.value.length)+")",1)])]),default:n(()=>[t(B,{data:O.value,size:"small","max-height":"400"},{default:n(()=>[t(o,{label:"账号","min-width":"120"},{default:n(({row:l})=>[i(s(M(l.account_id)),1)]),_:1}),t(o,{label:"并发",width:"120",align:"center"},{default:n(({row:l})=>[c("span",{class:se(Z(l.concurrency,l.max_concurrency))},s(l.concurrency),3),i(" / "+s(l.max_concurrency),1)]),_:1}),t(o,{label:"操作",width:"80",align:"center"},{default:n(({row:l})=>[t(u,{link:"",type:"danger",size:"small",onClick:j=>ve(l.account_id)},{default:n(()=>[...e[20]||(e[20]=[i(" 重置 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1}),t(ne,{span:12},{default:n(()=>[t(V,null,{header:n(()=>[c("div",qe,[c("span",null,"用户并发 ("+s(X.value.length)+")",1)])]),default:n(()=>[t(B,{data:X.value,size:"small","max-height":"400"},{default:n(()=>[t(o,{label:"用户","min-width":"120"},{default:n(({row:l})=>[i(s(P(l.user_id)),1)]),_:1}),t(o,{label:"并发",width:"120",align:"center"},{default:n(({row:l})=>[c("span",{class:se(Z(l.concurrency,l.max_concurrency))},s(l.concurrency),3),i(" / "+s(l.max_concurrency),1)]),_:1}),t(o,{label:"操作",width:"80",align:"center"},{default:n(({row:l})=>[t(u,{link:"",type:"danger",size:"small",onClick:j=>ge(l.user_id)},{default:n(()=>[...e[21]||(e[21]=[i(" 重置 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},Ge=xe(Je,[["__scopeId","data-v-f0f8e9b2"]]);export{Ge as default};

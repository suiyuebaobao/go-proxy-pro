# M8 套餐系统模块设计

> 创建时间：2024-12-10
> 状态：已完成

---

## 1. 模块概述

### 1.1 目标
实现灵活的套餐计费系统，支持订阅制和额度制两种模式，为用户提供多样化的付费选项。

### 1.2 核心功能
- 套餐模板管理（管理员）
- 用户套餐分配
- 周期额度控制（日/周/月）
- 模型使用限制
- 额度自动重置

---

## 2. 套餐类型

### 2.1 订阅类型 (subscription)
- **特点**：包月制，周期内有额度限制
- **额度控制**：每日/每周/每月额度限制
- **到期处理**：到期后套餐失效
- **适用场景**：稳定使用的用户

### 2.2 额度类型 (quota)
- **特点**：一次性购买，用完即止
- **额度控制**：总额度限制
- **到期处理**：过期或用完后失效
- **适用场景**：偶尔使用的用户

---

## 3. 数据模型

### 3.1 套餐模板表 (packages)

```sql
CREATE TABLE packages (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,                          -- 套餐名称
    type VARCHAR(20) NOT NULL,                           -- subscription/quota
    price DECIMAL(10,2) DEFAULT 0,                       -- 价格（美元）
    duration INT DEFAULT 30,                             -- 有效期天数

    -- 订阅类型额度限制（美元）
    daily_quota DECIMAL(10,4) DEFAULT 0,                 -- 每日额度（0=不限）
    weekly_quota DECIMAL(10,4) DEFAULT 0,                -- 每周额度（0=不限）
    monthly_quota DECIMAL(10,4) DEFAULT 0,               -- 每月额度（0=不限）

    -- 额度类型总额度
    quota_amount DECIMAL(10,4) DEFAULT 0,                -- 总额度（美元）

    -- 模型限制
    allowed_models TEXT,                                 -- 允许的模型（逗号分隔）

    description VARCHAR(500),                            -- 描述
    status VARCHAR(20) DEFAULT 'active',                 -- active/disabled
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,

    INDEX idx_type (type),
    INDEX idx_status (status)
);
```

### 3.2 用户套餐表 (user_packages)

```sql
CREATE TABLE user_packages (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNSIGNED NOT NULL,                    -- 所属用户
    package_id BIGINT UNSIGNED NOT NULL,                 -- 套餐模板ID
    name VARCHAR(100) NOT NULL,                          -- 套餐名称（冗余）
    type VARCHAR(20) NOT NULL,                           -- subscription/quota
    status VARCHAR(20) DEFAULT 'active',                 -- active/expired/exhausted/disabled

    -- 时间相关
    start_time TIMESTAMP,                                -- 开始时间
    expire_time TIMESTAMP,                               -- 到期时间

    -- 订阅类型额度限制
    daily_quota DECIMAL(10,4) DEFAULT 0,
    weekly_quota DECIMAL(10,4) DEFAULT 0,
    monthly_quota DECIMAL(10,4) DEFAULT 0,

    -- 订阅类型周期使用量
    daily_used DECIMAL(10,4) DEFAULT 0,                  -- 今日已用
    weekly_used DECIMAL(10,4) DEFAULT 0,                 -- 本周已用
    monthly_used DECIMAL(10,4) DEFAULT 0,                -- 本月已用
    last_reset_day VARCHAR(10),                          -- 上次重置日期 (YYYY-MM-DD)
    last_reset_week VARCHAR(10),                         -- 上次重置周 (YYYY-WW)
    last_reset_month VARCHAR(7),                         -- 上次重置月 (YYYY-MM)

    -- 额度类型字段
    quota_total DECIMAL(10,4) DEFAULT 0,                 -- 总额度
    quota_used DECIMAL(10,4) DEFAULT 0,                  -- 已用额度

    -- 模型限制
    allowed_models TEXT,                                 -- 允许的模型

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,

    INDEX idx_user_id (user_id),
    INDEX idx_package_id (package_id),
    INDEX idx_status (status),
    INDEX idx_expire_time (expire_time)
);
```

---

## 4. API 接口

### 4.1 套餐模板管理（管理员）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/packages | 获取所有套餐模板 |
| POST | /api/admin/packages | 创建套餐模板 |
| PUT | /api/admin/packages/:id | 更新套餐模板 |
| DELETE | /api/admin/packages/:id | 删除套餐模板 |

### 4.2 用户套餐管理（管理员）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/users/:user_id/packages | 获取用户的套餐列表 |
| POST | /api/admin/users/:user_id/packages | 给用户分配套餐 |
| PUT | /api/admin/user-packages/:id | 更新用户套餐 |
| DELETE | /api/admin/user-packages/:id | 删除用户套餐 |

### 4.3 用户自己的套餐

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/packages | 获取可购买的套餐列表 |
| GET | /api/my/packages | 获取我的套餐列表 |
| GET | /api/my/packages/active | 获取我的有效套餐 |

---

## 5. 核心逻辑

### 5.1 额度检查流程

```go
func (up *UserPackage) CanUse(amount float64) bool {
    // 1. 检查状态
    if up.Status != "active" {
        return false
    }

    // 2. 检查是否过期
    if up.ExpireTime != nil && time.Now().After(*up.ExpireTime) {
        return false
    }

    // 3. 按类型检查额度
    if up.Type == "subscription" {
        // 订阅类型：检查周期限额
        if up.DailyQuota > 0 && up.DailyUsed+amount > up.DailyQuota {
            return false
        }
        if up.WeeklyQuota > 0 && up.WeeklyUsed+amount > up.WeeklyQuota {
            return false
        }
        if up.MonthlyQuota > 0 && up.MonthlyUsed+amount > up.MonthlyQuota {
            return false
        }
        return true
    } else if up.Type == "quota" {
        // 额度类型：检查总额度
        return up.QuotaUsed+amount <= up.QuotaTotal
    }

    return false
}
```

### 5.2 周期重置逻辑

```go
func (up *UserPackage) ResetPeriodUsageIfNeeded() bool {
    if up.Type != "subscription" {
        return false
    }

    now := time.Now()
    today := now.Format("2006-01-02")
    thisWeek := now.Format("2006") + "-" + padWeek(week)
    thisMonth := now.Format("2006-01")

    changed := false

    // 重置每日（日期变化时）
    if up.LastResetDay != today {
        up.DailyUsed = 0
        up.LastResetDay = today
        changed = true
    }

    // 重置每周（周数变化时）
    if up.LastResetWeek != thisWeek {
        up.WeeklyUsed = 0
        up.LastResetWeek = thisWeek
        changed = true
    }

    // 重置每月（月份变化时）
    if up.LastResetMonth != thisMonth {
        up.MonthlyUsed = 0
        up.LastResetMonth = thisMonth
        changed = true
    }

    return changed
}
```

### 5.3 使用量记录

```go
func (up *UserPackage) RecordUsage(amount float64) {
    if up.Type == "subscription" {
        // 订阅类型：累加周期使用量
        up.DailyUsed += amount
        up.WeeklyUsed += amount
        up.MonthlyUsed += amount
    } else if up.Type == "quota" {
        // 额度类型：累加总使用量
        up.QuotaUsed += amount
    }
}
```

---

## 6. API Key 绑定

### 6.1 绑定方式
API Key 可以绑定到特定的用户套餐：

```go
type APIKey struct {
    // ... 其他字段
    UserPackageID *uint        `json:"user_package_id,omitempty"`    // 绑定的用户套餐ID
    BillingType   string       `json:"billing_type"`                 // quota/subscription
}
```

### 6.2 计费流程
1. 请求时获取 API Key 绑定的套餐
2. 检查套餐额度是否充足
3. 请求成功后记录使用量
4. 更新套餐的使用统计

---

## 7. 模型限制

### 7.1 限制规则
- 套餐可以限制允许使用的模型
- 字段 `allowed_models` 存储逗号分隔的模型名称
- 空值表示允许所有模型

### 7.2 检查逻辑
```go
func (up *UserPackage) IsModelAllowed(modelName string) bool {
    if up.AllowedModels == "" {
        return true  // 空=全部允许
    }
    allowed := strings.Split(up.AllowedModels, ",")
    for _, m := range allowed {
        if strings.TrimSpace(m) == modelName {
            return true
        }
    }
    return false
}
```

---

## 8. 前端界面

### 8.1 套餐管理页面 (Packages.vue)
- 套餐列表展示
- 创建/编辑套餐弹窗
- 模型多选下拉框（从系统模型列表获取）
- 订阅/额度类型动态表单

### 8.2 用户管理页面 (Users.vue)
- 用户套餐列表
- 分配套餐功能
- 编辑用户套餐（调整额度、有效期等）
- 订阅类型显示日/周/月使用情况

---

## 9. 核心代码结构

```
internal/
├── model/
│   └── package.go           # Package + UserPackage 模型
├── repository/
│   ├── package.go           # 套餐模板数据访问
│   └── user_package.go      # 用户套餐数据访问
└── handler/
    └── package.go           # 套餐管理API处理器

web/src/views/
├── Packages.vue             # 套餐管理页面
└── Users.vue                # 用户管理（含套餐分配）
```

---

## 10. 完成清单

- [x] Package 模型设计（订阅/额度两种类型）
- [x] UserPackage 模型设计
- [x] 周期额度限制（日/周/月）
- [x] 周期自动重置逻辑
- [x] 模型使用限制
- [x] 套餐模板 CRUD 接口
- [x] 用户套餐管理接口
- [x] 套餐管理前端页面
- [x] 用户套餐分配功能
- [x] 模型多选下拉框
- [ ] 套餐购买流程
- [ ] 支付集成

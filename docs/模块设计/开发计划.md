# 模块化开发计划 v2

> 核心优先：先跑通代理转发，再完善周边功能

---

## 调整后的开发顺序

```
阶段1：核心功能（Week 1-4）
├── M1 基础框架 + 简单用户（Week 1）
├── M2 账户管理（Week 2）        ← 转发需要账户
└── M3 代理转发（Week 3-4）      ← 核心！提前

阶段2：安全和配额（Week 5-7）
├── M4 API Key管理（Week 5）
├── M5 七层过滤（Week 6）
└── M6 额度管理（Week 7）

阶段3：完善功能（Week 8-10）
└── M7 统计监控（Week 8-10）
```

---

## M1 基础框架（Week 1）✅ 已完成

### 目标
搭建项目骨架，实现最简单的用户认证

### 后端 TODO ✅
- [x] 初始化 Go 项目结构
- [x] 配置 Gin 框架
- [x] 配置 MySQL + GORM
- [x] 配置 Redis
- [x] users 表 + 简单CRUD
- [x] JWT 登录/验证
- [x] 基础中间件（CORS、Logger、Recovery）

### 前端 TODO ✅
- [x] 初始化 Vue 项目
- [x] 登录页面
- [x] 基础布局框架

### 测试 TODO ✅
- [x] 数据库连接测试
- [x] JWT 验证测试

### 完成标准 ✅
- [x] 能登录，获取JWT
- [x] 前端能调通后端

---

## M2 账户管理（Week 2）✅ 已完成

### 目标
能添加和管理各类AI平台账户

### 后端 TODO ✅
- [x] accounts 表（支持10种类型）
- [x] account_groups 表
- [x] 账户 CRUD 接口
- [x] 分组管理接口
- [x] 账户状态管理
- [x] 简单的账户选择逻辑

### 前端 TODO ✅
- [x] 账户列表页面
- [x] 添加账户表单（动态表单）
- [x] 账户状态展示

### 测试 TODO ✅
- [x] 账户 CRUD 测试
- [x] 不同类型账户测试

### 完成标准 ✅
- [x] 能添加 Claude/OpenAI/Gemini 账户
- [x] 能查看账户状态

---

## M3 代理转发 ⭐核心（Week 3-4）✅ 已完成

### 目标
实现完整的多平台代理转发

### Week 3：基础转发 ✅
- [x] 统一调度器接口
- [x] Claude Official 适配器
- [x] OpenAI 适配器
- [x] 基础请求转发
- [x] 流式响应处理
- [x] 简单错误处理

### Week 4：完善转发 ✅
- [x] Claude Console 适配器
- [x] Claude CCR 适配器
- [x] Bedrock 适配器
- [x] Azure OpenAI 适配器
- [x] Gemini 适配器
- [x] 格式转换器（OpenAI ↔ Claude ↔ Gemini）
- [x] 智能路由（根据模型名）
- [x] 会话粘性（SessionID 绑定账户）
- [x] 错误重试（指数退避）
- [x] OAuth Token 自动刷新

### 前端 TODO ✅
- [x] 代理测试页面（发送请求）
- [x] 请求日志页面（分页查询、统计汇总）
- [x] 账户负载展示（时间范围筛选、成功率、Token使用量）

### 测试 TODO ✅
- [x] 各平台转发测试
- [x] 流式响应测试
- [x] 格式转换测试
- [x] 错误重试测试

### 接口清单
| 方法 | 路径 | 说明 | 状态 |
|------|------|------|------|
| POST | /api/v1/messages | Claude格式 | ✅ |
| POST | /v1/chat/completions | OpenAI格式 | ✅ |
| POST | /gemini/v1/chat | Gemini格式 | ✅ |
| GET | /admin/logs | 请求日志列表 | ✅ |
| GET | /admin/logs/summary | 请求日志统计 | ✅ |
| GET | /admin/logs/account-load | 账户负载统计 | ✅ |

### 完成标准 ✅
- [x] **能成功转发请求到各平台**
- [x] 流式响应正常
- [x] 格式转换正确

### 实现文件清单
```
internal/proxy/
├── adapter/
│   ├── adapter.go          # 适配器接口定义
│   ├── openai.go           # OpenAI 适配器
│   ├── claude.go           # Claude Official/Console 适配器（支持两种类型）
│   ├── claude_ccr.go       # Claude CCR 适配器
│   ├── bedrock.go          # AWS Bedrock 适配器
│   ├── azure.go            # Azure OpenAI 适配器
│   ├── gemini.go           # Google Gemini 适配器
│   └── converter.go        # 格式转换器（OpenAI ↔ Claude ↔ Gemini）
├── scheduler/
│   ├── scheduler.go        # 调度器（负载均衡、智能路由）
│   ├── retry.go            # 错误重试（指数退避）
│   ├── session.go          # 会话粘性管理
│   └── token.go            # OAuth Token 刷新

internal/model/
├── request_log.go          # 请求日志模型

internal/repository/
├── request_log.go          # 请求日志存储

internal/handler/
├── proxy.go                # 代理处理器
├── request_log.go          # 请求日志API
└── request_logger.go       # 异步日志记录

web/src/views/
├── ProxyTest.vue           # 代理测试页面
├── RequestLogs.vue         # 请求日志页面
└── AccountLoad.vue         # 账户负载页面
```

---

## M4 API Key管理（Week 5）

### 后端 TODO
- [ ] api_keys 表
- [ ] api_key_quotas 表
- [ ] 生成 API Key
- [ ] API Key 验证中间件
- [ ] Key 绑定账户
- [ ] Key CRUD 接口

### 前端 TODO
- [ ] API Key 列表页面
- [ ] 创建 Key 弹窗
- [ ] Key 详情和配置

### 完成标准
- [ ] 能用 API Key 调用代理接口
- [ ] Key 绑定账户生效

---

## M5 七层过滤（Week 6）

### 后端 TODO
- [ ] L0-L7 验证中间件
- [ ] Dice 相似度算法
- [ ] 验证缓存
- [ ] 配置开关

### 前端 TODO
- [ ] 安全配置页面
- [ ] 验证日志

### 完成标准
- [ ] 七层��滤可用
- [ ] 可配置开关

---

## M6 额度管理（Week 7）

### 后端 TODO
- [ ] 并发控制
- [ ] 滑动窗口限流
- [ ] 费用计算
- [ ] 使用量记录
- [ ] Redis 实时统计

### 前端 TODO
- [ ] 配额配置页面
- [ ] 使用量统计页面

### 完成标准
- [ ] 配额限制生效
- [ ] 费用计算准确

---

## M7 统计监控（Week 8-10）

### 后端 TODO
- [ ] 实时指标
- [ ] 多维度统计
- [ ] Webhook 通知
- [ ] 告警规则

### 前端 TODO
- [ ] Dashboard
- [ ] 图表展示
- [ ] 告警配置

---

## 里程碑调整

| 周 | 里程碑 | 说明 |
|---|--------|------|
| W1 | 框架搭建 | 能登录 ✅ |
| W2 | 账户就绪 | 能添加账户 ✅ |
| **W4** | **核心完成** | **能转发请求** ⭐ ✅ |
| W5 | Key可用 | 能用Key调用 |
| W6 | 安全可用 | 七层过滤生效 |
| W7 | 配额可用 | 限流生效 |
| W10 | 全部完成 | 上线就绪 |

---

## 快速验证路径

**最小可用版本（Week 4 完成）**：
1. 登录后台
2. 添加一个 Claude 账户
3. 用 curl 发送请求
4. 成功收到 AI 响应

```bash
# Week 4 能跑通这个
curl -X POST http://localhost:8080/api/v1/messages \
  -H "Content-Type: application/json" \
  -d '{"model":"claude-3-5-sonnet","messages":[{"role":"user","content":"Hello"}]}'
```

# M9 - 服务层设计

> 最后更新：2025-12-11
> 本文档详细说明 internal/service 层的设计和实现

---

## 概述

服务层（Service Layer）位于 Handler 和 Repository 之间，负责业务逻辑处理。主要职责：
- 业务逻辑封装
- 事务管理
- 缓存策略
- 定时任务

---

## 服务文件索引

| 文件 | 说明 | 核心功能 |
|------|------|----------|
| `user.go` | 用户业务服务 | 用户注册/登录/管理 |
| `account.go` | 账户业务服务 | AI账户管理、调度器刷新 |
| `api_key.go` | API Key服务 | Key生成/验证/使用量更新 |
| `usage.go` | 使用统计服务 | Redis统计、费用计算 |
| `pricing.go` | 定价计费服务 | Token费用计算 |
| `cache.go` | 缓存服务 | Redis缓存操作 |
| `config.go` | 配置服务 | 系统配置管理 |
| `sync.go` | 数据同步服务 | Redis→MySQL定时同步 |

---

## 核心服务详解

### 1. UsageService (usage.go)

使用统计服务，负责Token使用量和费用的记录与查询。

#### Redis Key 设计

```
# Token 使用量
usage:total:{userID}              # 用户总使用量 (Hash)
usage:daily:{userID}:{date}       # 用户每日使用量 (Hash)
usage:monthly:{userID}:{month}    # 用户每月使用量 (Hash)
usage:key:{apiKeyID}              # API Key 总使用量 (Hash)
usage:key:daily:{apiKeyID}:{date} # API Key 每日使用量 (Hash)
usage:key:monthly:{apiKeyID}:{month}

# 费用统计
cost:total:{userID}               # 用户总费用 (Hash)
cost:daily:{userID}:{date}        # 用户每日费用 (Hash)
cost:monthly:{userID}:{month}     # 用户每月费用 (Hash)
cost:key:{apiKeyID}               # API Key 总费用 (Hash)
cost:key:daily:{apiKeyID}:{date}
cost:key:monthly:{apiKeyID}:{month}

# 账户费用（2025-12-11新增）
cost:account:{accountID}          # 账户总费用 (Hash)
cost:account:daily:{accountID}:{date}

# 使用记录
usage:records:{userID}            # 用户使用记录 (List)
usage:records:key:{apiKeyID}      # API Key 使用记录 (List)

# 模型统计
usage:model:{userID}:{model}      # 用户按模型统计 (Hash)
```

#### 过期策略

| Key 类型 | 过期时间 |
|----------|----------|
| daily | 90天 |
| monthly | 365天 |
| records | 30天 |
| total | 永不过期 |

#### 核心方法

```go
// 增加使用量（原子操作，使用 Pipeline）
IncrementUsage(ctx, userID, apiKeyID, data *UsageData) error

// 增加费用（浮点数×1000000存储为整数，避免精度问题）
IncrementCost(ctx, userID, apiKeyID, data *CostData) error

// 增加账户费用（2025-12-11新增）
IncrementAccountCost(ctx, accountID, cost float64) error

// 记录请求（综合方法）
RecordRequest(ctx, userID, apiKeyID, log, priceRate) error

// 查询方法
GetUserUsage(ctx, userID) (*UsageData, error)
GetUserDailyUsage(ctx, userID, date) (*UsageData, error)
GetAccountCost(ctx, accountID) (float64, error)
GetAccountsCost(ctx, accountIDs []uint) (map[uint]float64, error)
```

#### 费用存储精度

费用使用整数存储（×1000000），避免浮点数精度问题：
```go
// 存储时
pipe.HIncrBy(ctx, key, "total_cost", int64(cost*1000000))

// 读取时
totalCost := float64(intVal) / 1000000
```

---

### 2. SyncService (sync.go)

数据同步服务，负责 Redis 数据定时同步到 MySQL。

#### 同步架构

```
写入流程:
请求 → recordUsage() → Redis (实时写入)
                           ↓
                      定时同步任务
                           ↓
                        MySQL (持久化)

查询流程:
前端请求 → 先查 Redis → 有数据返回
                ↓ 无数据
           查 MySQL → 返回
```

#### 配置项

通过 SystemConfig 表配置：
- `sync.enabled`: 是否启用同步 (true/false)
- `sync.interval`: 同步间隔 (最小1分钟)

#### 核心方法

```go
// 启动同步服务（单例模式）
GetSyncService() *SyncService
Start()
Stop()
Restart()

// 手动触发同步
TriggerSync()

// 获取同步状态
GetStatus() map[string]interface{}

// 配置变更回调
OnConfigChange(key, value string)
```

#### 同步内容

1. **使用记录同步** (`syncUsageRecords`)
   - 扫描 `usage:records:*` keys
   - 增量同步到 `usage_records` 表
   - 记录上次同步时间戳

2. **账户费用同步** (`syncAccountCosts`) - 2025-12-11新增
   - 扫描 `cost:account:*` keys
   - 更新 `accounts.total_cost` 字段

#### 同步流程

```go
func (s *SyncService) doSync() {
    // 1. 同步使用记录
    totalSynced := s.syncUsageRecords(ctx)

    // 2. 同步账户费用
    s.syncAccountCosts(ctx)

    // 3. 更新同步状态
    s.lastSync = time.Now()
    s.syncedCount = totalSynced
}
```

---

### 3. PricingService (pricing.go)

定价计费服务，负责计算 Token 费用。

#### 核心功能

- 根据模型名称查找定价
- 计算输入/输出/缓存 Token 费用
- 支持用户费率倍率

#### 费用计算公式

```
输入费用 = 输入Token × 输入单价 / 1000000 × 费率倍率
输出费用 = 输出Token × 输出单价 / 1000000 × 费率倍率
缓存创建费用 = 缓存创建Token × 缓存创建单价 / 1000000 × 费率倍率
缓存读取费用 = 缓存读取Token × 缓存读取单价 / 1000000 × 费率倍率
总费用 = 输入费用 + 输出费用 + 缓存创建费用 + 缓存读取费用
```

---

### 4. ConfigService (config.go)

系统配置服务，管理运行时配置。

#### 配置存储

- 持久化：MySQL `system_configs` 表
- 缓存：内存 map + Redis

#### 核心配置项

| Key | 说明 | 默认值 |
|-----|------|--------|
| `sync.enabled` | 同步服务开关 | true |
| `sync.interval` | 同步间隔(分钟) | 5 |
| `log.level` | 日志级别 | info |
| `proxy.timeout` | 代理超时(秒) | 300 |

---

### 5. AccountService (account.go)

账户业务服务，管理 AI 平台账户。

#### 关键逻辑

1. **创建账户后刷新调度器**
```go
func (s *AccountService) Create(req) (*model.Account, error) {
    // ... 创建逻辑
    scheduler.GetScheduler().Refresh() // 刷新内存缓存
    return account, nil
}
```

2. **更新/删除后同样刷新**

---

### 6. APIKeyService (api_key.go)

API Key 服务，管理密钥和使用量。

#### 核心方法

```go
// 生成新 Key
Create(userID, name, billingType) (*model.APIKey, string, error)

// 验证 Key
Validate(key string) (*model.APIKey, error)

// 增加使用量（MySQL）
IncrementUsage(keyID, tokens, cost) error

// 检查额度
CheckQuota(keyID) (bool, error)
```

---

## 定时任务汇总

| 任务 | 位置 | 间隔 | 说明 |
|------|------|------|------|
| 数据同步 | `sync.go:syncLoop()` | 可配置(默认5分钟) | Redis→MySQL |
| 限流恢复 | `scheduler.go:startRateLimitRecoveryTask()` | 1分钟 | 自动恢复过期限流账户 |

---

## 数据流图

```
                    ┌─────────────────────────────────────────────┐
                    │                  请求处理                    │
                    └─────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Handler   │───▶│   Service   │───▶│ Repository  │───▶│   MySQL     │
│  (proxy.go) │    │ (usage.go)  │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                          │
                          │ 实时写入
                          ▼
                   ┌─────────────┐
                   │    Redis    │
                   │  (统计数据)  │
                   └─────────────┘
                          │
                          │ 定时同步
                          ▼
                   ┌─────────────┐
                   │ SyncService │
                   │  (sync.go)  │
                   └─────────────┘
                          │
                          ▼
                   ┌─────────────┐
                   │   MySQL     │
                   │  (持久化)   │
                   └─────────────┘
```

---

## 变更记录

### 2025-12-11: 账户费用统计

**新增功能**：
- 账户级别费用统计
- Redis 优先查询架构
- 定时同步到 MySQL

**修改文件**：
- `internal/service/usage.go` - 添加 `IncrementAccountCost()`, `GetAccountCost()`, `GetAccountsCost()`
- `internal/service/sync.go` - 添加 `syncAccountCosts()` 同步方法
- `internal/model/account.go` - 添加 `TotalCost` 字段
- `internal/repository/account.go` - 添加 `UpdateTotalCost()` 方法
- `internal/handler/account.go` - 查询时 Redis 优先，MySQL 回退
- `internal/handler/proxy.go` - `recordUsage()` 调用 `IncrementAccountCost()`

**Redis Key**：
- `cost:account:{accountID}` - Hash: total_cost, requests
- `cost:account:daily:{accountID}:{date}` - Hash: total_cost, requests (90天过期)

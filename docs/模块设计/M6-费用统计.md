# M6 费用/使用统计模块设计

## 模块概述

费用统计模块负责记录和展示用户的 API 使用情况和费用消耗。核心设计原则：
- **用户可见**：总消费、详细使用记录（tokens、费用）
- **用户不可见**：费率倍率（PriceRate）
- **管理员功能**：设置模型基础定价、设置用户费率倍率、批量调整

## 功能列表

### 用户功能
1. 查看总使用量汇总（含今日消费）
2. 查看日期范围内每日统计
3. 查看某月使用量
4. 查看按模型统计
5. 查看使用记录列表
6. 查看 API Key 使用量

### 管理员功能
1. 查看指定用户使用汇总
2. 批量更新用户费率倍率
3. 全部用户费率更新
4. 模型定价管理

## 数据结构

### RequestLog 扩展字段

```go
type RequestLog struct {
    // ... 原有字段 ...

    // Token 统计
    InputTokens              int64 `json:"input_tokens"`
    OutputTokens             int64 `json:"output_tokens"`
    CacheCreationInputTokens int64 `json:"cache_creation_input_tokens"`
    CacheReadInputTokens     int64 `json:"cache_read_input_tokens"`
    TotalTokens              int64 `json:"total_tokens"`

    // 费用统计
    InputCost  float64 `json:"input_cost"`
    OutputCost float64 `json:"output_cost"`
    TotalCost  float64 `json:"total_cost"`
}
```

### User 费率字段

```go
type User struct {
    // ... 原有字段 ...
    PriceRate float64 `gorm:"type:decimal(10,4);default:1.0" json:"price_rate"`
}
```

### Redis 统计数据结构

```
# 总使用量 (Hash)
usage:total:{userID}
  - requests: 请求次数
  - input_tokens: 输入 token
  - output_tokens: 输出 token
  - cache_creation_input_tokens: 缓存创建 token
  - cache_read_input_tokens: 缓存读取 token
  - total_tokens: 总 token

# 日使用量 (Hash)
usage:daily:{userID}:{date}  # date 格式: 2006-01-02

# 月使用量 (Hash)
usage:monthly:{userID}:{month}  # month 格式: 2006-01

# API Key 使用量 (Hash)
usage:apikey:{apiKeyID}

# 总费用 (Hash, 金额×1000000存整数避免浮点精度问题)
cost:total:{userID}
  - input_cost: 输入费用
  - output_cost: 输出费用
  - cache_create_cost: 缓存创建费用
  - cache_read_cost: 缓存读取费用
  - total_cost: 总费用

# 日费用 (Hash)
cost:daily:{userID}:{date}

# API Key 费用 (Hash)
cost:apikey:{apiKeyID}
```

### 模型定价 (ModelPricing)

```go
type ModelPricing struct {
    ID                   uint    `gorm:"primaryKey"`
    ModelName            string  `gorm:"uniqueIndex"`
    InputPricePerMillion float64 // 输入价格 ($/百万token)
    OutputPricePerMillion float64 // 输出价格
    CacheCreatePricePerMillion float64 // 缓存创建价格
    CacheReadPricePerMillion float64 // 缓存读取价格
}
```

## API 接口设计

### 用户接口

#### 获取使用量汇总（含今日费用）
```
GET /api/usage/summary

Response:
{
    "total_tokens": 12345678,
    "total_requests": 1000,
    "total_cost": 12.3456,
    "today_cost": 1.2345
}
```

#### 获取日期范围每日统计
```
GET /api/usage/daily?start_date=2025-12-01&end_date=2025-12-09

Response:
[
    {
        "date": "2025-12-01",
        "requests": 100,
        "input_tokens": 50000,
        "output_tokens": 30000,
        "total_tokens": 80000,
        "cost": 1.2345
    },
    ...
]
```

#### 获取某月使用量
```
GET /api/usage/monthly?month=2025-12

Response:
{
    "month": "2025-12",
    "total_tokens": 1234567,
    "input_tokens": 800000,
    "output_tokens": 434567,
    "cache_creation_input_tokens": 0,
    "cache_read_input_tokens": 0,
    "total_requests": 500,
    "total_cost": 10.5678
}
```

#### 获取按模型统计
```
GET /api/usage/models

Response:
{
    "models": [
        {
            "model": "claude-sonnet-4-20250514",
            "requests": 300,
            "input_tokens": 500000,
            "output_tokens": 300000,
            "total_tokens": 800000,
            "cost": 8.1234
        },
        ...
    ]
}
```

#### 获取使用记录列表
```
GET /api/usage/records?offset=0&limit=20

Response:
{
    "records": [...],
    "offset": 0,
    "limit": 20
}
```

#### 获取 API Key 使用量
```
GET /api/api-keys/:id/usage

Response:
{
    "api_key_id": 1,
    "total_tokens": 123456,
    "input_tokens": 80000,
    "output_tokens": 43456,
    "cache_creation_input_tokens": 0,
    "cache_read_input_tokens": 0,
    "total_requests": 50,
    "total_cost": 1.2345
}
```

### 管理员接口

#### 获取指定用户使用汇总
```
GET /api/admin/users/:id/usage/summary

Response:
{
    "total_requests": 1000,
    "total_tokens": 12345678,
    "total_cost": 12.3456,
    "model_usage": [
        {
            "model": "claude-sonnet-4-20250514",
            "requests": 300,
            "tokens": 800000,
            "cost": 8.1234
        },
        ...
    ]
}
```

#### 批量更新用户费率
```
POST /api/admin/users/batch-price-rate
Content-Type: application/json

{
    "user_ids": [1, 2, 3],
    "price_rate": 1.5
}

Response:
{
    "updated_count": 3
}
```

#### 全部用户费率更新
```
POST /api/admin/users/all-price-rate
Content-Type: application/json

{
    "price_rate": 1.2
}

Response:
{
    "updated_count": 100
}
```

## 代码结构

```
internal/
├── model/
│   ├── request_log.go  # RequestLog 扩展字段
│   └── user.go         # User.PriceRate 字段
├── service/
│   ├── usage.go        # 使用统计服务
│   └── pricing.go      # 定价服务
├── handler/
│   ├── usage.go        # 使用统计处理器
│   └── user.go         # 用户管理（含费率批量更新）
└── repository/
    └── user.go         # 用户数据访问（含批量更新）

web/src/
├── views/
│   ├── Usage.vue       # 用户使用统计页面
│   └── Users.vue       # 用户管理（含批量费率调整）
├── api/
│   └── index.js        # API 接口
└── router/
    └── index.js        # 路由配置
```

## 费用计算逻辑

```go
// 计算请求费用
func CalculateCost(usage *TokenUsage, pricing *ModelPricing, userPriceRate float64) *CostResult {
    inputCost := float64(usage.InputTokens) * pricing.InputPricePerMillion / 1000000
    outputCost := float64(usage.OutputTokens) * pricing.OutputPricePerMillion / 1000000
    cacheCreateCost := float64(usage.CacheCreationInputTokens) * pricing.CacheCreatePricePerMillion / 1000000
    cacheReadCost := float64(usage.CacheReadInputTokens) * pricing.CacheReadPricePerMillion / 1000000

    totalCost := (inputCost + outputCost + cacheCreateCost + cacheReadCost) * userPriceRate

    return &CostResult{
        InputCost:       inputCost * userPriceRate,
        OutputCost:      outputCost * userPriceRate,
        CacheCreateCost: cacheCreateCost * userPriceRate,
        CacheReadCost:   cacheReadCost * userPriceRate,
        TotalCost:       totalCost,
    }
}
```

## 依赖关系

```
UsageHandler
    ├── UsageService
    │   ├── Redis (统计存储)
    │   └── RequestLogRepository (历史记录)
    └── PricingService
        └── ModelPricingRepository (模型定价)

ProxyHandler
    └── UsageService (记录使用统计)
```

## 前端页面

### 用户使用统计页面 (Usage.vue)

**功能**：
1. 总览卡片
   - 总请求数
   - 总 Token 消耗
   - 今日消费 ($)
   - 总消费 ($)

2. 每日使用统计表格
   - 日期范围选择器
   - 表格列：日期、请求数、输入Token、输出Token、总Token、费用

3. 按模型统计表格
   - 表格列：模型、请求数、输入Token、输出Token、总Token、费用、占比进度条

### 用户管理页面扩展 (Users.vue)

**新增功能**：
1. 多选用户
2. 批量设置费率按钮
3. 费率设置弹窗
4. 用户使用统计查看弹窗

## 安全考虑

1. **费率隐藏**：用户接口不返回 `price_rate` 字段
2. **权限控制**：管理员接口需要 AdminRequired 中间件
3. **数据隔离**：用户只能查看自己的数据
4. **API Key 权限**：验证 API Key 属于当前用户

## 性能优化

1. **Redis 缓存**：使用 Redis Hash 存储统计数据，支持原子增量操作
2. **金额精度**：金额乘以 1000000 存为整数，避免浮点精度问题
3. **批量操作**：支持批量更新用户费率，减少数据库交互

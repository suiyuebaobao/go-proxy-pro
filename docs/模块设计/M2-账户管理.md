# M2 账户管理模块设计

> 创建时间：2024-12-08
> 状态：已完成

---

## 1. 模块概述

### 1.1 目标
实现多平台AI账户的统一管理，支持10种不同类型的账户，为代理转发模块提供账户资源。

### 1.2 核心功能
- 多类型账户管理（10种AI平台）
- 账户分组管理
- 账户状态监控
- OAuth Token管理
- 账户健康检查

---

## 2. 支持的账户类型

| 类型代码 | 平台名称 | 认证方式 | 说明 |
|----------|----------|----------|------|
| claude_official | Claude Official | API Key | Anthropic官方API |
| claude_console | Claude Console | Session Key | Web控制台方式 |
| claude_ccr | Claude CCR | OAuth | Claude Code Runner |
| openai | OpenAI | API Key | OpenAI官方API |
| azure | Azure OpenAI | API Key | 微软Azure部署 |
| bedrock | AWS Bedrock | Access Key | AWS托管服务 |
| gemini | Google Gemini | API Key | Google AI API |
| vertex | Vertex AI | Service Account | Google Cloud AI |
| grok | Grok | API Key | xAI的Grok |
| deepseek | DeepSeek | API Key | 深度求索 |

---

## 3. 数据模型

### 3.1 账户表 (accounts)

```sql
CREATE TABLE accounts (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,                    -- 账户名称
    type VARCHAR(50) NOT NULL,                     -- 账户类型
    status VARCHAR(20) DEFAULT 'active',           -- active/disabled/error
    priority INT DEFAULT 0,                        -- 优先级（越大越优先）
    weight INT DEFAULT 1,                          -- 权重（负载均衡用）

    -- 通用凭证字段
    api_key VARCHAR(500),                          -- API Key
    api_secret VARCHAR(500),                       -- API Secret
    session_key VARCHAR(2000),                     -- Session Key
    access_token TEXT,                             -- Access Token
    refresh_token TEXT,                            -- Refresh Token
    token_expires_at TIMESTAMP,                    -- Token过期时间

    -- 平台特定配置
    endpoint VARCHAR(500),                         -- 自定义端点
    region VARCHAR(50),                            -- 区域（AWS/Azure）
    project_id VARCHAR(100),                       -- 项目ID（GCP）
    organization_id VARCHAR(100),                  -- 组织ID

    -- 配额和限制
    max_concurrency INT DEFAULT 5,                 -- 最大并发
    rate_limit INT DEFAULT 60,                     -- 每分钟请求限制
    daily_limit INT DEFAULT 0,                     -- 每日限制（0=不限）

    -- 代理设置
    proxy_url VARCHAR(500),                        -- 代理地址

    -- 统计信息
    request_count BIGINT DEFAULT 0,                -- 总请求数
    error_count BIGINT DEFAULT 0,                  -- 错误数
    total_tokens BIGINT DEFAULT 0,                 -- 总Token
    last_used_at TIMESTAMP,                        -- 最后使用时间
    last_error VARCHAR(500),                       -- 最后错误信息
    last_error_at TIMESTAMP,                       -- 最后错误时间

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,

    INDEX idx_type (type),
    INDEX idx_status (status),
    INDEX idx_priority (priority DESC)
);
```

### 3.2 账户分组表 (account_groups)

```sql
CREATE TABLE account_groups (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL
);
```

### 3.3 账户分组关联表 (account_group_members)

```sql
CREATE TABLE account_group_members (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    account_group_id BIGINT UNSIGNED NOT NULL,
    account_id BIGINT UNSIGNED NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_group_account (account_group_id, account_id)
);
```

---

## 4. API 接口

### 4.1 账户管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/accounts/types | 获取支持的账户类型 |
| GET | /api/admin/accounts | 获取账户列表 |
| GET | /api/admin/accounts/:id | 获取账户详情 |
| POST | /api/admin/accounts | 创建账户 |
| PUT | /api/admin/accounts/:id | 更新账户 |
| DELETE | /api/admin/accounts/:id | 删除账户 |
| PUT | /api/admin/accounts/:id/status | 更新账户状态 |

### 4.2 账户分组

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/account-groups | 获取分组列表 |
| GET | /api/admin/account-groups/all | 获取所有分组（不分页）|
| POST | /api/admin/account-groups | 创建分组 |
| PUT | /api/admin/account-groups/:id | 更新分组 |
| DELETE | /api/admin/account-groups/:id | 删除分组 |
| POST | /api/admin/account-groups/:id/accounts | 添加账户到分组 |
| DELETE | /api/admin/account-groups/:id/accounts/:account_id | 从分组移除账户 |

### 4.3 OAuth认证

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/admin/oauth/generate-url | 生成OAuth授权URL |
| POST | /api/admin/oauth/exchange | 交换授权码获取Token |
| POST | /api/admin/oauth/cookie-auth | Cookie方式认证 |

---

## 5. 核心代码结构

```
internal/
├── model/
│   └── account.go              # 账户模型定义
├── repository/
│   ├── account.go              # 账户数据访问
│   └── account_group.go        # 分组数据访问
├── handler/
│   ├── account.go              # 账户管理API
│   ├── account_group.go        # 分组管理API
│   └── oauth.go                # OAuth认证API
└── service/
    └── oauth/
        ├── claude_ccr.go       # Claude CCR OAuth
        └── token_refresh.go    # Token自动刷新
```

---

## 6. 账户选择策略

### 6.1 选择流程
1. 根据请求的模型类型筛选可用账户
2. 排除状态异常的账户
3. 排除达到限额的账户
4. 按优先级排序
5. 在同优先级中按权重进行负载均衡

### 6.2 负载均衡算法
- 加权轮询（Weighted Round Robin）
- 支持会话粘性（相同SessionID绑定相同账户）

---

## 7. 完成清单

- [x] 账户模型设计（支持10种类型）
- [x] 账户CRUD接口
- [x] 账户分组管理
- [x] 动态表单（根据类型显示不同字段）
- [x] 账户状态管理
- [x] OAuth授权流程
- [x] Token自动刷新
- [x] 账户列表页面
- [x] 添加/编辑账户表单

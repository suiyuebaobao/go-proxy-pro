# M3 代理转发模块设计

> 创建时间：2024-12-08
> 状态：进行中

---

## 1. 模块概述

### 1.1 目标
实现多平台AI API的统一代理转发，支持OpenAI、Claude、Gemini等多种API格式的兼容转换。

### 1.2 核心功能
- 多平台API转发
- 请求格式转换
- 流式响应处理
- Token计数与计费
- 账户负载均衡
- 请求日志记录

---

## 2. 支持的转发类型

| 源格式 | 目标平台 | 说明 |
|--------|----------|------|
| OpenAI Chat | Claude | /v1/chat/completions → Claude Messages |
| OpenAI Chat | OpenAI | 直接转发 |
| OpenAI Chat | Gemini | 格式转换转发 |
| Claude Messages | Claude | 直接转发 |
| Claude Messages | OpenAI | 格式转换（待实现）|
| OpenAI Responses | OpenAI Responses 账户 | /responses、/v1/responses 直接字节流转发 |

---

## 3. API 接口

### 3.1 代理接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /v1/chat/completions | OpenAI 兼容接口 |
| POST | /v1/messages | Claude 兼容接口 |
| GET | /v1/models | 获取可用模型列表 |
| POST | /responses | OpenAI Responses API (Codex) |
| POST | /v1/responses | OpenAI Responses API (Codex) |

### 3.2 认证方式
- Authorization: Bearer sk-xxx (API Key)
- X-API-Key: sk-xxx (备选)

---

## 4. 转发流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Client  │────▶│  Proxy   │────▶│ Selector │────▶│ Account  │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
                      │                                  │
                      │                                  ▼
                      │           ┌──────────┐     ┌──────────┐
                      └──────────▶│ Billing  │◀────│ Upstream │
                                  └──────────┘     └──────────┘
```

### 4.1 详细流程

1. **认证阶段**
   - 从请求头获取 API Key
   - 验证 Key 有效性和权限
   - 获取关联用户和套餐信息

2. **预检阶段**
   - 检查套餐额度是否充足
   - 检查模型是否允许使用
   - 检查请求频率限制

3. **账户选择**
   - 根据请求模型筛选可用账户
   - 按优先级和权重选择账户
   - 检查账户状态和限额

4. **请求转发**
   - 格式转换（如需要）
   - 添加认证信息
   - 转发到上游服务

5. **响应处理**
   - 流式/非流式响应处理
   - Token 计数
   - 格式转换（如需要）

6. **计费记账**
   - 计算费用
   - 扣减套餐额度
   - 更新使用统计
   - 记录请求日志

---

## 5. 核心代码结构

```
internal/
├── handler/
│   └── proxy.go              # 代理处理器
├── service/
│   ├── proxy/
│   │   ├── router.go         # 请求路由
│   │   ├── transformer.go    # 格式转换
│   │   └── streamer.go       # 流式处理
│   ├── account/
│   │   └── selector.go       # 账户选择器
│   └── billing/
│       ├── calculator.go     # 费用计算
│       └── recorder.go       # 记账记录
└── middleware/
    ├── ratelimit.go          # 频率限制
    └── auth.go               # 认证中间件
```

---

## 6. 负载均衡

### 6.1 账户选择算法

```go
// 选择流程
1. 筛选：状态正常 + 支持该模型
2. 排序：按优先级降序
3. 选择：同优先级按权重轮询
```

### 6.2 会话粘性
- 相同 SessionID 的请求绑定到同一账户
- 支持对话上下文连续性

#### 会话粘性实现

| 调度方法 | 说明 | 使用场景 |
|----------|------|----------|
| `SelectAccountWithSession()` | 按模型名选择，支持会话粘性 | OpenAI/Claude 代理 |
| `SelectAccountByTypeWithSession()` | 按账户类型选择，支持会话粘性 | OpenAI Responses API |
| `SelectAccountByType()` | 按账户类型选择，无会话粘性 | 简单场景 |

#### OpenAI Responses 会话粘性

```go
// Session ID 格式
sessionID := fmt.Sprintf("apikey:%d", apiKeyID)

// 调用方法
account, err := scheduler.SelectAccountByTypeWithSession(ctx,
    model.AccountTypeOpenAIResponses, sessionID, userID, apiKeyID)
```

- Redis Key: `session:binding:apikey:{apiKeyID}`
- TTL: 约 1 小时（3600秒）

---

## 7. Token 计费

### 7.1 计费公式

```
费用 = (输入Token × 输入价格 + 输出Token × 输出价格) / 1,000,000 × 价格倍率
```

### 7.2 价格来源
- 从 ai_models 表获取模型定价
- 支持缓存创建/读取价格（Claude）

---

## 8. 错误处理

| 错误码 | 说明 | 处理方式 |
|--------|------|----------|
| 401 | 认证失败 | 返回错误，不重试 |
| 429 | 频率限制 | 等待后重试或切换账户 |
| 500 | 上游错误 | 切换账户重试 |
| 503 | 服务不可用 | 标记账户异常，切换重试 |

---

## 9. 完成清单

- [x] 基础代理框架
- [x] API Key 认证
- [ ] OpenAI → Claude 格式转换
- [x] 流式响应处理 (`handleStreamResponse`)
- [x] 账户负载均衡 (`selectByWeight`)
- [x] Token 计费集成 (`CalculateCost`)
- [x] 请求日志记录 (`RequestLogger`)
- [x] 错误重试机制 (`retry.go`)
- [x] OpenAI Responses API 转发
- [x] OpenAI Responses 会话粘性支持

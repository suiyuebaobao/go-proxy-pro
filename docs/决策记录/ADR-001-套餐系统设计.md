# ADR-001: 套餐系统设计决策

> 日期：2024-12-10
> 状态：已采纳
> 决策者：开发团队

---

## 背景

系统需要实现用户付费功能，支持多种计费模式，同时需要精细化控制用户的资源使用。

## 决策点

### 1. 套餐类型设计

**问题**：如何设计套餐类型以满足不同用户需求？

**选项**：
- A. 单一额度制
- B. 单一订阅制
- C. 订阅制 + 额度制混合

**决策**：选择 C - 混合模式

**理由**：
- 订阅制适合稳定使用的用户，提供可预期的费用
- 额度制适合偶尔使用的用户，按需付费更灵活
- 两种模式可以覆盖更广的用户群体

---

### 2. 周期额度限制粒度

**问题**：订阅套餐应该支持哪些周期的额度限制？

**选项**：
- A. 只有月度限制
- B. 只有日度限制
- C. 日/周/月三级限制

**决策**：选择 C - 三级限制

**理由**：
- 日限制：防止单日过度使用，保护账户安全
- 周限制：平滑周内使用波动
- 月限制：总体额度控制
- 用户可以设置 0 表示不限制，灵活配置

**实现细节**：
```go
DailyQuota   float64  // 每日额度（0=不限）
WeeklyQuota  float64  // 每周额度（0=不限）
MonthlyQuota float64  // 每月额度（0=不限）
```

---

### 3. 额度重置策略

**问题**：周期额度何时重置？如何处理时区？

**选项**：
- A. 固定UTC时间重置
- B. 用户时区重置
- C. 惰性重置（使用时检查）

**决策**：选择 C - 惰性重置

**理由**：
- 实现简单，无需后台定时任务
- 每次使用前检查是否需要重置
- 通过记录 last_reset_day/week/month 来判断
- 避免时区复杂性

**实现**：
```go
func (up *UserPackage) ResetPeriodUsageIfNeeded() bool {
    today := time.Now().Format("2006-01-02")
    if up.LastResetDay != today {
        up.DailyUsed = 0
        up.LastResetDay = today
    }
    // ... 周、月类似
}
```

---

### 4. 模型限制存储方式

**问题**：如何存储允许使用的模型列表？

**选项**：
- A. 关联表（多对多）
- B. JSON 数组字段
- C. 逗号分隔字符串

**决策**：选择 C - 逗号分隔字符串

**理由**：
- 模型数量有限（通常 < 50）
- 实现简单，查询方便
- 前端处理便捷（split/join 转换）
- 避免复杂的关联查询

**示例**：
```
allowed_models = "claude-opus-4-5-20251101,claude-sonnet-4-5-20250929,gpt-4.1"
```

---

### 5. API Key 与套餐绑定

**问题**：如何将 API Key 与套餐关联？

**选项**：
- A. API Key 直接包含额度字段
- B. API Key 绑定到用户套餐
- C. 按用户整体计费

**决策**：选择 B - 绑定用户套餐

**理由**：
- 一个用户可以有多个套餐（不同用途）
- 一个用户可以有多个 API Key
- API Key 可以选择绑定特定套餐
- 灵活支持多场景使用

**数据结构**：
```go
type APIKey struct {
    UserPackageID *uint   // 绑定的用户套餐ID（可选）
    BillingType   string  // quota/subscription
}
```

---

### 6. 额度单位

**问题**：额度使用什么单位？

**选项**：
- A. Token 数量
- B. 请求次数
- C. 美元金额

**决策**：选择 C - 美元金额

**理由**：
- 不同模型 Token 价格差异大
- 金额是统一的计量标准
- 用户更容易理解消费情况
- 方便与定价体系对接

---

## 后续考虑

1. **套餐购买流程**：需要集成支付系统
2. **套餐续费**：自动续费或手动续费策略
3. **超额处理**：额度用完后的行为（停止服务 vs 降级）
4. **退款机制**：未使用额度的退款策略

---

## 相关文档

- [M8-套餐系统模块设计](../模块设计/M8-套餐系统.md)
- [M1-基础框架](../模块设计/M1-基础框架.md)

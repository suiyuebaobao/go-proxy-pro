# 开发日志 2025-12-16

## 今日工作

### 1. 系统日志功能扩展 - 支持服务器日志查看

**需求**: 在系统日志模块中增加查看服务器系统日志的功能（如 `/var/log/auth.log`、`/var/log/syslog` 等），方便在管理后台直接查看 SSH 登录尝试、系统事件等。

**实现方案**:
- 后端增加服务器日志支持，使用白名单机制限制可访问的日志文件（安全考虑）
- 前端增加 Tab 切换，区分"应用日志"和"服务器日志"
- 服务器日志禁止删除操作

**修改文件**:
- `internal/handler/system_log.go` - 增加服务器日志支持
- `web/src/views/SystemLogs.vue` - 增加 Tab 切换 UI
- `web/src/api/index.js` - API 方法增加 source 参数

**关键代码**:

```go
// system_log.go - 服务器日志白名单
type SystemLogHandler struct {
    appLogDir    string
    serverLogDir string
    allowedServerLogs map[string]string  // 白名单
}

func NewSystemLogHandler() *SystemLogHandler {
    return &SystemLogHandler{
        appLogDir:    "logs",
        serverLogDir: "/var/log",
        allowedServerLogs: map[string]string{
            "auth.log":       "SSH认证日志",
            "auth.log.1":     "SSH认证日志(旧)",
            "syslog":         "系统日志",
            "syslog.1":       "系统日志(旧)",
            "kern.log":       "内核日志",
            "kern.log.1":     "内核日志(旧)",
            "dpkg.log":       "软件包日志",
            "fail2ban.log":   "Fail2ban日志",
            "nginx/access.log":  "Nginx访问日志",
            "nginx/error.log":   "Nginx错误日志",
            "mysql/error.log":   "MySQL错误日志",
        },
    }
}
```

```vue
<!-- SystemLogs.vue - Tab 切换 -->
<el-tabs v-model="logSource" @tab-change="handleSourceChange" class="log-tabs">
  <el-tab-pane label="应用日志" name="app">
    <template #label>
      <span><el-icon><Files /></el-icon> 应用日志</span>
    </template>
  </el-tab-pane>
  <el-tab-pane label="服务器日志" name="server">
    <template #label>
      <span><el-icon><Monitor /></el-icon> 服务器日志</span>
    </template>
  </el-tab-pane>
</el-tabs>
```

### 2. 前端 API 响应处理修复

**问题**: 系统日志页面显示 0 个文件

**原因**: 前端获取 API 响应数据时路径错误，使用 `res.files` 而非 `res.data.files`

**修复**:
```javascript
// 修复前
files.value = res.files || []

// 修复后
files.value = res.data?.files || []
```

---

## 技术要点

### 服务器日志安全访问
- 使用白名单机制，只允许访问预定义的日志文件
- 禁止服务器日志删除操作
- 路径安全检查，防止目录遍历攻击

### API source 参数
所有系统日志 API 都支持 `source` 参数：
- `source=app` - 应用日志（默认，`logs/` 目录）
- `source=server` - 服务器日志（`/var/log/` 目录，白名单限制）

---

## 明日计划

### 1. 功能完善
- [ ] 检查其他页面是否有类似的 API 响应处理问题
- [ ] 考虑增加更多服务器日志文件到白名单

### 2. 文档维护
- [ ] 持续更新开发文档

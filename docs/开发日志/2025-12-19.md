# 开发日志 2025-12-19

## 完成的工作

### 1. OpenAI Responses 接口多账户类型支持

**问题描述**：
- `/responses` 接口只选择 `openai-responses` 类型账户
- 第三方 OpenAI API（类型为 `openai`）无法被选中
- 导致 503 Service Unavailable 错误

**修复方案**：
1. 调度器新增 `SelectAccountByTypesWithSession()` 方法
2. 支持从多个账户类型中选择账户
3. 保持会话粘性功能

**修改文件**：
- `internal/proxy/scheduler/scheduler.go` - 新增多类型选择方法
- `internal/handler/openai_responses.go` - 使用多类型选择

### 2. OpenAI Responses 会话粘性完善

**实现功能**：
- 会话哈希生成：基于 Session_id 请求头 > instructions 字段 > 第一条消息内容
- 会话绑定：将会话与账户绑定到 Redis
- 自动路由：后续相同会话的请求路由到同一账户

**相关代码**：
- `generateSessionHash()` 方法实现会话哈希生成
- 支持 Codex CLI 的 Session_id 请求头

## 文档更新

1. **新增 BUG 记录**：
   - `docs/BUG处理/2025-12-19-OpenAI-Responses接口账户类型选择修复.md`

2. **更新代码索引**：
   - `docs/代码索引.md` - 添加变更记录和更新索引

3. **更新决策记录**：
   - `docs/决策记录/ADR-002-会话粘性设计.md` - 添加新方法说明

## 测试验证

测试场景：
1. 使用 `openai-responses` 类型账户（ChatGPT 官方）调用 `/responses` - 成功
2. 使用 `openai` 类型账户（第三方 API）调用 `/responses` - 成功
3. 会话粘性：同一 Session_id 的请求路由到同一账户 - 成功

测试日志：
```
[INFO] [openai-responses] 选中账户 - ID: 27, Name: 其他家的api测试, BaseURL: https://coordcode.com/openai
[INFO] [openai-responses] 转发目标 - TargetURL: https://coordcode.com/openai/responses
[INFO] [openai-responses] Stream 完成 - Model: gpt-5.1-codex-max, InputTokens: 3610, OutputTokens: 15
```

## 技术要点

### 多类型账户选择实现

```go
// SelectAccountByTypesWithSession 根据多个账户类型选择（支持会话粘性）
func (s *Scheduler) SelectAccountByTypesWithSession(ctx context.Context, accountTypes []string, sessionID string, userID uint, apiKeyID uint) (*model.Account, error) {
    // 获取所有类型的账户
    var allAccounts []model.Account
    for _, accountType := range accountTypes {
        accounts, err := s.repo.GetEnabledByType(accountType)
        if err == nil {
            allAccounts = append(allAccounts, accounts...)
        }
    }
    // ... 会话粘性逻辑 ...
}
```

### 会话哈希生成优先级

1. `Session_id` 请求头（Codex CLI 提供）
2. `instructions` 字段（类似 system prompt）
3. 第一条 input 消息内容

---

### 3. 账号健康检查服务

**功能描述**：
定期检查 OAuth/SessionKey 类型账号的有效性，自动禁用连续错误达到阈值的账号。

**适用账号类型**：
- `claude-official` - Claude Official（支持 OAuth 和 SessionKey）
- `openai-responses` - OpenAI Responses（支持 API Key 和 ChatGPT OAuth Token）
- `gemini` - Google Gemini（使用 OAuth Token）

**不检查的账号类型**：
- `openai` - 第三方 API Key（由第三方管理）
- `claude` - Claude API Key（由 Anthropic 管理）
- `azure` / `bedrock` - 云平台账号（由云平台管理）

**验证方式**：
| 账号类型 | 认证方式 | 验证端点 | 说明 |
|----------|----------|----------|------|
| claude-official | OAuth (AccessToken) | `GET /api/oauth/usage` | 优先验证 |
| claude-official | SessionKey | `GET /api/organizations` | OAuth失败时回退 |
| openai-responses | API Key | `GET /v1/models` | 标准 API 验证 |
| openai-responses | ChatGPT OAuth | `GET /backend-api/accounts/check` | JWT Token 验证 |
| gemini | OAuth | `GET /v1beta/models` | 模型列表验证 |

**错误处理逻辑**：
- 检查通过：重置连续错误计数为 0
- 检查失败：连续错误计数 +1
- 429 限流：视为有效（账号本身可用，只是限流）
- 达到阈值：自动禁用账号并刷新调度器缓存

**实现文件**：
- `internal/service/health_check.go` - 健康检查服务
- `internal/service/config.go` - 配置便捷方法
- `internal/model/account.go` - ConsecutiveErrorCount 字段
- `internal/repository/account.go` - 数据库操作方法

**新增配置项**：
| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `account_health_check_enabled` | 是否启用健康检查 | false |
| `account_health_check_interval` | 检查间隔（分钟） | 5 |
| `account_error_threshold` | 连续错误阈值 | 5 |

**前端界面**：
- `web/src/views/Settings.vue` - 系统设置页新增健康检查配置卡片

### 4. ChatGPT OAuth Token 验证支持

**需求背景**：
OpenAI Responses 账号（如 112233、223344）使用 ChatGPT OAuth Token 认证，之前健康检查只支持 API Key 验证，导致这类账号无法被正确验证。

**实现方案**：
参考 `clove/utils/openai_account_helper.py` 项目，通过 ChatGPT 后台 API 验证 OAuth Token：

```go
// 验证端点
url := "https://chatgpt.com/backend-api/accounts/check/v4-2023-04-27"

// 请求头
req.Header.Set("Authorization", "Bearer "+token)
req.Header.Set("Accept", "*/*")
req.Header.Set("Content-Type", "application/json")
```

**修改文件**：
- `internal/service/health_check.go`
  - 新增 `checkChatGPTOAuth()` 方法
  - 修改 `checkOpenAIResponses()` 支持 API Key 和 OAuth Token 双重验证

**验证逻辑**：
1. 检测 Token 格式：JWT 格式（以 `eyJ` 开头）判定为 OAuth Token
2. OAuth Token：调用 ChatGPT backend-api 验证
3. API Key：调用 OpenAI /v1/models 验证

**测试结果**：
```log
[DEBUG] [health_check] [223344] ChatGPT OAuth 验证成功，账户数: 1
[DEBUG] [health_check] [112233] ChatGPT OAuth 验证成功，账户数: 1
```

---

## 文档更新

按照 README 规范完成以下文档更新：

1. **代码索引.md** - 更新健康检查服务变更记录
2. **功能模块索引.md** - 更新验证方式表
3. **开发日志/2025-12-19.md** - 记录今日工作
4. **README.md** - 文档更新记录

---

## 明日计划

### 1. 健康检查功能完善
- [ ] 添加手动触发健康检查的 API
- [ ] 前端添加健康检查状态展示

### 2. 账号管理优化
- [ ] 账号状态可视化改进
- [ ] 批量操作支持

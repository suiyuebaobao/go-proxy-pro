# 开发日志 - 2025-12-09

## 今日工作

### 已完成
- [x] 实现用户 API Key 管理功能
- [x] 后端：API Key 生成、验证、CRUD 接口
- [x] 前端：API Key 管理页面（创建、列表、删除、启用/禁用）
- [x] 代理接口：添加 API Key 认证中间件
- [x] 修复 Claude Console/CCR/Bedrock 平台认证类型判断问题
- [x] 修复账户列表创建后不自动刷新的问题
- [x] 创建项目 README.md 文档

### 详细说明

#### 1. API Key 管理模块
完成了完整的用户 API Key 管理功能：

**后端实现：**
- `internal/model/api_key.go` - 数据模型，包含 Key 生成和哈希函数
- `internal/repository/api_key.go` - 数据访问层
- `internal/service/api_key.go` - 业务逻辑层
- `internal/handler/api_key.go` - HTTP 处理器
- `internal/middleware/api_key.go` - API Key 认证中间件

**前端实现：**
- `web/src/views/APIKeys.vue` - API Key 管理页面
- `web/src/api/index.js` - 添加 API Key 相关接口

**功能特性：**
- API Key 使用 SHA256 哈希存储，只在创建时显示一次完整 Key
- 支持设置允许的平台、模型、速率限制、过期时间
- 每个用户最多创建 10 个 API Key
- 支持启用/禁用状态切换

#### 2. 代理接口认证
所有代理接口现在都需要有效的 API Key：
- `/v1/chat/completions` - OpenAI 兼容接口
- `/api/v1/messages` - Claude 原生接口
- `/gemini/v1/chat` - Gemini 接口

认证方式：
```bash
curl http://localhost:8080/v1/chat/completions \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model": "claude-sonnet-4-20250514", "messages": [...]}'
```

#### 3. Bug 修复

**问题1：Claude Console/CCR/Bedrock 平台无法正常添加账户**
- 原因：选择这些平台时，`form.addType` 仍然是 `cookie`，导致进入错误的 OAuth 流程
- 解决：在 watch 函数中为 `claude-console`、`claude-ccr`、`bedrock`、`azure-openai` 设置 `form.addType = 'apikey'`

**问题2：账户列表创建后不刷新**
- 原因：alova 默认启用缓存
- 解决：在 alova 实例配置中添加 `cacheFor: null` 禁用缓存

## 问题与解决

### 问题1：package go-aiproxy/internal/database is not in std
- 描述：API Key Service 中错误引用了不存在的 database 包
- 解决：改用 `repository.NewAPIKeyRepository()` 模式，与其他 service 保持一致

### 问题2：OAuth 流程步骤指示器显示逻辑
- 描述：步骤指示器只在 `oauth` 或 `setup-token` 时显示
- 解决：改用 `needsOAuth` 计算属性来判断是否显示步骤指示器

## 文件变更

### 新增文件
- `internal/repository/api_key.go`
- `internal/service/api_key.go`
- `internal/handler/api_key.go`
- `internal/middleware/api_key.go`
- `web/src/views/APIKeys.vue`
- `README.md`

### 修改文件
- `internal/handler/routes.go` - 添加 API Key 路由和代理认证中间件
- `web/src/api/index.js` - 禁用缓存，添加 API Key 接口
- `web/src/router/index.js` - 添加 /api-keys 路由
- `web/src/layouts/MainLayout.vue` - 添加菜单项
- `web/src/components/AccountForm.vue` - 修复平台类型判断

### 4. 日志系统优化（上午）

**问题**：日志输出到控制台而不是日志文件

**解决**：
- `internal/repository/mysql.go` - GORM 设置 Silent 模式
- `cmd/server/main.go` - Gin 设置 ReleaseMode
- `internal/middleware/logger.go` - 使用自定义 logger
- `internal/middleware/recovery.go` - 使用自定义 logger
- `internal/repository/migrate.go` - 使用自定义 logger
- `internal/middleware/api_key.go` - 添加认证日志

### 5. 代理测试页面优化

**问题**：代理测试需要用户输入 API Key

**解决**：创建管理员内部测试端点
- `internal/handler/proxy.go` - 添加 `TestProxy` 方法
- `internal/handler/routes.go` - 添加 `/api/admin/proxy/test` 路由
- `web/src/views/ProxyTest.vue` - 使用管理员测试端点

### 6. Claude 适配器简化

**背景**：作为代理中转服务，应该简单透传客户端请求

**变更**：
- `internal/proxy/adapter/claude.go` - 恢复到简单透传模式
- 移除多余的 metadata 和 system prompt 构造
- 只设置基本 headers：`Content-Type`、`anthropic-version`、认证头
- 直接透传原始请求体

## 文件变更补充

### 新增/修改文件（日志优化）
- `internal/repository/mysql.go` - GORM Silent 模式
- `cmd/server/main.go` - Gin ReleaseMode
- `internal/middleware/logger.go` - 自定义 logger
- `internal/middleware/recovery.go` - 自定义 logger
- `internal/repository/migrate.go` - 自定义 logger
- `internal/middleware/api_key.go` - 认证日志

### 新增/修改文件（代理测试）
- `internal/handler/proxy.go` - TestProxy 方法
- `internal/handler/routes.go` - 管理员测试路由
- `web/src/views/ProxyTest.vue` - 前端测试页面

### 修改文件（Claude 适配器）
- `internal/proxy/adapter/claude.go` - 简化为透传模式

### 7. 费用/使用统计系统（M6 额度管理）

**需求**：
- 用户可见：总消费、详细使用记录（tokens、费用），但**不可见费率倍率**
- 管理员：设置模型基础定价、设置用户费率倍率（对用户隐藏）、批量调整倍率

**后端实现：**

**新增/修改文件：**
- `internal/model/request_log.go` - 扩展 RequestLog 模型，添加 token 和费用字段
- `internal/service/usage.go` - Redis 使用统计服务
- `internal/service/pricing.go` - 定价服务
- `internal/handler/usage.go` - 使用统计处理器
- `internal/handler/user.go` - 添加批量费率更新方法
- `internal/repository/user.go` - 用户费率批量更新
- `internal/handler/routes.go` - ��增路由

**核心数据结构：**
```go
// RequestLog 扩展字段
InputTokens              int64   // 输入 token
OutputTokens             int64   // 输出 token
CacheCreationInputTokens int64   // 缓存创建 token
CacheReadInputTokens     int64   // 缓存读取 token
TotalTokens              int64   // 总 token
InputCost                float64 // 输入费用
OutputCost               float64 // 输出费用
TotalCost                float64 // 总费用

// User 费率字段
PriceRate float64 `gorm:"type:decimal(10,4);default:1.0"` // 用户费率倍率
```

**Redis 统计 Key 设计：**
```
usage:total:{userID}           # 总使用量 (Hash)
usage:daily:{userID}:{date}    # 日使用量 (Hash)
usage:monthly:{userID}:{month} # 月使用量 (Hash)
usage:apikey:{apiKeyID}        # API Key 使用量 (Hash)
cost:total:{userID}            # 总费用 (Hash, 金额×1000000存整数)
cost:daily:{userID}:{date}     # 日费用 (Hash)
```

**API 端点：**

管理员接口：
- `POST /api/admin/users/batch-price-rate` - 批量更新用户费率
- `POST /api/admin/users/all-price-rate` - 全部用户费率更新
- `GET /api/admin/users/:id/usage/summary` - 获取指定用户使用汇总

用户接口：
- `GET /api/usage/summary` - 获取使用汇总（含今日费用）
- `GET /api/usage/daily` - 日期范围每日统计
- `GET /api/usage/monthly` - 某月使用量
- `GET /api/usage/stats` - 日期范围统计
- `GET /api/usage/records` - 使用记录列表
- `GET /api/usage/models` - 按模型统计

**前端实现：**

**新增/修改文件：**
- `web/src/views/Usage.vue` - 用户使用统计页面（新建）
- `web/src/views/Users.vue` - 添加批量费率调整和用户使用统计查看
- `web/src/api/index.js` - 添加新接口
- `web/src/router/index.js` - 添加 Usage 路由
- `web/src/layouts/MainLayout.vue` - 添加导航菜单

**功能特性：**
1. **用户使用统计页面**：
   - 总览卡片：总请求数、总 Token、今日消费、总消费
   - 每日使用表格：支持日期范围筛选
   - 按模型统计：显示各模型使用量和费用占比

2. **管理员批量费率管理**：
   - 多选用户
   - 批量设置费率倍率
   - 查看用户使用统计弹窗

**设计决策：**
- 用户只能看到费用，不能看到费率倍率（业务需求）
- 费用在 Redis 中以整数存储（×1000000），避免浮点精度问题
- StreamResult 适配器接口返回 token 使用量

## 文件变更补充（费用统计）

### 新增文件
- `internal/service/usage.go` - 使用统计服务
- `internal/service/pricing.go` - 定价服务
- `web/src/views/Usage.vue` - 用户使用统计页面

### 修改文件
- `internal/model/request_log.go` - 扩展字段
- `internal/model/user.go` - 添加 PriceRate 字段
- `internal/handler/usage.go` - 新增处理方法
- `internal/handler/user.go` - 批量费率更新
- `internal/handler/routes.go` - 新增路由
- `internal/repository/user.go` - 批量更新方法
- `internal/proxy/handler/proxy.go` - 集成使用统计
- `web/src/views/Users.vue` - 批量费率和使用统计
- `web/src/api/index.js` - 新接口
- `web/src/router/index.js` - Usage 路由
- `web/src/layouts/MainLayout.vue` - 导航菜单

## 明日计划
- [ ] 完善 API Key 的权限控制（平台/模型级别）
- [ ] 添加速率限制功能实现
- [ ] 完善模型定价管理页面
- [ ] 编写接口文档

---

## 下午补充工作（续）

### 8. 管理员 API Key 管理页面

**需求**：管理员需要查看所有用户的 API Key，并能查看每个 Key 的使用日志

**后端实现：**
- `internal/handler/api_key.go` - 添加 `AdminListAll`、`AdminGetAPIKeyLogs` 方法
- `internal/service/api_key.go` - 添加 `AdminListAll`、`GetAPIKeyLogs` 方法
- `internal/repository/api_key.go` - 添加 `ListAllWithUser`、`GetAPIKeyLogs` 方法
- `internal/handler/routes.go` - 添加 `/api/admin/api-keys` 和 `/api/admin/api-keys/:id/logs` 路由

**前端实现：**
- `web/src/views/APIKeys.vue` - 重构为管理员 API Key 管理页面
- `web/src/api/index.js` - 添加 `adminGetAllAPIKeys`、`adminGetAPIKeyLogs` 方法
- `web/src/router/index.js` - 添加 `/api-keys` 路由
- `web/src/layouts/MainLayout.vue` - 添加 "API Key 管理" 菜单项

**功能特性：**
- 显示所有用户的 API Key 列表
- 每个 Key 显示用户账号标签
- 显示请求数、费用统计
- 支持查看详细使用日志（从 Redis 读取）
- 支持启用/禁用、删除操作

### 9. API Key 使用统计同步到 MySQL

**问题**：API Key 的请求数和费用只在 Redis 中统计，MySQL 中的 `request_count`、`tokens_used`、`cost_used` 字段始终为 0

**解决方案**：
- `internal/handler/proxy.go` - 添加 `apiKeyService` 依赖
- 在 `recordUsage` 函数中调用 `h.apiKeyService.IncrementUsage()` 同步统计到 MySQL
- 每次请求完成后自动更新 API Key 的统计数据

**修改文件：**
- `internal/handler/proxy.go` - ProxyHandler 添加 apiKeyService，recordUsage 中调用 IncrementUsage

### 10. 多节点部署架构分析

**背景**：讨论了系统在多节点部署下的架构设计

**分析的架构方案**：
1. 共享 MySQL + 共享 Redis（需要改造）
2. 共享 MySQL + 独立 Redis（当前选择）
3. 完全独立（每节点独立 MySQL + Redis）

**当前架构选择**：共享 MySQL + 每节点独立 Redis

```
┌─────────────────────────────────────────────────────────────┐
│                        负载均衡器                           │
└─────────────────────────┬───────────────────────────────────┘
                          │
      ┌───────────────────┼───────────────────┐
      │                   │                   │
      ▼                   ▼                   ▼
┌───────────┐       ┌───────────┐       ┌───────────┐
│  节点 A   │       │  节点 B   │       │  节点 C   │
├───────────┤       ├───────────┤       ├───────────┤
│ AIProxy   │       │ AIProxy   │       │ AIProxy   │
│ Redis(本地)│       │ Redis(本地)│       │ Redis(本地)│
└─────┬─────┘       └─────┬─────┘       └─────┬─────┘
      │                   │                   │
      └───────────────────┼───────────────────┘
                          │
                          ▼
               ┌─────────────────────┐
               │    共享 MySQL       │
               └─────────────────────┘
```

**数据分布：**
| 共享（MySQL） | 独立（Redis） |
|--------------|--------------|
| 用户、账户数据 | 会话绑定 |
| API Key | 实时统计缓存 |
| 每日汇总统计 | 并发计数 |
| 配置信息 | 临时不可用标记 |

**部署建议**：负载均衡配置 IP Hash，确保同一用户的请求始终路由到同一节点

## 文件变更补充（下午）

### 新增/修改文件
- `internal/handler/api_key.go` - AdminListAll, AdminGetAPIKeyLogs
- `internal/service/api_key.go` - AdminListAll, GetAPIKeyLogs
- `internal/repository/api_key.go` - ListAllWithUser, GetAPIKeyLogs, 添加 Redis 依赖
- `internal/handler/routes.go` - 管理员 API Key 路由
- `internal/handler/proxy.go` - 添加 apiKeyService，统计同步到 MySQL
- `web/src/views/APIKeys.vue` - 管理员 API Key 管理页面
- `web/src/api/index.js` - adminGetAllAPIKeys, adminGetAPIKeyLogs
- `web/src/router/index.js` - api-keys 路由
- `web/src/layouts/MainLayout.vue` - API Key 管理菜单

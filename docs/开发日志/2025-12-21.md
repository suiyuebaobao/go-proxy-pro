# 开发日志 2025-12-21

## 完成的工作

### 1. SSE 错误事件检测与重试机制

**问题描述**：
- Claude 流式请求出现断流
- 日志显示 `总行数: 3 | InputTokens: 0 | OutputTokens: 0`
- 流异常结束，客户端收到不完整响应

**根本原因**：
上游返回 HTTP 200 但发送 SSE 错误事件：
```
event: error
data: {"type":"error","error":{"type":"permission_error","message":"Permission denied"}}
```
原代码没有检测 SSE 错误事件，直接透传给客户端导致流异常结束。

**修复方案**：
1. 缓冲首个 `event:` 行，等到看到 `data:` 行再决定是否发送
2. 如果首个事件是 `error` 类型，不写入客户端，直接返回错误触发重试
3. 在重试逻辑中添加 SSE 错误类型作为可重试错误

**修改文件**：

`internal/proxy/adapter/claude.go`:
- 第220-224行: 新增调试和事件缓冲变量
  ```go
  var debugLines []string   // 记录前几行用于调试
  var lastEventType string  // 记录上一个 event 类型
  var firstEventChecked bool // 是否已检查首个事件
  var pendingEventLine []byte // 缓冲的 event 行
  ```
- 第250-258行: 检测 event 类型并缓冲，不立即写入
- 第265-280行: 检测首个事件是否为错误，是则返回错误触发重试
- 第282-288行: 首个事件检查完毕后写入缓冲的 event 行
- 第317-320行: 短流调试日志

`internal/proxy/scheduler/retry.go`:
- 第480-493行: `isConnectionError()` 方法新增 SSE 可重试错误类型
  ```go
  sseRetryableErrors := []string{
      "permission_error",
      "authentication_error",
      "overloaded_error",
      "rate_limit_error",
      "api_error",
  }
  ```

**调试日志**：
- `Claude Stream 行数异常少 | 总行数: %d | 内容: %v` - 记录短流的内容
- `Claude Stream 首个事件为错误 | Type: %s | Message: %s` - 检测到 SSE 错误

**待解决问题**：
断流问题可能仍存在，需要进一步排查：
1. 上游服务返回 `permission_error` 的原因需要分析
2. 只有单个账户时无法切换重试
3. 可能需要添加更多 SSE 错误类型到可重试列表

---

### 2. ClaudeConsole (API Key) 账户移除限流处理

**问题描述**：
用户要求对 API Key 模式（ClaudeConsole 类型）的账户不进行限流处理，因为 API Key 模式由上游直接控制限流。

**修复方案**：
1. 不提取 ClaudeConsole 账户的限流响应头
2. 不对 ClaudeConsole 账户执行限流状态标记

**修改文件**：

`internal/proxy/adapter/claude.go`:
- 第98-101行 (`Send` 方法): 跳过 API Key 模式的限流头提取
  ```go
  if account.Type != model.AccountTypeClaudeConsole {
      response.Headers = extractRateLimitHeaders(resp.Header)
  }
  ```
- 第154-157行 (`SendStream` 方法): 同上

`internal/proxy/scheduler/scheduler.go`:
- 第351-356行 (`MarkAccountErrorWithReset` 方法): API Key 模式跳过限流标记
  ```go
  if accountType == model.AccountTypeClaudeConsole {
      // API Key 模式只记录错误，不改变状态
      s.repo.IncrementErrorCount(accountID)
      return
  }
  ```

**额外处理**：
- 清理数据库中已存在的 ClaudeConsole 账户的 `rate_limit_reset_at` 历史数据
- SQL: `UPDATE accounts SET rate_limit_reset_at = NULL WHERE type = 'claude-console';`

---

## 技术要点

### SSE 首个事件缓冲机制

```go
// 1. 检测 event 类型
if strings.HasPrefix(lineStr, "event: ") {
    lastEventType = strings.TrimPrefix(lineStr, "event: ")
    if !firstEventChecked {
        // 缓冲 event 行，不立即写入
        pendingEventLine = make([]byte, len(line))
        copy(pendingEventLine, line)
        continue
    }
}

// 2. 检测 data 行时判断是否为错误
if strings.HasPrefix(lineStr, "data: ") {
    if !firstEventChecked && lastEventType == "error" {
        // 解析错误内容
        var errEvent struct { ... }
        if json.Unmarshal(...) == nil && errEvent.Type == "error" {
            // 不写入客户端，返回错误触发重试
            return result, NewUpstreamError(500, errMsg)
        }
    }
    // 写入缓冲的 event 行
    if !firstEventChecked && len(pendingEventLine) > 0 {
        writer.Write(pendingEventLine)
        writer.Write([]byte("\n"))
    }
    firstEventChecked = true
}
```

### 账户类型区分处理

| 账户类型 | 认证方式 | 限流处理 |
|----------|----------|----------|
| `claude-official` | OAuth Token / SessionKey | 提取限流头，标记限流状态 |
| `claude-console` | API Key | 不处理，由上游控制 |

---

## 文档更新

1. **代码索引.md** - 新增两个变更记录章节
2. **开发日志/2025-12-21.md** - 本文件

---

## 已知问题

### 断流问题未完全解决

**现象**：
- SSE 错误检测已实现
- 重试机制已添加 SSE 错误类型
- 但用户反馈仍有断流

**可能原因**：
1. 只有单个账户可用，重试时无法切换到其他账户
2. 上游服务 `permission_error` 是持续性问题
3. 需要更多调试日志确认问题根源

**建议排查**：
1. 检查账户配置是否正确
2. 查看上游服务的 OAuth Token 是否有效
3. 添加更多日志确认 SSE 错误检测是否生效
4. 考虑添加账户自动禁用机制

---

## 明日计划

### 1. 断流问题继续排查
- [ ] 分析上游 `permission_error` 的根因
- [ ] 确认 SSE 错误检测逻辑是否正确触发
- [ ] 考虑添加更多可重试的 SSE 错误类型

### 2. 健康检查优化
- [ ] 针对频繁返回 `permission_error` 的账号自动降级
- [ ] 添加账号有效性预检机制

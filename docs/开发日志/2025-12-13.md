# 开发日志 2025-12-13

## 今日工作

### 1. 用户统计按套餐分别显示（功能优化）

**问题**: 用户管理页面点击"统计"只显示汇总数据，没有按套餐分别显示

**优化**:
- `internal/handler/usage.go` - `AdminGetUserUsageSummary` 新增 `package_usage` 返回
- `web/src/views/Users.vue` - 统计弹窗新增"套餐使用情况"表格

**后端修改**:
```go
// handler/usage.go - AdminGetUserUsageSummary 新增
userPackages, _ := h.userPackageRepo.GetByUserID(uint(userID))
packageUsage := make([]gin.H, 0, len(userPackages))
for _, up := range userPackages {
    pkgInfo := gin.H{
        "id":     up.ID,
        "name":   up.Name,
        "type":   up.Type,
        "status": up.Status,
    }

    if up.Type == "subscription" {
        pkgInfo["daily_quota"] = up.DailyQuota
        pkgInfo["daily_used"] = up.DailyUsed
        pkgInfo["daily_remain"] = up.DailyQuota - up.DailyUsed
        // ... 周、月同理
    } else if up.Type == "quota" {
        pkgInfo["quota_total"] = up.QuotaTotal
        pkgInfo["quota_used"] = up.QuotaUsed
        pkgInfo["quota_remain"] = up.QuotaTotal - up.QuotaUsed
    }

    packageUsage = append(packageUsage, pkgInfo)
}

response.Success(c, gin.H{
    // ... 原有字段
    "package_usage":  packageUsage,  // 新增
})
```

**前端修改**:
- 添加 `packageUsage` ref 变量
- 统计弹窗新增"套餐使用情况"表格，显示每个套餐的使用明细

**效果**: 统计弹窗现在显示：
1. 统计概览（总请求、Token、消费）
2. 套餐使用情况（每个套餐的详细使用量）
3. 按模型统计

**BUG记录**: `docs/BUG处理/2025-12-13-用户统计按套餐分别显示.md`

### 2. 开发日志规范化

**问题**: 之前开发日志没有按实际日期区分，多日工作混在一个文件

**修复**:
- 按日期拆分开发日志
- 重命名 BUG处理 文件（使用实际修复日期）
- 更新文件内容中的日期

**拆分结果**:
```
开发日志/
├── 2025-12-11.md  ← 账户费用统计、文档完善
├── 2025-12-12.md  ← 套餐余额Bug修复、BUG处理文件夹（新建）
└── 2025-12-13.md  ← 用户统计按套餐显示（新建）

BUG处理/
├── 2025-12-12-套餐余额显示不正确.md  ← 重命名
└── 2025-12-13-用户统计按套餐分别显示.md  ← 重命名
```

### 3. 完善日志流程规范

**修改文件**: `docs/README.md`

**新增内容**:
- 每日开发流程图（开始→开发→结束）
- 文件命名规范表格
- 开发日志完整模板
- BUG处理完整模板（包含类型分类）
- 决策记录完整模板
- 代码索引规范
- 功能模块索引规范
- 故障排查手册规范
- 更新文档更新记录

### 4. 新增故障排查手册

**文件**: `docs/故障排查手册.md`

**内容**:
- 按现象分类（启动/代理/数据/前端问题）
- 按错误信息分类（常见报错→文件→解决方法）
- 日志查看指南（服务日志/Redis/MySQL）
- 常见操作速查（重置套餐/清除限流/刷新缓存）
- 问题排查流程（代理失败/费用不对）

**作用**: 遇到问题直接查，立刻知道怎么处理

### 5. 账户和用户并发控制功能完善

**需求**: 完善账户并发控制，支持账户管理页面显示并发数，简化缓存管理页面

**实现方案**:

#### 5.1 账户列表显示并发数

**后端修改** - `internal/handler/account.go`:
- 添加 `cacheService` 到 `AccountHandler`
- `List()` 方法返回 `CurrentConcurrency` 字段，从 Redis 实时获取

```go
type AccountWithUsage struct {
    model.Account
    TodayTokens        int64   `json:"today_tokens"`
    TodayCount         int64   `json:"today_count"`
    TotalCost          float64 `json:"total_cost"`
    CurrentConcurrency int64   `json:"current_concurrency"` // 新增
}

// 在循环中获取并发数
if concurrent, err := h.cacheService.GetAccountConcurrency(ctx, acc.ID); err == nil {
    items[i].CurrentConcurrency = concurrent
}
```

**后端修改** - `internal/service/account.go`:
- `CreateAccountRequest` 添加 `MaxConcurrency` 字段
- `UpdateAccountRequest` 添加 `MaxConcurrency` 指针字段
- `Create()` 设置默认并发限制为 5
- `Update()` 支持更新并发限制

**前端修改** - `web/src/views/Accounts.vue`:
- 添加"并发"列，显示格式: `当前/最大`
- 添加颜色指示: 绑色(正常)、黄色(接近上限)、红色(已满)

```vue
<el-table-column label="并发" width="100" align="center">
  <template #default="{ row }">
    <div class="concurrency-cell">
      <span class="concurrency-current" :class="getConcurrencyClass(row)">
        {{ row.current_concurrency || 0 }}
      </span>
      <span class="concurrency-separator">/</span>
      <span class="concurrency-max">{{ row.max_concurrency || 5 }}</span>
    </div>
  </template>
</el-table-column>
```

**前端修改** - `web/src/components/AccountForm.vue`:
- 编辑模式添加"最大并发"字段

#### 5.2 简化缓存管理页面

**文件**: `web/src/views/Cache.vue`

**完全重写**，简化为:
1. **缓存配置卡片**: 会话 TTL、会话续期阈值、并发计数 TTL
2. **账号缓存卡片**:
   - 按账号ID查询并发数和绑定会话
   - 清除单个账号缓存
   - 清除所有账号缓存
3. **用户缓存卡片**:
   - 按用户ID查询并发数和绑定会话
   - 清除单个用户缓存
   - 清除所有用户缓存

**前端修改** - `web/src/api/index.js`:
- 添加 `getUserConcurrency`
- 添加 `resetUserConcurrency`

---

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `internal/handler/account.go` | 添加cacheService，返回CurrentConcurrency |
| `internal/service/account.go` | 添加MaxConcurrency到请求结构体 |
| `web/src/views/Accounts.vue` | 添加并发列 |
| `web/src/views/Cache.vue` | 完全重写简化 |
| `web/src/components/AccountForm.vue` | 编辑模式添加max_concurrency |
| `web/src/api/index.js` | 添加用户并发API |

---

## 待完成测试

参见 `2025-12-12.md` 中的测试计划。

---

### 6. 缓存管理页面完善（聚合视图）

**需求**: 用户反馈缓存管理页面需要直接显示列表，不是让用户自己查询。需要支持：
1. 按账号维度查看缓存（每个账号被哪些用户使用）
2. 按用户维度查看缓存（每个用户使用了哪些账号）
3. 缓存配置管理（各类TTL设置）

**实现方案**:

#### 6.1 后端 - 聚合查询接口

**文件**: `internal/service/cache.go`

新增结构体和方法：
```go
// AccountCacheInfo 账号缓存信息（聚合）
type AccountCacheInfo struct {
    AccountID      uint             `json:"account_id"`
    Concurrency    int64            `json:"concurrency"`
    MaxConcurrency int              `json:"max_concurrency"`
    SessionCount   int              `json:"session_count"`
    Sessions       []SessionBinding `json:"sessions"`
    Users          []uint           `json:"users"` // 使用此账号的用户ID列表
}

// UserCacheInfo 用户缓存信息（聚合）
type UserCacheInfo struct {
    UserID         uint             `json:"user_id"`
    Concurrency    int64            `json:"concurrency"`
    SessionCount   int              `json:"session_count"`
    Sessions       []SessionBinding `json:"sessions"`
    Accounts       []uint           `json:"accounts"` // 此用户使用的账号ID列表
}

// ListAccountsWithCache 按账号聚合缓存列表
func (s *CacheService) ListAccountsWithCache(ctx context.Context) ([]AccountCacheInfo, error)

// ListUsersWithCache 按用户聚合缓存列表
func (s *CacheService) ListUsersWithCache(ctx context.Context) ([]UserCacheInfo, error)
```

**文件**: `internal/handler/cache.go`

新增接口：
```go
// ListAccountsCache 列出所有有缓存的账号（聚合视图）
func (h *CacheHandler) ListAccountsCache(c *gin.Context)

// ListUsersCache 列出所有有缓存的用户（聚合视图）
func (h *CacheHandler) ListUsersCache(c *gin.Context)
```

**文件**: `internal/handler/routes.go`

新增路由：
```go
cache.GET("/accounts", cacheHandler.ListAccountsCache)  // 账号缓存聚合
cache.GET("/users", cacheHandler.ListUsersCache)        // 用户缓存聚合
```

#### 6.2 前端 - 双Tab聚合视图

**文件**: `web/src/views/Cache.vue`

完全重写为双Tab布局：

1. **缓存配置区域** - 4个TTL设置：
   - 粘性会话TTL (session_ttl) - 会话绑定过期时间
   - 会话续期阈值 (session_renewal_ttl) - 智能续期触发阈值
   - 不可用标记TTL (unavailable_ttl) - 账户临时不可用标记时长
   - 并发计数TTL (concurrency_ttl) - 并发计数器过期时间

2. **账号缓存Tab**：
   - 表格显示：账号ID、并发(当前/最大)、会话数、使用此账号的用户列表
   - 点击"查看会话"弹窗显示详细会话列表
   - 支持按账号ID搜索
   - 支持清除单个/全部账号缓存

3. **用户缓存Tab**：
   - 表格显示：用户ID、并发(当前/10)、会话数、使用的账号列表
   - 点击"查看会话"弹窗显示详细会话列表
   - 支持按用户ID搜索
   - 支持清除单个/全部用户缓存

**文件**: `web/src/api/index.js`

新增API：
```javascript
getCacheAccounts: () => Get('/admin/cache/accounts'),   // 获取账号缓存列表
getCacheUsers: () => Get('/admin/cache/users'),         // 获取用户缓存列表
```

#### 6.3 智能续期机制说明

**配置参数**:
| 参数 | 说明 | 默认值 |
|------|------|--------|
| session_ttl | 会话总时长 | 60分钟 |
| session_renewal_ttl | 续期阈值 | 14分钟 |

**工作原理**:
- 用户请求时检查会话剩余TTL
- 剩余 > 阈值 → 不续期
- 剩余 < 阈值 → 自动续期到完整TTL

**优点**: 避免活跃用户会话中断，又避免每次请求都续期浪费资源

---

## 修改文件清单（补充）

| 文件 | 修改内容 |
|------|----------|
| `internal/service/cache.go` | 新增 AccountCacheInfo/UserCacheInfo 结构体，新增 ListAccountsWithCache/ListUsersWithCache 方法 |
| `internal/handler/cache.go` | 新增 ListAccountsCache/ListUsersCache 接口 |
| `internal/handler/routes.go` | 新增 /admin/cache/accounts 和 /admin/cache/users 路由 |
| `web/src/views/Cache.vue` | 完全重写为双Tab聚合视图 |
| `web/src/api/index.js` | 新增 getCacheAccounts/getCacheUsers API |
| `docs/代码索引.md` | 更新变更记录、Redis Key索引 |

---

## 明日计划

### 1. M7 统计监控（继续）
- [ ] 完善监控页面
- [ ] 添加实时统计图表

### 2. 测试与验证
- [ ] 完整测试缓存管理功能
- [ ] 验证会话粘性和并发控制

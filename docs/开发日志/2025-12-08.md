# 开发日志 - 2025-12-08

## 今日工作

- [x] 研究参考项目（clove、AIProxyV2、claude-relay）
- [x] 完成架构设计方案
- [x] 确定技术选型（Go/Gin/MySQL/Redis）
- [x] 确定模块划分（M1-M7）
- [x] 建立文档目录结构
- [x] 编写文档规范
- [x] 调整开发计划（代理转发提前到核心阶段）
- [x] **M1 基础框架开发完成**
- [x] **前后端不分离方案实现**
- [x] **OAuth 模块开发完成**（参考 clove 的 SessionKey 实现）
- [x] **账户添加界面重构**（卡片式添加类型选择）
- [x] **HTTP 客户端切换**（axios → alova）

## M1 基础框架完成内容

### 后端
| 文件 | 说明 |
|------|------|
| cmd/server/main.go | 程序入口 |
| internal/config/config.go | 配置加载 |
| internal/model/user.go | 用户模型 |
| internal/repository/mysql.go | MySQL 连接 |
| internal/repository/redis.go | Redis 连接 |
| internal/repository/user.go | 用户数据访问 |
| internal/repository/migrate.go | 数据库迁移 |
| internal/service/user.go | 用户业务逻辑 |
| internal/handler/user.go | 用户接口 |
| internal/handler/routes.go | 路由注册 |
| internal/handler/static.go | 静态文件嵌入 |
| internal/middleware/*.go | CORS/JWT/Logger/Recovery |
| pkg/response/response.go | 统一响应 |
| pkg/utils/jwt.go | JWT 工具 |

### 前端（Vue 3 + Element Plus）
| 文件 | 说明 |
|------|------|
| web/src/views/Login.vue | 登录页面 |
| web/src/views/Dashboard.vue | 仪表盘 |
| web/src/views/Users.vue | 用户管理 |
| web/src/views/Profile.vue | 个人设置 |
| web/src/layouts/MainLayout.vue | 后台布局 |
| web/src/api/index.js | API 调用 |
| web/src/stores/user.js | 用户状态 |
| web/src/router/index.js | 路由配置 |

### API 接口
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/auth/login | 登录 |
| POST | /api/auth/register | 注册 |
| GET | /api/profile | 获取个人信息 |
| PUT | /api/profile | 更新个人信息 |
| PUT | /api/profile/password | 修改密码 |
| GET | /api/admin/users | 用户列表 |
| PUT | /api/admin/users/:id | 更新用户 |
| DELETE | /api/admin/users/:id | 删除用户 |

## 讨论记录

### 讨论1：技术选型
- 时间：上午
- 内容：确定使用 Go 语言重写，借鉴三个参考项目
- 结论：
  - clove → 整体架构、账户管理
  - AIProxyV2 → 七层过滤
  - claude-relay → 额度管理、多平台转发

### 讨论2：存储分工
- 时间：下午
- 内容：MySQL 和 Redis 各存什么
- 结论：
  - MySQL：配置 + 历史记录
  - Redis：实时状态 + 计数 + 缓存

### 讨论3：开发模式
- 时间：下午
- 内容：如何进行模块化开发
- 结论：
  - 后端 + 前端 + 测试 同步进行
  - 每完成一个模块就可以测试
  - 文档按时间点更新

### 讨论4：开发计划调整
- 时间：下午
- 内容：代理转发模块的开发顺序
- 结论：
  - 代理转发是核心功能，需要提前
  - 新顺序：M1基础框架 → M2账户管理 → M3代理转发(核心) → M4-M7后续功能
  - Week 4 实现最小可用版本

### 讨论5：前后端方案
- 时间：下午
- 内容：前后端分离 vs 不分离
- 结论：
  - 采用不分离方案
  - Go embed 嵌入前端静态文件
  - 单二进制部署，运维简单

## 问题与解决

### 问题1：架构文档误删
- 描述：重建文档目录时误删了架构设计文档
- 解决：重新编写精简版架构文档

### 问题2：开发顺序不合理
- 描述：原计划代理转发在 W7-9，太靠后
- 解决：调整为 W3-4，作为核心功能优先开发

## 产出文档

| 文档 | 说明 |
|------|------|
| docs/README.md | 文档规范 |
| docs/架构设计/架构设计方案.md | 整体技术方案 |
| docs/架构设计/参考项目总结.md | 参考项目分析 |
| docs/模块设计/开发计划.md | 模块化开发计划v2（代理转发优先） |

---

## M2 账户管理完成内容

### 后端
| 文件 | 说明 |
|------|------|
| internal/model/account.go | 账户模型（10种类型）+ 分组模型 |
| internal/repository/account.go | 账户和分组数据访问 |
| internal/service/account.go | 账户业务逻辑 |
| internal/handler/account.go | 账户和分组接口 |

### 账户类型
| 平台 | 类型 | 说明 |
|------|------|------|
| Claude | claude-official | OAuth 认证 |
| Claude | claude-console | Console 认证 |
| Claude | bedrock | AWS Bedrock |
| Claude | ccr | CCR 认证 |
| OpenAI | openai | API Key |
| OpenAI | openai-responses | Responses API |
| OpenAI | azure-openai | Azure 部署 |
| Gemini | gemini | OAuth 认证 |
| Gemini | gemini-api | API Key |
| Other | droid | 其他平台 |

### API 接口
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/accounts/types | 获取账户类型列表 |
| GET | /api/admin/accounts | 账户列表 |
| POST | /api/admin/accounts | 创建账户 |
| GET | /api/admin/accounts/:id | 账户详情 |
| PUT | /api/admin/accounts/:id | 更新账户 |
| DELETE | /api/admin/accounts/:id | 删除账户 |
| PUT | /api/admin/accounts/:id/status | 更新账户状态 |
| GET | /api/admin/account-groups | 分组列表 |
| POST | /api/admin/account-groups | 创建分组 |
| PUT | /api/admin/account-groups/:id | 更新分组 |
| DELETE | /api/admin/account-groups/:id | 删除分组 |

### 前端
| 文件 | 说明 |
|------|------|
| web/src/views/Accounts.vue | 账户管理页面 |
| web/src/api/index.js | 新增账户相关 API |

---

## M3 代理转发完成内容

### 核心架构
```
请求 → 智能路由 → 账户调度 → 适配器 → 上游 API
                               ↓
                          流式响应
                               ↓
                          错误重试
```

### 后端文件
| 文件 | 说明 |
|------|------|
| internal/proxy/adapter/adapter.go | 统一适配器接口 |
| internal/proxy/adapter/openai.go | OpenAI 适配器 |
| internal/proxy/adapter/claude.go | Claude 适配器 |
| internal/proxy/adapter/azure.go | Azure OpenAI 适配器 |
| internal/proxy/adapter/gemini.go | Gemini 适配器 |
| internal/proxy/adapter/bedrock.go | AWS Bedrock 适配器（含 AWS Signature V4 签名） |
| internal/proxy/adapter/converter.go | 格式转换器（OpenAI ↔ Claude ↔ Gemini） |
| internal/proxy/scheduler/scheduler.go | 账户调度器 |
| internal/proxy/scheduler/retry.go | 错误重试机制 + 熔断器 |
| internal/handler/proxy.go | 代理请求处理器（集成重试） |

### 适配器支持
| 适配器 | 账户类型 | 说明 |
|--------|----------|------|
| OpenAI | openai, openai-responses | OpenAI API |
| Claude | claude-official, claude-console, ccr | Anthropic Claude |
| Azure OpenAI | azure-openai | Azure 部署的 OpenAI |
| Gemini | gemini, gemini-api | Google Gemini |
| Bedrock | bedrock | AWS Bedrock Claude |

### 代理接口
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /v1/chat/completions | OpenAI 兼容接口 |
| POST | /api/v1/messages | Claude 兼容接口 |

### 支持的功能
- **智能路由**: 根据模型名自动检测平台（claude-*/gpt-*/gemini-*）
- **账户调度**: 基于优先级+权重的负载均衡
- **流式响应**: 支持 SSE 流式输出
- **错误处理**: 自动标记账户状态（valid/invalid/rate_limited/overloaded）
- **请求统计**: 自动记录请求次数和错误次数
- **灵活路由**: 支持 "type,model" 格式指定账户类型
- **错误重试**: 自动重试失败请求，支持退避策略
- **账户切换**: 错误时自动切换到其他可用账户
- **熔断保护**: 连续失败后自动熔断，防止雪崩
- **格式转换**: 支持跨平台请求/响应格式转换

### 重试机制特性
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| MaxRetries | 3 | 最大重试次数 |
| RetryDelay | 1s | 初始重试延迟 |
| RetryBackoff | 2.0 | 退避系数 |
| RetryableErrors | timeout, 429, 529, 503... | 可重试错误类型 |
| SwitchOnRateLimit | true | 限流时切换账户 |
| SwitchOnError | true | 错误时切换账户 |

### 前端
| 文件 | 说明 |
|------|------|
| web/src/views/ProxyTest.vue | 代理测试页面 |

### 代理测试页面功能
- 支持 OpenAI / Claude 两种请求格式
- 支持选择模型（Claude/OpenAI/Gemini）
- 支持指定账户类型
- 支持流式/非流式响应
- 可配置 max_tokens / temperature / top_p
- 实时显示请求体和响应结果

### 使用示例
```bash
# OpenAI 格式请求
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{"model":"gpt-4","messages":[{"role":"user","content":"Hello"}]}'

# Claude 格式请求
curl -X POST http://localhost:8080/api/v1/messages \
  -H "Content-Type: application/json" \
  -d '{"model":"claude-3-5-sonnet","max_tokens":1024,"messages":[{"role":"user","content":"Hello"}]}'

# 指定账户类型
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{"model":"ccr,claude-3-5-sonnet","messages":[{"role":"user","content":"Hello"}]}'

# 使用 Bedrock
curl -X POST http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{"model":"bedrock,claude-3-5-sonnet","messages":[{"role":"user","content":"Hello"}]}'
```

---

## OAuth 模块完成内容

### 后端文件
| 文件 | 行数 | 说明 |
|------|------|------|
| internal/handler/oauth.go | 474 | OAuth 处理器（PKCE + SessionKey） |
| internal/handler/routes.go | 89-94 | OAuth 路由注册 |

### 后端函数跟踪
| 函数 | 文件:行号 | 说明 |
|------|-----------|------|
| `NewOAuthHandler` | oauth.go:53 | 创建处理器 |
| `GenerateURL` | oauth.go:58 | 生成 OAuth 授权 URL |
| `Exchange` | oauth.go:127 | 交换授权码获取 Token |
| `CookieAuth` | oauth.go:178 | SessionKey Cookie 认证 |
| `authenticateWithSessionKey` | oauth.go:210 | SessionKey 完整认证流程 |
| `getOrganizationInfo` | oauth.go:241 | 获取 Claude 组织信息 |
| `authorizeWithCookie` | oauth.go:293 | 使用 Cookie 获取授权码 |
| `exchangeClaudeToken` | oauth.go:367 | 交换 Claude Token |
| `createHTTPClient` | oauth.go:419 | 创建支持代理的 HTTP 客户端 |
| `generatePKCE` | oauth.go:456 | 生成 PKCE verifier/challenge |
| `generateRandomString` | oauth.go:470 | 生成随机字符串 |

### API 接口
| 方法 | 路径 | 处理函数 | 行号 |
|------|------|----------|------|
| POST | /api/admin/oauth/generate-url | GenerateURL | routes.go:91 |
| POST | /api/admin/oauth/exchange | Exchange | routes.go:92 |
| POST | /api/admin/oauth/cookie-auth | CookieAuth | routes.go:93 |

### 前端文件
| 文件 | 行数 | 说明 |
|------|------|------|
| web/src/components/OAuthFlow.vue | 827 | OAuth 流程组件 |
| web/src/components/AccountForm.vue | 1167 | 账户表单（含添加类型选择） |
| web/src/api/index.js | 79-82 | OAuth API 定义 |

### 前端函数跟踪
| 函数 | 文件:行号 | 说明 |
|------|-----------|------|
| `generateAuthUrl` | OAuthFlow.vue:428 | 生成授权 URL |
| `regenerateAuthUrl` | OAuthFlow.vue:457 | 重新生成 URL |
| `copyAuthUrl` | OAuthFlow.vue:465 | 复制到剪贴板 |
| `exchangeCode` | OAuthFlow.vue:491 | 交换授权码 |
| `handleCookieAuth` | OAuthFlow.vue:516 | SessionKey 认证 |
| `onAuthMethodChange` | OAuthFlow.vue:574 | 切换认证方式 |
| `needsOAuth` | AccountForm.vue:582 | 判断是否需要 OAuth |
| `handleOAuthSuccess` | AccountForm.vue:657 | OAuth 成功回调 |

### 前端 API 定义
| 函数 | 文件:行号 | API 路径 |
|------|-----------|----------|
| `generateOAuthUrl` | index.js:80 | /admin/oauth/generate-url |
| `exchangeOAuthCode` | index.js:81 | /admin/oauth/exchange |
| `oauthByCookie` | index.js:82 | /admin/oauth/cookie-auth |

### 支持的认证方式
| 平台 | OAuth | SessionKey | API Key |
|------|-------|------------|---------|
| Claude | ✅ | ✅ | - |
| OpenAI | ✅ | - | ✅ |
| Gemini | ✅ | - | ✅ |

### 问题与解决
详见: [问题解决方案.md](./问题解决方案.md)

| 问题 | 原因 | 解决 |
|------|------|------|
| OAuth 路由 404 | 后端运行旧二进制 | 重新编译并重启 |
| Network Error | 前端 dev server 未运行 | 启动 npm run dev |
| SessionKey 403 | Cloudflare 保护 | 配置代理服务器 |

---

## 前端技术栈升级

### HTTP 客户端切换 (axios → alova)

| 变更项 | 说明 |
|--------|------|
| 移除 | axios ^1.6.7 |
| 新增 | alova ^3.4.0 |
| 文件 | web/src/api/index.js |

**Alova 配置要点** (`web/src/api/index.js:1-51`)：
```javascript
import { createAlova } from 'alova'
import adapterFetch from 'alova/fetch'

const alovaInstance = createAlova({
  baseURL: '/api',
  timeout: 10000,
  requestAdapter: adapterFetch(),
  beforeRequest(method) { /* JWT token */ },
  responded: { /* 响应处理 */ }
})

// 封装自动调用 send()，兼容原有调用方式
const Get = (url, config) => alovaInstance.Get(url, config).send()
const Post = (url, data, config) => alovaInstance.Post(url, data, config).send()
```

### 开发工具配置

| 工具 | 配置文件 | 说明 |
|------|----------|------|
| Context7 MCP | ~/.claude/settings.json | 提供最新库文档查询 |

---

## 今日总结

- [x] M1 基础框架 - 完成
- [x] M2 账户管理 - 完成
- [x] M3 代理转发 - 完成
- [x] OAuth 模块 - 完成
- [x] 前端技术栈升级 (axios → alova)
- [x] Context7 MCP 配置

**核心功能已就绪，可以进行基础测试。**

## 技术栈

### 后端
| 组件 | 版本 |
|------|------|
| Go | 1.21+ |
| Gin | 1.10+ |
| MySQL | 8.0+ |
| Redis | 7.0+ |
| GORM | - |

### 前端
| 组件 | 版本 |
|------|------|
| Vue | 3.4+ |
| Vite | 5.x |
| Element Plus | 2.6+ |
| Pinia | 2.x |
| Vue Router | 4.x |
| Alova | 3.x |

## 产出文档

| 文档 | 说明 |
|------|------|
| docs/架构设计/架构设计方案.md | 更新技术栈（含前端） |
| docs/模块设计/OAuth模块.md | OAuth 功能跟踪文档 |
| docs/开发日志/问题解决方案.md | 问题解决方案记录 |

## 下一步计划

- [ ] M4 API Key 管理
- [ ] M5 七层过滤
- [ ] M6 额度管理
- [ ] M7 费用统计

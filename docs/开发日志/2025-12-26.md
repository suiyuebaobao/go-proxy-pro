# 开发日志 2025-12-26

## 今日工作

### 1. GLM缓存Token解析修复

**需求**: 智谱GLM通过Claude兼容API返回的缓存Token信息没有被正确解析，导致cache_read_input_tokens始终为0。

**问题分析**:
- Claude官方API: 缓存信息在 `message_start` 事件中
- GLM兼容API: 缓存信息在 `message_delta` 事件中

**修复方案**:
扩展 `parseStreamUsage()` 函数，同时解析两种事件中的缓存信息。

**修改文件**:
- `internal/proxy/adapter/claude.go` - parseStreamUsage() 函数

**关键代码**:
```go
case "message_delta":
    // 兼容 GLM：如果 message_delta 中有 input_tokens，使用它
    if event.Usage.InputTokens > 0 && result.InputTokens == 0 {
        result.InputTokens = event.Usage.InputTokens
    }
    // 兼容 GLM：如果 message_delta 中有缓存信息，使用它
    if event.Usage.CacheReadInputTokens > 0 && result.CacheReadInputTokens == 0 {
        result.CacheReadInputTokens = event.Usage.CacheReadInputTokens
    }
```

---

### 2. 流式响应末尾捕获（TailWriter）

**需求**: 请求日志中response_body为空，无法查看响应详情（特别是usage/cache信息）。

**问题分析**:
流式响应直接写入客户端，没有累积保存。用户需要查看末尾的usage信息用于调试。

**实现方案**:
创建TailWriter，在转发数据的同时捕获最后2KB内容。

**修改文件**:
- `internal/proxy/adapter/adapter.go` - 新增 TailWriter 结构体
- `internal/handler/proxy.go` - 所有流式Handler使用TailWriter

**关键代码**:
```go
type TailWriter struct {
    w       io.Writer
    tail    []byte
    maxSize int
}

func (t *TailWriter) Write(p []byte) (n int, err error) {
    n, err = t.w.Write(p)
    t.tail = append(t.tail, p[:n]...)
    if len(t.tail) > t.maxSize {
        t.tail = t.tail[len(t.tail)-t.maxSize:]
    }
    return n, nil
}
```

---

### 3. iptables自动加载配置

**需求**: iptables规则在服务器重启后丢失。

**实现方案**:
创建systemd服务，在启动时自动加载iptables规则。

**操作步骤**:
```bash
# 保存当前规则
iptables-save > /etc/iptables.rules

# 创建systemd服务
cat > /etc/systemd/system/iptables-restore.service << 'EOF'
[Unit]
Description=Restore iptables rules
Before=network-pre.target
Wants=network-pre.target

[Service]
Type=oneshot
ExecStart=/sbin/iptables-restore /etc/iptables.rules
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# 启用服务
systemctl daemon-reload
systemctl enable iptables-restore.service
```

---

### 4. MCP代理方案讨论

**背景**: 用户希望通过服务器转发智谱GLM的MCP功能（联网搜索等），让终端用户无需单独配置。

**讨论结果**:

| 方案 | 代码量 | 用户配置 | 复杂度 |
|------|--------|----------|--------|
| A: MCP代理 | ~100行 | 一行命令 | 低 |
| B: Agent Loop | ~500-800行 | 零配置 | 高 |

**推荐方案A**:
- 在服务器添加 `/mcp/*` 路由
- 转发请求到智谱MCP服务器
- 服务器端加上智谱API Key（用户看不到）

**安全性**: 智谱Key存在服务器，用户无法获取。

**详细文档**: [ADR-003-MCP代理方案讨论](../决策记录/ADR-003-MCP代理方案讨论.md)

---

## 技术要点

### MCP协议

MCP (Model Context Protocol) 基于 JSON-RPC 2.0：
- 传输: HTTP POST
- 必需Header: `MCP-Protocol-Version: 2025-06-18`
- 响应: JSON 或 SSE (流式)

### 智谱Claude兼容API vs 原生API

| 特性 | Claude兼容API | 原生API |
|------|---------------|---------|
| 端点 | `/api/anthropic/v1/messages` | `/api/paas/v4/chat/completions` |
| 格式 | Claude格式 | OpenAI格式 |
| 工具调用 | 返回tool_use，不执行 | 服务器端执行 |
| 联网搜索 | 需要MCP | 原生支持 |

---

### 5. 账户AllowedModels过滤修复

**问题**: 账户设置了"允许的模型"（AllowedModels）后，其他模型仍然可以使用该账户。

**根本原因**:
账户的 `AllowedModels` 字段只保存到数据库，但调度器选择账户时**从未检查**这个字段。

**修复方案**:
在调度器中添加 `filterByAllowedModels()` 函数，在选择账户前过滤。

**修改文件**:
- `internal/proxy/scheduler/scheduler.go`
  - 新增 `filterByAllowedModels()` 函数
  - 修改 `SelectAccountWithSession()` 添加过滤
  - 修改 `SelectAccountByType()` 添加过滤
  - 修改 `SelectAccountByTypeWithSession()` 添加过滤
  - 修改 `SelectAccountByTypesWithSession()` 添加过滤
- `internal/handler/openai_responses.go`
  - 更新调用，传递 modelName 参数

**关键代码**:
```go
// filterByAllowedModels 根据 AllowedModels 过滤账户
func (s *Scheduler) filterByAllowedModels(accounts []*model.Account, modelName string) []*model.Account {
    for _, acc := range accounts {
        if acc.AllowedModels == "" {
            // 没有设置限制，允许所有模型
            filtered = append(filtered, acc)
            continue
        }
        // 检查模型是否在允许列表中（支持前缀匹配）
        allowedList := strings.Split(acc.AllowedModels, ",")
        for _, allowed := range allowedList {
            if strings.HasPrefix(modelLower, allowed) || allowed == modelLower {
                filtered = append(filtered, acc)
                break
            }
        }
    }
    return filtered
}
```

**功能说明**:
- 如果账户 `AllowedModels` 为空，该账户可用于所有模型
- 如果设置了 `AllowedModels`（逗号分隔），只有匹配的模型才能使用该账户
- 支持前缀匹配：如设置 `glm-4` 可以匹配 `glm-4-plus`、`glm-4.5` 等

---

## 遗留问题

- [ ] MCP代理功能待实现（用户确认后）

---

## 明日计划

### 1. MCP代理实现（如用户确认）
- [ ] 添加智谱MCP API Key配置项
- [ ] 创建MCP Handler
- [ ] 添加路由
- [ ] 测试

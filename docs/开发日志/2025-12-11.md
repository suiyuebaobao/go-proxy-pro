# 开发日志 2025-12-11

## 今日工作

### 1. 账户费用统计功能

**需求**: 账户管理页面需要显示每个账户消耗的总费用

**实现方案**: Redis 优先架构
- 写入: 每次请求实时写入 Redis `cost:account:{accountID}`
- 查询: 先查 Redis，无数据时回退 MySQL
- 同步: 定时任务将 Redis 数据同步到 MySQL

**修改文件**:
- `internal/service/usage.go` - 添加账户费用方法
  - `IncrementAccountCost(ctx, accountID, cost)`
  - `GetAccountCost(ctx, accountID)`
  - `GetAccountsCost(ctx, accountIDs)`
  - `GetAccountDailyCost(ctx, accountID, date)`
- `internal/service/sync.go` - 添加 `syncAccountCosts()` 同步方法
- `internal/model/account.go` - 添加 `TotalCost float64` 字段
- `internal/repository/account.go` - 添加 `UpdateTotalCost()` 方法
- `internal/handler/account.go` - List 方法实现 Redis 优先查询
- `internal/handler/proxy.go` - recordUsage 调用 IncrementAccountCost
- `web/src/views/Accounts.vue` - 添加"总费用"列

**Redis Key 设计**:
```
cost:account:{accountID}              # Hash: total_cost, requests
cost:account:daily:{accountID}:{date} # Hash: total_cost, requests (90天过期)
```

### 2. 文档完善

**新增文档**:
- `docs/模块设计/M9-服务层设计.md` - 服务层详细设计文档
- `docs/架构设计/后端架构总览.md` - 后端整体架构文档
- `docs/功能模块索引.md` - 功能模块索引（关键代码+配置项）

**更新文档**:
- `docs/代码索引.md` - 添加定时任务索引、Redis Key 索引、变更记录
- `docs/README.md` - 添加快速导航、更新目录结构

---

## 技术要点

### Redis 费用存储精度
使用整数存储避免浮点精度问题:
```go
// 存储时乘以 1000000
pipe.HIncrBy(ctx, key, "total_cost", int64(cost*1000000))

// 读取时除以 1000000
totalCost := float64(intVal) / 1000000
```

### Redis 优先查询模式
```go
// 1. 先查 Redis
redisCostMap, _ := h.usageService.GetAccountsCost(ctx, accountIDs)

// 2. 找出 Redis 没有的
var missingIDs []uint
for _, id := range accountIDs {
    if _, ok := redisCostMap[id]; !ok {
        missingIDs = append(missingIDs, id)
    }
}

// 3. 从 MySQL 补充
if len(missingIDs) > 0 {
    mysqlCostMap, _ = logRepo.GetAccountsTotalCost(missingIDs)
}

// 4. 合并结果，优先使用 Redis 数据
```

### 定时同步任务
位置: `internal/service/sync.go`

同步流程:
1. `doSync()` 被定时调用
2. `syncUsageRecords()` 同步使用记录
3. `syncAccountCosts()` 同步账户费用
4. 扫描 Redis keys，更新到 MySQL

---

## 遗留问题

1. ~~数据库 `total_cost` 字段需要迁移（GORM AutoMigrate 会自动处理）~~ 已完成

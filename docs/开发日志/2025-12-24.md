# 开发日志 2025-12-24

## 今日工作

### 1. 操作日志功能修复

**需求**: 修复操作日志系统中的多个 BUG，确保正确记录用户操作审计信息。

**问题描述**:

1. **登录操作 user_id 和 username 为空**
   - 现象：登录操作的日志中 `user_id=0`，`username=""` 为空
   - 原因：登录请求在认证中间件之前处理，此时 context 中还没有用户信息

2. **更新操作 target_name 为空**
   - 现象：更新用户等操作的日志中 `target_name` 始终为空
   - 原因1：`c.Param("id")` 在中间件中无法获取路由参数（Gin 路由尚未解析）
   - 原因2：用户可能已被软删除，GORM 默认排除软删除记录

**修复方案**:

1. **登录日志用户信息修复**
   - 在响应返回后解析 JSON，从登录成功的响应中提取 `user_id` 和 `username`
   - 代码位置：`internal/middleware/operation_log.go:720-732`

2. **路径 ID 提取修复**
   - 添加 `pathIDPattern` 和 `secondPathIDPattern` 正则表达式
   - 修改 `getPathID()` 和 `getSecondPathID()` 函数，从 URL 路径中直接提取 ID
   - 代码位置：`internal/middleware/operation_log.go:149-186`

3. **软删除记录查询修复**
   - 所有 `getXxxNameByID()` 函数改用 `repository.DB.Unscoped().First()` 查询
   - 确保能查询到已删除的记录名称用于日志记录
   - 代码位置：`internal/middleware/operation_log.go:251-357`

**修改文件**:

| 文件 | 修改内容 |
|------|----------|
| `internal/middleware/operation_log.go` | 路径ID提取正则、软删除查询、登录响应解析 |

**关键代码**:

```go
// 路径ID提取正则
var (
    pathIDPattern       = regexp.MustCompile(`/(\d+)(?:/|$)`)
    secondPathIDPattern = regexp.MustCompile(`/(\d+)/[^/]+/(\d+)(?:/|$)`)
)

// 使用 Unscoped 查询软删除记录
func getUsernameByID(id uint) string {
    if repository.DB == nil {
        return ""
    }
    var user model.User
    if err := repository.DB.Unscoped().First(&user, id).Error; err != nil {
        return ""
    }
    return user.Username
}

// 从登录响应中提取用户信息
if mapping.Action == model.ActionLogin && respCode == 0 {
    if data, ok := respData["data"].(map[string]interface{}); ok {
        if user, ok := data["user"].(map[string]interface{}); ok {
            if id, ok := user["id"].(float64); ok {
                userIDUint = uint(id)
            }
            if name, ok := user["username"].(string); ok {
                usernameStr = name
            }
        }
    }
}
```

**测试验证**:

```sql
-- 验证登录日志用户信息
SELECT id, user_id, username, module, action FROM operation_logs
WHERE action='login' ORDER BY id DESC LIMIT 3;
-- 结果：user_id=1, username='admin' 正确记录

-- 验证更新操作 target_name
SELECT id, target_id, target_name, description FROM operation_logs
WHERE action='update' ORDER BY id DESC LIMIT 3;
-- 结果：target_id=4, target_name='testuser2' 正确记录（含软删除用户）
```

---

## 技术要点

### 中间件中获取路由参数

Gin 中间件执行时，路由参数可能尚未解析。解决方案：

1. **使用正则从 URL 提取**：适用于通用中间件（如本次修复）
2. **在路由组内注册**：确保中间件在路由匹配后执行
3. **使用 `c.Params`**：某些情况下可行

### GORM 软删除与 Unscoped

GORM 软删除默认添加 `WHERE deleted_at IS NULL` 条件。使用 `Unscoped()` 可忽略此条件：

```go
// 包含软删除记录
db.Unscoped().First(&user, id)

// 默认排除软删除
db.First(&user, id)
```

---

### 2. 操作日志前端优化

**问题描述**:

1. **筛选条件不生效**
   - 现象：选择模块或操作类型后，列表没有变化
   - 原因：筛选条件改变时没有重置分页到第一页，如果当前在第 N 页而筛选结果不足 N 页则显示空白

2. **操作类型选项冗余**
   - 现象：操作下拉框有「测试」「同步」选项，但数据库中无相关记录
   - 原因：前端选项与实际数据不匹配

**修复方案**:

1. **筛选时重置分页**
   - 新增 `handleFilterChange()` 函数，筛选条件改变时先重置 `pagination.page = 1`
   - 同时修复日期筛选和搜索框的分页重置

2. **精简操作类型选项**
   - 查询数据库实际操作类型分布
   - 移除无数据的「测试」和「同步」选项

**数据库操作类型统计**:

| 操作 | 记录数 |
|------|--------|
| update | 219 |
| login | 206 |
| create | 89 |
| delete | 42 |
| clear | 11 |

**修改文件**:

| 文件 | 修改内容 |
|------|----------|
| `web/src/views/OperationLogs.vue` | 筛选重置分页、精简操作选项 |

**关键代码**:

```javascript
// 筛选条件改变时重置分页
function handleFilterChange() {
  pagination.page = 1
  loadLogs()
}

// 搜索时重置分页
function handleSearch() {
  clearTimeout(searchTimer)
  searchTimer = setTimeout(() => {
    pagination.page = 1
    loadLogs()
  }, 300)
}
```

---

### 3. 移除 Redis 依赖，改用内存缓存

**需求**: 简化部署架构，移除 Redis 依赖，使用 Go 原生 sync.Map 实现内存缓存。

**背景**:
- 原架构使用 Redis 存储会话绑定、并发计数、不可用标记
- 对于单实例部署场景，Redis 引入额外运维复杂度
- Go 的 sync.Map + atomic.Int64 完全能满足内存缓存需求

**实现方案**:

| 功能 | 原实现 (Redis) | 新实现 (sync.Map) |
|------|---------------|-------------------|
| 会话绑定 | Redis Hash + TTL | sync.Map + 定期清理 |
| 并发计数 | Redis INCR/DECR | atomic.Int64 + CAS |
| 不可用标记 | Redis String + EXPIRE | sync.Map + TTL 字段 |

**修改文件**:

| 文件 | 修改内容 |
|------|----------|
| `internal/cache/memory.go` | 核心实现：SessionStore、ConcurrencyManager、UnavailableMarker |
| `internal/service/system_monitor.go` | 监控数据结构：MemoryCacheStats、GetCacheStats() |
| `internal/handler/cache.go` | API 接口更新 |
| `internal/proxy/scheduler/scheduler.go` | 调度器使用内存缓存 |
| `configs/config.yaml` | 移除 Redis 配置 |
| `web/src/views/SystemMonitor.vue` | 前端字段从 redis 改为 cache |

**关键代码**:

```go
// ConcurrencyManager.Stats() - 新增并发统计方法
func (m *ConcurrencyManager) Stats() (accountCount, userCount int) {
    m.accountCounters.Range(func(_, _ interface{}) bool {
        accountCount++
        return true
    })
    m.userCounters.Range(func(_, _ interface{}) bool {
        userCount++
        return true
    })
    return
}

// MemoryCache.Stats() - 更新统计方法
func (c *MemoryCache) Stats() map[string]interface{} {
    accountConcurrency, userConcurrency := GetConcurrencyManager().Stats()
    return map[string]interface{}{
        "session_count":             c.Sessions.Count(),
        "unavailable_count":         c.Unavailable.Count(),
        "account_concurrency_count": accountConcurrency,
        "user_concurrency_count":    userConcurrency,
    }
}
```

**测试验证**:

```bash
# 验证 API 返回 cache 字段（非 redis）
curl -s http://localhost:18080/api/admin/monitor | jq '.data.cache'
# 结果：
# {
#   "session_count": 1,
#   "unavailable_count": 0,
#   "account_concurrency_count": 1,
#   "user_concurrency_count": 1,
#   "connected": true
# }

# 验证后端无 Redis 引用
grep -r "redis" internal/ --include="*.go" | wc -l
# 结果: 0
```

**优点**:
- 部署简化：无需安装和维护 Redis 服务
- 性能提升：减少网络 IO，内存访问更快
- 代码简化：移除 Redis 客户端依赖

**注意事项**:
- 服务重启后内存缓存会丢失，会话需要重新建立
- 不适用于多实例部署（需要共享状态时应考虑恢复 Redis）

---

## 明日计划

### 1. 日志系统完善
- [ ] 完善日志查询 API 文档
- [ ] 添加日志导出功能

### 2. 其他优化
- [ ] 检查其他可能的操作日志遗漏场景

# 开发日志 2025-12-14

## 今日工作

### 1. gzip 响应解压修复（BUG修复）

**问题**: 代理请求返回 502 错误，错误信息 `parse response: invalid character '\x1f' looking for beginning of value`

**原因**: 上游 API 返回 gzip 压缩的响应体，代码直接 JSON 解析未解压的二进制数据。`\x1f\x8b` 是 gzip 文件的魔术字节。

**修复方案**:
1. 新增 `ReadResponseBody()` 辅助函数，自动检测和解压 gzip
2. 在 Claude 适配器中过滤 `Accept-Encoding` 请求头，避免请求 gzip 响应

**修改文件**:
- `internal/proxy/adapter/http_client.go` - 新增 `ReadResponseBody()` 函数
- `internal/proxy/adapter/claude.go` - 使用 `ReadResponseBody()`，过滤 `accept-encoding` 头
- `internal/proxy/adapter/openai.go` - 使用 `ReadResponseBody()`
- `internal/proxy/adapter/azure.go` - 使用 `ReadResponseBody()`
- `internal/proxy/adapter/gemini.go` - 使用 `ReadResponseBody()`
- `internal/proxy/adapter/bedrock.go` - 使用 `ReadResponseBody()`
- `internal/proxy/adapter/claude_ccr.go` - 使用 `ReadResponseBody()`

**核心代码**:
```go
// internal/proxy/adapter/http_client.go
func ReadResponseBody(resp *http.Response) ([]byte, error) {
    if resp.Body == nil {
        return nil, nil
    }
    var reader io.Reader = resp.Body
    contentEncoding := resp.Header.Get("Content-Encoding")

    // 按 Content-Encoding 头解压
    if strings.EqualFold(contentEncoding, "gzip") {
        gzReader, err := gzip.NewReader(resp.Body)
        if err != nil {
            return nil, err
        }
        defer gzReader.Close()
        reader = gzReader
    }

    // 读取数据
    var buf bytes.Buffer
    _, err := io.Copy(&buf, reader)
    if err != nil {
        return nil, err
    }
    data := buf.Bytes()

    // 检测 gzip magic bytes 作为后备
    if !strings.EqualFold(contentEncoding, "gzip") && len(data) >= 2 &&
       data[0] == 0x1f && data[1] == 0x8b {
        gzReader, err := gzip.NewReader(bytes.NewReader(data))
        if err != nil {
            return data, nil
        }
        defer gzReader.Close()
        decompressed, err := io.ReadAll(gzReader)
        if err != nil {
            return data, nil
        }
        return decompressed, nil
    }
    return data, nil
}
```

**BUG记录**: `docs/BUG处理/2025-12-14-gzip响应解压修复.md`

---

### 2. 客户端过滤界面简化（功能优化）

**需求**: 简化客户端过滤界面，改为简单/严格两种模式

**参考**: claude-relay 项目的简单验证模式

**实现**:

#### 2.1 后端 - 添加过滤模式

**文件**: `internal/model/client_filter.go`
```go
const (
    FilterModeSimple = "simple" // 简单模式: 宽松UA检查
    FilterModeStrict = "strict" // 严格模式: 完整验证
)

type ClientFilterConfig struct {
    FilterEnabled bool     `json:"filter_enabled"`
    FilterMode    string   `json:"filter_mode"`    // 新增
    AllowedClients []string `json:"allowed_clients"`
}
```

**文件**: `internal/service/client_filter.go`
- `matchClientType()` 根据模式选择不同的 UA 正则:
  - 简单模式: `^claude-cli/\d+\.\d+\.\d+`
  - 严格模式: `^claude-cli/(\d+\.\d+\.\d+)\s*\(external,\s*(cli|claude-vscode|sdk-ts|sdk-cli)...`
- `validateClaudeCodeRules()` 严格模式额外验证:
  - 必需请求头: `x-stainless-os`, `anthropic-version`
  - System Prompt 相似度检查 (Sørensen-Dice 算法)
  - metadata.user_id 格式验证

**文件**: `internal/repository/client_filter.go`
- 支持 `filter_mode` 字段的读写

#### 2.2 前端 - 简化界面

**文件**: `web/src/views/ClientFilter.vue`

完全重写，简化为:
1. **主开关卡片**: 客户端过滤总开关
2. **允许的客户端**: 卡片式选择，点击切换启用/禁用
3. **验证模式**: 单选按钮组（简单模式/严格模式）
4. **验证测试**: 折叠面板，可测试 UA/Headers/Body

**模式说明**:
| 模式 | UA 要求 | 其他验证 |
|------|---------|----------|
| 简单模式 | `claude-cli/版本` 开头 | 无 |
| 严格模式 | 完整格式 `claude-cli/版本 (external, cli)` | Headers + System Prompt + metadata |

**BUG记录**: `docs/BUG处理/2025-12-14-客户端过滤简化.md`

---

### 3. 文档更新

根据 `docs/README.md` 规范更新所有相关文档:

| 文档 | 更新内容 |
|------|----------|
| `代码索引.md` | 新增客户端过滤和 gzip 修复的变更记录 |
| `功能模块索引.md` | 新增第11节「客户端过滤」模块 |
| `故障排查手册.md` | 新增客户端过滤问题分类、gzip 错误说明 |
| `README.md` | M5 客户端过滤标记完成 |

---

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `internal/proxy/adapter/http_client.go` | 新增 `ReadResponseBody()` gzip 解压函数 |
| `internal/proxy/adapter/claude.go` | 使用 `ReadResponseBody()`，过滤 `accept-encoding` |
| `internal/proxy/adapter/openai.go` | 使用 `ReadResponseBody()` |
| `internal/proxy/adapter/azure.go` | 使用 `ReadResponseBody()` |
| `internal/proxy/adapter/gemini.go` | 使用 `ReadResponseBody()` |
| `internal/proxy/adapter/bedrock.go` | 使用 `ReadResponseBody()` |
| `internal/proxy/adapter/claude_ccr.go` | 使用 `ReadResponseBody()` |
| `internal/model/client_filter.go` | 添加 `FilterMode` 常量和字段 |
| `internal/service/client_filter.go` | 根据模式选择验证规则 |
| `internal/repository/client_filter.go` | 支持 `filter_mode` 字段 |
| `web/src/views/ClientFilter.vue` | 完全重写简化界面 |
| `docs/代码索引.md` | 更新变更记录 |
| `docs/功能模块索引.md` | 新增客户端过滤模块 |
| `docs/故障排查手册.md` | 新增问题分类 |
| `docs/README.md` | 更新模块进度 |

---

## 关键代码位置

| 功能 | 文件 | 位置 |
|------|------|------|
| gzip 解压 | `internal/proxy/adapter/http_client.go` | `ReadResponseBody()` |
| 模式常量 | `internal/model/client_filter.go` | 第37-40行 |
| UA 匹配 | `internal/service/client_filter.go` | `matchClientType()` |
| 规则验证 | `internal/service/client_filter.go` | `validateClaudeCodeRules()` |

---

## 明日计划

### 1. 测试与验证
- [ ] 测试客户端过滤两种模式
- [ ] 验证 gzip 解压在各平台的兼容性

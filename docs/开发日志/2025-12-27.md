# 开发日志 2025-12-27

## 今日工作

### 1. 移除全局模型映射

**需求**: 之前的全局模型映射会把 Claude 模型转换为其他模型（如 GLM-4.7），导致请求无法正确路由到 Claude 平台账户。

**实现方案**: 移除代理入口处的全局模型映射调用，只保留账户级别的 ModelMapping（在账户配置中设置）。

**修改文件**:
- `internal/handler/proxy.go` - 移除 `modelMappingService.MapModel()` 调用
  - 影响接口：`ClaudeMessages`、`OpenAIChatCompletions`、`GeminiChat`

### 2. 修复 Thinking Block Signature 错误

**需求**: Claude 的 Extended Thinking 功能在 thinking block 中包含签名信息，该签名与特定的认证上下文（账户）绑定。当请求被路由到不同账户时，签名校验失败，返回 `Invalid signature in thinking block` 错误。

**实现方案**:
1. 检测 signature 错误（`isSignatureError` 函数）
2. 自动移除请求中的 thinking blocks（`removeThinkingBlocks` 函数）
3. 使用相同账户重新发送请求

**修改文件**:
- `internal/proxy/adapter/claude.go`
  - 新增 `doSendWithRetry()` - 非流式请求重试
  - 新增 `doSendStreamWithRetry()` - 流式请求重试
  - 新增 `isSignatureError()` - 检测 signature 错误
  - 新增 `removeThinkingBlocks()` - 移除 thinking blocks

**关键代码**:
```go
// isSignatureError 检测是否是 thinking block signature 错误
func isSignatureError(errStr string) bool {
    return strings.Contains(errStr, "Invalid") &&
        strings.Contains(errStr, "signature") &&
        strings.Contains(errStr, "thinking")
}
```

### 3. 修复账户 ModelMapping 过滤逻辑（BUG修复）

**需求**: 当账户配置了 ModelMapping（如 `{"claude-opus-4-5-20251101":"MiniMax-M2.1"}`）且 AllowedModels 只允许目标模型时，账户被错误过滤掉无法使用。

**实现方案**: 修改 `filterByAllowedModelsWithOriginal()` 函数逻辑：
1. 先检查账户的 ModelMapping 是否包含请求的模型
2. 如果包含，获取映射后的目标模型
3. 用映射后的目标模型去匹配 AllowedModels

**修改文件**:
- `internal/proxy/scheduler/scheduler.go`
  - 重写 `filterByAllowedModelsWithOriginal()` 函数
  - 新增 `getAccountMappedModel()` 函数

**关键代码**:
```go
// getAccountMappedModel 获取账户 ModelMapping 中原始模型对应的目标模型
func getAccountMappedModel(acc *model.Account, originalModel string) string {
    if acc.ModelMapping == "" {
        return ""
    }
    mapping := parseAccountModelMapping(acc)
    if mapping == nil {
        return ""
    }
    originalLower := strings.ToLower(originalModel)
    for sourceModel, targetModel := range mapping {
        sourceLower := strings.ToLower(sourceModel)
        if strings.HasPrefix(originalLower, sourceLower) || sourceLower == originalLower {
            return targetModel
        }
    }
    return ""
}
```

---

## 技术要点

### Thinking Block 结构
```json
{
  "messages": [
    {
      "role": "assistant",
      "content": [
        {
          "type": "thinking",
          "thinking": "...",
          "signature": "..."  // 与认证上下文绑定
        },
        {
          "type": "text",
          "text": "..."
        }
      ]
    }
  ]
}
```

### 模型映射流程（修复后）
```
请求模型: claude-opus-4-5-20251101
    ↓
检查账户 ModelMapping
    ↓ (找到映射)
目标模型: MiniMax-M2.1
    ↓
匹配 AllowedModels: MiniMax-M2.1
    ↓ (匹配成功)
账户可用
```

---

## 遗留问题

- [ ] 重试配置优化：当前配置为 5 次重试，初始延迟 1 秒，退避系数 1.5。可根据实际情况调整
- [ ] 上游服务延迟：GLM、MiniMax 等第三方服务响应较慢（20-30秒），这是上游服务本身的问题

---

## 明日计划

### 1. 测试验证（优先级高）
- [x] Claude 模型正常转发
- [x] ModelMapping 正确生效（claude-* → MiniMax/GLM）
- [x] Thinking block signature 错误自动处理
- [x] 流式和非流式请求均正常

### 2. 文档完善
- [ ] 更新 ModelMapping 使用文档
- [ ] 添加 Thinking Block 处理说明

# 开发日志 - 2024-12-10

## 今日工作内容

### 1. 套餐系统功能完善

#### 1.1 订阅套餐周期额度
完善了订阅类型套餐的周期额度限制功能：

- **每日额度 (daily_quota)**：限制用户每天的消费上限
- **每周额度 (weekly_quota)**：限制用户每周的消费上限
- **每月额度 (monthly_quota)**：限制用户每月的消费上限

设置为 0 表示不限制该周期。

#### 1.2 周期使用量跟踪
添加了周期使用量字段：
- `daily_used` - 今日已使用
- `weekly_used` - 本周已使用
- `monthly_used` - 本月已使用

使用惰性重置策略，每次请求前检查是否需要重置。

#### 1.3 额度类型套餐
额度类型套餐只需要：
- `quota_total` - 总额度
- `quota_used` - 已使用额度
- `expire_time` - 过期时间

用完或过期后套餐失效。

### 2. 模型限制功能

#### 2.1 套餐模型限制
套餐可以限制用户只能使用特定模型：
- 字段 `allowed_models` 存储逗号分隔的模型名称
- 空值表示允许使用所有模型

#### 2.2 前端模型选择优化
将模型限制的输入方式从文本框改为多选下拉框：
- 从系统模型列表获取可选模型
- 支持多选、搜索、折叠标签
- 自动过滤只显示启用的模型

**修改文件**：
- `web/src/views/Packages.vue` - 套餐管理页面
- `web/src/views/Users.vue` - 用户管理页面

### 3. 后端 API 更新

#### 3.1 UpdateUserPackage 接口
增加了对以下字段的更新支持：
- `daily_used` - 每日使用量
- `weekly_used` - 每周使用量
- `monthly_used` - 每月使用量

**修改文件**：`internal/handler/package.go`

### 4. Bug 修复

#### 4.1 模型下拉框无数据问题
**问题**：模型选择下拉框显示为空，无法选择模型

**原因**：API 返回格式误判
- 错误代码：`res.data?.items`（假设分页格式）
- 正确格式：`res.data`（直接返回数组）

**修复**：
```javascript
// 修复前
modelList.value = res.data?.items || []

// 修复后
modelList.value = (res.data || []).filter(m => m.enabled)
```

## 代码变更统计

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| internal/model/package.go | 已存在 | 套餐和用户套餐模型 |
| internal/handler/package.go | 修改 | 添加周期使用量更新支持 |
| web/src/views/Packages.vue | 修改 | 模型多选下拉框 |
| web/src/views/Users.vue | 修改 | 用户套餐显示和编辑 |

## 文档更新

今日创建/更新了以下文档：

1. **模块设计文档**
   - `docs/模块设计/M1-基础框架.md` - 基础框架模块设计
   - `docs/模块设计/M2-账户管理.md` - 账户管理模块设计
   - `docs/模块设计/M3-代理转发.md` - 代理转发模块设计
   - `docs/模块设计/M8-套餐系统.md` - 套餐系统模块设计

2. **决策记录**
   - `docs/决策记录/ADR-001-套餐系统设计.md` - 套餐系统设计决策

## 待办事项

- [ ] 套餐购买流程实现
- [ ] 支付系统集成
- [ ] 代理转发模块开发
- [ ] Token 计费集成测试

## 备注

套餐系统的核心功能已完成，支持订阅制和额度制两种模式，以及灵活的模型限制。下一步需要实现用户自助购买流程和支付集成。

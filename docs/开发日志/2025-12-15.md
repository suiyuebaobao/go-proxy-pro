# 开发日志 2025-12-15

## 今日工作

### 1. 系统监控模块（新功能）

**需求**: 新增系统监控页面，显示系统资源、数据库状态、账号统计、用户统计、今日使用量

**实现**:

#### 1.1 后端

**新增文件**:
- `internal/service/system_monitor.go` - 监控服务
- `internal/handler/system_monitor.go` - API 接口

**监控数据结构**:
```go
type MonitorData struct {
    System     SystemStats     // CPU/内存/磁盘
    Redis      RedisStats      // Key数量/内存使用
    MySQL      MySQLStats      // 表数量/数据大小
    Accounts   AccountStats    // 总数/正常/限流/无效
    Users      UserStats       // 总数/活跃/今日新增
    TodayUsage TodayUsageStats // 消费/Token/请求数
}
```

**API 接口**:
| 接口 | 说明 |
|------|------|
| `GET /api/admin/monitor` | 完整监控数据 |
| `GET /api/admin/monitor/system` | 系统资源 |
| `GET /api/admin/monitor/redis` | Redis 统计 |
| `GET /api/admin/monitor/mysql` | MySQL 统计 |
| `GET /api/admin/monitor/accounts` | 账号统计 |
| `GET /api/admin/monitor/users` | 用户统计 |
| `GET /api/admin/monitor/today` | 今日使用统计 |

**依赖**: 新增 `github.com/shirou/gopsutil/v3` 用于获取系统资源信息

#### 1.2 前端

**新增文件**: `web/src/views/SystemMonitor.vue`

**页面内容**:
1. 今日使用概览（消费、Token、请求、活跃用户）
2. Token 详情（输入/输出/缓存创建/缓存读取）
3. 用户统计（总数、活跃、新增、活跃率）
4. 账号状态（总数、正常、限流、无效）
5. 系统资源（CPU、内存、磁盘 - 进度条显示）
6. 数据库状态（Redis、MySQL 连接和大小）

**路由**: `/system-monitor`
**菜单**: 侧边栏「系统监控」（仪表盘下方）

---

### 2. 接口文档完善

完善所有 API 接口文档，方便对接：

| 文档 | 说明 |
|------|------|
| `docs/接口文档/README.md` | 接口文档索引 |
| `docs/接口文档/认证接口文档.md` | 登录、注册接口 |
| `docs/接口文档/用户接口文档.md` | 个人资料、使用统计、套餐查询 |
| `docs/接口文档/代理转发接口文档.md` | OpenAI/Claude/Gemini 代理接口 |
| `docs/接口文档/系统监控接口文档.md` | 系统监控数据接口 |
| `docs/接口文档/管理员接口-用户账户模型.md` | 用户/账户/模型/OAuth 管理 |
| `docs/接口文档/管理员接口-日志缓存配置.md` | 日志/缓存/配置/代理配置 管理 |
| `docs/接口文档/管理员接口-套餐客户端过滤.md` | 套餐/客户端过滤 管理 |

---

### 3. 其他文档更新

| 文档 | 更新内容 |
|------|----------|
| `docs/README.md` | 添加按日期创建文档规则，M7 系统监控标记完成 |
| `docs/功能模块索引.md` | 新增第12节「系统监控」模块 |
| `docs/代码索引.md` | 新增系统监控变更记录 |

---

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `internal/service/system_monitor.go` | 新增监控服务 |
| `internal/handler/system_monitor.go` | 新增监控 API |
| `internal/handler/routes.go` | 添加监控路由 |
| `web/src/views/SystemMonitor.vue` | 新增监控页面 |
| `web/src/router/index.js` | 添加前端路由 |
| `web/src/layouts/MainLayout.vue` | 添加菜单项 |
| `web/src/api/index.js` | 添加监控 API |
| `go.mod` | 新增 gopsutil 依赖 |
| `docs/README.md` | 添加文档创建规则 |
| `docs/功能模块索引.md` | 新增系统监控模块 |
| `docs/代码索引.md` | 新增变更记录 |
| `docs/接口文档/系统监控接口文档.md` | 新增接口文档 |

---

## 关键代码位置

| 功能 | 文件 | 位置 |
|------|------|------|
| 监控服务 | `internal/service/system_monitor.go` | `GetMonitorData()` |
| 监控接口 | `internal/handler/system_monitor.go` | 全部 Handler |
| 监控路由 | `internal/handler/routes.go` | `/api/admin/monitor` |
| 监控页面 | `web/src/views/SystemMonitor.vue` | 完整页面 |

---

### 4. 系统日志查看模块（新功能）

**需求**: 在 Web 界面查看服务器端的所有日志文件

**实现**:

#### 4.1 后端

**新增文件**:
- `internal/handler/system_log.go` - 系统日志 API

**API 接口**:
| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/admin/system-logs/files` | GET | 获取日志文件列表 |
| `/api/admin/system-logs/read` | GET | 分页读取日志内容 |
| `/api/admin/system-logs/tail` | GET | 获取日志末尾内容（实时） |
| `/api/admin/system-logs/download` | GET | 下载日志文件 |
| `/api/admin/system-logs/file` | DELETE | 删除日志文件 |

**功能特点**:
- 自动识别日志分类（auth, http, proxy, scheduler 等）
- 支持按分类、日期过滤文件
- 支持分页读取、关键词搜索
- 支持正序/倒序显示
- 支持实时 tail 功能

#### 4.2 前端

**新增文件**: `web/src/views/SystemLogs.vue`

**页面布局**:
- 左侧：文件列表（分类筛选、日期筛选）
- 右侧：日志内容显示
  - 关键词搜索
  - 正序/倒序切换
  - 实时查看按钮
  - 分页控制

**路由**: `/system-logs`
**菜单**: 侧边栏「系统日志」

---

### 5. 安全功能测试与验证

对以下已实现的安全功能进行了完整测试：

| 功能 | 测试结果 | 说明 |
|------|----------|------|
| 图片验证码 | ✅ 通过 | `/api/auth/captcha` 返回 Base64 图片 |
| 登录限流 | ✅ 通过 | 连续 3 次失败后返回 429 错误 |
| 错误消息配置 | ✅ 通过 | CRUD 操作正常 |
| 安全配置管理 | ✅ 通过 | 获取/更新配置正常 |

---

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `internal/service/system_monitor.go` | 新增监控服务 |
| `internal/handler/system_monitor.go` | 新增监控 API |
| `internal/handler/system_log.go` | **新增**系统日志 API |
| `internal/handler/routes.go` | 添加监控路由、系统日志路由 |
| `web/src/views/SystemMonitor.vue` | 新增监控页面 |
| `web/src/views/SystemLogs.vue` | **新增**系统日志页面 |
| `web/src/router/index.js` | 添加前端路由 |
| `web/src/layouts/MainLayout.vue` | 添加菜单项 |
| `web/src/api/index.js` | 添加监控 API、系统日志 API |
| `go.mod` | 新增 gopsutil 依赖 |
| `docs/README.md` | 添加文档创建规则 |
| `docs/功能模块索引.md` | 新增系统监控、系统日志模块 |
| `docs/代码索引.md` | 新增变更记录 |
| `docs/接口文档/系统监控接口文档.md` | 新增接口文档 |

---

## 关键代码位置

| 功能 | 文件 | 位置 |
|------|------|------|
| 监控服务 | `internal/service/system_monitor.go` | `GetMonitorData()` |
| 监控接口 | `internal/handler/system_monitor.go` | 全部 Handler |
| 监控路由 | `internal/handler/routes.go` | `/api/admin/monitor` |
| 监控页面 | `web/src/views/SystemMonitor.vue` | 完整页面 |
| 系统日志服务 | `internal/handler/system_log.go` | `SystemLogHandler` |
| 系统日志路由 | `internal/handler/routes.go` | `/api/admin/system-logs` |
| 系统日志页面 | `web/src/views/SystemLogs.vue` | 完整页面 |

---

## 明日计划

- [ ] 测试系统监控数据准确性
- [ ] 验证各统计数据来源正确性
- [ ] 系统日志实时刷新优化（WebSocket）

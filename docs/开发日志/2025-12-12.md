# 开发日志 2025-12-12

## 今日工作

### 1. 用户套餐使用量更新（Bug修复）

**问题**: 用户管理页面"额度余额"和"订阅日余额"只显示套餐总额度，没有扣除已用量

**原因**: `RecordUsage()` 方法定义了但从未被调用，代理请求时没有更新套餐使用量

**修复**:
- `internal/repository/package.go` - 添加 `IncrementUsage()` 原子操作方法
- `internal/handler/proxy.go` - 在 `recordUsage()` 中添加套餐使用量更新逻辑

**关键代码**:
```go
// repository/package.go - 新增原子更新方法
func (r *UserPackageRepository) IncrementUsage(id uint, pkgType string, amount float64) error {
    if pkgType == "subscription" {
        return r.db.Model(&model.UserPackage{}).Where("id = ?", id).
            Updates(map[string]interface{}{
                "daily_used":   gorm.Expr("daily_used + ?", amount),
                "weekly_used":  gorm.Expr("weekly_used + ?", amount),
                "monthly_used": gorm.Expr("monthly_used + ?", amount),
            }).Error
    } else if pkgType == "quota" {
        return r.db.Model(&model.UserPackage{}).Where("id = ?", id).
            Update("quota_used", gorm.Expr("quota_used + ?", amount)).Error
    }
    return nil
}

// handler/proxy.go - recordUsage 中新增
userPackages, err := h.userPackageRepo.GetActiveByUserID(uid)
if err == nil && len(userPackages) > 0 {
    for _, up := range userPackages {
        // 惰性重置周期使用量
        if up.ResetPeriodUsageIfNeeded() {
            h.userPackageRepo.Update(&up)
        }
        // 增加使用量
        h.userPackageRepo.IncrementUsage(up.ID, up.Type, costBreakdown.TotalCost)
    }
}
```

**余额计算**（在 `repository/user.go`）:
- 额度余额 = `quota_total - quota_used`
- 订阅日余额 = `daily_quota - daily_used`

**BUG记录**: `docs/BUG处理/2025-12-12-套餐余额显示不正确.md`

### 2. 新增 BUG处理 文件夹

创建 `docs/BUG处理/` 文件夹，用于规范化记录 BUG 修复：
- 命名规范: `YYYY-MM-DD-问题简述.md`
- 内容: 问题描述、原因、修复方案、修改文件、验证方法

---

## 明日计划

### 1. 功能验证测试（优先级高）

- [ ] **套餐余额测试**
  - 创建一个测试用户
  - 分配订阅套餐（设置日限额 $1）
  - 分配额度套餐（设置总额度 $5）
  - 用该用户的 API Key 发起几次请求
  - 检查用户管理页面余额是否正确扣减

- [ ] **账户费用测试**
  - 查看账户管理页面"总费用"列
  - 发起请求后刷新，费用是否增加
  - 等待 5 分钟后检查 MySQL 是否同步

### 2. 边界情况测试

- [ ] **额度耗尽测试**
  - 设置一个很小的额度（如 $0.01）
  - 发起请求直到额度用完
  - 检查套餐状态是否变为 "exhausted"
  - 检查后续请求是否被拒绝

- [ ] **周期重置测试**
  - 手动修改数据库 `last_reset_day` 为昨天
  - 发起请求，检查 `daily_used` 是否重置为 0

### 3. 前端页面检查

- [ ] 用户管理页 - 余额显示
- [ ] 账户管理页 - 费用显示
- [ ] 套餐管理页 - 编辑功能
- [ ] 使用统计页 - 数据展示

### 4. 日志检查

- [ ] 查看服务器日志，确认无报错
- [ ] 检查 Redis 中的 key 是否正确写入
  ```bash
  redis-cli keys "cost:*" | head -20
  redis-cli keys "usage:*" | head -20
  ```

---

### 测试账号建议

```
用户名: test_user
密码: test123456
角色: user
套餐:
  - 订阅套餐（日限额 $1，周限额 $5，月限额 $20）
  - 额度套餐（总额度 $10）
```

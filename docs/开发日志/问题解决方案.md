# 问题解决方案记录

## 问题1: OAuth 路由 404 Not Found

**日期**: 2025-12-08

**现象**:
前端调用 `/api/admin/oauth/generate-url` 返回 404 Not Found

**原因分析**:
后端运行的是旧版本二进制文件，没有包含新增的 OAuth 路由

**解决步骤**:
1. 查找并终止旧进程
   ```bash
   ps aux | grep aiproxy
   kill <pid>
   ```
2. 重新编译
   ```bash
   cd /root/go-aiproxy
   go build -o aiproxy cmd/server/main.go
   ```
3. 启动新版本
   ```bash
   ./aiproxy &
   ```
4. 验证路由注册（查看启动日志）
   ```
   [GIN-debug] POST /api/admin/oauth/generate-url --> ...
   [GIN-debug] POST /api/admin/oauth/exchange --> ...
   [GIN-debug] POST /api/admin/oauth/cookie-auth --> ...
   ```

**相关代码**:
- 路由注册: `internal/handler/routes.go:89-94`

---

## 问题2: Frontend Network Error

**日期**: 2025-12-08

**现象**:
前端页面报 Network Error，无法连接后端 API

**原因分析**:
前端开发服务器未运行，Vite 代理无法转发请求到后端

**解决步骤**:
1. 检查前端服务状态
   ```bash
   curl -s http://localhost:3000
   ```
2. 启动前端开发服务器
   ```bash
   cd /root/go-aiproxy/web
   npm run dev -- --host 0.0.0.0
   ```
3. 验证代理配置 (`vite.config.js:14-18`)
   ```javascript
   proxy: {
     '/api': {
       target: 'http://localhost:8080',
       changeOrigin: true
     }
   }
   ```

**相关代码**:
- Vite 配置: `web/vite.config.js:12-20`
- API 基础配置: `web/src/api/index.js:1-10`

---

## 问题3: Claude SessionKey 认证返回 403

**日期**: 2025-12-08

**现象**:
使用 SessionKey 认证时返回 HTTP 403 和 Cloudflare 挑战页面

**原因分析**:
1. Claude.ai 使用 Cloudflare 保护，直接请求会触发人机验证
2. 服务器 IP 可能在 Cloudflare 黑名单中
3. 缺少必要的浏览器指纹 Headers

**解决方案**:
1. 配置代理服务器绕过 Cloudflare
   ```json
   {
     "proxy": {
       "type": "socks5",
       "host": "proxy.example.com",
       "port": 1080
     }
   }
   ```
2. 使用住宅 IP 代理
3. 确保 SessionKey 有效且未过期

**相关代码**:
- 代理配置: `internal/handler/oauth.go:419-453`
- SessionKey 认证: `internal/handler/oauth.go:210-238`

---

## 问题4: 前后端代码不同步

**日期**: 2025-12-08

**现象**:
前端新增了 OAuth 相关 API 调用，但后端没有对应的路由

**原因分析**:
修改前端时没有同步修改后端代码

**解决步骤**:
1. 检查前端 API 定义
   ```javascript
   // web/src/api/index.js:79-82
   generateOAuthUrl: (platform, proxy) => instance.post('/admin/oauth/generate-url', ...),
   exchangeOAuthCode: (platform, code, session_id, proxy) => instance.post('/admin/oauth/exchange', ...),
   oauthByCookie: (platform, session_key, proxy) => instance.post('/admin/oauth/cookie-auth', ...),
   ```
2. 创建后端 Handler
   - 新建 `internal/handler/oauth.go`
   - 实现 `GenerateURL`, `Exchange`, `CookieAuth` 方法
3. 注册路由
   ```go
   // internal/handler/routes.go:89-94
   oauth := admin.Group("/oauth")
   {
       oauth.POST("/generate-url", oauthHandler.GenerateURL)
       oauth.POST("/exchange", oauthHandler.Exchange)
       oauth.POST("/cookie-auth", oauthHandler.CookieAuth)
   }
   ```
4. 重新编译运行

**教训**:
前后端功能应同步开发，API 定义先于实现

---

## 调试技巧

### 检查后端路由是否注册
```bash
# 查看启动日志中的路由列表
grep "GIN-debug" /tmp/aiproxy.log
```

### 测试 API 端点
```bash
# 先获取 Token
TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | grep -o '"token":"[^"]*' | cut -d'"' -f4)

# 测试 OAuth API
curl -s -X POST http://localhost:8080/api/admin/oauth/generate-url \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"platform":"claude-official"}'
```

### 检查前端代理
```bash
# 通过前端代理测试（确认 Vite 代理工作正常）
curl -s -X POST http://localhost:3000/api/admin/oauth/generate-url \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"platform":"claude-official"}'
```

---

## 问题5: Claude 流式请求断流（SSE 错误事件）

**日期**: 2025-12-21

**现象**:
Claude 流式请求出现断流，日志显示：
```
Claude Stream 行数异常少 | 总行数: 3 | InputTokens: 0 | OutputTokens: 0
```

**原因分析**:
1. 上游返回 HTTP 200，但发送的是 SSE 错误事件
2. 原代码没有检测 SSE 事件类型，直接透传
3. 错误事件格式：`event: error` + `data: {"type":"error",...}`

**解决方案**:
1. 缓冲首个 `event:` 行，等待 `data:` 行
2. 如果首个事件是 `error` 类型，返回错误触发重试
3. 在 `isConnectionError()` 添加 SSE 错误类型

**相关代码**:
- SSE 错误检测: `internal/proxy/adapter/claude.go:250-292`
- 可重试错误: `internal/proxy/scheduler/retry.go:480-493`

**详细文档**:
- [BUG处理/2025-12-21-SSE错误事件检测与重试.md](../BUG处理/2025-12-21-SSE错误事件检测与重试.md)

---

## 问题6: ClaudeConsole 账户不应标记限流

**日期**: 2025-12-21

**现象**:
使用 API Key 模式的 ClaudeConsole 账户被错误标记为限流状态

**原因分析**:
1. API Key 模式的限流由上游直接控制
2. 不应该在代理层进行限流状态管理

**解决方案**:
1. 不提取 ClaudeConsole 账户的限流响应头
2. `MarkAccountErrorWithReset` 跳过 ClaudeConsole 账户
3. 清理历史限流数据

**相关代码**:
- 跳过限流头: `internal/proxy/adapter/claude.go:98-101, 154-157`
- 跳过限流标记: `internal/proxy/scheduler/scheduler.go:351-356`

**详细文档**:
- [BUG处理/2025-12-21-ClaudeConsole账户移除限流处理.md](../BUG处理/2025-12-21-ClaudeConsole账户移除限流处理.md)

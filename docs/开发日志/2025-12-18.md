# 开发日志 2025-12-18

## 今日工作

### 1. Chrome TLS 指纹支持

**需求**: OpenAI 等平台可能检测 TLS 指纹，需要模拟 Chrome 浏览器的 TLS 特征以避免被拦截。

**实现方案**:
1. 在 `http_client.go` 中添加 Chrome TLS 指纹支持
2. 使用 uTLS 库模拟 Chrome 120 的 TLS 握手
3. 支持 SOCKS5 和 HTTP 代理
4. 提供智能客户端选择（根据目标域名自动判断）

**修改文件**:
- `internal/proxy/adapter/http_client.go` - 新增 Chrome TLS 相关函数

**新增函数**:
| 函数 | 说明 |
|------|------|
| `GetChromeTLSClient()` | 获取带 Chrome TLS 指纹的 HTTP 客户端 |
| `GetSmartHTTPClient()` | 智能选择 HTTP 客户端（自动判断是否需要 Chrome TLS） |
| `dialTLSWithChrome()` | 使用 Chrome TLS 指纹建立 TLS 连接 |
| `dialWithProxy()` | 通过代理建立连接（支持 SOCKS5/HTTP） |
| `NeedsChromeTLS()` | 判断目标是否需要 Chrome TLS |

**需要 Chrome TLS 的域名**:
- `chatgpt.com`
- `claude.ai`
- `api.openai.com`
- `auth.openai.com`

---

### 2. OpenAI Responses 认证增强

**需求**:
1. 支持 Session Key（OAuth access token）认证
2. 使用 Chrome TLS 指纹连接 chatgpt.com

**修改文件**:
- `internal/proxy/adapter/openai_responses.go`

**认证逻辑**:
```go
// 优先使用 SessionKey（OAuth access token），否则使用 APIKey
authToken := account.APIKey
if account.SessionKey != "" {
    authToken = account.SessionKey
}
httpReq.Header.Set("Authorization", "Bearer "+authToken)
```

**HTTP 客户端**:
```go
// 使用智能 HTTP 客户端（chatgpt.com 使用 Chrome TLS）
client := GetSmartHTTPClient(account, targetURL)
```

---

### 3. OpenAI OAuth 支持

**需求**: 修复 OpenAI OAuth 链接生成，使用正确的 CLIENT_ID。

**参考**: claude-relay 的 `openaiAccountService.js`

**修改文件**:
- `internal/handler/oauth.go`

**配置常量**:
```go
// OpenAI OAuth 配置
OpenAIClientID    = "app_EMoamEEZ73f0CkXaXp7hrann"  // Codex CLI 官方 CLIENT_ID
OpenAITokenURL    = "https://auth.openai.com/oauth/token"
OpenAIAuthorizeURL = "https://auth.openai.com/authorize"
```

**新增函数**:
- `exchangeOpenAIToken()` - OpenAI OAuth token 交换

---

## 技术要点

### Chrome TLS 指纹原理

1. **问题**: 标准 Go HTTP 客户端的 TLS 指纹与 Chrome 不同，可能被服务端检测
2. **解决**: 使用 uTLS 库模拟 Chrome 120 的 TLS ClientHello
3. **注意**: 强制使用 HTTP/1.1，避免 HTTP/2 协议不匹配

### OpenAI 认证方式

| 方式 | 字段 | 来源 | 有效期 |
|------|------|------|--------|
| API Key | `account.APIKey` | 手动申请 | 长期有效 |
| Session Key | `account.SessionKey` | OAuth 流程 | 短期（需刷新） |

---

## 相关决策

参考 claude-relay 项目实现:
- `openaiAccountService.js` - OpenAI OAuth 刷新逻辑
- `openaiResponsesRelayService.js` - OpenAI Responses 转发

---

## 明日计划

- [ ] 测试 OpenAI OAuth 完整流程
- [ ] 添加 OpenAI token 自动刷新机制
- [ ] 考虑其他平台的 Chrome TLS 需求

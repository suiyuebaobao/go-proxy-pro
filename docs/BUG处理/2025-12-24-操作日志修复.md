# BUG修复: 操作日志记录不完整

> 日期: 2025-12-24
> 类型: BUG修复
> 状态: 已修复

---

## 问题描述

操作日志系统存在多个问题导致审计信息记录不完整：

1. **登录操作日志用户信息为空**
   - `user_id` 始终为 0
   - `username` 始终为空字符串

2. **更新/删除操作日志目标名称为空**
   - `target_id` 能正确记录
   - `target_name` 始终为空

**预期行为**:
- 登录日志应记录登录用户的 ID 和用户名
- 更新操作应记录被操作对象的 ID 和名称

**实际行为**:
- 登录日志 `user_id=0, username=""`
- 更新日志 `target_name=""`

---

## 问题原因

### 问题1：登录日志用户信息为空

登录请求处理流程：
```
请求 → JWT中间件（跳过）→ OperationLogger → LoginHandler → 响应
```

登录请求在认证之前，context 中没有用户信息。原代码只从 context 读取：
```go
userID, _ := c.Get("user_id")      // 返回 nil
username, _ := c.Get("username")    // 返回 nil
```

### 问题2：target_id 获取失败

原代码使用 Gin 的路由参数方法：
```go
func getPathID(c *gin.Context) uint {
    idStr := c.Param("id")  // 在通用中间件中返回空字符串
    id, _ := strconv.ParseUint(idStr, 10, 32)
    return uint(id)  // 返回 0
}
```

中间件执行时 Gin 路由尚未完成参数解析，`c.Param("id")` 返回空字符串。

### 问题3：target_name 查询失败

部分被操作的用户已被软删除，GORM 默认查询添加 `WHERE deleted_at IS NULL`：
```go
user, err := userRepoForLog.GetByID(id)  // 软删除用户返回 nil
```

---

## 修复方案

### 1. 登录日志：从响应中提取用户信息

**文件**: `internal/middleware/operation_log.go`

在响应返回后解析 JSON，从登录成功响应中提取用户信息：

```go
// 对于登录操作，从响应中提取用户信息
if mapping.Action == model.ActionLogin && respCode == 0 {
    if data, ok := respData["data"].(map[string]interface{}); ok {
        if user, ok := data["user"].(map[string]interface{}); ok {
            if id, ok := user["id"].(float64); ok {
                userIDUint = uint(id)
            }
            if name, ok := user["username"].(string); ok {
                usernameStr = name
            }
        }
    }
}
```

### 2. 路径ID提取：使用正则表达式

**文件**: `internal/middleware/operation_log.go`

添加正则表达式从 URL 路径中提取 ID：

```go
var (
    pathIDPattern       = regexp.MustCompile(`/(\d+)(?:/|$)`)
    secondPathIDPattern = regexp.MustCompile(`/(\d+)/[^/]+/(\d+)(?:/|$)`)
)

func getPathID(c *gin.Context) uint {
    // 优先使用 Gin 的 Param，如果没有则从路径中提取
    if idStr := c.Param("id"); idStr != "" {
        id, _ := strconv.ParseUint(idStr, 10, 32)
        return uint(id)
    }
    // 从 URL 路径中提取第一个数字ID
    path := c.Request.URL.Path
    matches := pathIDPattern.FindStringSubmatch(path)
    if len(matches) >= 2 {
        id, _ := strconv.ParseUint(matches[1], 10, 32)
        return uint(id)
    }
    return 0
}
```

### 3. 软删除查询：使用 Unscoped

**文件**: `internal/middleware/operation_log.go`

所有 `getXxxNameByID()` 函数改用 `Unscoped()` 查询：

```go
func getUsernameByID(id uint) string {
    if repository.DB == nil {
        return ""
    }
    var user model.User
    if err := repository.DB.Unscoped().First(&user, id).Error; err != nil {
        return ""
    }
    return user.Username
}

// 同样修改：
// - getAccountNameByID()
// - getGroupNameByID()
// - getAPIKeyNameByID()
// - getModelNameByID()
// - getProxyNameByID()
// - getPackageNameByID()
// - getUserPackageNameByID()
```

---

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `internal/middleware/operation_log.go` | 路径ID正则提取、软删除Unscoped查询、登录响应解析 |

**具体修改位置**:
- 第149-186行：新增路径ID提取正则和函数
- 第251-263行：`getUsernameByID()` 改用 Unscoped
- 第265-276行：`getAccountNameByID()` 改用 Unscoped
- 第278-289行：`getGroupNameByID()` 改用 Unscoped
- 第291-302行：`getAPIKeyNameByID()` 改用 Unscoped
- 第304-315行：`getModelNameByID()` 改用 Unscoped
- 第317-326行：`getProxyNameByID()` 改用 Unscoped
- 第329-339行：`getPackageNameByID()` 改用 Unscoped
- 第342-357行：`getUserPackageNameByID()` 改用 Unscoped
- 第720-732行：登录响应解析提取用户信息

---

## 验证方法

1. **登录操作验证**
```bash
# 登录请求
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"test123"}'

# 检查数据库
mysql -u root aiproxy -e "SELECT id, user_id, username, module, action FROM operation_logs WHERE action='login' ORDER BY id DESC LIMIT 1;"
# 预期：user_id=1, username='admin'
```

2. **更新操作验证**
```bash
# 更新用户请求
curl -X PUT http://localhost:8080/api/admin/users/4 \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com"}'

# 检查数据库
mysql -u root aiproxy -e "SELECT id, target_id, target_name, description FROM operation_logs WHERE action='update' ORDER BY id DESC LIMIT 1;"
# 预期：target_id=4, target_name='testuser2'（即使用户已软删除）
```

3. **测试结果**
```
id | user_id | username | module | action | target_id | target_name | description
---|---------|----------|--------|--------|-----------|-------------|-------------
557| 1       | admin    | user   | update | 1         | admin       | 更新用户 #1
556| 1       | admin    | auth   | login  | 0         | admin       | 用户登录
555| 1       | admin    | user   | update | 4         | testuser2   | 更新用户 #4
```

所有字段正确记录。

---

## 相关文档

- [开发日志 2025-12-24](../开发日志/2025-12-24.md)
- [功能模块索引 - 操作日志](../功能模块索引.md#16-操作日志)

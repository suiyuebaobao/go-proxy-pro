# 优化: 用户统计按套餐分别显示

> 日期: 2025-12-13
> 类型: 功能优化

---

## 问题描述

用户管理页面点击"统计"按钮后，只显示总的使用统计（总请求数、总Token、总消费），没有按套餐分别显示使用情况。

**用户反馈**: 应该按套餐来统计，统计成一个不合适。

---

## 优化方案

在统计弹窗中新增"套餐使用情况"部分，分别显示每个套餐的：
- 套餐名称、类型、状态
- 订阅套餐：日/周/月 已用/限额
- 额度套餐：已用/总额度 + 进度条

---

## 修改文件

### 后端

**文件**: `internal/handler/usage.go`

1. `UsageHandler` 添加 `userPackageRepo` 字段
2. `AdminGetUserUsageSummary` 方法新增套餐使用情况返回

```go
// 获取用户套餐使用情况
userPackages, _ := h.userPackageRepo.GetByUserID(uint(userID))
packageUsage := make([]gin.H, 0, len(userPackages))
for _, up := range userPackages {
    pkgInfo := gin.H{
        "id":     up.ID,
        "name":   up.Name,
        "type":   up.Type,
        "status": up.Status,
    }

    if up.Type == "subscription" {
        pkgInfo["daily_quota"] = up.DailyQuota
        pkgInfo["daily_used"] = up.DailyUsed
        pkgInfo["daily_remain"] = up.DailyQuota - up.DailyUsed
        // ... 周、月同理
    } else if up.Type == "quota" {
        pkgInfo["quota_total"] = up.QuotaTotal
        pkgInfo["quota_used"] = up.QuotaUsed
        pkgInfo["quota_remain"] = up.QuotaTotal - up.QuotaUsed
    }

    packageUsage = append(packageUsage, pkgInfo)
}

response.Success(c, gin.H{
    // ... 原有字段
    "package_usage":  packageUsage,  // 新增
})
```

### 前端

**文件**: `web/src/views/Users.vue`

1. 添加 `packageUsage` 变量
2. 统计弹窗新增套餐使用情况表格
3. 添加相关 CSS 样式

---

## 效果

统计弹窗现在显示：
1. **统计概览** - 总请求数、总Token、总消费
2. **套餐使用情况** - 每个套餐的详细使用情况（新增）
3. **按模型统计** - 按模型分组的统计

---

## 相关文档

- [M8-套餐系统设计](../模块设计/M8-套餐系统.md)

# 客户端过滤界面简化

> 修复日期：2025-12-14
> 类型：功能优化
> 模块：客户端过滤 (M5)

## 需求描述

简化客户端过滤界面，改为简单/严格两种模式：
- **简单模式**: 参考 claude-relay 项目，只检查 User-Agent 前缀
- **严格模式**: 完整验证 UA、Headers、System Prompt、metadata

## 实现方案

### 1. 后端 - 添加过滤模式

**文件**: `internal/model/client_filter.go`

新增模式常量：
```go
const (
    FilterModeSimple = "simple" // 简单模式: 宽松UA检查
    FilterModeStrict = "strict" // 严格模式: 完整验证
)

type ClientFilterConfig struct {
    FilterEnabled  bool     `json:"filter_enabled"`
    FilterMode     string   `json:"filter_mode"`     // 新增
    AllowedClients []string `json:"allowed_clients"`
}
```

**文件**: `internal/service/client_filter.go`

根据模式选择不同的验证逻辑：

```go
func (s *ClientFilterService) matchClientType(ctx context.Context, ct *model.ClientType, req *model.ClientValidateRequest) (bool, map[string]interface{}) {
    config, _ := s.GetConfig(ctx)
    mode := config.FilterMode
    if mode == "" {
        mode = model.FilterModeSimple
    }

    // 根据模式选择 UA 正则
    var uaPattern string
    if mode == model.FilterModeSimple {
        // 简单模式: 只检查前缀
        uaPattern = `^claude-cli/\d+\.\d+\.\d+`
    } else {
        // 严格模式: 完整格式
        uaPattern = `^claude-cli/(\d+\.\d+\.\d+)\s*\(external,\s*(cli|claude-vscode|sdk-ts|sdk-cli)(?:,\s*agent-sdk/[\w.\-]+)?\)`
    }
    // ...
}

func (s *ClientFilterService) validateClaudeCodeRules(req *model.ClientValidateRequest, mode string) (bool, string) {
    if mode == model.FilterModeSimple {
        return true, "" // 简单模式跳过详细验证
    }
    // 严格模式：检查 Headers、System Prompt、metadata
    // ...
}
```

### 2. 前端 - 简化界面

**文件**: `web/src/views/ClientFilter.vue`

完全重写，简化为四个部分：

1. **主开关卡片**
   - 客户端过滤总开关
   - 显示当前状态（已开启/已关闭）

2. **允许的客户端**
   - 卡片式布局，每个客户端一张卡片
   - 点击切换启用/禁用
   - 启用时显示绿色边框和勾选图标

3. **验证模式**
   - 单选按钮组
   - 简单模式：宽松验证（推荐大多数场景）
   - 严格模式：完整验证（安全要求高的场景）
   - 下方显示当前模式的说明

4. **验证测试**（折叠面板）
   - User-Agent 输入
   - Headers JSON 输入
   - Body JSON 输入
   - 测试按钮 + 填入示例按钮
   - 显示测试结果

## 模式对比

| 验证项 | 简单模式 | 严格模式 |
|--------|----------|----------|
| UA 前缀 `claude-cli/x.x.x` | ✅ | ✅ |
| UA 完整格式 `(external, cli)` | - | ✅ |
| 必需 Headers | - | ✅ |
| System Prompt 相似度 | - | ✅ |
| metadata.user_id 格式 | - | ✅ |

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `internal/model/client_filter.go` | 添加 `FilterMode` 常量和字段 |
| `internal/service/client_filter.go` | 根据模式选择验证规则 |
| `internal/repository/client_filter.go` | 支持 `filter_mode` 字段读写 |
| `web/src/views/ClientFilter.vue` | 完全重写简化界面 |

## 关键代码位置

| 功能 | 文件 | 位置 |
|------|------|------|
| 模式常量 | `internal/model/client_filter.go` | 第37-40行 |
| UA 匹配 | `internal/service/client_filter.go` | `matchClientType()` 第239-274行 |
| 规则验证 | `internal/service/client_filter.go` | `validateClaudeCodeRules()` 第320-458行 |

## 使用建议

| 场景 | 推荐模式 |
|------|----------|
| 个人使用、内部测试 | 简单模式 |
| 生产环境、安全要求高 | 严格模式 |
| 需要兼容多种客户端 | 简单模式 |
| 只允许官方 Claude Code | 严格模式 |

## 相关文档

- [功能模块索引](../功能模块索引.md) - 第11节客户端过滤
- [故障排查手册](../故障排查手册.md) - 客户端过滤问题排查
- [代码索引](../代码索引.md) - 变更记录

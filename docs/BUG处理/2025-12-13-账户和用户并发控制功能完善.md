# 功能优化: 账户和用户并发控制功能完善

> 日期: 2025-12-13
> 类型: 功能优化
> 状态: 已完成

---

## 功能描述

完善账户级别和用户级别的并发控制功能，包括：

1. **账户并发控制**: 限制单个账户同时处理的请求数
2. **用户并发控制**: 限制单个用户同时进行的请求数
3. **前端管理界面**: 在账户管理和缓存管理页面添加并发控制配置

---

## 实现方案

### 1. 后端修改

#### 1.1 账户模型添加 MaxConcurrency 字段

**文件**: `internal/model/account.go`

```go
type Account struct {
    // ... 其他字段
    MaxConcurrency int `json:"max_concurrency" gorm:"default:5"` // 最大并发数
}
```

#### 1.2 用户模型添加 MaxConcurrency 字段

**文件**: `internal/model/user.go`

```go
type User struct {
    // ... 其他字段
    MaxConcurrency int `json:"max_concurrency" gorm:"default:10"` // 最大并发数
}
```

#### 1.3 Account Service 添加 MaxConcurrency 支持

**文件**: `internal/service/account.go`

- `CreateAccountRequest` 添加 `MaxConcurrency` 字段
- `UpdateAccountRequest` 添加 `MaxConcurrency *int` 字段（指针类型）
- `Create()` 方法设置默认并发限制为 5
- `Update()` 方法处理 MaxConcurrency 更新

#### 1.4 User Service 添加 MaxConcurrency 支持

**文件**: `internal/service/user.go`

- `AdminCreateUserRequest` 添加 `MaxConcurrency` 字段
- `UpdateUserRequest` 添加 `MaxConcurrency *int` 字段（指针类型）
- `AdminCreateUser()` 方法设置默认并发限制为 10
- `Update()` 方法处理 MaxConcurrency 更新

#### 1.5 账户列表返回实时并发数

**文件**: `internal/handler/account.go`

```go
type AccountHandler struct {
    service      *service.AccountService
    usageService *service.UsageService
    cacheService *service.CacheService  // 新增
}

type AccountWithUsage struct {
    model.Account
    TodayTokens        int64   `json:"today_tokens"`
    TodayCount         int64   `json:"today_count"`
    TotalCost          float64 `json:"total_cost"`
    CurrentConcurrency int64   `json:"current_concurrency"` // 新增
}

// List() 方法中获取实时并发数
if concurrent, err := h.cacheService.GetAccountConcurrency(ctx, acc.ID); err == nil {
    items[i].CurrentConcurrency = concurrent
}
```

### 2. 前端修改

#### 2.1 账户列表显示并发数

**文件**: `web/src/views/Accounts.vue`

```vue
<el-table-column label="并发" width="100" align="center">
  <template #default="{ row }">
    <div class="concurrency-cell">
      <span class="concurrency-current" :class="getConcurrencyClass(row)">
        {{ row.current_concurrency || 0 }}
      </span>
      <span class="concurrency-separator">/</span>
      <span class="concurrency-max">{{ row.max_concurrency || 5 }}</span>
    </div>
  </template>
</el-table-column>
```

颜色指示:
- 绿色: 正常 (< 80%)
- 黄色: 接近上限 (80% ~ 100%)
- 红色: 已满 (= 100%)

#### 2.2 账户表单组件

**文件**: `web/src/components/AccountForm.vue`

- 新建模式: 已有 max_concurrency 字段（第 215-218 行）
- 编辑模式: 添加 max_concurrency 字段（第 460-463 行）
- 表单布局调整为 4 列（优先级、权重、最大并发、启用）

#### 2.3 API 封装

**文件**: `web/src/api/index.js`

添加用户并发管理 API:
```javascript
// Admin - User Concurrency
getUserConcurrency: (userId) => Get(`/admin/users/${userId}/concurrency`),
resetUserConcurrency: (userId) => Delete(`/admin/users/${userId}/concurrency`),
```

#### 2.4 简化缓存管理页面

**文件**: `web/src/views/Cache.vue`

完全重写，简化为三个区域:

1. **缓存配置卡片**:
   - 会话 TTL（分钟）
   - 会话续期阈值（分钟）
   - 并发计数 TTL（分钟）
   - 保存按钮

2. **账号缓存卡片**:
   - 输入账号ID查询
   - 显示当前并发数、最大并发数、绑定会话数
   - 显示绑定的会话列表（会话ID、用户、绑定时间）
   - 清除单个账号缓存
   - 清除所有账号缓存

3. **用户缓存卡片**:
   - 输入用户ID查询
   - 显示当前并发数、最大并发数、绑定会话数
   - 显示用户的会话列表（会话ID、账号、绑定时间）
   - 清除单个用户缓存
   - 清除所有用户缓存

---

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `internal/handler/account.go` | 添加cacheService，返回CurrentConcurrency |
| `internal/service/account.go` | 添加 MaxConcurrency 到请求结构体和处理逻辑 |
| `internal/service/user.go` | 添加 MaxConcurrency 到请求结构体和处理逻辑 |
| `web/src/views/Accounts.vue` | 添加并发列，显示当前/最大并发，颜色指示 |
| `web/src/views/Cache.vue` | 完全重写简化，三个区域 |
| `web/src/components/AccountForm.vue` | 编辑模式添加 max_concurrency 字段 |
| `web/src/api/index.js` | 添加用户并发管理 API |

---

## 使用说明

### 账户并发限制

1. 在"账户管理"页面创建或编辑账户时，可以设置"最大并发"
2. 默认值为 5
3. 当账户并发达到上限时，新请求会返回 429 Too Many Requests

### 用户并发限制

1. 在"用户管理"页面创建或编辑用户时，可以设置"最大并发"
2. 默认值为 10
3. 当用户并发达到上限时，新请求会返回 429 Too Many Requests

### 缓存管理

1. "账户并发"标签页: 查询和管理单个账户的并发状态
2. "用户并发"标签页: 查询和管理单个用户的并发状态
3. 可以手动重置并发计数（解决计数异常问题）

---

## 后端 API

### 账户并发

| 接口 | 方法 | 说明 |
|------|------|------|
| `/admin/accounts/:id/cache/concurrency` | GET | 获取账户并发信息 |
| `/admin/accounts/:id/cache/concurrency` | PUT | 设置账户并发限制 |
| `/admin/accounts/:id/cache/concurrency` | DELETE | 重置账户并发计数 |

### 用户并发

| 接口 | 方法 | 说明 |
|------|------|------|
| `/admin/users/:id/concurrency` | GET | 获取用户并发信息 |
| `/admin/users/:id/concurrency` | DELETE | 重置用户并发计数 |

---

## 相关文档

- [功能模块索引](../功能模块索引.md) - 缓存管理模块
- [M9-服务层设计](../模块设计/M9-服务层设计.md) - Redis Key 设计

---

## 后续更新：缓存管理页面聚合视图

### 需求变更

用户反馈：缓存管理页面需要直接显示列表，而不是让用户手动查询。需要支持：
1. 按账号维度查看缓存（每个账号被哪些用户使用）
2. 按用户维度查看缓存（每个用户使用了哪些账号）

### 新增后端接口

**文件**: `internal/service/cache.go`

```go
// AccountCacheInfo 账号缓存信息（聚合）
type AccountCacheInfo struct {
    AccountID      uint             `json:"account_id"`
    Concurrency    int64            `json:"concurrency"`
    MaxConcurrency int              `json:"max_concurrency"`
    SessionCount   int              `json:"session_count"`
    Sessions       []SessionBinding `json:"sessions"`
    Users          []uint           `json:"users"` // 使用此账号的用户ID列表
}

// UserCacheInfo 用户缓存信息（聚合）
type UserCacheInfo struct {
    UserID       uint             `json:"user_id"`
    Concurrency  int64            `json:"concurrency"`
    SessionCount int              `json:"session_count"`
    Sessions     []SessionBinding `json:"sessions"`
    Accounts     []uint           `json:"accounts"` // 此用户使用的账号ID列表
}

// ListAccountsWithCache 按账号聚合缓存列表
func (s *CacheService) ListAccountsWithCache(ctx context.Context) ([]AccountCacheInfo, error)

// ListUsersWithCache 按用户聚合缓存列表
func (s *CacheService) ListUsersWithCache(ctx context.Context) ([]UserCacheInfo, error)
```

**文件**: `internal/handler/cache.go`

新增接口：
- `ListAccountsCache()` - 账号缓存聚合列表
- `ListUsersCache()` - 用户缓存聚合列表

**文件**: `internal/handler/routes.go`

新增路由：
```go
cache.GET("/accounts", cacheHandler.ListAccountsCache)
cache.GET("/users", cacheHandler.ListUsersCache)
```

### 前端重构

**文件**: `web/src/views/Cache.vue`

完全重写为双Tab布局：

1. **缓存配置区域** - 4个TTL设置：
   - 粘性会话TTL (session_ttl)
   - 会话续期阈值 (session_renewal_ttl)
   - 不可用标记TTL (unavailable_ttl)
   - 并发计数TTL (concurrency_ttl)

2. **账号缓存Tab**：
   - 表格显示：账号ID、并发(当前/最大)、会话数、使用此账号的用户列表
   - 点击"查看会话"弹窗显示详细会话列表
   - 支持按账号ID搜索
   - 支持清除单个/全部账号缓存

3. **用户缓存Tab**：
   - 表格显示：用户ID、并发(当前/10)、会话数、使用的账号列表
   - 点击"查看会话"弹窗显示详细会话列表
   - 支持按用户ID搜索
   - 支持清除单个/全部用户缓存

**文件**: `web/src/api/index.js`

新增API：
```javascript
getCacheAccounts: () => Get('/admin/cache/accounts'),
getCacheUsers: () => Get('/admin/cache/users'),
```

### 补充文件清单

| 文件 | 修改内容 |
|------|----------|
| `internal/service/cache.go` | 新增 AccountCacheInfo/UserCacheInfo 结构体和聚合方法 |
| `internal/handler/cache.go` | 新增 ListAccountsCache/ListUsersCache 接口 |
| `internal/handler/routes.go` | 新增 /admin/cache/accounts 和 /admin/cache/users 路由 |
| `web/src/views/Cache.vue` | 完全重写为双Tab聚合视图 |
| `web/src/api/index.js` | 新增 getCacheAccounts/getCacheUsers API |

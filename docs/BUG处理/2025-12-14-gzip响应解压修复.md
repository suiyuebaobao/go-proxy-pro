# gzip 响应解压修复

> 修复日期：2025-12-14
> 类型：BUG修复
> 严重程度：高（导致代理请求全部失败）

## 问题描述

代理请求返回 502 错误，错误信息：
```
parse response: invalid character '\x1f' looking for beginning of value
```

## 原因分析

1. 上游 API（如 Claude API）返回 gzip 压缩的响应体
2. 代码直接使用 `io.ReadAll(resp.Body)` 读取，未解压
3. 将压缩的二进制数据当作 JSON 解析，遇到 gzip 魔术字节 `\x1f\x8b` 报错

**gzip 文件格式**:
- 前两个字节固定为 `0x1f 0x8b`（魔术字节）
- `\x1f` 是十进制 31，在 JSON 解析时报 `invalid character`

## 解决方案

### 1. 新增 gzip 解压辅助函数

**文件**: `internal/proxy/adapter/http_client.go`

```go
func ReadResponseBody(resp *http.Response) ([]byte, error) {
    if resp.Body == nil {
        return nil, nil
    }
    var reader io.Reader = resp.Body
    contentEncoding := resp.Header.Get("Content-Encoding")

    // 方式1: 按 Content-Encoding 头解压
    if strings.EqualFold(contentEncoding, "gzip") {
        gzReader, err := gzip.NewReader(resp.Body)
        if err != nil {
            return nil, err
        }
        defer gzReader.Close()
        reader = gzReader
    }

    var buf bytes.Buffer
    _, err := io.Copy(&buf, reader)
    if err != nil {
        return nil, err
    }
    data := buf.Bytes()

    // 方式2: 检测 magic bytes 作为后备（某些代理可能剥离 Content-Encoding 头）
    if !strings.EqualFold(contentEncoding, "gzip") && len(data) >= 2 &&
       data[0] == 0x1f && data[1] == 0x8b {
        gzReader, err := gzip.NewReader(bytes.NewReader(data))
        if err != nil {
            return data, nil // 解压失败返回原数据
        }
        defer gzReader.Close()
        decompressed, err := io.ReadAll(gzReader)
        if err != nil {
            return data, nil
        }
        return decompressed, nil
    }
    return data, nil
}
```

### 2. 过滤 Accept-Encoding 请求头

**文件**: `internal/proxy/adapter/claude.go`

在过滤头列表中添加 `accept-encoding`，避免请求 gzip 响应：

```go
var filteredHeaders = map[string]bool{
    "host":            true,
    "content-length":  true,
    "accept-encoding": true,  // 新增：避免请求 gzip 响应
    // ...
}
```

### 3. 更新所有适配器

将 `io.ReadAll(resp.Body)` 替换为 `ReadResponseBody(resp)`:

| 文件 | 修改位置 |
|------|----------|
| `claude.go` | 所有响应读取处 |
| `openai.go` | 所有响应读取处 |
| `azure.go` | 所有响应读取处 |
| `gemini.go` | 所有响应读取处 |
| `bedrock.go` | 所有响应读取处 |
| `claude_ccr.go` | 所有响应读取处 |

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `internal/proxy/adapter/http_client.go` | 新增 `ReadResponseBody()` 函数 |
| `internal/proxy/adapter/claude.go` | 使用 `ReadResponseBody()`，过滤 `accept-encoding` |
| `internal/proxy/adapter/openai.go` | 使用 `ReadResponseBody()` |
| `internal/proxy/adapter/azure.go` | 使用 `ReadResponseBody()` |
| `internal/proxy/adapter/gemini.go` | 使用 `ReadResponseBody()` |
| `internal/proxy/adapter/bedrock.go` | 使用 `ReadResponseBody()` |
| `internal/proxy/adapter/claude_ccr.go` | 使用 `ReadResponseBody()` |

## 验证方法

1. 发送代理请求，确认不再返回 502 错误
2. 检查日志，确认响应正常解析

## 相关文档

- [故障排查手册](../故障排查手册.md) - 新增此错误的排查说明
- [代码索引](../代码索引.md) - 变更记录

# BUG: 套餐余额显示不正确

> 日期: 2025-12-12
> 状态: 已修复

---

## 问题描述

用户管理页面的"额度余额"和"订阅日余额"两列只显示套餐的总额度，没有扣除已消费的额度。

**预期行为**: 显示剩余额度 = 总额度 - 已用额度
**实际行为**: 显示总额度（已用额度始终为 0）

---

## 问题原因

`internal/model/package.go` 中定义了 `RecordUsage()` 方法用于记录套餐使用量，但该方法**从未被调用**。

代理请求完成后，系统记录了：
- Redis 使用统计 ✓
- MySQL 每日汇总 ✓
- API Key 使用量 ✓
- 账户费用 ✓
- **用户套餐使用量 ✗** ← 遗漏

导致 `user_packages` 表中的 `daily_used`, `weekly_used`, `monthly_used`, `quota_used` 字段始终为 0。

---

## 修复方案

### 1. 新增原子更新方法

**文件**: `internal/repository/package.go`

```go
// IncrementUsage 增加套餐使用量（原子操作）
func (r *UserPackageRepository) IncrementUsage(id uint, pkgType string, amount float64) error {
    if pkgType == "subscription" {
        return r.db.Model(&model.UserPackage{}).Where("id = ?", id).
            Updates(map[string]interface{}{
                "daily_used":   gorm.Expr("daily_used + ?", amount),
                "weekly_used":  gorm.Expr("weekly_used + ?", amount),
                "monthly_used": gorm.Expr("monthly_used + ?", amount),
            }).Error
    } else if pkgType == "quota" {
        return r.db.Model(&model.UserPackage{}).Where("id = ?", id).
            Update("quota_used", gorm.Expr("quota_used + ?", amount)).Error
    }
    return nil
}
```

### 2. 在代理请求中调用

**文件**: `internal/handler/proxy.go`

添加 `userPackageRepo` 到 ProxyHandler 结构体：
```go
type ProxyHandler struct {
    // ... 其他字段
    userPackageRepo *repository.UserPackageRepository  // 新增
}
```

在 `recordUsage()` 方法中添加套餐使用量更新：
```go
// 更新用户套餐使用量
if uid > 0 {
    userPackages, err := h.userPackageRepo.GetActiveByUserID(uid)
    if err == nil && len(userPackages) > 0 {
        for _, up := range userPackages {
            // 惰性重置周期使用量
            if up.ResetPeriodUsageIfNeeded() {
                h.userPackageRepo.Update(&up)
            }
            // 增加使用量
            h.userPackageRepo.IncrementUsage(up.ID, up.Type, costBreakdown.TotalCost)
        }
    }
}
```

---

## 余额计算逻辑

**文件**: `internal/repository/user.go` - `GetUserKeyBalances()`

| 字段 | 计算公式 |
|------|----------|
| 额度余额 | `quota_total - quota_used` |
| 订阅日余额 | `daily_quota - daily_used` |

---

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `internal/repository/package.go` | 新增 `IncrementUsage()` 方法 |
| `internal/handler/proxy.go` | 添加 `userPackageRepo`，在 `recordUsage()` 中更新套餐使用量 |

---

## 验证方法

1. 给用户分配一个套餐（订阅或额度类型）
2. 使用该用户的 API Key 发起请求
3. 查看用户管理页面，"额度余额"或"订阅日余额"应该减少

---

## 相关文档

- [M8-套餐系统设计](../模块设计/M8-套餐系统.md)
- [功能模块索引](../功能模块索引.md)

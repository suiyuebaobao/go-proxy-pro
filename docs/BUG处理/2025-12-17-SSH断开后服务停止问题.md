# BUG: SSH 断开后服务自动停止

> 日期: 2025-12-17
> 类型: BUG修复
> 状态: 已修复

---

## 问题描述

服务运行一段时间后突然无法访问，进程消失。

**预期行为**: 服务持续运行，不受 SSH 连接状态影响
**实际行为**: SSH 会话断开/超时后，服务进程被终止

---

## 问题原因

### 根本原因

服务通过 `nohup ./aiproxy &` 在 SSH 终端中启动，当 SSH 会话断开时，systemd 清理该会话的 scope，导致会话下的所有进程（包括 aiproxy）被终止。

### 系统日志证据

```
Dec 17 05:30:19 systemd[1]: session-146.scope: Deactivated successfully.
Dec 17 05:30:19 systemd[1]: session-146.scope: Consumed 1h 35min 44.494s CPU time.
```

### 应用日志证据

主日志显示服务正常启动后，没有关闭日志（异常终止）：
```
[2025-12-16 13:24:51.211] [INFO] [main] 服务启动完成 | 总耗时: 1.052475818s
# 之后没有 "收到关闭信号" 日志，说明进程被强制杀掉
```

---

## 修复方案

### 创建 systemd 服务

**文件**: `/etc/systemd/system/aiproxy.service`

```ini
[Unit]
Description=Go-AIProxy Service
After=network.target mysql.service redis.service

[Service]
Type=simple
User=root
WorkingDirectory=/root/go-aiproxy
ExecStart=/root/go-aiproxy/aiproxy
Restart=always
RestartSec=5
StandardOutput=append:/root/go-aiproxy/logs/server.log
StandardError=append:/root/go-aiproxy/logs/server.log

[Install]
WantedBy=multi-user.target
```

### 启用服务

```bash
# 重载 systemd 配置
systemctl daemon-reload

# 启用开机自启
systemctl enable aiproxy

# 启动服务
systemctl start aiproxy

# 查看状态
systemctl status aiproxy
```

---

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `/etc/systemd/system/aiproxy.service` | 新增：systemd 服务配置文件 |

---

## 验证方法

1. 启动服务：`systemctl start aiproxy`
2. 确认运行：`systemctl status aiproxy` 显示 `active (running)`
3. 健康检查：`curl http://localhost:8080/health` 返回 `{"status":"ok"}`
4. 断开 SSH，重新连接后确认服务仍在运行

---

## 常用命令

| 命令 | 说明 |
|------|------|
| `systemctl status aiproxy` | 查看服务状态 |
| `systemctl start aiproxy` | 启动服务 |
| `systemctl stop aiproxy` | 停止服务 |
| `systemctl restart aiproxy` | 重启服务 |
| `systemctl enable aiproxy` | 启用开机自启 |
| `systemctl disable aiproxy` | 禁用开机自启 |
| `journalctl -u aiproxy -f` | 查看实时日志 |
| `journalctl -u aiproxy --since "1 hour ago"` | 查看最近1小时日志 |

---

## 相关知识

### 为什么 nohup 不够用？

`nohup` 只是忽略 SIGHUP 信号，但现代 Linux 使用 systemd 管理会话，当 SSH 会话关闭时：
1. systemd 会清理该会话的 scope（`session-xxx.scope`）
2. scope 内的所有进程会被终止（不一定通过 SIGHUP）

### systemd 服务的优势

| 特性 | nohup | systemd |
|------|-------|---------|
| SSH 断开后存活 | 不稳定 | 稳定 |
| 开机自启 | 需要额外配置 | 内置支持 |
| 崩溃自动重启 | 不支持 | 支持 |
| 日志管理 | 手动 | journalctl |
| 资源限制 | 不支持 | 支持 |
| 依赖管理 | 不支持 | 支持 |

# 管理员接口文档 - 套餐/客户端过滤

## 概述

管理员接口需要 JWT Token 认证且用户角色为 admin。

**认证**: `Authorization: Bearer <jwt_token>`

---

## 一、套餐管理

### 1. 获取套餐列表

**路径**: `GET /api/admin/packages`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "基础套餐",
      "description": "适合个人用户",
      "price": 10.00,
      "token_quota": 100000,
      "valid_days": 30,
      "allowed_platforms": "claude-official,openai",
      "allowed_models": "",
      "rate_limit": 60,
      "daily_limit": 1000,
      "status": "active",
      "created_at": "2025-12-01T00:00:00Z"
    }
  ]
}
```

### 2. 创建套餐

**路径**: `POST /api/admin/packages`

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 套餐名称 |
| description | string | 否 | 描述 |
| price | float | 是 | 价格 |
| token_quota | int | 是 | Token 配额 |
| valid_days | int | 是 | 有效天数 |
| allowed_platforms | string | 否 | 允许的平台(逗号分隔) |
| allowed_models | string | 否 | 允许的模型(逗号分隔) |
| rate_limit | int | 否 | 每分钟请求限制 |
| daily_limit | int | 否 | 每日请求限制 |
| status | string | 否 | 状态: active/disabled |

### 3. 更新套餐

**路径**: `PUT /api/admin/packages/:id`

### 4. 删除套餐

**路径**: `DELETE /api/admin/packages/:id`

---

## 二、用户套餐管理

### 1. 获取用户的套餐

**路径**: `GET /api/admin/user-packages/user/:user_id`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": 1,
      "user_id": 1,
      "package_id": 1,
      "package_name": "基础套餐",
      "token_quota": 100000,
      "used_tokens": 50000,
      "remaining_tokens": 50000,
      "start_time": "2025-12-01T00:00:00Z",
      "end_time": "2025-12-31T23:59:59Z",
      "status": "active"
    }
  ]
}
```

### 2. 给用户分配套餐

**路径**: `POST /api/admin/user-packages/user/:user_id`

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| package_id | int | 是 | 套餐ID |
| token_quota | int | 否 | 自定义配额(覆盖套餐配置) |
| valid_days | int | 否 | 自定义有效天数 |
| start_time | string | 否 | 开始时间 |

### 3. 更新用户套餐

**路径**: `PUT /api/admin/user-packages/:id`

**请求参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| token_quota | int | Token 配额 |
| end_time | string | 结束时间 |
| status | string | 状态 |

### 4. 删除用户套餐

**路径**: `DELETE /api/admin/user-packages/:id`

---

## 三、客户端过滤

### 1. 获取过滤配置

**路径**: `GET /api/admin/client-filter/config`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "filter_enabled": true,
    "filter_mode": "simple",
    "allowed_clients": ["claude-code", "cursor"]
  }
}
```

### 2. 更新过滤配置

**路径**: `PUT /api/admin/client-filter/config`

**请求参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| filter_enabled | bool | 是否启用过滤 |
| filter_mode | string | 模式: simple/strict |
| allowed_clients | array | 允许的客户端列表 |

**请求示例**:
```json
{
  "filter_enabled": true,
  "filter_mode": "simple",
  "allowed_clients": ["claude-code", "cursor"]
}
```

### 3. 重载缓存

**路径**: `POST /api/admin/client-filter/reload`

### 4. 测试验证

**路径**: `POST /api/admin/client-filter/test`

**请求参数**:
```json
{
  "user_agent": "claude-cli/1.0.0 (external, cli)",
  "headers": {
    "x-stainless-os": "linux",
    "anthropic-version": "2023-06-01"
  },
  "body": {
    "system": "You are Claude..."
  }
}
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "allowed": true,
    "client_type": "claude-code",
    "match_details": {
      "ua_matched": true,
      "headers_valid": true,
      "body_valid": true
    }
  }
}
```

---

## 四、客户端类型管理

### 1. 获取客户端类型列表

**路径**: `GET /api/admin/client-filter/client-types`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "claude-code",
      "display_name": "Claude Code",
      "description": "Anthropic 官方 CLI",
      "ua_pattern": "^claude-cli/",
      "enabled": true
    }
  ]
}
```

### 2. 创建客户端类型

**路径**: `POST /api/admin/client-filter/client-types`

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 标识名称 |
| display_name | string | 是 | 显示名称 |
| description | string | 否 | 描述 |
| ua_pattern | string | 是 | UA 正则匹配 |
| enabled | bool | 否 | 是否启用 |

### 3. 获取单个客户端类型

**路径**: `GET /api/admin/client-filter/client-types/:id`

### 4. 更新客户端类型

**路径**: `PUT /api/admin/client-filter/client-types/:id`

### 5. 删除客户端类型

**路径**: `DELETE /api/admin/client-filter/client-types/:id`

### 6. 切换启用状态

**路径**: `PUT /api/admin/client-filter/client-types/:id/toggle`

---

## 五、过滤规则管理

### 1. 获取规则列表

**路径**: `GET /api/admin/client-filter/rules`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": 1,
      "client_type_id": 1,
      "rule_type": "header",
      "field_name": "x-stainless-os",
      "pattern": ".+",
      "required": true,
      "enabled": true
    }
  ]
}
```

### 2. 创建规则

**路径**: `POST /api/admin/client-filter/rules`

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| client_type_id | int | 是 | 客户端类型ID |
| rule_type | string | 是 | 规则类型: header/body |
| field_name | string | 是 | 字段名 |
| pattern | string | 是 | 匹配模式 |
| required | bool | 否 | 是否必需 |
| enabled | bool | 否 | 是否启用 |

### 3. 获取单个规则

**路径**: `GET /api/admin/client-filter/rules/:id`

### 4. 更新规则

**路径**: `PUT /api/admin/client-filter/rules/:id`

### 5. 删除规则

**路径**: `DELETE /api/admin/client-filter/rules/:id`

### 6. 切换规则启用状态

**路径**: `PUT /api/admin/client-filter/rules/:id/toggle`

---

## 过滤模式说明

| 模式 | UA 要求 | 其他验证 |
|------|---------|----------|
| simple | `claude-cli/版本号` 开头 | 无 |
| strict | 完整格式验证 | Headers + Body 规则验证 |

**简单模式**: 只检查 User-Agent 是否以 `claude-cli/` 开头。

**严格模式**: 完整验证 User-Agent 格式，并检查必需的请求头和请求体字段。

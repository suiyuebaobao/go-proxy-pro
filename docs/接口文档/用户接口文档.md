# 用户接口文档

## 概述

用户接口包括个人资料管理、使用统计、套餐查询等功能。

**认证方式**：JWT Token

---

## 一、个人资料接口

### 1. 获取个人资料

**路径**: `GET /api/profile`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1,
    "username": "user1",
    "email": "user@example.com",
    "role": "user",
    "status": "active",
    "balance": 50.00,
    "price_rate": 1.0,
    "max_concurrency": 10,
    "created_at": "2025-12-01T00:00:00Z",
    "updated_at": "2025-12-10T00:00:00Z"
  }
}
```

---

### 2. 更新个人资料

**路径**: `PUT /api/profile`

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| email | string | 否 | 邮箱 |

**请求示例**:
```json
{
  "email": "newemail@example.com"
}
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1,
    "username": "user1",
    "email": "newemail@example.com",
    "role": "user",
    "status": "active"
  }
}
```

> 注意：普通用户不能修改 role 和 status

---

### 3. 修改密码

**路径**: `PUT /api/profile/password`

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| old_password | string | 是 | 原密码 |
| new_password | string | 是 | 新密码（至少6字符） |

**请求示例**:
```json
{
  "old_password": "oldpass123",
  "new_password": "newpass456"
}
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": null
}
```

---

## 二、使用统计接口

### 1. 获取使用汇总（含今日）

**路径**: `GET /api/usage/summary`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "total_cost": 25.50,
    "total_tokens": 500000,
    "input_tokens": 300000,
    "output_tokens": 150000,
    "cache_creation_tokens": 25000,
    "cache_read_tokens": 25000,
    "request_count": 1200,
    "today": {
      "cost": 2.50,
      "tokens": 50000,
      "requests": 100
    }
  }
}
```

---

### 2. 获取日期范围统计

**路径**: `GET /api/usage/daily`

**查询参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| start_date | string | 否 | 开始日期 YYYY-MM-DD |
| end_date | string | 否 | 结束日期 YYYY-MM-DD |

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "date": "2025-12-14",
      "cost": 5.20,
      "input_tokens": 100000,
      "output_tokens": 50000,
      "request_count": 200
    },
    {
      "date": "2025-12-15",
      "cost": 3.80,
      "input_tokens": 80000,
      "output_tokens": 40000,
      "request_count": 150
    }
  ]
}
```

---

### 3. 获取月度使用量

**路径**: `GET /api/usage/monthly`

**查询参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| year | int | 否 | 年份，默认当前年 |
| month | int | 否 | 月份，默认当前月 |

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "year": 2025,
    "month": 12,
    "total_cost": 50.00,
    "total_tokens": 1000000,
    "request_count": 2500
  }
}
```

---

### 4. 获取使用记录列表

**路径**: `GET /api/usage/records`

**查询参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | int | 否 | 页码，默认1 |
| page_size | int | 否 | 每页数量，默认20 |
| start_date | string | 否 | 开始日期 |
| end_date | string | 否 | 结束日期 |

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "model": "claude-sonnet-4-20250514",
        "platform": "claude-official",
        "input_tokens": 1000,
        "output_tokens": 500,
        "cost": 0.02,
        "created_at": "2025-12-15T10:30:00Z"
      }
    ],
    "total": 100,
    "page": 1
  }
}
```

---

### 5. 按模型统计

**路径**: `GET /api/usage/models`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "model": "claude-sonnet-4-20250514",
      "total_cost": 20.00,
      "total_tokens": 400000,
      "request_count": 800
    },
    {
      "model": "claude-opus-4-20250514",
      "total_cost": 30.00,
      "total_tokens": 200000,
      "request_count": 200
    }
  ]
}
```

---

### 6. MySQL 持久化数据查询

#### 6.1 获取总汇总（MySQL）

**路径**: `GET /api/usage/db/summary`

#### 6.2 获取每日汇总（MySQL）

**路径**: `GET /api/usage/db/daily`

**查询参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| start_date | string | 否 | 开始日期 |
| end_date | string | 否 | 结束日期 |

#### 6.3 获取模型汇总（MySQL）

**路径**: `GET /api/usage/db/models`

---

## 三、模型查询

### 获取可用模型列表

**路径**: `GET /api/models`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": "claude-sonnet-4-20250514",
      "name": "Claude Sonnet 4",
      "platform": "claude-official",
      "input_price": 3.0,
      "output_price": 15.0
    },
    {
      "id": "claude-opus-4-20250514",
      "name": "Claude Opus 4",
      "platform": "claude-official",
      "input_price": 15.0,
      "output_price": 75.0
    }
  ]
}
```

---

## 四、套餐查询接口

### 1. 获取可购买套餐

**路径**: `GET /api/packages`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "基础套餐",
      "description": "适合个人用户",
      "price": 10.00,
      "token_quota": 100000,
      "valid_days": 30,
      "status": "active"
    }
  ]
}
```

---

### 2. 获取我的套餐

**路径**: `GET /api/my-packages`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": 1,
      "package_id": 1,
      "package_name": "基础套餐",
      "token_quota": 100000,
      "used_tokens": 50000,
      "remaining_tokens": 50000,
      "start_time": "2025-12-01T00:00:00Z",
      "end_time": "2025-12-31T23:59:59Z",
      "status": "active"
    }
  ]
}
```

---

### 3. 获取我的有效套餐

**路径**: `GET /api/my-packages/active`

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": 1,
      "package_name": "基础套餐",
      "remaining_tokens": 50000,
      "end_time": "2025-12-31T23:59:59Z"
    }
  ]
}
```

---

## 错误响应

### 认证错误

```json
{
  "code": 401,
  "message": "unauthorized"
}
```

### 用户不存在

```json
{
  "code": 404,
  "message": "user not found"
}
```

### 密码错误

```json
{
  "code": 400,
  "message": "incorrect old password"
}
```

# 系统监控接口文档

## 概述

系统监控接口用于获取系统资源、数据库状态、账号统计、用户统计、今日使用量等监控数据。

**认证方式**：JWT Token（需要管理员权限）

**基础路径**：`/api/admin/monitor`

---

## 接口列表

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/admin/monitor` | GET | 获取完整监控数据 |
| `/api/admin/monitor/system` | GET | 获取系统资源统计 |
| `/api/admin/monitor/cache` | GET | 获取缓存统计 |
| `/api/admin/monitor/mysql` | GET | 获取 MySQL 统计 |
| `/api/admin/monitor/accounts` | GET | 获取账号统计 |
| `/api/admin/monitor/users` | GET | 获取用户统计 |
| `/api/admin/monitor/today` | GET | 获取今日使用统计 |

---

## 1. 获取完整监控数据

**路径**: `GET /api/admin/monitor`

**认证**: JWT Token（管理员）

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "system": {
      "cpu_cores": 8,
      "cpu_usage": 25.5,
      "memory_total": 17179869184,
      "memory_used": 8589934592,
      "memory_free": 8589934592,
      "memory_usage": 50.0,
      "disk_total": 107374182400,
      "disk_used": 53687091200,
      "disk_free": 53687091200,
      "disk_usage": 50.0
    },
    "cache": {
      "session_count": 150,
      "account_concurrency_count": 10,
      "user_concurrency_count": 25,
      "unavailable_count": 2
    },
    "mysql": {
      "table_count": 15,
      "data_size": 52428800,
      "index_size": 10485760,
      "total_size": 62914560,
      "connected": true
    },
    "accounts": {
      "total": 10,
      "active": 8,
      "rate_limited": 1,
      "invalid": 1
    },
    "users": {
      "total": 100,
      "active": 25,
      "new_today": 3
    },
    "today_usage": {
      "total_cost": 12.50,
      "total_tokens": 150000,
      "input_tokens": 80000,
      "output_tokens": 50000,
      "cache_creation_tokens": 10000,
      "cache_read_tokens": 10000,
      "request_count": 500
    },
    "updated_at": "2025-12-15T10:30:00Z"
  }
}
```

---

## 2. 获取系统资源统计

**路径**: `GET /api/admin/monitor/system`

**认证**: JWT Token（管理员）

**响应字段**:
| 字段 | 类型 | 说明 |
|------|------|------|
| cpu_cores | int | CPU 核心数 |
| cpu_usage | float | CPU 使用率 (%) |
| memory_total | int | 内存总量 (bytes) |
| memory_used | int | 已用内存 (bytes) |
| memory_free | int | 可用内存 (bytes) |
| memory_usage | float | 内存使用率 (%) |
| disk_total | int | 磁盘总量 (bytes) |
| disk_used | int | 已用磁盘 (bytes) |
| disk_free | int | 可用磁盘 (bytes) |
| disk_usage | float | 磁盘使用率 (%) |

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "cpu_cores": 8,
    "cpu_usage": 25.5,
    "memory_total": 17179869184,
    "memory_used": 8589934592,
    "memory_free": 8589934592,
    "memory_usage": 50.0,
    "disk_total": 107374182400,
    "disk_used": 53687091200,
    "disk_free": 53687091200,
    "disk_usage": 50.0
  }
}
```

---

## 3. 获取缓存统计

**路径**: `GET /api/admin/monitor/cache`

**认证**: JWT Token（管理员）

**响应字段**:
| 字段 | 类型 | 说明 |
|------|------|------|
| session_count | int | 会话绑定数量 |
| account_concurrency_count | int | 账户并发计数数量 |
| user_concurrency_count | int | 用户并发计数数量 |
| unavailable_count | int | 不可用标记数量 |

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "session_count": 150,
    "account_concurrency_count": 10,
    "user_concurrency_count": 25,
    "unavailable_count": 2
  }
}
```

---

## 4. 获取 MySQL 统计

**路径**: `GET /api/admin/monitor/mysql`

**认证**: JWT Token（管理员）

**响应字段**:
| 字段 | 类型 | 说明 |
|------|------|------|
| table_count | int | 表数量 |
| data_size | int | 数据大小 (bytes) |
| index_size | int | 索引大小 (bytes) |
| total_size | int | 总大小 (bytes) |
| connected | bool | 是否连接 |

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "table_count": 15,
    "data_size": 52428800,
    "index_size": 10485760,
    "total_size": 62914560,
    "connected": true
  }
}
```

---

## 5. 获取账号统计

**路径**: `GET /api/admin/monitor/accounts`

**认证**: JWT Token（管理员）

**响应字段**:
| 字段 | 类型 | 说明 |
|------|------|------|
| total | int | 账号总数 |
| active | int | 正常可用（enabled=true 且 status=valid） |
| rate_limited | int | 被限流（status=rate_limited） |
| invalid | int | 无效/禁用（enabled=false 或 status=invalid） |

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "total": 10,
    "active": 8,
    "rate_limited": 1,
    "invalid": 1
  }
}
```

---

## 6. 获取用户统计

**路径**: `GET /api/admin/monitor/users`

**认证**: JWT Token（管理员）

**响应字段**:
| 字段 | 类型 | 说明 |
|------|------|------|
| total | int | 用户总数 |
| active | int | 今日活跃用户数（今日有请求记录） |
| new_today | int | 今日新增用户数 |

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "total": 100,
    "active": 25,
    "new_today": 3
  }
}
```

---

## 7. 获取今日使用统计

**路径**: `GET /api/admin/monitor/today`

**认证**: JWT Token（管理员）

**响应字段**:
| 字段 | 类型 | 说明 |
|------|------|------|
| total_cost | float | 今日总消费 (美元) |
| total_tokens | int | 今日总 Token 数 |
| input_tokens | int | 输入 Token 数 |
| output_tokens | int | 输出 Token 数 |
| cache_creation_tokens | int | 缓存创建 Token 数 |
| cache_read_tokens | int | 缓存读取 Token 数 |
| request_count | int | 请求次数 |

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "total_cost": 12.50,
    "total_tokens": 150000,
    "input_tokens": 80000,
    "output_tokens": 50000,
    "cache_creation_tokens": 10000,
    "cache_read_tokens": 10000,
    "request_count": 500
  }
}
```

---

## 错误响应

### 认证错误

```json
{
  "code": 401,
  "message": "未登录或登录已过期"
}
```

### 权限错误

```json
{
  "code": 403,
  "message": "需要管理员权限"
}
```

### 服务错误

```json
{
  "code": 500,
  "message": "获取监控数据失败: xxx"
}
```

---

## 数据说明

### 字节单位换算

前端显示时建议进行单位换算：

```javascript
function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
```

### 账号状态说明

| 状态 | 说明 |
|------|------|
| valid | 正常可用 |
| rate_limited | 被上游限流 |
| invalid | 无效（凭证错误等） |

### 数据来源

| 指标 | 来源 |
|------|------|
| 系统资源 | gopsutil 库 |
| 缓存统计 | 内存缓存 (sync.Map) |
| MySQL 统计 | information_schema 表 |
| 账号统计 | accounts 表 |
| 用户统计 | users 表 + request_logs 表 |
| 今日使用 | daily_usages 表 |

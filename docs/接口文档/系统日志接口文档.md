# 系统日志接口文档

> 最后更新：2025-12-16
> 适用于管理员查看日志文件（应用日志 + 服务器日志）

---

## 概述

系统日志接口允许管理员在 Web 界面查看日志文件，支持两种日志来源：

- **应用日志**（`source=app`，默认）：项目 `logs/` 目录下的应用日志
- **服务器日志**（`source=server`）：`/var/log/` 目录下的系统日志（白名单限制）

支持分类筛选、分页读取、关键词搜索、实时 tail 等功能。

---

## 通用参数

所有接口都支持以下参数：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `source` | string | 否 | 日志来源：`app`（应用日志，默认）或 `server`（服务器日志） |

---

## 1. 获取日志文件列表

### 接口

```
GET /api/admin/system-logs/files
```

### 描述

获取日志文件列表，支持按分类和日期过滤。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `source` | string | 否 | 日志来源：`app`（默认）或 `server` |
| `category` | string | 否 | 日志分类过滤（auth, http, proxy 等） |
| `date` | string | 否 | 日期过滤（YYYY-MM-DD 格式，仅应用日志） |

### 响应

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "files": [
      {
        "name": "auth-2025-12-15.log",
        "size": 1234567,
        "size_human": "1.18 MB",
        "mod_time": "2025-12-15T10:30:00Z",
        "category": "auth",
        "date": "2025-12-15"
      }
    ],
    "categories": [
      {
        "name": "auth",
        "label": "认证日志",
        "count": 5
      },
      {
        "name": "http",
        "label": "HTTP日志",
        "count": 10
      }
    ],
    "total": 15
  }
}
```

### 应用日志分类（source=app）

| 分类 | 说明 |
|------|------|
| `auth` | 认证相关日志 |
| `http` | HTTP 请求日志 |
| `main` | 主程序日志 |
| `proxy` | 代理转发日志 |
| `scheduler` | 调度器日志 |
| `sync` | 数据同步日志 |
| `operation` | 操作日志 |
| `middleware` | 中间件日志 |
| `client_filter` | 客户端过滤日志 |
| `error_message` | 错误消息日志 |
| `error_response` | 错误响应日志 |

### 服务器日志白名单（source=server）

| 文件 | 分类 | 说明 |
|------|------|------|
| `auth.log` / `auth.log.1` | ssh | SSH认证日志 |
| `syslog` / `syslog.1` | system | 系统日志 |
| `kern.log` / `kern.log.1` | kernel | 内核日志 |
| `dpkg.log` | system | 软件包日志 |
| `fail2ban.log` | fail2ban | Fail2ban日志 |
| `nginx/access.log` | nginx | Nginx访问日志 |
| `nginx/error.log` | nginx | Nginx错误日志 |
| `mysql/error.log` | mysql | MySQL错误日志 |

---

## 2. 读取日志内容

### 接口

```
GET /api/admin/system-logs/read
```

### 描述

分页读取指定日志文件的内容，支持关键词搜索和正序/倒序显示。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `source` | string | 否 | 日志来源：`app`（默认）或 `server` |
| `file` | string | 是 | 日志文件名 |
| `page` | int | 否 | 页码（默认 1） |
| `page_size` | int | 否 | 每页行数（默认 200，最大 1000） |
| `keyword` | string | 否 | 搜索关键词 |
| `reverse` | string | 否 | 是否倒序（"true" 启用） |

### 响应

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "file": "auth-2025-12-15.log",
    "lines": [
      "2025-12-15 10:00:01 [INFO] User login: admin",
      "2025-12-15 10:00:02 [INFO] Token generated for user: admin"
    ],
    "page": 1,
    "page_size": 200,
    "total_lines": 1500,
    "total_pages": 8,
    "size": 1234567,
    "size_human": "1.18 MB",
    "mod_time": "2025-12-15T10:30:00Z",
    "reverse": false
  }
}
```

---

## 3. 实时查看日志

### 接口

```
GET /api/admin/system-logs/tail
```

### 描述

获取日志文件末尾的内容，类似 `tail` 命令。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `source` | string | 否 | 日志来源：`app`（默认）或 `server` |
| `file` | string | 是 | 日志文件名 |
| `lines` | int | 否 | 获取行数（默认 100，最大 1000） |

### 响应

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "file": "auth-2025-12-15.log",
    "lines": [
      "2025-12-15 10:29:58 [INFO] Token validated",
      "2025-12-15 10:29:59 [INFO] Request processed",
      "2025-12-15 10:30:00 [INFO] User logout: admin"
    ],
    "count": 100,
    "size": 1234567,
    "size_human": "1.18 MB",
    "mod_time": "2025-12-15T10:30:00Z"
  }
}
```

---

## 4. 下载日志文件

### 接口

```
GET /api/admin/system-logs/download
```

### 描述

下载指定的日志文件。

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `source` | string | 否 | 日志来源：`app`（默认）或 `server` |
| `file` | string | 是 | 日志文件名 |

### 响应

返回文件内容，Content-Type 为 `text/plain; charset=utf-8`。

---

## 5. 删除日志文件

### 接口

```
DELETE /api/admin/system-logs/file
```

### 描述

删除指定的日志文件。**注意：仅支持删除应用日志，服务器日志不允许删除。**

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `source` | string | 否 | 日志来源：仅支持 `app`（默认） |
| `file` | string | 是 | 日志文件名 |

### 响应

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "message": "删除成功"
  }
}
```

### 错误响应

当 `source=server` 时：

```json
{
  "code": 403,
  "message": "不允许删除服务器日志文件"
}
```

---

## 错误响应

| 状态码 | 说明 |
|--------|------|
| 400 | 参数错误（如文件名为空、无效的日志文件） |
| 403 | 禁止访问（尝试访问白名单外的服务器日志、删除服务器日志） |
| 404 | 文件不存在 |
| 500 | 服务器内部错误 |

---

## 使用示例

### 获取所有应用日志文件

```bash
curl -X GET "http://localhost:8080/api/admin/system-logs/files" \
  -H "Authorization: Bearer <token>"
```

### 获取所有服务器日志文件

```bash
curl -X GET "http://localhost:8080/api/admin/system-logs/files?source=server" \
  -H "Authorization: Bearer <token>"
```

### 获取 auth 类型的应用日志文件

```bash
curl -X GET "http://localhost:8080/api/admin/system-logs/files?category=auth" \
  -H "Authorization: Bearer <token>"
```

### 读取应用日志内容（第一页）

```bash
curl -X GET "http://localhost:8080/api/admin/system-logs/read?file=auth-2025-12-15.log&page=1&page_size=100" \
  -H "Authorization: Bearer <token>"
```

### 读取服务器 SSH 认证日志

```bash
curl -X GET "http://localhost:8080/api/admin/system-logs/read?source=server&file=auth.log&page=1" \
  -H "Authorization: Bearer <token>"
```

### 搜索包含 "error" 的日志

```bash
curl -X GET "http://localhost:8080/api/admin/system-logs/read?file=proxy-2025-12-15.log&keyword=error&reverse=true" \
  -H "Authorization: Bearer <token>"
```

### 查看服务器日志最新 100 行

```bash
curl -X GET "http://localhost:8080/api/admin/system-logs/tail?source=server&file=auth.log&lines=100" \
  -H "Authorization: Bearer <token>"
```

### 下载服务器系统日志

```bash
curl -X GET "http://localhost:8080/api/admin/system-logs/download?source=server&file=syslog" \
  -H "Authorization: Bearer <token>" \
  -o syslog.txt
```

### 删除应用日志文件

```bash
curl -X DELETE "http://localhost:8080/api/admin/system-logs/file?file=old-log.log" \
  -H "Authorization: Bearer <token>"
```

---

## 相关文档

- [功能模块索引 - 系统日志](../功能模块索引.md#13-系统日志)
- [代码索引 - system_log.go](../代码索引.md)

# Go-AIProxy 测试计划

> 创建时间：2025-12-22
> 本文档列出所有需要测试的功能模块和测试用例

---

## 测试概览

| 模块 | 测试项数 | 状态 |
|------|----------|------|
| 1. 健康检查与服务状态 | 2 | ✅ 通过 |
| 2. 用户认证 (JWT) | 3 | ✅ 通过 |
| 3. API Key 认证 | 2 | ✅ 通过 |
| 4. Claude 代理转发 | 4 | ✅ 通过 |
| 5. OpenAI 代理转发 | 2 | ✅ 通过 |
| 6. OpenAI Responses API | 2 | ✅ 通过 |
| 7. 管理后台 API | 10 | ✅ 通过 |
| 8. 缓存管理 | 3 | ✅ 通过 |
| 9. 系统监控 | 2 | ✅ 通过 |
| 10. 套餐/额度管理 | 8 | ✅ 通过 |

---

## 1. 健康检查与服务状态

### 1.1 健康检查接口
- **端点**: `GET /health`
- **预期**: 返回 `{"status": "ok"}`

### 1.2 服务进程状态
- 检查服务是否正常运行
- 检查端口 8080 是否监听

---

## 2. 用户认证 (JWT)

### 2.1 登录接口
- **端点**: `POST /api/auth/login`
- **测试**: 使用有效凭证登录，获取 JWT Token

### 2.2 验证码接口
- **端点**: `GET /api/auth/captcha`
- **测试**: 获取验证码图片

### 2.3 受保护接口访问
- **端点**: `GET /api/profile`
- **测试**: 使用 JWT Token 访问用户信息

---

## 3. API Key 认证

### 3.1 API Key 验证
- **端点**: 代理接口
- **测试**: 使用有效 API Key 请求代理接口

### 3.2 无效 API Key 拒绝
- **测试**: 使用无效 API Key 应返回 401

---

## 4. Claude 代理转发

### 4.1 Claude 非流式请求
- **端点**: `POST /v1/messages`
- **测试**: 发送非流式消息请求

### 4.2 Claude 流式请求
- **端点**: `POST /v1/messages` (stream: true)
- **测试**: 发送流式消息请求，验证 SSE 响应

### 4.3 SSE 首个事件错误检测
- **测试**: 验证首个事件为错误时触发重试

### 4.4 会话粘性
- **测试**: 验证相同会话绑定到同一账户

---

## 5. OpenAI 代理转发

### 5.1 OpenAI Chat Completions
- **端点**: `POST /v1/chat/completions`
- **测试**: OpenAI 格式请求转发

### 5.2 OpenAI 流式请求
- **测试**: 流式响应验证

---

## 6. OpenAI Responses API

### 6.1 Responses 接口
- **端点**: `POST /v1/responses`
- **测试**: Codex CLI 格式请求

### 6.2 多账户类型支持
- **测试**: 支持 openai-responses 和 openai 类型账户

---

## 7. 管理后台 API

### 7.1 账户管理
- **端点**: `GET /api/admin/accounts`
- **测试**: 获取账户列表

### 7.2 用户管理
- **端点**: `GET /api/admin/users`
- **测试**: 获取用户列表

### 7.3 模型管理
- **端点**: `GET /api/admin/models`
- **测试**: 获取模型列表

### 7.4 系统配置
- **端点**: `GET /api/admin/configs`
- **测试**: 获取系统配置

### 7.5 请求日志
- **端点**: `GET /api/admin/logs`
- **测试**: 获取请求日志

### 7.6 套餐管理
- **端点**: `GET /api/admin/packages`
- **测试**: 获取套餐列表

### 7.7 代理配置
- **端点**: `GET /api/admin/proxy-configs`
- **测试**: 获取代理配置

### 7.8 操作日志
- **端点**: `GET /api/admin/operation-logs`
- **测试**: 获取操作审计日志

### 7.9 错误消息配置
- **端点**: `GET /api/admin/error-messages`
- **测试**: 获取错误消息配置

### 7.10 客户端过滤
- **端点**: `GET /api/admin/client-filter/config`
- **测试**: 获取客户端过滤配置

---

## 8. 缓存管理

### 8.1 缓存统计
- **端点**: `GET /api/admin/cache/stats`
- **测试**: 获取缓存统计信息

### 8.2 会话列表
- **端点**: `GET /api/admin/cache/sessions`
- **测试**: 获取会话绑定列表

### 8.3 缓存配置
- **端点**: `GET /api/admin/cache/config`
- **测试**: 获取缓存配置

---

## 9. 系统监控

### 9.1 监控数据
- **端点**: `GET /api/admin/monitor`
- **测试**: 获取完整监控数据

### 9.2 系统日志
- **端点**: `GET /api/admin/system-logs/files`
- **测试**: 获取日志文件列表

---

## 测试执行命令

```bash
# 健康检查
curl http://localhost:8080/health

# 登录获取 Token
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 使用 Token 访问管理接口
curl http://localhost:8080/api/admin/accounts \
  -H "Authorization: Bearer <token>"

# Claude 代理测试
curl -X POST http://localhost:8080/v1/messages \
  -H "Authorization: Bearer <api-key>" \
  -H "Content-Type: application/json" \
  -d '{"model":"claude-sonnet-4-20250514","messages":[{"role":"user","content":"Hi"}],"max_tokens":100}'
```

---

## 10. 套餐/额度管理

### 10.1 套餐 CRUD
- **端点**: `GET/POST/PUT/DELETE /api/admin/packages`
- **测试**: 创建、读取、更新、删除套餐

### 10.2 额度套餐
- **类型**: `quota`
- **测试**: 创建额度套餐，设置 quota_amount

### 10.3 订阅套餐
- **类型**: `subscription`
- **测试**: 创建订阅套餐，设置 daily/weekly/monthly_quota

### 10.4 用户套餐分配
- **端点**: `GET/POST /api/admin/user-packages/user/:user_id`
- **测试**: 给用户分配套餐

### 10.5 用户套餐更新
- **端点**: `PUT /api/admin/user-packages/:id`
- **测试**: 修改用户套餐的额度限制

### 10.6 用户套餐删除
- **端点**: `DELETE /api/admin/user-packages/:id`
- **测试**: 删除用户的套餐

### 10.7 额度消耗追踪
- **测试**: quota_used 字段正确记录使用量

### 10.8 周期重置
- **测试**: 订阅套餐的 daily/weekly/monthly_used 按周期重置

---

## 测试结果记录

| 时间 | 模块 | 结果 | 备注 |
|------|------|------|------|
| 2025-12-22 03:08 | 健康检查 | ✅ 通过 | /health 返回 {"status":"ok"} |
| 2025-12-22 03:08 | JWT 登录 | ✅ 通过 | 获取 Token 成功，结构: data.token |
| 2025-12-22 03:09 | API Key 认证 | ✅ 通过 | 使用 API Key 访问代理接口成功 |
| 2025-12-22 03:09 | Claude 非流式 | ✅ 通过 | 返回完整响应 |
| 2025-12-22 03:09 | Claude 流式 | ✅ 通过 | SSE 传输正常 |
| 2025-12-22 03:10 | Claude 错误检测 | ✅ 通过 | 首个事件错误时触发账户切换重试 |
| 2025-12-22 03:11 | OpenAI 转发 | ⚠️ 部分 | 转发成功，但账户 API Key 已禁用 |
| 2025-12-22 03:40 | 模型列表 | ✅ 通过 | 返回 19 个模型 (Claude/Gemini/GPT) |
| 2025-12-22 03:40 | 用户列表 | ✅ 通过 | 返回 2 个用户 |
| 2025-12-22 03:40 | 系统日志 | ✅ 通过 | 17 个日志分类，141 个文件 |
| 2025-12-22 03:40 | 账户列表 | ✅ 通过 | 返回 11 个账户 |
| 2025-12-22 03:40 | 套餐列表 | ✅ 通过 | 返回 4 个套餐 |
| 2025-12-22 03:40 | 创建套餐 | ✅ 通过 | 额度套餐和订阅套餐创建成功 |
| 2025-12-22 03:40 | 更新套餐 | ✅ 通过 | 修改名称、价格、额度成功 |
| 2025-12-22 03:40 | 删除套餐 | ✅ 通过 | 删除操作成功 |
| 2025-12-22 03:41 | 用户套餐分配 | ✅ 通过 | 给用户分配套餐成功 |
| 2025-12-22 03:41 | 用户套餐更新 | ✅ 通过 | 修改 quota_total 成功 |
| 2025-12-22 03:41 | 用户套餐删除 | ✅ 通过 | 删除用户套餐成功 |
| 2025-12-22 03:21 | 缓存统计 | ✅ 通过 | 109 个 Redis keys |
| 2025-12-22 03:21 | 缓存配置 | ✅ 通过 | 返回缓存 TTL 配置 |
| 2025-12-22 03:21 | 系统监控 | ✅ 通过 | CPU/内存/磁盘监控正常 |

---

## 发现的问题

### 已知问题

1. **获取单个套餐接口不存在**
   - `GET /api/admin/packages/:id` 返回 404
   - 只能通过列表接口获取套餐信息

2. **用户余额充值接口不存在**
   - `POST /api/admin/users/:id/recharge` 返回 404
   - 需要通过套餐分配来给用户增加额度

3. **订阅套餐超额使用**
   - 用户 daily_used (6.6032) 超过 daily_quota (1.5)
   - 可能是软限制，允许短暂超额

### 建议改进

1. 添加获取单个套餐详情的接口
2. 添加用户余额直接充值的接口
3. 考虑添加套餐使用记录查询接口


# Go-AIProxy 架构设计方案

> 版本: v1.0 | 日期: 2025-12-08

---

## 一、项目概述

### 1.1 项目定位
企业级 AI API 代理服务，统一接口访问多个 AI 平台，提供安全防护、额度管理和负载均衡。

### 1.2 核心特性
1. **多平台转发** - 支持 10 种账户类型
2. **七层安全过滤** - 客户端验证和请求过滤
3. **额度管理** - 多维度配额控制
4. **智能调度** - 负载均衡和会话粘性
5. **费用统计** - 实时计算和报表

### 1.3 技术栈

**后端**
| 组件 | 选型 |
|------|------|
| 语言 | Go 1.21+ |
| Web框架 | Gin 1.10+ |
| 数据库 | MySQL 8.0+ |
| 缓存 | Redis 7.0+ |
| ORM | GORM |
| HTTP客户端 | Resty |

**前端**
| 组件 | 选型 |
|------|------|
| 框架 | Vue 3.4+ (Composition API) |
| 构建工具 | Vite 5.x |
| UI组件库 | Element Plus 2.6+ |
| 状态管理 | Pinia 2.x |
| 路由 | Vue Router 4.x |
| HTTP客户端 | Alova 3.x |
| 图标 | Font Awesome 6.x |

---

## 二、系统架构

```
┌─────────────────────────────────────────────┐
│                  客户端层                     │
│   Claude Code │ VS Code │ SDK │ 其他客户端    │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────┴───────────────────────────┐
│                API 网关层                    │
│  ├─ API Key 认证                            │
│  ├─ 七层安全过滤                            │
│  ├─ 额度验证                                │
│  └─ 频率限制                                │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────┴───────────────────────────┐
│                业务逻辑层                    │
│  AccountMgr │ QuotaMgr │ SessionMgr │ Stats │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────┴───────────────────────────┐
│                平台适配层                    │
│  Claude │ OpenAI │ Gemini │ Azure │ Bedrock │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────┴───────────────────────────┐
│                数据存储层                    │
│       MySQL (持久化) │ Redis (实时)          │
└─────────────────────────────────────────────┘
```

---

## 三、多平台支持

### 3.1 支持的账户类型（10种）

| 平台 | 账户类型 | 认证方式 |
|------|---------|---------|
| Claude | claude-official | OAuth 2.0 |
| Claude | claude-console | 自定义认证 |
| Claude | bedrock | AWS 凭据 |
| Claude | ccr | CCR 凭据 |
| OpenAI | openai | API Key |
| OpenAI | openai-responses | API Key |
| OpenAI | azure-openai | Azure API Key |
| Gemini | gemini | Google OAuth |
| Gemini | gemini-api | API Key |
| Other | droid | API Key |

### 3.2 智能路由
- 根据模型前缀自动检测后端（claude-/gpt-/gemini-）
- 支持 `ccr,model` 格式指定后端
- API Key 级别权限控制

---

## 四、七层安全过滤

| 层级 | 功能 | 说明 |
|------|------|------|
| L0 | 配置检查 | 是否启用验证 |
| L1 | User-Agent | 验证客户端类型 |
| L2 | 路径分流 | 只对 /messages 严格验证 |
| L3 | Headers | 必需头部检查 |
| L4 | Body解析 | 请求体解析 |
| L5 | System Prompt | Dice相似度验证 |
| L6 | UserID | 格式验证 |
| L7 | 频率限制 | API Key级别限流 |

---

## 五、额度管理

### 5.1 配额类型
- 并发限制（concurrency_limit）
- 频率限制（rate_limit_window + requests/cost）
- 每日费用（daily_cost_limit）
- 总费用（total_cost_limit）
- Opus周费用（weekly_opus_cost_limit）

### 5.2 存储分工

**MySQL**：配额配置、使用记录

**Redis**：
- 实时费用统计
- 滑动窗口计数
- 并发控制（Sorted Set）

---

## 六、数据库设计

### 6.1 MySQL 表

| 表名 | 说明 |
|------|------|
| users | 用户信息 |
| api_keys | API Key |
| api_key_quotas | 配额配置 |
| accounts | 账户（10种类型） |
| account_groups | 账户分组 |
| account_group_members | 分组关联 |
| usage_records | 使用记录 |
| model_pricing | 模型价格 |
| system_settings | 系统配置 |

### 6.2 accounts 表关键字段

```sql
account_type     -- 账户类型（10种）
platform         -- 平台（claude/openai/gemini）
status           -- 状态（valid/invalid/rate_limited/overloaded）
schedulable      -- 是否可调度
priority         -- 优先级（1-100）
-- Claude Official
oauth_token, subscription_level, opus_access
-- Bedrock
aws_access_key_id, aws_secret_access_key, aws_region
-- Azure
base_url, deployment_name, api_version
```

### 6.3 api_keys 表关键字段

```sql
permissions           -- 权限（all/claude/openai/gemini）
claude_account_id     -- 绑定Claude账户
openai_account_id     -- 绑定OpenAI账户
gemini_account_id     -- 绑定Gemini账户
```

---

## 七、Redis 设计

### 7.1 键命名规范
`aiproxy:{模块}:{对象}:{id}`

### 7.2 主要键

```redis
# 会话
aiproxy:session:account:{session_id}        -- 会话绑定账户
aiproxy:session:conversation:{session_id}   -- 会话对话ID

# 账户状态
aiproxy:account:inflight:{uuid}             -- 在途请求(ZSet)
aiproxy:account:overload:{uuid}             -- 过载标记
aiproxy:account:ratelimit:{uuid}            -- 限流标记

# 统计
aiproxy:usage:daily:{api_key}:{date}        -- 每日使用量(Hash)
aiproxy:cost:daily:{api_key}:{date}         -- 每日费用
aiproxy:cost:total:{api_key}                -- 总费用

# 限流
aiproxy:rate_limit:window:{api_key}:{ts}    -- 滑动窗口
aiproxy:concurrency:{api_key}               -- 并发控制(ZSet)
```

---

## 八、模块划分

| 模块 | 后端 | 前端 | 说明 |
|------|------|------|------|
| M1 | 用户CRUD/JWT | 登录页 | 用户管理 |
| M2 | Key CRUD/配额 | Key管理页 | API Key管理 |
| M3 | 账户CRUD/分组 | 账户管理页 | 多平台账户 |
| M4 | 七层中间件 | 配置页 | 安全过滤 |
| M5 | 检查/记录/统计 | 统计页 | 额度管理 |
| M6 | 调度/适配/转发 | 日志页 | 代理转发 |
| M7 | 指标/报表/告警 | Dashboard | 统计监控 |

---

## 九、开发计划

> 核心优先：先跑通代理转发，再完善周边功能

### 阶段1：核心功能（Week 1-4）
| 周 | 模块 | 内容 |
|---|------|------|
| W1 | M1 基础框架 | Go项目结构、Gin、MySQL、Redis、简单用户CRUD、JWT |
| W2 | M2 账户管理 | accounts表、account_groups表、账户CRUD、分组管理 |
| W3-4 | M3 代理转发⭐ | 统一调度器、多平台适配器、流式响应、格式转换、智能路由 |

### 阶段2：安全和配额（Week 5-7）
| 周 | 模块 | 内容 |
|---|------|------|
| W5 | M4 API Key | api_keys表、Key生成/验证、绑定账户 |
| W6 | M5 七层过滤 | L0-L7验证中间件、Dice相似度、配置开关 |
| W7 | M6 额度管理 | 并发控制、滑动窗口限流、费用计算 |

### 阶段3：完善功能（Week 8-10）
| 周 | 模块 | 内容 |
|---|------|------|
| W8-10 | M7 统计监控 | 实时指标、多维度统计、Webhook通知、告警 |

**总计**: 10周

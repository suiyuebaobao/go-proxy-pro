# 后端架构总览

> 最后更新：2025-12-11
> 本文档提供后端系统的整体架构设计和核心组件说明

---

## 技术栈

| 组件 | 技术选型 | 版本 |
|------|----------|------|
| 语言 | Go | 1.21+ |
| Web框架 | Gin | 1.x |
| ORM | GORM | 2.x |
| 数据库 | MySQL | 8.0+ |
| 缓存 | Redis | 7.0+ |
| 日志 | 自研 logger | - |

---

## 分层架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        HTTP Layer                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  Middleware │  │   Router    │  │       Handler           │  │
│  │  (认证/日志) │  │  (路由分发) │  │  (请求处理/响应构建)     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Service Layer                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Business  │  │   Pricing   │  │        Sync             │  │
│  │    Logic    │  │   Service   │  │       Service           │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Repository Layer                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │    MySQL    │  │    Redis    │  │     External API        │  │
│  │   Access    │  │    Access   │  │       Access            │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Proxy Layer                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  Scheduler  │  │   Adapter   │  │      Session            │  │
│  │  (账户调度)  │  │  (协议适配)  │  │     (会话粘性)          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 核心模块

### 1. HTTP 层

#### 中间件 (internal/middleware/)
| 文件 | 功能 |
|------|------|
| `jwt.go` | JWT Token 认证 |
| `api_key.go` | API Key 认证 |
| `cors.go` | 跨域处理 |
| `logger.go` | 请求日志 |
| `recovery.go` | Panic 恢复 |

#### 路由 (internal/handler/routes.go)
- `/api/auth/*` - 认证相关
- `/api/admin/*` - 管理接口 (需要JWT)
- `/v1/*` - 代理接口 (需要API Key)

### 2. 服务层 (internal/service/)

详见 [M9-服务层设计](../模块设计/M9-服务层设计.md)

| 服务 | 职责 |
|------|------|
| UserService | 用户管理 |
| AccountService | 账户管理 |
| APIKeyService | API Key 管理 |
| UsageService | 使用统计 |
| PricingService | 计费定价 |
| SyncService | 数据同步 |
| ConfigService | 配置管理 |
| CacheService | 缓存管理 |

### 3. 数据访问层 (internal/repository/)

| Repository | 数据源 |
|------------|--------|
| UserRepository | MySQL |
| AccountRepository | MySQL |
| APIKeyRepository | MySQL |
| RequestLogRepository | MySQL |
| UsageRecordRepository | MySQL |
| DailyUsageRepository | MySQL |
| SystemConfigRepository | MySQL |

### 4. 代理层 (internal/proxy/)

#### 调度器 (scheduler/)
- **Scheduler**: 账户负载均衡调度
- **Session**: 会话粘性管理
- **Retry**: 失败重试机制
- **Token**: Token 刷新管理

#### 适配器 (adapter/)
| 适配器 | 目标平台 |
|--------|----------|
| ClaudeAdapter | Claude Official API |
| ClaudeCCRAdapter | Claude CCR (OAuth) |
| OpenAIAdapter | OpenAI API |
| AzureAdapter | Azure OpenAI |
| GeminiAdapter | Google Gemini |
| BedrockAdapter | AWS Bedrock |

---

## 数据存储策略

### MySQL - 持久化存储
- 用户、账户、API Key 等核心数据
- 请求日志 (request_logs)
- 使用记录 (usage_records)
- 每日汇总 (daily_usages)

### Redis - 缓存和实时统计
- 使用量统计 (实时增量)
- 费用统计 (实时增量)
- 会话粘性数据
- 系统配置缓存

### 数据同步流程

```
┌────────────┐     实时写入     ┌────────────┐
│   请求处理  │ ───────────────▶│   Redis    │
└────────────┘                  └────────────┘
                                      │
                                      │ 定时同步
                                      ▼
                                ┌────────────┐
                                │   MySQL    │
                                └────────────┘
```

**同步策略**:
1. 写入: 实时写入 Redis，保证性能
2. 同步: 定时任务 (默认5分钟) 批量同步到 MySQL
3. 查询: 优先查询 Redis，无数据时回退到 MySQL

---

## 定时任务

| 任务 | 间隔 | 位置 | 说明 |
|------|------|------|------|
| 数据同步 | 5分钟(可配置) | sync.go | Redis → MySQL |
| 限流恢复 | 1分钟 | scheduler.go | 恢复过期限流账户 |

---

## 认证机制

### JWT 认证 (管理后台)
```
Header: Authorization: Bearer <jwt_token>
```
- 用于管理后台 API
- 包含 user_id, username, role
- 过期时间可配置

### API Key 认证 (代理接口)
```
Header: Authorization: Bearer <api_key>
# 或
Header: x-api-key: <api_key>
```
- 用于代理接口
- 支持额度/订阅两种计费模式
- 支持费率倍率配置

---

## 错误处理

### 统一响应格式
```json
// 成功
{
  "code": 0,
  "message": "success",
  "data": {}
}

// 失败
{
  "code": 400,
  "message": "error message"
}
```

### 代理错误处理
- OpenAI 格式错误响应
- Claude 格式错误响应
- 支持重试机制

---

## 配置管理

### 静态配置 (configs/config.yaml)
```yaml
server:
  port: 8080
mysql:
  host: localhost
  port: 3306
redis:
  host: localhost
  port: 6379
```

### 动态配置 (system_configs 表)
| Key | 说明 |
|-----|------|
| sync.enabled | 同步开关 |
| sync.interval | 同步间隔 |
| log.level | 日志级别 |

---

## 日志系统

### 日志级别
- DEBUG: 调试信息
- INFO: 一般信息
- WARN: 警告信息
- ERROR: 错误信息

### 日志分类
| Logger | 用途 |
|--------|------|
| main | 主程序 |
| proxy | 代理请求 |
| sync | 数据同步 |
| scheduler | 调度器 |

---

## 性能优化

### Redis 优化
- 使用 Pipeline 批量操作
- Hash 结构存储统计数据
- 合理设置过期时间

### MySQL 优化
- 合理使用索引
- 批量插入 (BatchCreate)
- 增量更新 (IncrementUsage)

### 并发处理
- goroutine 异步记录日志
- Channel 收集并发错误
- sync.Once 单例模式

---

## 扩展点

### 添加新的 AI 平台
1. 在 `internal/model/account.go` 添加账户类型常量
2. 在 `internal/proxy/adapter/` 创建新适配器
3. 在适配器注册表中注册
4. 更新前端表单支持

### 添加新的定时任务
1. 在 `internal/service/` 创建服务
2. 实现 `Start()` / `Stop()` 方法
3. 在 `cmd/server/main.go` 启动

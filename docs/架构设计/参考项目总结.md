# 参考项目功能总结

## 一、项目概览

| 项目 | 技术栈 | 借鉴内容 |
|------|-------|---------|
| clove | Python/FastAPI | 整体架构、账户管理、会话管理 |
| AIProxyV2 | Go/GoFrame | 七层安全过滤 |
| claude-relay | Node.js/Express | 额度管理、多平台转发 |

---

## 二、clove 核心功能

### 借鉴点
- **架构**: 分层设计（网关→业务→适配→存储）
- **账户管理**: Redis无锁架构、智能调度算法
- **会话管理**: 轻量设计、会话粘性、自动续期
- **调度算法**: 优先级40% + 负载30% + 能力20% + 时间10%

---

## 三、AIProxyV2 核心功能

### 七层过滤
| 层 | 功能 |
|---|------|
| L0 | 配置开关 |
| L1 | User-Agent验证 |
| L2 | 路径分流 |
| L3 | Headers验证 |
| L4 | Body解析 |
| L5 | System Prompt相似度（Dice系数） |
| L6 | UserID格式 |
| L7 | 频率限制 |

---

## 四、claude-relay 核心功能

### 4.1 多平台转发（重点）

**10种账户类型**：
- Claude: official, console, bedrock, ccr
- OpenAI: openai, responses, azure
- Gemini: oauth, api-key
- Other: droid

**统一调度器**: 按平台分组，支持会话粘性

**格式转换**: OpenAI ↔ Claude ↔ Gemini

### 4.2 额度管理

**配额类型**：
- 并发限制
- 滑动窗口限流（请求数/费用）
- 每日/总费用限制
- Opus周费用限制

**Redis结构**：
```
usage:daily:{keyId}:{date}     -- 每日统计
cost:daily:{keyId}:{date}      -- 每日费用
cost:total:{keyId}             -- 总费用
concurrency:{keyId}            -- 并发(ZSet)
```

### 4.3 费用计算

```
输入费用 = input_tokens / 1M × 单价
输出费用 = output_tokens / 1M × 单价
缓存费用 = cache_tokens / 1M × 单价
总费用 = 输入 + 输出 + 缓存
```

---

## 五、Go-AIProxy 整合方案

| 功能 | 来源 |
|------|------|
| 整体架构 | clove |
| 账户调度 | clove |
| 会话管理 | clove |
| 七层过滤 | AIProxyV2 |
| 多平台转发 | claude-relay |
| 额度管理 | claude-relay |
| 费用计算 | claude-relay |

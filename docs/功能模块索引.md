# 功能模块索引

> 最后更新：2025-12-29
> 本文档索引系统所有功能模块，标注关键代码位置和可配置项

---

## 目录

1. [首页](#1-首页)
2. [用户认证](#2-用户认证)
3. [账户管理](#3-账户管理)
4. [API Key 管理](#4-api-key-管理)
5. [代理转发](#5-代理转发)
6. [套餐系统](#6-套餐系统)
7. [费用统计](#7-费用统计)
8. [使用量统计](#8-使用量统计)
9. [定时任务](#9-定时任务)
10. [缓存管理](#10-缓存管理)
11. [系统配置](#11-系统配置)
12. [客户端过滤](#12-客户端过滤)
13. [系统监控](#13-系统监控)
14. [系统日志](#14-系统日志)
15. [OpenAI Responses API](#15-openai-responses-api)
16. [账号健康检查](#16-账号健康检查)
17. [操作日志](#17-操作日志)

---

## 1. 首页

### 功能描述
系统对外展示的首页，提供平台介绍、API文档和客户端对接教程

### 关键代码位置
| 功能 | 文件 | 说明 |
|------|------|------|
| 动态效果 | `web/src/views/Home.vue` | Canvas 粒子系统、星空、数据流、打字机等 |
| 服务端点展示 | `web/src/views/Home.vue:87-114` | Claude/OpenAI/Gemini Base URL |
| API 文档展示 | `web/src/views/Home.vue:189-247` | Claude/OpenAI/Gemini 接口文档 |
| 对接教程 | `web/src/views/Home.vue:253-418` | Claude Code、Cursor、Continue、Open WebUI |

### 动态效果列表
| 效果 | 实现方式 | 代码位置 |
|------|----------|----------|
| Canvas 粒子系统 | Canvas 2D API | Home.vue:477-517 |
| 星空背景 | 100 个随机星星 DOM | Home.vue:24-31 |
| 数据流动画 | 5 条垂直数据流 | Home.vue:33-38 |
| 鼠标跟随光晕 | 径向渐变 + 跟随 | Home.vue:13-15, 532-535 |
| 打字机效果 | 逐字符追加 | Home.vue:704-715 |
| 数字滚动 | CountUp 组件 | Home.vue:480-517 |
| 卡片悬停效果 | CSS 变量 + 径向渐变 | Home.vue:643-651 |

### 服务端点配置
客户端需要配置的 Base URL（不包含完整端点路径）：
- Claude: `{{ baseUrl }}/claude`
- OpenAI: `{{ baseUrl }}/openai`
- Gemini: `{{ baseUrl }}/gemini`

### 前端页面
`web/src/views/Home.vue` - 首页（路由 `/`）

---

## 2. 用户认证

### 功能描述
用户登录、注册、JWT Token 认证

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 用户登录 | `internal/handler/user.go` | `Login()` |
| 用户注册 | `internal/handler/user.go` | `Register()` |
| JWT 生成 | `pkg/utils/jwt.go` | `GenerateToken()` |
| JWT 验证 | `internal/middleware/jwt.go` | `JWTAuth()` |
| 密码哈希 | `internal/model/user.go` | `HashPassword()` |

### 可配置项
| 配置项 | 位置 | 默认值 | 说明 |
|--------|------|--------|------|
| `jwt.secret` | `configs/config.yaml` | 随机生成 | JWT 签名密钥 |
| `jwt.expire_hours` | `configs/config.yaml` | 24 | Token 过期时间(小时) |

### 前端页面
- `web/src/views/Login.vue` - 登录页面
- `web/src/views/Profile.vue` - 个人设置页面

---

## 3. 账户管理

### 功能描述
管理各 AI 平台账户（OpenAI、Claude、Azure、Gemini、Bedrock 等）

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 账户 CRUD | `internal/handler/account.go` | `Create/Update/Delete/List` |
| 账户模型 | `internal/model/account.go` | `Account` 结构体 |
| 账户调度 | `internal/proxy/scheduler/scheduler.go` | `GetAccount()` |
| ModelMapping 过滤 | `internal/proxy/scheduler/scheduler.go` | `filterByAllowedModelsWithOriginal()` |
| ModelMapping 获取 | `internal/proxy/scheduler/scheduler.go` | `getAccountMappedModel()` |
| 限流恢复 | `internal/proxy/scheduler/scheduler.go` | `startRateLimitRecoveryTask()` |
| 费用统计 | `internal/handler/account.go` | `List()` MySQL查询 |
| 费用更新 | `internal/repository/account.go` | `UpdateTotalCost()` |
| 账户并发控制 | `internal/middleware/concurrency.go` | `AccountConcurrencyControl()` |

### 可配置项
| 配置项 | 位置 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | 账户字段 | true | 是否启用 |
| `priority` | 账户字段 | 0 | 调度优先级 |
| `weight` | 账户字段 | 1 | 负载均衡权重 |
| `max_concurrency` | 账户字段 | 5 | 最大并发请求数 |
| `rate_limit_reset_at` | 账户字段 | null | 限流恢复时间 |

### 支持平台
| 平台 | Type 值 | 必填字段 |
|------|---------|----------|
| OpenAI | `openai` | api_key |
| Claude Official | `claude` | api_key |
| Claude CCR | `claude_ccr` | access_token, refresh_token |
| Claude Console | `claude_console` | session_key |
| Azure OpenAI | `azure` | api_key, endpoint |
| Google Gemini | `gemini` | api_key |
| AWS Bedrock | `bedrock` | access_key, secret_key, region |

### 前端页面
- `web/src/views/Accounts.vue` - 账户管理
- `web/src/views/AccountLoad.vue` - 账户负载统计
- `web/src/components/AccountForm.vue` - 账户表单（含模型映射选择）

### 模型映射配置

账户可以配置模型映射，将请求中的模型名自动转换为实际使用的模型名。

**配置方式**：
从全局模型映射（模型管理页面配置）中选择要应用的映射规则。

**存储格式**：
```json
{"claude-3-5-sonnet": "claude-sonnet-4-20250514", "gpt-4": "gpt-4-turbo"}
```

**关键代码**：
| 功能 | 文件 | 方法 |
|------|------|------|
| 加载全局映射 | `web/src/components/AccountForm.vue` | `loadMappings()` |
| 映射ID匹配 | `web/src/components/AccountForm.vue` | `watch(visible)` |
| 构建映射JSON | `web/src/components/AccountForm.vue` | `buildSubmitData()`

---

## 4. API Key 管理

### 功能描述
API Key 生成、验证、权限控制

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| Key 生成 | `internal/service/api_key.go` | `Create()` |
| Key 验证 | `internal/middleware/api_key.go` | `APIKeyAuth()` |
| Key 哈希 | `internal/service/api_key.go` | `hashAPIKey()` |
| 使用量更新 | `internal/service/api_key.go` | `IncrementUsage()` |
| 管理员创建 | `internal/service/api_key.go` | `AdminCreate()` |

### 可配置项
| 配置项 | 位置 | 默认值 | 说明 |
|--------|------|--------|------|
| `billing_type` | API Key 字段 | quota | 计费类型(quota/subscription) |
| `allowed_models` | API Key 字段 | * | 允许的模型列表 |
| `price_rate` | 用户字段 | 1.0 | 费率倍率 |
| `expires_at` | API Key 字段 | null | 过期时间 |

### Key 格式
- 前缀: `sk-`
- 长度: 32字节随机 + 前缀 = 48字符
- 存储: SHA256 哈希，不存原文

### 前端页面
- `web/src/views/APIKeys.vue` - API Key 管理

---

## 5. 代理转发

### 功能描述
转发请求到上游 AI 平台，支持多平台、负载均衡、会话粘性

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 代理入口 | `internal/handler/proxy.go` | `HandleProxy()` |
| 流式处理 | `internal/handler/proxy.go` | `handleStreamResponse()` |
| 非流式处理 | `internal/handler/proxy.go` | `handleNonStreamResponse()` |
| 使用记录 | `internal/handler/proxy.go` | `recordUsage()` |
| 账户调度 | `internal/proxy/scheduler/scheduler.go` | `GetAccount()` |
| 会话粘性 | `internal/proxy/scheduler/session.go` | `GetSessionAccount()` |
| 格式转换 | `internal/proxy/adapter/converter.go` | 各转换方法 |

### 适配器列表
| 适配器 | 文件 | 说明 |
|--------|------|------|
| OpenAI | `internal/proxy/adapter/openai.go` | OpenAI API |
| Claude | `internal/proxy/adapter/claude.go` | Claude Official API（含 Thinking Block 处理） |
| Claude CCR | `internal/proxy/adapter/claude_ccr.go` | Claude OAuth |
| Azure | `internal/proxy/adapter/azure.go` | Azure OpenAI |
| Gemini | `internal/proxy/adapter/gemini.go` | Google Gemini |
| Bedrock | `internal/proxy/adapter/bedrock.go` | AWS Bedrock |

### Claude 适配器扩展功能
| 功能 | 方法 | 说明 |
|------|------|------|
| Signature 错误检测 | `isSignatureError()` | 检测 thinking block signature 错误 |
| Thinking Block 移除 | `removeThinkingBlocks()` | 从请求体移除 thinking blocks |
| 非流式重试 | `doSendWithRetry()` | 支持 signature 错误自动重试 |
| 流式重试 | `doSendStreamWithRetry()` | 支持 signature 错误自动重试 |

### 可配置项
| 配置项 | 位置 | 默认值 | 说明 |
|--------|------|--------|------|
| `proxy.timeout` | system_configs | 300 | 代理超时(秒) |
| `session_ttl` | config.yaml | 60分钟 | 会话粘性TTL |
| `retry_count` | 代码常量 | 3 | 重试次数 |

### 支持路由
| 路由 | 协议 | 说明 |
|------|------|------|
| `/v1/chat/completions` | OpenAI | OpenAI 兼容接口 |
| `/v1/messages` | Claude | Claude 原生接口 |

### 前端页面
- `web/src/views/ProxyTest.vue` - 代理测试
- `web/src/views/RequestLogs.vue` - 请求日志

### HTTP 客户端

**功能描述**：
管理 HTTP 客户端连接池，支持代理、流式请求、Chrome TLS 指纹

**关键代码位置**：
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 获取普通客户端 | `internal/proxy/adapter/http_client.go` | `GetHTTPClient()` |
| 获取流式客户端 | `internal/proxy/adapter/http_client.go` | `GetStreamHTTPClient()` |
| 代理客户端缓存 | `internal/proxy/adapter/http_client.go` | `getOrCreateProxyClient()` |
| Chrome TLS 客户端 | `internal/proxy/adapter/http_client.go` | `GetChromeTLSClient()` |
| 缓存清理 | `internal/proxy/adapter/http_client.go` | `ClearProxyClientCache()` |
| 缓存统计 | `internal/proxy/adapter/http_client.go` | `GetProxyClientCacheStats()` |

**全局客户端配置**：
| 客户端 | 超时 | 用途 |
|--------|------|------|
| `defaultHTTPClient` | 120s | 普通请求（连接池复用） |
| `defaultStreamClient` | 600s | 流式请求（禁用压缩、HTTP/2） |

**连接池参数**：
| 参数 | 值 | 说明 |
|------|-----|------|
| `MaxIdleConns` | 100 | 全局最大空闲连接数 |
| `MaxIdleConnsPerHost` | 20 | 每个主机最大空闲连接 |
| `IdleConnTimeout` | 90s/120s | 空闲连接超时（普通/流式） |

**支持的代理类型**：
| 类型 | 说明 |
|------|------|
| `http/https` | HTTP 代理 |
| `socks5/socks5h` | SOCKS5 代理 |

---

## 6. 套餐系统

### 功能描述
订阅和额度两种计费模式，周期限额控制

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 套餐模板 CRUD | `internal/handler/package.go` | 各方法 |
| 用户套餐管理 | `internal/handler/package.go` | `AssignUserPackage()` |
| 额度检查 | `internal/model/package.go` | `CanUse()` |
| 周期重置 | `internal/model/package.go` | `ResetPeriodUsageIfNeeded()` |
| 使用量增加 | `internal/model/package.go` | `IncrementUsage()` |

### 可配置项
| 配置项 | 位置 | 默认值 | 说明 |
|--------|------|--------|------|
| `type` | Package | subscription | 套餐类型(subscription/quota) |
| `daily_limit` | Package | 0 | 日限额(0=无限) |
| `weekly_limit` | Package | 0 | 周限额(0=无限) |
| `monthly_limit` | Package | 0 | 月限额(0=无限) |
| `total_quota` | Package | 0 | 总额度(额度类型) |
| `allowed_models` | Package | * | 允许模型列表 |

### 计费类型
| 类型 | 说明 | 限制方式 |
|------|------|----------|
| subscription | 订阅制 | 日/周/月周期限额 |
| quota | 额度制 | 总额度 + 过期时间 |

### 前端页面
- `web/src/views/Packages.vue` - 套餐管理

---

## 7. 费用统计

### 功能描述
Token 费用计算、账户费用统计

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 费用计算 | `internal/service/pricing.go` | `CalculateCost()` |
| 模型定价 | `internal/model/ai_model.go` | `AIModel` 结构体 |
| 费用记录 | `internal/service/usage.go` | `IncrementCost()` |
| 账户费用 | `internal/service/usage.go` | `IncrementAccountCost()` |

### 可配置项
| 配置项 | 位置 | 默认值 | 说明 |
|--------|------|--------|------|
| `input_price` | AIModel | 模型相关 | 输入价格/1M tokens |
| `output_price` | AIModel | 模型相关 | 输出价格/1M tokens |
| `cache_creation_price` | AIModel | 0 | 缓存创建价格 |
| `cache_read_price` | AIModel | 0 | 缓存读取价格 |
| `price_rate` | User | 1.0 | 用户费率倍率 |

### 费用公式
```
输入费用 = 输入Token × 输入单价 / 1000000 × 费率倍率
输出费用 = 输出Token × 输出单价 / 1000000 × 费率倍率
总费用 = 输入费用 + 输出费用 + 缓存费用
```

### 前端页面
- `web/src/views/Models.vue` - 模型定价管理

---

## 8. 使用量统计

### 功能描述
MySQL 实时统计（直接写入数据库）

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 使用量增加 | `internal/service/usage.go` | `IncrementUsage()` |
| 费用增加 | `internal/service/usage.go` | `IncrementCost()` |
| 记录请求 | `internal/service/usage.go` | `RecordRequest()` |
| 模型统计 | `internal/service/usage.go` | `IncrementModelUsage()` |
| 查询用户统计 | `internal/service/usage.go` | `GetUserUsage()` |
| 查询每日统计 | `internal/service/usage.go` | `GetUserDailyStats()` |
| 每日汇总存储 | `internal/repository/daily_usage.go` | `Upsert()` |

### 数据表结构
| 表名 | 说明 |
|------|------|
| `daily_usages` | 每日使用汇总（按用户+日期+模型） |
| `usage_records` | 详细使用记录 |
| `request_logs` | 请求日志 |

### 可配置项
| 配置项 | 位置 | 默认值 | 说明 |
|--------|------|--------|------|
| 数据保留 | 手动清理 | 无限期 | MySQL 数据永久保留 |

### 前端页面
- `web/src/views/Usage.vue` - 使用统计

---

## 9. 定时任务

### 功能描述
后台定时执行的任务

### 任务列表
| 任务 | 文件 | 间隔 | 说明 |
|------|------|------|------|
| 限流恢复 | `internal/proxy/scheduler/scheduler.go` | 1分钟 | 恢复过期限流账户 |
| 内存缓存清理 | `internal/cache/memory.go` | 自动 | 过期数据自动清理 |

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 限流恢复任务 | `internal/proxy/scheduler/scheduler.go` | `startRateLimitRecoveryTask()` |
| 限流恢复执行 | `internal/repository/account.go` | `RecoverRateLimitedAccounts()` |
| 会话过期清理 | `internal/cache/memory.go` | `cleanupExpired()` |

---

## 10. 缓存管理

### 功能描述
内存缓存操作、会话管理、并发控制、聚合视图查询

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 内存缓存核心 | `internal/cache/memory.go` | `SessionStore`, `ConcurrencyManager` |
| 缓存服务 | `internal/service/cache.go` | `CacheService` |
| 缓存 API | `internal/handler/cache.go` | 各方法 |
| 账户并发控制 | `internal/service/cache.go` | `AcquireConcurrency()` |
| 用户并发控制 | `internal/middleware/user_concurrency.go` | `UserConcurrencyControl()` |
| 会话绑定 | `internal/cache/session.go` | `SetSessionBinding()` |
| 会话获取 | `internal/cache/session.go` | `GetSessionBinding()` |
| 账号缓存聚合 | `internal/service/cache.go` | `ListAccountsWithCache()` |
| 用户缓存聚合 | `internal/service/cache.go` | `ListUsersWithCache()` |

### 聚合视图

**账号缓存视图** (`/api/admin/cache/accounts`):
- 每个账号的当前并发数、最大并发数
- 会话数量和会话详情
- 使用此账号的用户ID列表

**用户缓存视图** (`/api/admin/cache/users`):
- 每个用户的当前并发数
- 会话数量和会话详情
- 此用户使用的账号ID列表

### TTL 配置参数
| 参数 | 说明 | 默认值 | 单位 |
|------|------|--------|------|
| `session_ttl` | 粘性会话TTL，会话绑定过期时间 | 60 | 分钟 |
| `session_renewal_ttl` | 会话续期阈值，剩余时间低于此值时自动续期 | 14 | 分钟 |
| `unavailable_ttl` | 不可用标记TTL，账户临时不可用的标记时长 | 5 | 分钟 |
| `concurrency_ttl` | 并发计数TTL，并发计数器的过期时间 | 5 | 分钟 |
| `default_concurrency_max` | 默认最大并发数 | 5 | 个 |

### 智能续期机制
当用户持续使用同一会话时：
- 系统检查会话剩余TTL
- 剩余时间 > session_renewal_ttl → 不续期
- 剩余时间 < session_renewal_ttl → 自动续期到 session_ttl

**优点**: 避免活跃用户会话中断，又避免每次请求都续期浪费资源

### 并发控制
| 类型 | 默认值 | 配置位置 | 说明 |
|------|--------|----------|------|
| 账户并发 | 5 | Account.max_concurrency | 单账户最大并发请求数 |
| 用户并发 | 10 | User.max_concurrency | 单用户最大并发请求数 |

### 内存缓存结构（会话与并发）
| 数据类型 | 存储结构 | 说明 | 过期 |
|----------|----------|------|------|
| 会话绑定 | `sync.Map` | 会话→账户映射 | session_ttl |
| 账户并发 | `atomic.Int64` | 账户当前并发数 | concurrency_ttl |
| 用户并发 | `atomic.Int64` | 用户当前并发数 | concurrency_ttl |
| 不可用标记 | `sync.Map` | 账户不可用信息 | unavailable_ttl |

### 可配置项
| 配置项 | 位置 | 默认值 | 说明 |
|--------|------|--------|------|
| `cache.session_ttl` | config.yaml / API | 60 | 会话 TTL(分钟) |
| `cache.session_renewal_ttl` | config.yaml / API | 14 | 续期阈值(分钟) |
| `cache.unavailable_ttl` | config.yaml / API | 5 | 不可用标记 TTL(分钟) |
| `cache.concurrency_ttl` | config.yaml / API | 5 | 并发计数 TTL(分钟) |

### 前端页面
- `web/src/views/Cache.vue` - 缓存管理（双Tab：账号缓存/用户缓存聚合视图）

---

## 11. 系统配置

### 功能描述
运行时动态配置管理

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 配置服务 | `internal/service/config.go` | `ConfigService` |
| 配置 API | `internal/handler/config.go` | 各方法 |
| 配置模型 | `internal/model/system_config.go` | `SystemConfig` |

### 系统配置项
| Key | 说明 | 默认值 | 影响范围 |
|-----|------|--------|----------|
| `log.level` | 日志级别 | info | Logger |
| `proxy.timeout` | 代理超时(秒) | 300 | ProxyHandler |
| `cache.session_ttl` | 会话TTL(分钟) | 60 | CacheService |
| `cache.unavailable_ttl` | 不可用TTL(分钟) | 5 | CacheService |

### 前端页面
- `web/src/views/Settings.vue` - 系统设置

---

## 快速定位指南

### 修改代理超时
1. 文件: `internal/handler/proxy.go`
2. 或通过系统配置: `proxy.timeout`

### 修改 JWT 过期时间
1. 文件: `configs/config.yaml`
2. 配置项: `jwt.expire_hours`

### 添加新的 AI 平台
1. `internal/model/account.go` - 添加平台类型常量
2. `internal/proxy/adapter/` - 创建新适配器
3. `internal/handler/account.go` - 注册适配器
4. `web/src/views/Accounts.vue` - 前端表单支持

### 修改费用计算
1. 文件: `internal/service/pricing.go`
2. 方法: `CalculateCost()`

### 修改缓存 TTL
1. 文件: `configs/config.yaml`
2. 配置节: `cache`
3. 支持参数: `session_ttl`, `unavailable_ttl`, `concurrency_ttl`

### 修改限流恢复间隔
1. 文件: `internal/proxy/scheduler/scheduler.go`
2. 方法: `startRateLimitRecoveryTask()`
3. 当前固定: 1分钟

---

## 12. 客户端过滤

### 功能描述
过滤非官方客户端访问，支持简单/严格两种验证模式

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 过滤中间件 | `internal/middleware/client_filter.go` | `ClientFilter()` |
| 过滤服务 | `internal/service/client_filter.go` | `ValidateClient()` |
| 客户端匹配 | `internal/service/client_filter.go` | `matchClientType()` |
| Claude Code 验证 | `internal/service/client_filter.go` | `validateClaudeCodeRules()` |
| 配置存储 | `internal/repository/client_filter.go` | `GetConfig()/SaveConfig()` |
| 过滤模型 | `internal/model/client_filter.go` | `ClientFilterConfig` |

### 验证模式
| 模式 | 说明 | User-Agent 要求 |
|------|------|-----------------|
| `simple` | 简单模式 | `claude-cli/版本号` 开头即可 |
| `strict` | 严格模式 | 完整格式 `claude-cli/版本 (external, cli)` |

### 严格模式验证规则（Claude Code）
| 规则 | 检查内容 | 说明 |
|------|----------|------|
| UA 格式 | `^claude-cli/(\d+\.\d+\.\d+)\s*\(external,\s*(cli|claude-vscode|sdk-ts|sdk-cli)` | 完整 User-Agent |
| 必需头 | `x-stainless-os`, `anthropic-version` | HTTP Headers |
| System Prompt | 相似度 > 0.3 | Sørensen-Dice 算法 |
| metadata.user_id | `user_[a-f0-9]+_account__session_[a-f0-9-]+` | 请求体字段 |

### 可配置项
| 配置项 | 位置 | 默认值 | 说明 |
|--------|------|--------|------|
| `filter_enabled` | 数据库/API | false | 过滤开关 |
| `filter_mode` | 数据库/API | simple | 验证模式 |
| `allowed_clients` | 数据库/API | [] | 允许的客户端类型列表 |

### 支持的客户端类型
| ID | 名称 | 说明 |
|----|------|------|
| `claude_code` | Claude Code | Anthropic 官方 CLI |

### 数据表
| 表名 | 说明 |
|------|------|
| `client_types` | 客户端类型定义 |
| `client_filter_rules` | 过滤规则配置 |

### 前端页面
- `web/src/views/ClientFilter.vue` - 客户端过滤设置

---

## 13. 系统监控

### 功能描述
实时监控系统资源、数据库状态、账号统计、用户统计、今日使用量

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 监控服务 | `internal/service/system_monitor.go` | `SystemMonitorService` |
| 完整监控数据 | `internal/service/system_monitor.go` | `GetMonitorData()` |
| 系统资源 | `internal/service/system_monitor.go` | `GetSystemStats()` |
| 缓存统计 | `internal/service/system_monitor.go` | `GetCacheStats()` |
| MySQL 统计 | `internal/service/system_monitor.go` | `GetMySQLStats()` |
| 账号统计 | `internal/service/system_monitor.go` | `GetAccountStats()` |
| 用户统计 | `internal/service/system_monitor.go` | `GetUserStats()` |
| 今日使用统计 | `internal/service/system_monitor.go` | `GetTodayUsageStats()` |
| 监控 API | `internal/handler/system_monitor.go` | 各方法 |

### 监控指标
| 分类 | 指标 |
|------|------|
| 系统资源 | CPU 核数、CPU 使用率、内存总量/已用/可用、磁盘总量/已用/可用 |
| 缓存 | 连接状态、会话数量、不可用标记数量 |
| MySQL | 连接状态、表数量、数据大小、索引大小 |
| 账号 | 总数、正常可用、限流中、无效/禁用 |
| 用户 | 总数、今日活跃、今日新增 |
| 今日使用 | 消费金额、总Token、输入/输出Token、缓存Token、请求次数 |

### API 接口
| 接口 | 说明 |
|------|------|
| `GET /api/admin/monitor` | 完整监控数据 |
| `GET /api/admin/monitor/system` | 系统资源 |
| `GET /api/admin/monitor/cache` | 缓存统计 |
| `GET /api/admin/monitor/mysql` | MySQL 统计 |
| `GET /api/admin/monitor/accounts` | 账号统计 |
| `GET /api/admin/monitor/users` | 用户统计 |
| `GET /api/admin/monitor/today` | 今日使用统计 |

### 依赖
- `github.com/shirou/gopsutil/v3` - 系统资源采集

### 前端页面
- `web/src/views/SystemMonitor.vue` - 系统监控页面

---

## 14. 系统日志

### 功能描述
查看日志文件，支持两种日志来源：
- **应用日志**：项目 `logs/` 目录下的应用日志
- **服务器日志**：`/var/log/` 目录下的系统日志（白名单限制）

支持分类筛选、分页查看、关键词搜索、实时 tail

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 日志 Handler | `internal/handler/system_log.go` | `SystemLogHandler` |
| 服务器日志白名单 | `internal/handler/system_log.go` | `allowedServerLogs` |
| 文件列表 | `internal/handler/system_log.go` | `ListFiles()` |
| 服务器日志列表 | `internal/handler/system_log.go` | `listServerLogs()` |
| 读取内容 | `internal/handler/system_log.go` | `ReadFile()` |
| 实时查看 | `internal/handler/system_log.go` | `TailFile()` |
| 下载文件 | `internal/handler/system_log.go` | `DownloadFile()` |
| 删除文件 | `internal/handler/system_log.go` | `DeleteFile()` |

### API 接口
| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/admin/system-logs/files` | GET | 获取日志文件列表 |
| `/api/admin/system-logs/read` | GET | 分页读取日志内容 |
| `/api/admin/system-logs/tail` | GET | 获取日志末尾内容 |
| `/api/admin/system-logs/download` | GET | 下载日志文件 |
| `/api/admin/system-logs/file` | DELETE | 删除日志文件（仅应用日志） |

### 查询参数
| 参数 | 接口 | 说明 |
|------|------|------|
| `source` | 所有接口 | 日志来源：`app`（应用日志，默认）或 `server`（服务器日志） |
| `category` | files | 日志分类过滤（auth, http, proxy 等） |
| `date` | files | 日期过滤（YYYY-MM-DD，仅应用日志） |
| `file` | read/tail/download/delete | 日志文件名 |
| `page` | read | 页码（默认 1） |
| `page_size` | read | 每页行数（默认 200） |
| `keyword` | read | 搜索关键词 |
| `reverse` | read | 倒序显示（true/false） |
| `lines` | tail | 获取行数（默认 200） |

### 应用日志分类（source=app）
| 分类 | 说明 |
|------|------|
| `auth` | 认证相关日志 |
| `http` | HTTP 请求日志 |
| `main` | 主程序日志 |
| `proxy` | 代理转发日志 |
| `scheduler` | 调度器日志 |
| `sync` | 数据同步日志 |
| `operation` | 操作日志 |
| `middleware` | 中间件日志 |
| `client_filter` | 客户端过滤日志 |
| `error_message` | 错误消息日志 |
| `error_response` | 错误响应日志 |

### 服务器日志白名单（source=server）
| 文件 | 分类 | 说明 |
|------|------|------|
| `auth.log` / `auth.log.1` | ssh | SSH认证日志 |
| `syslog` / `syslog.1` | system | 系统日志 |
| `kern.log` / `kern.log.1` | kernel | 内核日志 |
| `dpkg.log` | system | 软件包日志 |
| `fail2ban.log` | fail2ban | Fail2ban日志 |
| `nginx/access.log` | nginx | Nginx访问日志 |
| `nginx/error.log` | nginx | Nginx错误日志 |
| `mysql/error.log` | mysql | MySQL错误日志 |

### 前端页面
- `web/src/views/SystemLogs.vue` - 系统日志查看页面
  - Tab 切换：应用日志 / 服务器日志
  - 服务器日志不显示删除操作

---

## 15. OpenAI Responses API

### 功能描述
实现 OpenAI Responses API（Codex）转发功能，支持 Claude Code、Codex CLI 等客户端的 `/responses` 接口请求。支持会话粘性，同一 API Key 的请求始终路由到同一账户。

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| Responses Handler | `internal/handler/openai_responses.go` | `OpenAIResponsesHandler` |
| 请求处理入口 | `internal/handler/openai_responses.go` | `HandleResponses()` |
| 流式响应处理 | `internal/handler/openai_responses.go` | `handleStreamResponse()` |
| 非流式响应处理 | `internal/handler/openai_responses.go` | `handleNormalResponse()` |
| SSE Usage 解析 | `internal/handler/openai_responses.go` | `parseSSEForUsage()` |
| 请求头设置 | `internal/handler/openai_responses.go` | `setRequestHeaders()` |
| 会话哈希生成 | `internal/handler/openai_responses.go` | `generateSessionHash()` |
| 适配器 | `internal/proxy/adapter/openai_responses.go` | `OpenAIResponsesAdapter` |
| 多类型账户调度 | `internal/proxy/scheduler/scheduler.go` | `SelectAccountByTypesWithSession()` |
| 单类型账户调度 | `internal/proxy/scheduler/scheduler.go` | `SelectAccountByTypeWithSession()` |

### 技术实现要点

**直接字节流转发**：
参考 claude-relay 项目实现，不解析 SSE 格式，直接转发原始字节流，确保流完整性：
```go
buf := make([]byte, 32*1024)
for {
    n, err := resp.Body.Read(buf)
    if n > 0 {
        c.Writer.Write(buf[:n])
        c.Writer.Flush()
    }
}
```

**Usage 数据解析**：
在转发的同时异步解析 `response.completed` 事件获取 token 统计：
- 监听 `type: response.completed` 事件
- 提取 `usage.input_tokens` 和 `usage.output_tokens`

**URL 构建**：
```
targetURL = baseURL + requestPath
```
与 claude-relay 保持一致，直接拼接 base URL 和请求路径

### 支持路由
| 路由 | 方法 | 说明 | 中间件 |
|------|------|------|--------|
| `/responses` | POST | OpenAI Responses API | APIKeyAuth, ClientFilter, UserConcurrency |
| `/v1/responses` | POST | OpenAI Responses API | APIKeyAuth, ClientFilter, UserConcurrency |

### 账户类型
| Type 值 | 说明 | 必填字段 |
|---------|------|----------|
| `openai-responses` | ChatGPT 官方 Codex 账户 | api_key/session_key, base_url |
| `openai` | 第三方 OpenAI API（也支持 /responses） | api_key, base_url |

> **注意**：2025-12-19 更新后，`/responses` 接口同时支持 `openai-responses` 和 `openai` 两种账户类型，调度器会从两种类型中选择可用账户。

### 默认配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `base_url` | `https://chatgpt.com/backend-api/codex` | 默认上游地址 |

### 请求头透传
| 客户端头 | 转发头 | 说明 |
|----------|--------|------|
| `User-Agent` | `User-Agent` | 客户端标识 |
| `Session_id` | `session_id` | 会话 ID |
| `Version` | `version` | 版本号 |
| `Openai-Beta` | `openai-beta` | Beta 特性标识 |

### chatgpt.com 特殊处理
当目标 URL 为 `chatgpt.com` 时，自动添加：
- `openai-beta: responses=experimental`
- `chatgpt-account-id: {organization_id}` （如果账户配置了 organization_id）

### 使用示例
```bash
curl http://localhost:8080/responses \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gpt-5.1-codex-max",
    "input": "Write a hello world function",
    "stream": true
  }'
```

### 会话粘性支持

OpenAI Responses API 支持会话粘性功能，确保同一会话的请求始终路由到同一后端账户。

**实现机制**：
- 使用 `SelectAccountByTypesWithSession()` 方法支持多账户类型选择
- 同时从 `openai-responses` 和 `openai` 类型账户中选择
- 会话绑定存储在内存缓存，Key 格式：`session:binding:{sessionHash}`
- TTL 默认 60 分钟（可配置）

**会话哈希生成**（`generateSessionHash()`）：
按优先级生成会话标识：
1. `Session_id` 请求头（Codex CLI 提供）
2. `instructions` 字段（类似 system prompt）
3. 第一条 input 消息内容

**工作流程**：
1. 首次请求：生成会话哈希，按权重从多类型账户中选择，创建会话绑定
2. 后续请求：从内存缓存获取绑定，直接使用已绑定账户
3. 账户不可用：自动移除绑定，重新选择账户

**验证测试**：
多个不同会话并发请求时，每个会话会绑定到不同账户，后续相同会话的请求命中缓存。

### 前端页面
- 无独立页面，使用现有账户管理页面配置 `openai-responses` 或 `openai` 类型账户

---

## 16. 账号健康检查

### 功能描述
定期检查 OAuth/SessionKey 类型账号的有效性，自动禁用连续错误达到阈值的账号。

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 健康检查服务 | `internal/service/health_check.go` | `AccountHealthCheckService` |
| 服务启动/停止 | `internal/service/health_check.go` | `Start()`, `Stop()` |
| 检查循环 | `internal/service/health_check.go` | `checkLoop()` |
| 执行检查 | `internal/service/health_check.go` | `doCheck()` |
| 单账号检查 | `internal/service/health_check.go` | `checkAccount()` |
| Claude OAuth 验证 | `internal/service/health_check.go` | `checkClaudeOAuth()` |
| Claude SessionKey 验证 | `internal/service/health_check.go` | `checkClaudeSessionKey()` |
| Claude 检查 | `internal/service/health_check.go` | `checkClaudeOfficial()` |
| OpenAI Responses 检查 | `internal/service/health_check.go` | `checkOpenAIResponses()` |
| ChatGPT OAuth 验证 | `internal/service/health_check.go` | `checkChatGPTOAuth()` |
| Gemini 检查 | `internal/service/health_check.go` | `checkGemini()` |
| 错误计数增加 | `internal/repository/account.go` | `IncrementConsecutiveErrorCount()` |
| 错误计数重置 | `internal/repository/account.go` | `ResetConsecutiveErrorCount()` |
| 禁用账号 | `internal/repository/account.go` | `DisableAccountByHealthCheck()` |
| 获取检查账号 | `internal/repository/account.go` | `GetAccountsForHealthCheck()` |

### 检查账号类型
| 账号类型 | Type 值 | 认证方式 | 验证端点 |
|----------|---------|----------|----------|
| Claude Official | `claude-official` | OAuth (AccessToken) | `https://api.anthropic.com/api/oauth/usage` |
| Claude Official | `claude-official` | SessionKey | `https://claude.ai/api/organizations` |
| OpenAI Responses | `openai-responses` | API Key | `https://api.openai.com/v1/models` |
| OpenAI Responses | `openai-responses` | ChatGPT OAuth | `https://chatgpt.com/backend-api/accounts/check/v4-2023-04-27` |
| Google Gemini | `gemini` | OAuth | `https://generativelanguage.googleapis.com/v1beta/models` |

**不检查的类型**：
- `openai` - 第三方 API Key（由第三方管理）
- `claude` - Claude API Key（由 Anthropic 管理）
- `azure` - Azure OpenAI（由 Azure 管理）
- `bedrock` - AWS Bedrock（由 AWS 管理）

### 可配置项
| 配置项 | 位置 | 默认值 | 说明 |
|--------|------|--------|------|
| `account_health_check_enabled` | system_configs | false | 是否启用健康检查 |
| `account_health_check_interval` | system_configs | 5 | 检查间隔（分钟） |
| `account_error_threshold` | system_configs | 5 | 连续错误阈值 |

### 错误处理逻辑
| 检查结果 | 处理方式 |
|----------|----------|
| HTTP 200 | 健康，重置连续错误计数 |
| HTTP 401/403 | 认证失败，连续错误计数+1 |
| HTTP 429 | 限流，视为健康（账号本身有效） |
| 其他错误 | 连续错误计数+1 |
| 达到阈值 | 禁用账号，刷新调度器缓存 |

### 服务生命周期
```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│  配置启用时启动  │ ──▶ │  定期执行检查    │ ──▶ │  关闭时停止      │
│  main.go        │      │  checkLoop()    │      │  srv.Shutdown   │
└─────────────────┘      └─────────────────┘      └─────────────────┘
```

### 前端页面
- `web/src/views/Settings.vue` - 系统设置页面，健康检查配置卡片

---

## 17. 操作日志

### 功能描述
记录系统所有管理操作（创建、更新、删除等），便于审计和追溯。支持按模块、操作类型、时间范围筛选，以及日志清理功能。

### 关键代码位置
| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| 操作日志模型 | `internal/model/operation_log.go` | `OperationLog` |
| 模块常量 | `internal/model/operation_log.go` | `ModuleAuth`, `ModuleUser` 等 |
| 操作类型常量 | `internal/model/operation_log.go` | `ActionLogin`, `ActionCreate` 等 |
| 操作日志中间件 | `internal/middleware/operation_log.go` | `OperationLogger()` |
| 路由映射 | `internal/middleware/operation_log.go` | `routeMappings` |
| 路径ID提取 | `internal/middleware/operation_log.go` | `getPathID()`, `getSecondPathID()` |
| 目标名称查询 | `internal/middleware/operation_log.go` | `getUsernameByID()` 等 |
| 日志仓库 | `internal/repository/operation_log.go` | `OperationLogRepository` |
| 日志列表 | `internal/repository/operation_log.go` | `List()` |
| 日志清理 | `internal/repository/operation_log.go` | `DeleteOldLogs()` |
| 日志统计 | `internal/repository/operation_log.go` | `GetStats()` |
| API Handler | `internal/handler/operation_log.go` | `OperationLogHandler` |
| 日志列表接口 | `internal/handler/operation_log.go` | `List()` |
| 日志清理接口 | `internal/handler/operation_log.go` | `Cleanup()` |

### 支持的模块
| 模块 | 常量值 | 说明 |
|------|--------|------|
| 认证 | `auth` | 登录、注册 |
| 用户 | `user` | 用户管理 |
| 账户 | `account` | AI账户管理 |
| API Key | `apikey` | API Key管理 |
| 模型 | `model` | 模型管理 |
| 配置 | `config` | 系统配置 |
| 缓存 | `cache` | 缓存管理 |
| 代理 | `proxy` | 代理配置 |
| 套餐 | `package` | 套餐管理 |
| 分组 | `group` | 账户分组 |

### 支持的操作类型
| 操作 | 常量值 | HTTP方法 |
|------|--------|----------|
| 登录 | `login` | POST |
| 创建 | `create` | POST |
| 更新 | `update` | PUT |
| 删除 | `delete` | DELETE |
| 启用 | `enable` | PUT |
| 禁用 | `disable` | PUT |
| 清除 | `clear` | POST/DELETE |
| 测试 | `test` | POST |
| 同步 | `sync` | POST |

### 路由映射机制
中间件使用正则表达式匹配请求路径，自动识别模块和操作类型：

```go
type RouteMapping struct {
    PathPattern       *regexp.Regexp               // 路径正则
    Module            string                       // 模块名
    Action            string                       // 操作类型
    GetTargetID       func(*gin.Context) uint      // 获取目标ID
    GetTargetName     func(*gin.Context, map[string]interface{}) string  // 从请求体获取名称
    GetTargetNameByID func(uint) string            // 从数据库查询名称
    Description       func(*gin.Context, map[string]interface{}) string  // 生成描述
}
```

### 敏感字段脱敏
以下字段在日志记录时自动脱敏（替换为 `******`）：
- `token`
- `secret`
- `api_key`
- `session_key`
- `access_token`
- `refresh_token`

> **注意**：`password` 字段不脱敏，用于安全审计查看登录尝试。

### API 接口
| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/admin/operation-logs` | GET | 获取操作日志列表 |
| `/api/admin/operation-logs/:id` | GET | 获取单条日志详情 |
| `/api/admin/operation-logs/stats` | GET | 获取日志统计 |
| `/api/admin/operation-logs/cleanup` | DELETE | 清理旧日志 |

### 查询参数
| 参数 | 类型 | 说明 |
|------|------|------|
| `page` | int | 页码，默认 1 |
| `page_size` | int | 每页数量，默认 20，最大 100 |
| `user_id` | uint | 按用户ID筛选 |
| `module` | string | 按模块筛选 |
| `action` | string | 按操作类型筛选 |
| `start_time` | string | 开始日期（YYYY-MM-DD） |
| `end_time` | string | 结束日期（YYYY-MM-DD） |
| `search` | string | 搜索（用户名/描述/目标名/路径） |

### 数据库表结构
```sql
CREATE TABLE operation_logs (
    id              bigint unsigned PRIMARY KEY AUTO_INCREMENT,
    user_id         bigint unsigned,           -- 操作用户ID
    username        varchar(100),              -- 操作用户名
    ip              varchar(50),               -- 客户端IP
    method          varchar(10),               -- HTTP方法
    path            varchar(255),              -- 请求路径
    module          varchar(50),               -- 模块
    action          varchar(50),               -- 操作类型
    target_id       bigint unsigned,           -- 目标ID
    target_name     varchar(255),              -- 目标名称
    description     text,                      -- 操作描述
    request_body    text,                      -- 请求体（脱敏后）
    response_code   int,                       -- 响应码
    response_msg    varchar(500),              -- 响应消息
    duration        bigint,                    -- 耗时(ms)
    user_agent      varchar(500),              -- User-Agent
    created_at      datetime(3)                -- 创建时间
);
```

### 2025-12-24 修复记录

**问题**：
1. 登录日志 `user_id` 和 `username` 为空
2. 更新操作 `target_name` 为空

**修复**：
1. 从登录成功响应中提取用户信息
2. 使用正则表达式从 URL 提取目标ID
3. 使用 `Unscoped()` 查询包含软删除记录

**修复代码位置**：
- `internal/middleware/operation_log.go:149-186` - 路径ID提取
- `internal/middleware/operation_log.go:251-357` - 软删除查询
- `internal/middleware/operation_log.go:720-732` - 登录响应解析

### 前端页面
- `web/src/views/OperationLogs.vue` - 操作日志查看页面
  - 模块/操作类型/日期筛选
  - 关键词搜索
  - 详情弹窗
  - 清理旧日志

---

## 相关文档

- [代码索引](代码索引.md) - 完整代码结构索引
- [后端架构总览](架构设计/后端架构总览.md) - 后端架构说明
- [服务层设计](模块设计/M9-服务层设计.md) - 服务层详细设计
- [开发日志](开发日志/) - 日常开发记录

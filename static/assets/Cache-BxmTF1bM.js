import{_ as ie,r as p,a as de,c as Q,o as _e,b as C,d as i,e as r,f as l,w as a,h as c,i as d,L as fe,n as o,q as $,v as me,I as q,k as y,l as S,C as R,t as f,F as W,G as X,O as Y,E as V}from"./index-DPRGuc89.js";const pe={class:"cache-page"},ve={class:"page-header"},ge={class:"card-header"},ye={class:"header-actions"},he={key:0,class:"no-data"},be={class:"card-header"},we={class:"header-actions"},Ce={key:0,class:"no-data"},Ve={__name:"Cache",setup(ke){const h=p(!1),u=de({session_ttl:60,session_renewal_ttl:14,unavailable_ttl:5,concurrency_ttl:5}),I=p("accounts"),k=p(!1),v=p([]),x=p(""),z=p(!1),g=p([]),U=p(""),Z=Q(()=>x.value?v.value.filter(n=>String(n.account_id).includes(x.value)):v.value),ee=Q(()=>U.value?g.value.filter(n=>String(n.user_id).includes(U.value)):g.value);function G(n){return n?new Date(n).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-"}function O(n,e){return n>=e?"danger":n>=e*.8?"warning":"success"}async function j(){h.value=!0;try{const e=(await d.getCacheConfig()).data||{};u.session_ttl=e.session_ttl||60,u.session_renewal_ttl=e.session_renewal_ttl||14,u.unavailable_ttl=e.unavailable_ttl||5,u.concurrency_ttl=e.concurrency_ttl||5}catch(n){console.error("Failed to fetch config:",n)}finally{h.value=!1}}async function le(){h.value=!0;try{await d.updateCacheConfig(u),V.success("配置已保存")}catch(n){console.error("Failed to save config:",n)}finally{h.value=!1}}async function A(){var n;k.value=!0;try{const e=await d.getCacheAccounts();v.value=((n=e.data)==null?void 0:n.accounts)||[]}catch(e){console.error("Failed to load account cache:",e)}finally{k.value=!1}}async function N(){var n;z.value=!0;try{const e=await d.getCacheUsers();g.value=((n=e.data)==null?void 0:n.users)||[]}catch(e){console.error("Failed to load user cache:",e)}finally{z.value=!1}}async function ae(n){try{await d.clearAccountSessions(n),await d.resetAccountConcurrency(n),V.success("账号缓存已清除"),A()}catch(e){console.error("Failed to clear account cache:",e)}}async function te(){try{await d.clearCache("sessions"),await d.clearCache("concurrency"),V.success("所有账号缓存已清除"),v.value=[]}catch(n){console.error("Failed to clear all account cache:",n)}}async function ne(n){try{await d.clearUserCache(n),await d.resetUserConcurrency(n),V.success("用户缓存已清除"),N()}catch(e){console.error("Failed to clear user cache:",e)}}async function se(){try{await d.clearCache("sessions"),await d.clearCache("concurrency"),V.success("所有用户缓存已清除"),g.value=[]}catch(n){console.error("Failed to clear all user cache:",n)}}function oe(n){n==="accounts"&&v.value.length===0?A():n==="users"&&g.value.length===0&&N()}function re(){j(),I.value==="accounts"?A():N()}return _e(()=>{j(),A()}),(n,e)=>{const B=c("el-icon"),m=c("el-button"),F=c("el-input-number"),b=c("el-form-item"),ce=c("el-form"),E=c("el-card"),H=c("el-input"),T=c("el-popconfirm"),s=c("el-table-column"),D=c("el-tag"),L=c("el-table"),J=c("el-popover"),K=c("el-empty"),P=c("el-tab-pane"),ue=c("el-tabs"),M=fe("loading");return i(),C("div",pe,[r("div",ve,[e[8]||(e[8]=r("h2",null,"缓存管理",-1)),l(m,{onClick:re},{default:a(()=>[l(B,null,{default:a(()=>[l($(me))]),_:1}),e[7]||(e[7]=o(" 刷新 ",-1))]),_:1})]),l(E,{class:"config-card"},{header:a(()=>[...e[9]||(e[9]=[r("span",null,"缓存配置",-1)])]),default:a(()=>[q((i(),y(ce,{inline:!0,model:u},{default:a(()=>[l(b,{label:"粘性会话TTL"},{default:a(()=>[l(F,{modelValue:u.session_ttl,"onUpdate:modelValue":e[0]||(e[0]=t=>u.session_ttl=t),min:1,max:1440},null,8,["modelValue"]),e[10]||(e[10]=r("span",{class:"unit"},"分钟",-1))]),_:1}),l(b,{label:"会话续期阈值"},{default:a(()=>[l(F,{modelValue:u.session_renewal_ttl,"onUpdate:modelValue":e[1]||(e[1]=t=>u.session_renewal_ttl=t),min:1,max:60},null,8,["modelValue"]),e[11]||(e[11]=r("span",{class:"unit"},"分钟",-1))]),_:1}),l(b,{label:"不可用标记TTL"},{default:a(()=>[l(F,{modelValue:u.unavailable_ttl,"onUpdate:modelValue":e[2]||(e[2]=t=>u.unavailable_ttl=t),min:1,max:60},null,8,["modelValue"]),e[12]||(e[12]=r("span",{class:"unit"},"分钟",-1))]),_:1}),l(b,{label:"并发计数TTL"},{default:a(()=>[l(F,{modelValue:u.concurrency_ttl,"onUpdate:modelValue":e[3]||(e[3]=t=>u.concurrency_ttl=t),min:1,max:60},null,8,["modelValue"]),e[13]||(e[13]=r("span",{class:"unit"},"分钟",-1))]),_:1}),l(b,null,{default:a(()=>[l(m,{type:"primary",onClick:le},{default:a(()=>[...e[14]||(e[14]=[o("保存配置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])),[[M,h.value]])]),_:1}),l(ue,{modelValue:I.value,"onUpdate:modelValue":e[6]||(e[6]=t=>I.value=t),onTabChange:oe},{default:a(()=>[l(P,{label:"账号缓存",name:"accounts"},{default:a(()=>[l(E,null,{header:a(()=>[r("div",ge,[r("span",null,"账号缓存列表 ("+f(v.value.length)+")",1),r("div",ye,[l(H,{modelValue:x.value,"onUpdate:modelValue":e[4]||(e[4]=t=>x.value=t),placeholder:"搜索账号ID",clearable:"",style:{width:"150px"}},{prefix:a(()=>[l(B,null,{default:a(()=>[l($(Y))]),_:1})]),_:1},8,["modelValue"]),l(T,{title:"清除所有账号缓存?",onConfirm:te},{reference:a(()=>[l(m,{type:"danger",size:"small"},{default:a(()=>[...e[15]||(e[15]=[o("清除全部",-1)])]),_:1})]),_:1})])])]),default:a(()=>[q((i(),y(L,{data:Z.value,size:"small"},{default:a(()=>[l(s,{prop:"account_id",label:"账号ID",width:"100",align:"center"}),l(s,{label:"并发",width:"120",align:"center"},{default:a(({row:t})=>[r("span",{class:R(O(t.concurrency,t.max_concurrency))},f(t.concurrency),3),o(" / "+f(t.max_concurrency),1)]),_:1}),l(s,{label:"会话数",width:"100",align:"center"},{default:a(({row:t})=>[l(D,{size:"small"},{default:a(()=>[o(f(t.session_count),1)]),_:2},1024)]),_:1}),l(s,{label:"使用此账号的用户","min-width":"150"},{default:a(({row:t})=>{var _;return[(i(!0),C(W,null,X(t.users,w=>(i(),y(D,{key:w,size:"small",class:"user-tag"},{default:a(()=>[o(" 用户"+f(w),1)]),_:2},1024))),128)),(_=t.users)!=null&&_.length?S("",!0):(i(),C("span",he,"-"))]}),_:1}),l(s,{label:"会话详情","min-width":"200"},{default:a(({row:t})=>[l(J,{placement:"left",width:400,trigger:"click"},{reference:a(()=>[l(m,{link:"",type:"primary",size:"small"},{default:a(()=>[...e[16]||(e[16]=[o("查看会话",-1)])]),_:1})]),default:a(()=>[l(L,{data:t.sessions,size:"small","max-height":"300"},{default:a(()=>[l(s,{prop:"session_id",label:"会话ID","show-overflow-tooltip":""}),l(s,{prop:"user_id",label:"用户",width:"60"}),l(s,{label:"绑定时间",width:"120"},{default:a(({row:_})=>[o(f(G(_.bound_at)),1)]),_:1})]),_:1},8,["data"])]),_:2},1024)]),_:1}),l(s,{label:"操作",width:"100",align:"center"},{default:a(({row:t})=>[l(T,{title:"清除此账号缓存?",onConfirm:_=>ae(t.account_id)},{reference:a(()=>[l(m,{link:"",type:"danger",size:"small"},{default:a(()=>[...e[17]||(e[17]=[o("清除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[M,k.value]]),!k.value&&v.value.length===0?(i(),y(K,{key:0,description:"暂无账号缓存"})):S("",!0)]),_:1})]),_:1}),l(P,{label:"用户缓存",name:"users"},{default:a(()=>[l(E,null,{header:a(()=>[r("div",be,[r("span",null,"用户缓存列表 ("+f(g.value.length)+")",1),r("div",we,[l(H,{modelValue:U.value,"onUpdate:modelValue":e[5]||(e[5]=t=>U.value=t),placeholder:"搜索用户ID",clearable:"",style:{width:"150px"}},{prefix:a(()=>[l(B,null,{default:a(()=>[l($(Y))]),_:1})]),_:1},8,["modelValue"]),l(T,{title:"清除所有用户缓存?",onConfirm:se},{reference:a(()=>[l(m,{type:"danger",size:"small"},{default:a(()=>[...e[18]||(e[18]=[o("清除全部",-1)])]),_:1})]),_:1})])])]),default:a(()=>[q((i(),y(L,{data:ee.value,size:"small"},{default:a(()=>[l(s,{prop:"user_id",label:"用户ID",width:"100",align:"center"}),l(s,{label:"并发",width:"120",align:"center"},{default:a(({row:t})=>[r("span",{class:R(O(t.concurrency,10))},f(t.concurrency),3),e[19]||(e[19]=o(" / 10 ",-1))]),_:1}),l(s,{label:"会话数",width:"100",align:"center"},{default:a(({row:t})=>[l(D,{size:"small"},{default:a(()=>[o(f(t.session_count),1)]),_:2},1024)]),_:1}),l(s,{label:"使用的账号","min-width":"150"},{default:a(({row:t})=>{var _;return[(i(!0),C(W,null,X(t.accounts,w=>(i(),y(D,{key:w,size:"small",type:"warning",class:"account-tag"},{default:a(()=>[o(" 账号"+f(w),1)]),_:2},1024))),128)),(_=t.accounts)!=null&&_.length?S("",!0):(i(),C("span",Ce,"-"))]}),_:1}),l(s,{label:"会话详情","min-width":"200"},{default:a(({row:t})=>[l(J,{placement:"left",width:400,trigger:"click"},{reference:a(()=>[l(m,{link:"",type:"primary",size:"small"},{default:a(()=>[...e[20]||(e[20]=[o("查看会话",-1)])]),_:1})]),default:a(()=>[l(L,{data:t.sessions,size:"small","max-height":"300"},{default:a(()=>[l(s,{prop:"session_id",label:"会话ID","show-overflow-tooltip":""}),l(s,{prop:"account_id",label:"账号",width:"60"}),l(s,{label:"绑定时间",width:"120"},{default:a(({row:_})=>[o(f(G(_.bound_at)),1)]),_:1})]),_:1},8,["data"])]),_:2},1024)]),_:1}),l(s,{label:"操作",width:"100",align:"center"},{default:a(({row:t})=>[l(T,{title:"清除此用户缓存?",onConfirm:_=>ne(t.user_id)},{reference:a(()=>[l(m,{link:"",type:"danger",size:"small"},{default:a(()=>[...e[21]||(e[21]=[o("清除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[M,z.value]]),!z.value&&g.value.length===0?(i(),y(K,{key:0,description:"暂无用户缓存"})):S("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},ze=ie(Ve,[["__scopeId","data-v-9e6ce078"]]);export{ze as default};

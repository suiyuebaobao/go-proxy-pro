import{_ as ue,r as p,c as de,a as J,o as re,b as q,d,e as u,f as t,w as l,h as s,i as L,M as ie,n as r,q as _e,v as ce,t as i,J as $,k as v,l as g,F as K,H as j}from"./index-DggV_0iX.js";const pe={class:"logs-page"},ve={class:"page-header"},fe={class:"stat-item"},me={class:"stat-value"},ge={class:"stat-item"},be={class:"stat-value"},he={class:"stat-item cost"},we={class:"stat-value"},ye={class:"stat-item"},ke={class:"stat-value"},xe={key:2,class:"pagination-wrap"},De={__name:"RequestLogs",setup(Ve){const A=p("daily"),_=p(null),I=p([]),f=p(null),b=p(""),G=[{text:"今天",value:()=>{const o=new Date;return[o,o]}},{text:"最近7天",value:()=>{const o=new Date,e=new Date;return e.setDate(e.getDate()-7),[e,o]}},{text:"最近30天",value:()=>{const o=new Date,e=new Date;return e.setDate(e.getDate()-30),[e,o]}},{text:"本月",value:()=>{const o=new Date;return[new Date(o.getFullYear(),o.getMonth(),1),o]}}],O=de(()=>h.value.map(o=>o.model).filter(Boolean)),m=J({total_requests:0,total_tokens:0,total_cost:0}),T=p([]),k=p(!1),h=p([]),x=p(!1),w=p([]),D=p(!1),c=J({page:1,pageSize:20,total:0});function C(o){return o?o>=1e6?(o/1e6).toFixed(1)+"M":o>=1e3?(o/1e3).toFixed(1)+"K":o:"0"}function Q(o){return o?new Date(o).toLocaleString("zh-CN"):""}async function W(){var o;try{const e=await L.getUsers({page:1,page_size:1e3});I.value=((o=e.data)==null?void 0:o.items)||[]}catch(e){console.error("Failed to fetch users:",e)}}async function P(){k.value=!0,x.value=!0;try{const e=(await L.getAllUsageSummary({})).data||{};m.total_requests=e.total_requests||0,m.total_tokens=e.total_tokens||0,m.total_cost=e.total_cost||0,T.value=e.daily||[],h.value=e.models||[]}catch(o){console.error("Failed to fetch summary:",o)}finally{k.value=!1,x.value=!1}}function X(){c.page=1,w.value=[]}async function V(){if(_.value){D.value=!0;try{const o={page:c.page,page_size:c.pageSize};f.value&&f.value.length===2&&(o.start_date=f.value[0],o.end_date=f.value[1]),b.value&&(o.model=b.value);const F=(await L.getUserUsageRecords(_.value,o)).data||{};w.value=F.items||[],c.total=F.total||w.value.length}catch(o){console.error("Failed to fetch records:",o)}finally{D.value=!1}}}function Z(){f.value=null,b.value="",c.page=1,_.value&&V()}function ee(){P(),_.value&&V()}return re(()=>{W(),P()}),(o,e)=>{const F=s("el-icon"),M=s("el-button"),U=s("el-card"),z=s("el-col"),te=s("el-row"),n=s("el-table-column"),R=s("el-table"),B=s("el-empty"),N=s("el-tab-pane"),E=s("el-option"),H=s("el-select"),S=s("el-form-item"),ae=s("el-date-picker"),le=s("el-form"),oe=s("el-alert"),se=s("el-pagination"),ne=s("el-tabs"),Y=ie("loading");return d(),q("div",pe,[u("div",ve,[e[7]||(e[7]=u("h2",null,"请求日志",-1)),t(M,{onClick:ee},{default:l(()=>[t(F,null,{default:l(()=>[t(_e(ce))]),_:1}),e[6]||(e[6]=r(" 刷新 ",-1))]),_:1})]),t(te,{gutter:20,class:"summary-cards"},{default:l(()=>[t(z,{span:6},{default:l(()=>[t(U,{shadow:"hover"},{default:l(()=>[u("div",fe,[u("div",me,i(m.total_requests||0),1),e[8]||(e[8]=u("div",{class:"stat-label"},"总请求数",-1))])]),_:1})]),_:1}),t(z,{span:6},{default:l(()=>[t(U,{shadow:"hover"},{default:l(()=>[u("div",ge,[u("div",be,i(C(m.total_tokens)),1),e[9]||(e[9]=u("div",{class:"stat-label"},"总Token",-1))])]),_:1})]),_:1}),t(z,{span:6},{default:l(()=>[t(U,{shadow:"hover"},{default:l(()=>[u("div",he,[u("div",we,"$"+i((m.total_cost||0).toFixed(4)),1),e[10]||(e[10]=u("div",{class:"stat-label"},"总费用",-1))])]),_:1})]),_:1}),t(z,{span:6},{default:l(()=>[t(U,{shadow:"hover"},{default:l(()=>[u("div",ye,[u("div",ke,i(h.value.length),1),e[11]||(e[11]=u("div",{class:"stat-label"},"模型数",-1))])]),_:1})]),_:1})]),_:1}),t(ne,{modelValue:A.value,"onUpdate:modelValue":e[5]||(e[5]=a=>A.value=a)},{default:l(()=>[t(N,{label:"每日汇总",name:"daily"},{default:l(()=>[$((d(),v(R,{data:T.value,stripe:""},{default:l(()=>[t(n,{prop:"date",label:"日期",width:"120"}),t(n,{prop:"request_count",label:"请求数",width:"100"}),t(n,{prop:"total_tokens",label:"Token",width:"120"},{default:l(({row:a})=>[r(i(C(a.total_tokens)),1)]),_:1}),t(n,{label:"费用",width:"120"},{default:l(({row:a})=>{var y;return[r(" $"+i(((y=a.total_cost)==null?void 0:y.toFixed(4))||"0"),1)]}),_:1})]),_:1},8,["data"])),[[Y,k.value]]),T.value.length===0&&!k.value?(d(),v(B,{key:0,description:"暂无数据"})):g("",!0)]),_:1}),t(N,{label:"模型统计",name:"models"},{default:l(()=>[$((d(),v(R,{data:h.value,stripe:""},{default:l(()=>[t(n,{prop:"model",label:"模型","min-width":"200"}),t(n,{prop:"request_count",label:"请求数",width:"100"}),t(n,{prop:"total_tokens",label:"Token",width:"120"},{default:l(({row:a})=>[r(i(C(a.total_tokens)),1)]),_:1}),t(n,{label:"费用",width:"120"},{default:l(({row:a})=>{var y;return[r(" $"+i(((y=a.total_cost)==null?void 0:y.toFixed(4))||"0"),1)]}),_:1})]),_:1},8,["data"])),[[Y,x.value]]),h.value.length===0&&!x.value?(d(),v(B,{key:0,description:"暂无数据"})):g("",!0)]),_:1}),t(N,{label:"用户详细记录",name:"records"},{default:l(()=>[t(le,{inline:!0,style:{"margin-bottom":"16px"}},{default:l(()=>[t(S,{label:"选择用户"},{default:l(()=>[t(H,{modelValue:_.value,"onUpdate:modelValue":e[0]||(e[0]=a=>_.value=a),clearable:"",placeholder:"选择用户",onChange:X,filterable:"",style:{width:"160px"}},{default:l(()=>[(d(!0),q(K,null,j(I.value,a=>(d(),v(E,{key:a.id,label:a.username,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(S,{label:"时间范围"},{default:l(()=>[t(ae,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=a=>f.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"240px"},shortcuts:G},null,8,["modelValue"])]),_:1}),t(S,{label:"模型"},{default:l(()=>[t(H,{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=a=>b.value=a),clearable:"",placeholder:"全部模型",filterable:"",style:{width:"200px"}},{default:l(()=>[(d(!0),q(K,null,j(O.value,a=>(d(),v(E,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(S,null,{default:l(()=>[t(M,{type:"primary",onClick:V,disabled:!_.value},{default:l(()=>[...e[12]||(e[12]=[r("查询",-1)])]),_:1},8,["disabled"]),t(M,{onClick:Z},{default:l(()=>[...e[13]||(e[13]=[r("重置",-1)])]),_:1})]),_:1})]),_:1}),_.value?g("",!0):(d(),v(oe,{key:0,type:"info",closable:!1,style:{"margin-bottom":"16px"}},{default:l(()=>[...e[14]||(e[14]=[r(" 请选择用户查看详细记录 ",-1)])]),_:1})),_.value?$((d(),v(R,{key:1,data:w.value,stripe:""},{default:l(()=>[t(n,{prop:"model",label:"模型","min-width":"180","show-overflow-tooltip":""}),t(n,{prop:"request_ip",label:"请求IP",width:"130","show-overflow-tooltip":""}),t(n,{label:"输入Token",width:"100"},{default:l(({row:a})=>[r(i(a.input_tokens||0),1)]),_:1}),t(n,{label:"输出Token",width:"100"},{default:l(({row:a})=>[r(i(a.output_tokens||0),1)]),_:1}),t(n,{label:"缓存Token",width:"100"},{default:l(({row:a})=>[r(i((a.cache_creation_input_tokens||0)+(a.cache_read_input_tokens||0)),1)]),_:1}),t(n,{prop:"total_tokens",label:"总Token",width:"100"}),t(n,{label:"费用",width:"100"},{default:l(({row:a})=>[r(" $"+i((a.total_cost||0).toFixed(4)),1)]),_:1}),t(n,{label:"时间",width:"170"},{default:l(({row:a})=>[r(i(Q(a.timestamp||a.request_time)),1)]),_:1})]),_:1},8,["data"])),[[Y,D.value]]):g("",!0),_.value&&c.total>0?(d(),q("div",xe,[t(se,{"current-page":c.page,"onUpdate:currentPage":e[3]||(e[3]=a=>c.page=a),"page-size":c.pageSize,"onUpdate:pageSize":e[4]||(e[4]=a=>c.pageSize=a),total:c.total,"page-sizes":[20,50,100],layout:"total, sizes, prev, pager, next",onChange:V},null,8,["current-page","page-size","total"])])):g("",!0),_.value&&w.value.length===0&&!D.value?(d(),v(B,{key:3,description:"暂无记录"})):g("",!0)]),_:1})]),_:1},8,["modelValue"])])}}},Ue=ue(De,[["__scopeId","data-v-1242022a"]]);export{Ue as default};
